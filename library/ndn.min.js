/*
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
  MIT
 <a href="https://github.com/bitcoinjs/bitcoinjs-lib/blob/master/LICENSE">MIT License</a>
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
*/
(function(ka,u){"object"===typeof exports?module.exports.printStackTrace=u():"function"===typeof define&&define.amd?define(u):ka.printStackTrace=u()})(this,function(){function ka(u){u=u||{guess:!0};var J=u.e||null,S=!!u.guess,T=u.mode||null;u=new ka.implementation;J=u.run(J,T);return S?u.guessAnonymousFunctions(J):J}ka.implementation=function(){};ka.implementation.prototype={run:function(u,J){u=u||this.createException();J=J||this.mode(u);return"other"===J?this.other(arguments.callee):this[J](u)},
createException:function(){try{this.undef()}catch(u){return u}},mode:function(u){return"undefined"!==typeof window&&-1<window.navigator.userAgent.indexOf("PhantomJS")?"phantomjs":u.arguments&&u.stack?"chrome":u.stack&&u.sourceURL?"safari":u.stack&&u.number?"ie":u.stack&&u.fileName?"firefox":u.message&&u["opera#sourceloc"]?!u.stacktrace||-1<u.message.indexOf("\n")&&u.message.split("\n").length>u.stacktrace.split("\n").length?"opera9":"opera10a":u.message&&u.stack&&u.stacktrace?0>u.stacktrace.indexOf("called from line")?
"opera10b":"opera11":u.stack&&!u.fileName?"chrome":"other"},instrumentFunction:function(u,J,S){u=u||window;var T=u[J];u[J]=function(){S.call(this,ka().slice(4));return u[J]._instrumented.apply(this,arguments)};u[J]._instrumented=T},deinstrumentFunction:function(u,J){u[J].constructor===Function&&u[J]._instrumented&&u[J]._instrumented.constructor===Function&&(u[J]=u[J]._instrumented)},chrome:function(u){return(u.stack+"\n").replace(/^[\s\S]+?\s+at\s+/," at ").replace(/^\s+(at eval )?at\s+/gm,"").replace(/^([^\(]+?)([\n$])/gm,
"{anonymous}() ($1)$2").replace(/^Object.<anonymous>\s*\(([^\)]+)\)/gm,"{anonymous}() ($1)").replace(/^(.+) \((.+)\)$/gm,"$1@$2").split("\n").slice(0,-1)},safari:function(u){return u.stack.replace(/\[native code\]\n/m,"").replace(/^(?=\w+Error\:).*$\n/m,"").replace(/^@/gm,"{anonymous}()@").split("\n")},ie:function(u){return u.stack.replace(/^\s*at\s+(.*)$/gm,"$1").replace(/^Anonymous function\s+/gm,"{anonymous}() ").replace(/^(.+)\s+\((.+)\)$/gm,"$1@$2").split("\n").slice(1)},firefox:function(u){return u.stack.replace(/(?:\n@:0)?\s+$/m,
"").replace(/^(?:\((\S*)\))?@/gm,"{anonymous}($1)@").split("\n")},opera11:function(u){var J=/^.*line (\d+), column (\d+)(?: in (.+))? in (\S+):$/;u=u.stacktrace.split("\n");for(var S=[],T=0,V=u.length;T<V;T+=2){var K=J.exec(u[T]);if(K){var A=K[4]+":"+K[1]+":"+K[2],K=K[3]||"global code",K=K.replace(/<anonymous function: (\S+)>/,"$1").replace(/<anonymous function>/,"{anonymous}");S.push(K+"@"+A+" -- "+u[T+1].replace(/^\s+/,""))}}return S},opera10b:function(u){var J=/^(.*)@(.+):(\d+)$/;u=u.stacktrace.split("\n");
for(var S=[],T=0,V=u.length;T<V;T++){var K=J.exec(u[T]);K&&S.push((K[1]?K[1]+"()":"global code")+"@"+K[2]+":"+K[3])}return S},opera10a:function(u){var J=/Line (\d+).*script (?:in )?(\S+)(?:: In function (\S+))?$/i;u=u.stacktrace.split("\n");for(var S=[],T=0,V=u.length;T<V;T+=2){var K=J.exec(u[T]);K&&S.push((K[3]||"{anonymous}")+"()@"+K[2]+":"+K[1]+" -- "+u[T+1].replace(/^\s+/,""))}return S},opera9:function(u){var J=/Line (\d+).*script (?:in )?(\S+)/i;u=u.message.split("\n");for(var S=[],T=2,V=u.length;T<
V;T+=2){var K=J.exec(u[T]);K&&S.push("{anonymous}()@"+K[2]+":"+K[1]+" -- "+u[T+1].replace(/^\s+/,""))}return S},phantomjs:function(u){var J=/(\S+) \((\S+)\)/i;u=u.stack.split("\n");for(var S=[],T=1,V=u.length;T<V;T++){u[T]=u[T].replace(/^\s+at\s+/gm,"");var K=J.exec(u[T]);K?S.push(K[1]+"()@"+K[2]):S.push("{anonymous}()@"+u[T])}return S},other:function(u){for(var J=/function(?:\s+([\w$]+))?\s*\(/,S=[],T,V,K=Array.prototype.slice;u&&10>S.length;){T=J.test(u.toString())?RegExp.$1||"{anonymous}":"{anonymous}";
try{V=K.call(u.arguments||[])}catch(A){V=["Cannot access arguments: "+A]}S[S.length]=T+"("+this.stringifyArguments(V)+")";try{u=u.caller}catch(ka){S[S.length]="Cannot access caller: "+ka;break}}return S},stringifyArguments:function(u){for(var J=[],S=Array.prototype.slice,T=0;T<u.length;++T){var V=u[T];void 0===V?J[T]="undefined":null===V?J[T]="null":V.constructor&&(J[T]=V.constructor===Array?3>V.length?"["+this.stringifyArguments(V)+"]":"["+this.stringifyArguments(S.call(V,0,1))+"..."+this.stringifyArguments(S.call(V,
-1))+"]":V.constructor===Object?"#object":V.constructor===Function?"#function":V.constructor===String?'"'+V+'"':V.constructor===Number?V:"?")}return J.join(",")},sourceCache:{},ajax:function(u){var J=this.createXMLHTTPObject();if(J)try{return J.open("GET",u,!1),J.send(null),J.responseText}catch(S){}return""},createXMLHTTPObject:function(){for(var u,J=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},
function(){return new ActiveXObject("Microsoft.XMLHTTP")}],S=0;S<J.length;S++)try{return u=J[S](),this.createXMLHTTPObject=J[S],u}catch(T){}},isSameDomain:function(u){return"undefined"!==typeof location&&-1!==u.indexOf(location.hostname)},getSource:function(u){u in this.sourceCache||(this.sourceCache[u]=this.ajax(u).split("\n"));return this.sourceCache[u]},guessAnonymousFunctions:function(u){for(var J=0;J<u.length;++J){var S=/^(.*?)(?::(\d+))(?::(\d+))?(?: -- .+)?$/,T=u[J],V=/\{anonymous\}\(.*\)@(.*)/.exec(T);
if(V){var K=S.exec(V[1]);K&&(S=K[1],V=K[2],K=K[3]||0,S&&this.isSameDomain(S)&&V&&(S=this.guessAnonymousFunction(S,V,K),u[J]=T.replace("{anonymous}",S)))}}return u},guessAnonymousFunction:function(u,J,S){var T;try{T=this.findFunctionName(this.getSource(u),J)}catch(V){T="getSource failed with url: "+u+", exception: "+V.toString()}return T},findFunctionName:function(u,J){for(var S=/function\s+([^(]*?)\s*\(([^)]*)\)/,T=/['"]?([$_A-Za-z][$_A-Za-z0-9]*)['"]?\s*[:=]\s*function\b/,V=/['"]?([$_A-Za-z][$_A-Za-z0-9]*)['"]?\s*[:=]\s*(?:eval|new Function)\b/,
K="",A,ka=Math.min(J,20),jd,Ab=0;Ab<ka;++Ab)if(A=u[J-Ab-1],jd=A.indexOf("//"),0<=jd&&(A=A.substr(0,jd)),A)if(K=A+K,(A=T.exec(K))&&A[1]||(A=S.exec(K))&&A[1]||(A=V.exec(K))&&A[1])return A[1];return"(?)"}};return ka});
(function(ka){function u(e){var k="",h,d=0,v,l;for(h=0;h<e.length&&e.charAt(h)!=wd;++h)l=Qb.indexOf(e.charAt(h)),0>l||(0==d?(k+=Rb.charAt(l>>2),v=l&3,d=1):1==d?(k+=Rb.charAt(v<<2|l>>4),v=l&15,d=2):2==d?(k+=Rb.charAt(v),k+=Rb.charAt(l>>2),v=l&3,d=3):(k+=Rb.charAt(v<<2|l>>4),k+=Rb.charAt(l&15),d=0));1==d&&(k+=Rb.charAt(v<<2));return k}function J(){this.j=this.i=0;this.S=[]}function S(){var e=(new Date).getTime();vb[Ka++]^=e&255;vb[Ka++]^=e>>8&255;vb[Ka++]^=e>>16&255;vb[Ka++]^=e>>24&255;Ka>=xd&&(Ka-=
xd)}function T(){}function V(e,k){return new z(e,k)}function K(e,k,h){for(var d="",v=0;d.length<k;)d+=h(String.fromCharCode.apply(String,e.concat([(v&4278190080)>>24,(v&16711680)>>16,(v&65280)>>8,v&255]))),v+=1;return d}function A(){this.n=null;this.e=0;this.coeff=this.dmq1=this.dmp1=this.q=this.p=this.d=null}function Hd(e,k,h){for(var d="",v=0;d.length<k;)d+=h(e+String.fromCharCode.apply(String,[(v&4278190080)>>24,(v&16711680)>>16,(v&65280)>>8,v&255])),v+=1;return d}function jd(e){var k=[],h=E.getStartPosOfV_AtObj(e,
0),d=E.getPosOfNextSibling_AtObj(e,h),v=E.getPosOfNextSibling_AtObj(e,d),l=E.getPosOfNextSibling_AtObj(e,v),a=E.getPosOfNextSibling_AtObj(e,l),b=E.getPosOfNextSibling_AtObj(e,a),c=E.getPosOfNextSibling_AtObj(e,b),f=E.getPosOfNextSibling_AtObj(e,c),g=E.getPosOfNextSibling_AtObj(e,f);k.push(h,d,v,l,a,b,c,f,g);h=E.getHexOfV_AtObj(e,k[0]);d=E.getHexOfV_AtObj(e,k[1]);v=E.getHexOfV_AtObj(e,k[2]);l=E.getHexOfV_AtObj(e,k[3]);a=E.getHexOfV_AtObj(e,k[4]);b=E.getHexOfV_AtObj(e,k[5]);c=E.getHexOfV_AtObj(e,k[6]);
f=E.getHexOfV_AtObj(e,k[7]);e=E.getHexOfV_AtObj(e,k[8]);k=[];k.push(h,d,v,l,a,b,c,f,e);return k}function Ab(e,k){for(var h="",d=k/4-e.length,v=0;v<d;v++)h+="0";return h+e}function Id(e,k){var h=N.crypto.Util.hashString(e,k);return this.signWithMessageHash(h,k)}function he(e){return Id.call(this,e,"sha1")}function ie(e){return Id.call(this,e,"sha256")}function je(e,k,h){for(var d="",v=0;d.length<k;)d+=hextorstr(h(rstrtohex(e+String.fromCharCode.apply(String,[(v&4278190080)>>24,(v&16711680)>>16,(v&
65280)>>8,v&255])))),v+=1;return d}function ke(e,k,h){e=rstrtohex(e);e=N.crypto.Util.hashHex(e,k);void 0===h&&(h=-1);return this.signWithMessageHashPSS(e,k,h)}function Sd(e){for(var k in N.crypto.Util.DIGESTINFOHEAD){var h=N.crypto.Util.DIGESTINFOHEAD[k],d=h.length;if(e.substring(0,d)==h)return[k,e.substring(d)]}return[]}function ld(e,k){var h=V(e,16);var d=this.n.toString(16),v=this.e.toString(16),l=new A;l.setPublic(d,v);h=l.doPublic(h).toString(16).replace(/^1f+00/,"");d=Sd(h);0==d.length?h=!1:
(h=d[1],d=N.crypto.Util.hashString(k,d[0]),h=h==d);return h}function yd(e,k){k=k.replace(Jd,"");k=k.replace(/[ \n]+/g,"");var h=V(k,16);if(h.bitLength()>this.n.bitLength())return 0;var h=this.doPublic(h).toString(16).replace(/^1f+00/,""),d=Sd(h);if(0==d.length)return!1;h=d[1];d=N.crypto.Util.hashString(e,d[0]);return h==d}function Td(e,k,h,d){e=rstrtohex(e);e=N.crypto.Util.hashHex(e,h);void 0===d&&(d=-1);return this.verifyWithMessageHashPSS(e,k,h,d)}function da(){this.hex=this.subjectPublicKeyRSA_hE=
this.subjectPublicKeyRSA_hN=this.subjectPublicKeyRSA=null;this.getSerialNumberHex=function(){return E.getDecendantHexVByNthList(this.hex,0,[0,1])};this.getIssuerHex=function(){return E.getDecendantHexTLVByNthList(this.hex,0,[0,3])};this.getIssuerString=function(){return da.hex2dn(E.getDecendantHexTLVByNthList(this.hex,0,[0,3]))};this.getSubjectHex=function(){return E.getDecendantHexTLVByNthList(this.hex,0,[0,5])};this.getSubjectString=function(){return da.hex2dn(E.getDecendantHexTLVByNthList(this.hex,
0,[0,5]))};this.getNotBefore=function(){var e=E.getDecendantHexVByNthList(this.hex,0,[0,4,0]),e=e.replace(/(..)/g,"%$1");return e=decodeURIComponent(e)};this.getNotAfter=function(){var e=E.getDecendantHexVByNthList(this.hex,0,[0,4,1]),e=e.replace(/(..)/g,"%$1");return e=decodeURIComponent(e)};this.readCertPEM=function(e){e=da.pemToHex(e);var k=da.getPublicKeyHexArrayFromCertHex(e),h=new A;h.setPublic(k[0],k[1]);this.subjectPublicKeyRSA=h;this.subjectPublicKeyRSA_hN=k[0];this.subjectPublicKeyRSA_hE=
k[1];this.hex=e};this.readCertPEMWithoutRSAInit=function(e){e=da.pemToHex(e);var k=da.getPublicKeyHexArrayFromCertHex(e);this.subjectPublicKeyRSA.setPublic(k[0],k[1]);this.subjectPublicKeyRSA_hN=k[0];this.subjectPublicKeyRSA_hE=k[1];this.hex=e}}function ga(){return new z(null)}function Fb(e,k,h,d,v,l){for(;0<=--l;){var a=k*this[e++]+h[d]+v;v=Math.floor(a/67108864);h[d++]=a&67108863}return v}function le(e,k,h,d,v,l){var a=k&32767;for(k>>=15;0<=--l;){var b=this[e]&32767,c=this[e++]>>15,f=k*b+c*a,b=
a*b+((f&32767)<<15)+h[d]+(v&1073741823);v=(b>>>30)+(f>>>15)+k*c+(v>>>30);h[d++]=b&1073741823}return v}function Ud(e,k,h,d,v,l){var a=k&16383;for(k>>=14;0<=--l;){var b=this[e]&16383,c=this[e++]>>14,f=k*b+c*a,b=a*b+((f&16383)<<14)+h[d]+v;v=(b>>28)+(f>>14)+k*c;h[d++]=b&268435455}return v}function Sc(e,k){var h=me[e.charCodeAt(k)];return null==h?-1:h}function Dc(e){var k=ga();k.fromInt(e);return k}function zd(e){var k=1,h;0!=(h=e>>>16)&&(e=h,k+=16);0!=(h=e>>8)&&(e=h,k+=8);0!=(h=e>>4)&&(e=h,k+=4);0!=(h=
e>>2)&&(e=h,k+=2);0!=e>>1&&(k+=1);return k}function rc(e){this.m=e}function La(e){this.m=e;this.mp=e.invDigit();this.mpl=this.mp&32767;this.mph=this.mp>>15;this.um=(1<<e.DB-15)-1;this.mt2=2*e.t}function ue(e,k){return e&k}function Kd(e,k){return e|k}function Ld(e,k){return e^k}function Tc(e,k){return e&~k}function Uc(){}function Ad(e){return e}function Ec(e){this.r2=ga();this.q3=ga();z.ONE.dlShiftTo(2*e.t,this.r2);this.mu=this.r2.divide(e);this.m=e}function f(e,k,h){if(!(this instanceof f))return new f(e,
k,h);var d=typeof e;if("base64"===k&&"string"===d)for(e=f.stringtrim(e);0!==e.length%4;)e+="=";var v;if("number"===d)v=f.coerce(e);else if("string"===d)v=f.byteLength(e,k);else if("object"===d)v=f.coerce(e.length);else throw Error("First argument needs to be a number, array or string.");var l;f._useTypedArrays?l=f._augment(new Uint8Array(v)):(l=this,l.length=v,l._isBuffer=!0);if(f._useTypedArrays&&"number"===typeof e.byteLength)l._set(e);else if(f.isArrayish(e))if(f.isBuffer(e))for(k=0;k<v;k++)l[k]=
e.readUInt8(k);else for(k=0;k<v;k++)l[k]=(e[k]%256+256)%256;else if("string"===d)l.write(e,0,k);else if("number"===d&&!f._useTypedArrays&&!h)for(k=0;k<v;k++)l[k]=0;return l}function R(e){if(e)return e.__proto__=R.prototype,e}function sa(e){if(e)return e.__proto__=sa.prototype,e}function Gb(e){if(e)return e.__proto__=Gb.prototype,e}function x(e){if(e)return e.__proto__=x.prototype,e}function Fc(e){x.call(this,e)}function D(e){x.call(this,e)}function Yb(e){if(e)return e.__proto__=Yb.prototype,e}var a=
a||{},q=a;q.printStackTrace=ka.printStackTrace;var yb=function(){var e=!1;if("undefined"!==typeof crypto&&crypto&&crypto.subtle){var k={name:"RSASSA-PKCS1-v1_5",modulusLength:2048,hash:{name:"SHA-256"},publicExponent:new Uint8Array([1,0,1])},h;crypto.subtle.generateKey(k,!0,["sign","verify"]).then(function(d){h=d;return crypto.subtle.sign(k,d.privateKey,new Uint8Array([1,2,3,4,5]))}).then(function(d){return crypto.subtle.verify(k,h.publicKey,d,new Uint8Array([1,2,3,4,5]))}).then(function(d){return crypto.subtle.exportKey("pkcs8",
h.privateKey)}).then(function(d){return crypto.subtle.importKey("pkcs8",d,k,!0,["sign"])}).then(function(d){return crypto.subtle.exportKey("spki",h.publicKey)}).then(function(d){return crypto.subtle.importKey("spki",d,k,!0,["verify"])}).then(function(d){d=new Uint8Array([1,2,3,4,5]);return crypto.subtle.digest({name:"SHA-256"},d.buffer)}).then(function(d){e=!0},function(d){console.log("DetectSubtleCrypto encountered error, not using crypto.subtle: ",d)})}return function(){return e}}();q.UseSubtleCrypto=
yb;var Sb=Sb||function(e,k){var h={},d=h.lib={},v=d.Base=function(){function d(){}return{extend:function(e){d.prototype=this;var h=new d;e&&h.mixIn(e);h.hasOwnProperty("init")||(h.init=function(){h.$super.init.apply(this,arguments)});h.init.prototype=h;h.$super=this;return h},create:function(){var d=this.extend();d.init.apply(d,arguments);return d},init:function(){},mixIn:function(d){for(var e in d)d.hasOwnProperty(e)&&(this[e]=d[e]);d.hasOwnProperty("toString")&&(this.toString=d.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),
l=d.WordArray=v.extend({init:function(d,e){d=this.words=d||[];this.sigBytes=e!=k?e:4*d.length},toString:function(d){return(d||b).stringify(this)},concat:function(d){var e=this.words,h=d.words,k=this.sigBytes;d=d.sigBytes;this.clamp();if(k%4)for(var l=0;l<d;l++)e[k+l>>>2]|=(h[l>>>2]>>>24-l%4*8&255)<<24-(k+l)%4*8;else for(l=0;l<d;l+=4)e[k+l>>>2]=h[l>>>2];this.sigBytes+=d;return this},clamp:function(){var d=this.words,h=this.sigBytes;d[h>>>2]&=4294967295<<32-h%4*8;d.length=e.ceil(h/4)},clone:function(){var d=
v.clone.call(this);d.words=this.words.slice(0);return d},random:function(d){for(var h=[],k=0;k<d;k+=4)h.push(4294967296*e.random()|0);return new l.init(h,d)}}),a=h.enc={},b=a.Hex={stringify:function(d){var e=d.words;d=d.sigBytes;for(var h=[],k=0;k<d;k++){var l=e[k>>>2]>>>24-k%4*8&255;h.push((l>>>4).toString(16));h.push((l&15).toString(16))}return h.join("")},parse:function(d){for(var e=d.length,h=[],k=0;k<e;k+=2)h[k>>>3]|=parseInt(d.substr(k,2),16)<<24-k%8*4;return new l.init(h,e/2)}},c=a.Latin1=
{stringify:function(d){var e=d.words;d=d.sigBytes;for(var h=[],k=0;k<d;k++)h.push(String.fromCharCode(e[k>>>2]>>>24-k%4*8&255));return h.join("")},parse:function(d){for(var e=d.length,h=[],k=0;k<e;k++)h[k>>>2]|=(d.charCodeAt(k)&255)<<24-k%4*8;return new l.init(h,e)}},f=a.Utf8={stringify:function(d){try{return decodeURIComponent(escape(c.stringify(d)))}catch(e){throw Error("Malformed UTF-8 data");}},parse:function(d){return c.parse(unescape(encodeURIComponent(d)))}},g=d.BufferedBlockAlgorithm=v.extend({reset:function(){this._data=
new l.init;this._nDataBytes=0},_append:function(d){"string"==typeof d&&(d=f.parse(d));this._data.concat(d);this._nDataBytes+=d.sigBytes},_process:function(d){var h=this._data,k=h.words,v=h.sigBytes,a=this.blockSize,b=v/(4*a),b=d?e.ceil(b):e.max((b|0)-this._minBufferSize,0);d=b*a;v=e.min(4*d,v);if(d){for(var kd=0;kd<d;kd+=a)this._doProcessBlock(k,kd);kd=k.splice(0,d);h.sigBytes-=v}return new l.init(kd,v)},clone:function(){var d=v.clone.call(this);d._data=this._data.clone();return d},_minBufferSize:0});
d.Hasher=g.extend({cfg:v.extend(),init:function(d){this.cfg=this.cfg.extend(d);this.reset()},reset:function(){g.reset.call(this);this._doReset()},update:function(d){this._append(d);this._process();return this},finalize:function(d){d&&this._append(d);return this._doFinalize()},blockSize:16,_createHelper:function(d){return function(e,h){return(new d.init(h)).finalize(e)}},_createHmacHelper:function(d){return function(e,h){return(new m.HMAC.init(d,h)).finalize(e)}}});var m=h.algo={};return h}(Math);
q.CryptoJS=Sb;var Bd=a.CryptoJS;(function(e){var k=Bd.lib,h=k.WordArray,d=k.Hasher,k=Bd.algo,v=[],l=[];(function(){function d(h){for(var k=e.sqrt(h),l=2;l<=k;l++)if(!(h%l))return!1;return!0}function h(d){return 4294967296*(d-(d|0))|0}for(var k=2,a=0;64>a;)d(k)&&(8>a&&(v[a]=h(e.pow(k,0.5))),l[a]=h(e.pow(k,1/3)),a++),k++})();var a=[],k=k.SHA256=d.extend({_doReset:function(){this._hash=new h.init(v.slice(0))},_doProcessBlock:function(d,e){for(var h=this._hash.words,k=h[0],v=h[1],b=h[2],c=h[3],f=h[4],
g=h[5],m=h[6],n=h[7],p=0;64>p;p++){if(16>p)a[p]=d[e+p]|0;else{var s=a[p-15],q=a[p-2];a[p]=((s<<25|s>>>7)^(s<<14|s>>>18)^s>>>3)+a[p-7]+((q<<15|q>>>17)^(q<<13|q>>>19)^q>>>10)+a[p-16]}s=n+((f<<26|f>>>6)^(f<<21|f>>>11)^(f<<7|f>>>25))+(f&g^~f&m)+l[p]+a[p];q=((k<<30|k>>>2)^(k<<19|k>>>13)^(k<<10|k>>>22))+(k&v^k&b^v&b);n=m;m=g;g=f;f=c+s|0;c=b;b=v;v=k;k=s+q|0}h[0]=h[0]+k|0;h[1]=h[1]+v|0;h[2]=h[2]+b|0;h[3]=h[3]+c|0;h[4]=h[4]+f|0;h[5]=h[5]+g|0;h[6]=h[6]+m|0;h[7]=h[7]+n|0},_doFinalize:function(){var d=this._data,
h=d.words,k=8*this._nDataBytes,l=8*d.sigBytes;h[l>>>5]|=128<<24-l%32;h[(l+64>>>9<<4)+14]=e.floor(k/4294967296);h[(l+64>>>9<<4)+15]=k;d.sigBytes=4*h.length;this._process();return this._hash},clone:function(){var e=d.clone.call(this);e._hash=this._hash.clone();return e}});Bd.SHA256=d._createHelper(k);Bd.HmacSHA256=d._createHmacHelper(k)})(Math);q.CryptoJS=Bd;(function(){var e=Sb,k=e.enc.Utf8;e.algo.HMAC=e.lib.Base.extend({init:function(e,d){e=this._hasher=new e.init;"string"==typeof d&&(d=k.parse(d));
var v=e.blockSize,l=4*v;d.sigBytes>l&&(d=e.finalize(d));d.clamp();for(var a=this._oKey=d.clone(),b=this._iKey=d.clone(),c=a.words,f=b.words,g=0;g<v;g++)c[g]^=1549556828,f[g]^=909522486;a.sigBytes=b.sigBytes=l;this.reset()},reset:function(){var e=this._hasher;e.reset();e.update(this._iKey)},update:function(e){this._hasher.update(e);return this},finalize:function(e){var d=this._hasher;e=d.finalize(e);d.reset();return d.finalize(this._oKey.clone().concat(e))}})})();var Qb="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",
wd="=";q.b64tohex=u;q.b64toBA=function(e){e=u(e);var k,h=[];for(k=0;2*k<e.length;++k)h[k]=parseInt(e.substring(2*k,2*k+2),16);return h};q.hex2b64=function(e){var k,h,d="";for(k=0;k+3<=e.length;k+=3)h=parseInt(e.substring(k,k+3),16),d+=Qb.charAt(h>>6)+Qb.charAt(h&63);k+1==e.length?(h=parseInt(e.substring(k,k+1),16),d+=Qb.charAt(h<<2)):k+2==e.length&&(h=parseInt(e.substring(k,k+2),16),d+=Qb.charAt(h>>2)+Qb.charAt((h&3)<<4));if(wd)for(;0<(d.length&3);)d+=wd;return d};J.prototype.init=function(e){var k,
h,d;for(k=0;256>k;++k)this.S[k]=k;for(k=h=0;256>k;++k)h=h+this.S[k]+e[k%e.length]&255,d=this.S[k],this.S[k]=this.S[h],this.S[h]=d;this.j=this.i=0};J.prototype.next=function(){var e;this.i=this.i+1&255;this.j=this.j+this.S[this.i]&255;e=this.S[this.i];this.S[this.i]=this.S[this.j];this.S[this.j]=e;return this.S[e+this.S[this.i]&255]};var xd=256,sc,vb,Ka;if(null==vb){vb=[];Ka=0;var Vc;if("Netscape"==navigator.appName&&"5">navigator.appVersion&&window.crypto){var cc=window.crypto.random(32);for(Vc=0;Vc<
cc.length;++Vc)vb[Ka++]=cc.charCodeAt(Vc)&255}for(;Ka<xd;)Vc=Math.floor(65536*Math.random()),vb[Ka++]=Vc>>>8,vb[Ka++]=Vc&255;Ka=0;S()}T.prototype.nextBytes=function(e){var k;for(k=0;k<e.length;++k){var h=e,d=k,v;if(null==sc){S();sc=new J;sc.init(vb);for(Ka=0;Ka<vb.length;++Ka)vb[Ka]=0;Ka=0}v=sc.next();h[d]=v}};var dc=a,Hb=20;A.prototype.doPublic=function(e){return e.modPowInt(this.e,this.n)};A.prototype.setPublic=function(e,k){this.isPublic=!0;"string"!==typeof e?(this.n=e,this.e=k):null!=e&&null!=
k&&0<e.length&&0<k.length?(this.n=V(e,16),this.e=parseInt(k,16)):alert("Invalid RSA public key")};A.prototype.encrypt=function(e){var k;k=this.n.bitLength()+7>>3;if(k<e.length+11)alert("Message too long for RSA"),k=null;else{for(var h=[],d=e.length-1;0<=d&&0<k;){var v=e.charCodeAt(d--);128>v?h[--k]=v:127<v&&2048>v?(h[--k]=v&63|128,h[--k]=v>>6|192):(h[--k]=v&63|128,h[--k]=v>>6&63|128,h[--k]=v>>12|224)}h[--k]=0;e=new T;for(d=[];2<k;){for(d[0]=0;0==d[0];)e.nextBytes(d);h[--k]=d[0]}h[--k]=2;h[--k]=0;
k=new z(h)}if(null==k)return null;k=this.doPublic(k);if(null==k)return null;k=k.toString(16);return 0==(k.length&1)?k:"0"+k};A.prototype.encryptOAEP=function(e,k){var h,d=this.n.bitLength()+7>>3;if(e.length+2*Hb+2>d)throw"Message too long for RSA";var v="";for(h=0;h<d-e.length-2*Hb-2;h+=1)v+="\x00";var l=rstr_sha1("")+v+"\u0001"+e,d=Array(Hb);(new T).nextBytes(d);var a=K(d,l.length,k||rstr_sha1),v=[];for(h=0;h<l.length;h+=1)v[h]=l.charCodeAt(h)^a.charCodeAt(h);l=K(v,d.length,rstr_sha1);a=[0];for(h=
0;h<d.length;h+=1)a[h+1]=d[h]^l.charCodeAt(h);h=new z(a.concat(v));if(null==h)return null;h=this.doPublic(h);if(null==h)return null;h=h.toString(16);return 0==(h.length&1)?h:"0"+h};A.prototype.type="RSA";q.RSAKey=A;var dc=a,z=dc.BigInteger?dc.BigInteger:dc,A=a.RSAKey,Hb=20;A.prototype.doPrivate=function(e){if(null==this.p||null==this.q)return e.modPow(this.d,this.n);var k=e.mod(this.p).modPow(this.dmp1,this.p);for(e=e.mod(this.q).modPow(this.dmq1,this.q);0>k.compareTo(e);)k=k.add(this.p);return k.subtract(e).multiply(this.coeff).mod(this.p).multiply(this.q).add(e)};
A.prototype.setPrivate=function(e,k,h){this.isPrivate=!0;"string"!==typeof e?(this.n=e,this.e=k,this.d=h):null!=e&&null!=k&&0<e.length&&0<k.length?(this.n=V(e,16),this.e=parseInt(k,16),this.d=V(h,16)):alert("Invalid RSA private key")};A.prototype.setPrivateEx=function(e,k,h,d,v,l,a,b){this.isPrivate=!0;if(null==e)throw"RSASetPrivateEx N == null";if(null==k)throw"RSASetPrivateEx E == null";if(0==e.length)throw"RSASetPrivateEx N.length == 0";if(0==k.length)throw"RSASetPrivateEx E.length == 0";null!=
e&&null!=k&&0<e.length&&0<k.length?(this.n=V(e,16),this.e=parseInt(k,16),this.d=V(h,16),this.p=V(d,16),this.q=V(v,16),this.dmp1=V(l,16),this.dmq1=V(a,16),this.coeff=V(b,16)):alert("Invalid RSA private key in RSASetPrivateEx")};A.prototype.generate=function(e,k){var h=new T,d=e>>1;this.e=parseInt(k,16);for(var v=new z(k,16);;){for(;this.p=new z(e-d,1,h),0!=this.p.subtract(z.ONE).gcd(v).compareTo(z.ONE)||!this.p.isProbablePrime(10););for(;this.q=new z(d,1,h),0!=this.q.subtract(z.ONE).gcd(v).compareTo(z.ONE)||
!this.q.isProbablePrime(10););if(0>=this.p.compareTo(this.q)){var l=this.p;this.p=this.q;this.q=l}var l=this.p.subtract(z.ONE),a=this.q.subtract(z.ONE),b=l.multiply(a);if(0==b.gcd(v).compareTo(z.ONE)){this.n=this.p.multiply(this.q);this.d=v.modInverse(b);this.dmp1=this.d.mod(l);this.dmq1=this.d.mod(a);this.coeff=this.q.modInverse(this.p);break}}this.isPrivate=!0};A.prototype.decrypt=function(e){e=V(e,16);e=this.doPrivate(e);if(null==e)return null;a:{var k=this.n.bitLength()+7>>3;e=e.toByteArray();
for(var h=0;h<e.length&&0==e[h];)++h;if(e.length-h!=k-1||2!=e[h])e=null;else{for(++h;0!=e[h];)if(++h>=e.length){e=null;break a}for(k="";++h<e.length;){var d=e[h]&255;128>d?k+=String.fromCharCode(d):191<d&&224>d?(k+=String.fromCharCode((d&31)<<6|e[h+1]&63),++h):(k+=String.fromCharCode((d&15)<<12|(e[h+1]&63)<<6|e[h+2]&63),h+=2)}e=k}}return e};A.prototype.decryptOAEP=function(e,k){var h=V(e,16),h=this.doPrivate(h);if(null==h)return null;for(var d=h,v=this.n.bitLength()+7>>3,d=d.toByteArray(),h=0;h<d.length;h+=
1)d[h]&=255;for(;d.length<v;)d.unshift(0);d=String.fromCharCode.apply(String,d);if(d.length<2*Hb+2)throw"Cipher too short";for(var l=d.substr(1,Hb),v=d.substr(Hb+1),a=Hd(v,Hb,k||rstr_sha1),b=[],h=0;h<l.length;h+=1)b[h]=l.charCodeAt(h)^a.charCodeAt(h);l=Hd(String.fromCharCode.apply(String,b),d.length-Hb,rstr_sha1);d=[];for(h=0;h<v.length;h+=1)d[h]=v.charCodeAt(h)^l.charCodeAt(h);d=String.fromCharCode.apply(String,d);if(d.substr(0,Hb)!==rstr_sha1(""))throw"Hash mismatch";d=d.substr(Hb);h=d.indexOf("\u0001");
if((-1!=h?d.substr(0,h).lastIndexOf("\x00"):-1)+1!=h)throw"Malformed data";return d.substr(h+1)};q.RSAKey=A;Sb=a.CryptoJS;dc=a;"undefined"!=typeof N&&N||(N={});"undefined"!=typeof N.crypto&&N.crypto||(N.crypto={});N.crypto.Util=new function(){this.DIGESTINFOHEAD={sha1:"3021300906052b0e03021a05000414",sha224:"302d300d06096086480165030402040500041c",sha256:"3031300d060960864801650304020105000420",sha384:"3041300d060960864801650304020205000430",sha512:"3051300d060960864801650304020305000440",md2:"3020300c06082a864886f70d020205000410",
md5:"3020300c06082a864886f70d020505000410",ripemd160:"3021300906052b2403020105000414"};this.DEFAULTPROVIDER={md5:"cryptojs",sha1:"cryptojs",sha224:"cryptojs",sha256:"cryptojs",sha384:"cryptojs",sha512:"cryptojs",ripemd160:"cryptojs",hmacmd5:"cryptojs",hmacsha1:"cryptojs",hmacsha224:"cryptojs",hmacsha256:"cryptojs",hmacsha384:"cryptojs",hmacsha512:"cryptojs",hmacripemd160:"cryptojs",MD5withRSA:"cryptojs/jsrsa",SHA1withRSA:"cryptojs/jsrsa",SHA224withRSA:"cryptojs/jsrsa",SHA256withRSA:"cryptojs/jsrsa",
SHA384withRSA:"cryptojs/jsrsa",SHA512withRSA:"cryptojs/jsrsa",RIPEMD160withRSA:"cryptojs/jsrsa",MD5withECDSA:"cryptojs/jsrsa",SHA1withECDSA:"cryptojs/jsrsa",SHA224withECDSA:"cryptojs/jsrsa",SHA256withECDSA:"cryptojs/jsrsa",SHA384withECDSA:"cryptojs/jsrsa",SHA512withECDSA:"cryptojs/jsrsa",RIPEMD160withECDSA:"cryptojs/jsrsa",SHA1withDSA:"cryptojs/jsrsa",SHA224withDSA:"cryptojs/jsrsa",SHA256withDSA:"cryptojs/jsrsa",MD5withRSAandMGF1:"cryptojs/jsrsa",SHA1withRSAandMGF1:"cryptojs/jsrsa",SHA224withRSAandMGF1:"cryptojs/jsrsa",
SHA256withRSAandMGF1:"cryptojs/jsrsa",SHA384withRSAandMGF1:"cryptojs/jsrsa",SHA512withRSAandMGF1:"cryptojs/jsrsa",RIPEMD160withRSAandMGF1:"cryptojs/jsrsa"};this.CRYPTOJSMESSAGEDIGESTNAME={md5:"CryptoJS.algo.MD5",sha1:"CryptoJS.algo.SHA1",sha224:"CryptoJS.algo.SHA224",sha256:"CryptoJS.algo.SHA256",sha384:"CryptoJS.algo.SHA384",sha512:"CryptoJS.algo.SHA512",ripemd160:"CryptoJS.algo.RIPEMD160"};this.getDigestInfoHex=function(e,k){if("undefined"==typeof this.DIGESTINFOHEAD[k])throw"alg not supported in Util.DIGESTINFOHEAD: "+
k;return this.DIGESTINFOHEAD[k]+e};this.getPaddedDigestInfoHex=function(e,k,h){var d=this.getDigestInfoHex(e,k);e=h/4;if(d.length+22>e)throw"key is too short for SigAlg: keylen="+h+","+k;k="00"+d;h="";e=e-4-k.length;for(d=0;d<e;d+=2)h+="ff";return"0001"+h+k};this.hashString=function(e,k){return(new N.crypto.MessageDigest({alg:k})).digestString(e)};this.hashHex=function(e,k){return(new N.crypto.MessageDigest({alg:k})).digestHex(e)};this.sha1=function(e){return(new N.crypto.MessageDigest({alg:"sha1",
prov:"cryptojs"})).digestString(e)};this.sha256=function(e){return(new N.crypto.MessageDigest({alg:"sha256",prov:"cryptojs"})).digestString(e)};this.sha256Hex=function(e){return(new N.crypto.MessageDigest({alg:"sha256",prov:"cryptojs"})).digestHex(e)};this.sha512=function(e){return(new N.crypto.MessageDigest({alg:"sha512",prov:"cryptojs"})).digestString(e)};this.sha512Hex=function(e){return(new N.crypto.MessageDigest({alg:"sha512",prov:"cryptojs"})).digestHex(e)};this.md5=function(e){return(new N.crypto.MessageDigest({alg:"md5",
prov:"cryptojs"})).digestString(e)};this.ripemd160=function(e){return(new N.crypto.MessageDigest({alg:"ripemd160",prov:"cryptojs"})).digestString(e)};this.getCryptoJSMDByName=function(e){}};N.crypto.MessageDigest=function(e){this.setAlgAndProvider=function(e,h){null!=e&&void 0===h&&(h=N.crypto.Util.DEFAULTPROVIDER[e]);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(e)&&"cryptojs"==h){try{this.md=eval(N.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[e]).create()}catch(d){throw"setAlgAndProvider hash alg set fail alg="+
e+"/"+d;}this.updateString=function(d){this.md.update(d)};this.updateHex=function(d){d=Sb.enc.Hex.parse(d);this.md.update(d)};this.digest=function(){return this.md.finalize().toString(Sb.enc.Hex)};this.digestString=function(d){this.updateString(d);return this.digest()};this.digestHex=function(d){this.updateHex(d);return this.digest()}}if(-1!=":sha256:".indexOf(e)&&"sjcl"==h){try{this.md=new sjcl.hash.sha256}catch(v){throw"setAlgAndProvider hash alg set fail alg="+e+"/"+v;}this.updateString=function(d){this.md.update(d)};
this.updateHex=function(d){d=sjcl.codec.hex.toBits(d);this.md.update(d)};this.digest=function(){var d=this.md.finalize();return sjcl.codec.hex.fromBits(d)};this.digestString=function(d){this.updateString(d);return this.digest()};this.digestHex=function(d){this.updateHex(d);return this.digest()}}};this.updateString=function(e){throw"updateString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName;};this.updateHex=function(e){throw"updateHex(hex) not supported for this alg/prov: "+
this.algName+"/"+this.provName;};this.digest=function(){throw"digest() not supported for this alg/prov: "+this.algName+"/"+this.provName;};this.digestString=function(e){throw"digestString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName;};this.digestHex=function(e){throw"digestHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName;};void 0!==e&&void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov&&(this.provName=N.crypto.Util.DEFAULTPROVIDER[this.algName]),
this.setAlgAndProvider(this.algName,this.provName))};N.crypto.Mac=function(e){this.setAlgAndProvider=function(e,h){e=e.toLowerCase();null==e&&(e="hmacsha1");e=e.toLowerCase();if("hmac"!=e.substr(0,4))throw"setAlgAndProvider unsupported HMAC alg: "+e;void 0===h&&(h=N.crypto.Util.DEFAULTPROVIDER[e]);this.algProv=e+"/"+h;var d=e.substr(4);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(d)&&"cryptojs"==h){try{var v=eval(N.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[d]);this.mac=Sb.algo.HMAC.create(v,
this.pass)}catch(l){throw"setAlgAndProvider hash alg set fail hashAlg="+d+"/"+l;}this.updateString=function(d){this.mac.update(d)};this.updateHex=function(d){d=Sb.enc.Hex.parse(d);this.mac.update(d)};this.doFinal=function(){return this.mac.finalize().toString(Sb.enc.Hex)};this.doFinalString=function(d){this.updateString(d);return this.doFinal()};this.doFinalHex=function(d){this.updateHex(d);return this.doFinal()}}};this.updateString=function(e){throw"updateString(str) not supported for this alg/prov: "+
this.algProv;};this.updateHex=function(e){throw"updateHex(hex) not supported for this alg/prov: "+this.algProv;};this.doFinal=function(){throw"digest() not supported for this alg/prov: "+this.algProv;};this.doFinalString=function(e){throw"digestString(str) not supported for this alg/prov: "+this.algProv;};this.doFinalHex=function(e){throw"digestHex(hex) not supported for this alg/prov: "+this.algProv;};this.setPassword=function(e){if("string"==typeof e){var h=e;1!=e.length%2&&e.match(/^[0-9A-Fa-f]+$/)||
(h=rstrtohex(e))}else{if("object"!=typeof e)throw"KJUR.crypto.Mac unsupported password type: "+e;h=null;if(void 0!==e.hex){if(0!=e.hex.length%2||!e.hex.match(/^[0-9A-Fa-f]+$/))throw"Mac: wrong hex password: "+e.hex;h=e.hex}void 0!==e.utf8&&(h=utf8tohex(e.utf8));void 0!==e.rstr&&(h=rstrtohex(e.rstr));void 0!==e.b64&&(h=u(e.b64));void 0!==e.b64u&&(h=b64utohex(e.b64u));if(null==h)throw"KJUR.crypto.Mac unsupported password type: "+e;}this.pass=Sb.enc.Hex.parse(h)};void 0!==e&&(void 0!==e.pass&&this.setPassword(e.pass),
void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov&&(this.provName=N.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName)))};N.crypto.Signature=function(e){var k=null;this._setAlgNames=function(){this.algName.match(/^(.+)with(.+)$/)&&(this.mdAlgName=RegExp.$1.toLowerCase(),this.pubkeyAlgName=RegExp.$2.toLowerCase())};this._zeroPaddingOfSignature=function(d,e){for(var h="",k=e/4-d.length,a=0;a<k;a++)h+="0";return h+d};this.setAlgAndProvider=function(d,e){this._setAlgNames();
if("cryptojs/jsrsa"!=e)throw"provider not supported: "+e;if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(this.mdAlgName)){try{this.md=new N.crypto.MessageDigest({alg:this.mdAlgName})}catch(h){throw"setAlgAndProvider hash alg set fail alg="+this.mdAlgName+"/"+h;}this.init=function(d,e){var h=null;try{h=void 0===e?KEYUTIL.getKey(d):KEYUTIL.getKey(d,e)}catch(k){throw"init failed:"+k;}if(!0===h.isPrivate)this.prvKey=h,this.state="SIGN";else if(!0===h.isPublic)this.pubKey=h,this.state=
"VERIFY";else throw"init failed.:"+h;};this.initSign=function(d){"string"==typeof d.ecprvhex&&"string"==typeof d.eccurvename?(this.ecprvhex=d.ecprvhex,this.eccurvename=d.eccurvename):this.prvKey=d;this.state="SIGN"};this.initVerifyByPublicKey=function(d){"string"==typeof d.ecpubhex&&"string"==typeof d.eccurvename?(this.ecpubhex=d.ecpubhex,this.eccurvename=d.eccurvename):d instanceof N.crypto.ECDSA?this.pubKey=d:d instanceof A&&(this.pubKey=d);this.state="VERIFY"};this.initVerifyByCertificatePEM=function(d){var e=
new da;e.readCertPEM(d);this.pubKey=e.subjectPublicKeyRSA;this.state="VERIFY"};this.updateString=function(d){this.md.updateString(d)};this.updateHex=function(d){this.md.updateHex(d)};this.sign=function(){this.sHashHex=this.md.digest();if("undefined"!=typeof this.ecprvhex&&"undefined"!=typeof this.eccurvename)this.hSign=(new N.crypto.ECDSA({curve:this.eccurvename})).signHex(this.sHashHex,this.ecprvhex);else if(this.prvKey instanceof A&&"rsaandmgf1"==this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHashPSS(this.sHashHex,
this.mdAlgName,this.pssSaltLen);else if(this.prvKey instanceof A&&"rsa"==this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex,this.mdAlgName);else if(this.prvKey instanceof N.crypto.ECDSA)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex);else if(this.prvKey instanceof N.crypto.DSA)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex);else throw"Signature: unsupported public key alg: "+this.pubkeyAlgName;return this.hSign};this.signString=function(d){this.updateString(d);
return this.sign()};this.signHex=function(d){this.updateHex(d);return this.sign()};this.verify=function(d){this.sHashHex=this.md.digest();if("undefined"!=typeof this.ecpubhex&&"undefined"!=typeof this.eccurvename)return(new N.crypto.ECDSA({curve:this.eccurvename})).verifyHex(this.sHashHex,d,this.ecpubhex);if(this.pubKey instanceof A&&"rsaandmgf1"==this.pubkeyAlgName)return this.pubKey.verifyWithMessageHashPSS(this.sHashHex,d,this.mdAlgName,this.pssSaltLen);if(this.pubKey instanceof A&&"rsa"==this.pubkeyAlgName||
this.pubKey instanceof N.crypto.ECDSA||this.pubKey instanceof N.crypto.DSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,d);throw"Signature: unsupported public key alg: "+this.pubkeyAlgName;}}};this.init=function(d,e){throw"init(key, pass) not supported for this alg:prov="+this.algProvName;};this.initVerifyByPublicKey=function(d){throw"initVerifyByPublicKey(rsaPubKeyy) not supported for this alg:prov="+this.algProvName;};this.initVerifyByCertificatePEM=function(d){throw"initVerifyByCertificatePEM(certPEM) not supported for this alg:prov="+
this.algProvName;};this.initSign=function(d){throw"initSign(prvKey) not supported for this alg:prov="+this.algProvName;};this.updateString=function(d){throw"updateString(str) not supported for this alg:prov="+this.algProvName;};this.updateHex=function(d){throw"updateHex(hex) not supported for this alg:prov="+this.algProvName;};this.sign=function(){throw"sign() not supported for this alg:prov="+this.algProvName;};this.signString=function(d){throw"digestString(str) not supported for this alg:prov="+
this.algProvName;};this.signHex=function(d){throw"digestHex(hex) not supported for this alg:prov="+this.algProvName;};this.verify=function(d){throw"verify(hSigVal) not supported for this alg:prov="+this.algProvName;};this.initParams=e;if(void 0!==e&&(void 0!==e.alg&&(this.algName=e.alg,this.provName=void 0===e.prov?N.crypto.Util.DEFAULTPROVIDER[this.algName]:e.prov,this.algProvName=this.algName+":"+this.provName,this.setAlgAndProvider(this.algName,this.provName),this._setAlgNames()),void 0!==e.psssaltlen&&
(this.pssSaltLen=e.psssaltlen),void 0!==e.prvkeypem)){if(void 0!==e.prvkeypas)throw"both prvkeypem and prvkeypas parameters not supported";try{k=new A,k.readPrivateKeyFromPEMString(e.prvkeypem),this.initSign(k)}catch(h){throw"fatal error to load pem private key: "+h;}}};N.crypto.OID=new function(){this.oidhex2name={"2a864886f70d010101":"rsaEncryption","2a8648ce3d0201":"ecPublicKey","2a8648ce380401":"dsa","2a8648ce3d030107":"secp256r1","2b8104001f":"secp192k1","2b81040021":"secp224r1","2b8104000a":"secp256k1",
"2b81040023":"secp521r1","2b81040022":"secp384r1","2a8648ce380403":"SHA1withDSA","608648016503040301":"SHA224withDSA","608648016503040302":"SHA256withDSA"}};q.KJUR=N;var E=a.ASN1HEX,u=a.b64tohex,A=a.RSAKey;A.prototype.readPrivateKeyFromPEMString=function(e){e=e.replace("-----BEGIN RSA PRIVATE KEY-----","");e=e.replace("-----END RSA PRIVATE KEY-----","");e=e.replace(/[ \n]+/g,"");e=u(e);e=jd(e);this.setPrivateEx(e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])};A.prototype.readPrivateKeyFromASN1HexString=
function(e){e=jd(e);this.setPrivateEx(e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])};q.RSAKey=A;var dc=a,z=dc.BigInteger?dc.BigInteger:dc,A=a.RSAKey,Jd=RegExp("");Jd.compile("[^0-9a-f]","gi");A.prototype.signWithMessageHash=function(e,k){var h=N.crypto.Util.getPaddedDigestInfoHex(e,k,this.n.bitLength()),h=V(h,16),h=this.doPrivate(h).toString(16);return Ab(h,this.n.bitLength())};A.prototype.signString=Id;A.prototype.signStringWithSHA1=he;A.prototype.signStringWithSHA256=ie;A.prototype.sign=Id;A.prototype.signWithSHA1=
he;A.prototype.signWithSHA256=ie;A.prototype.signWithMessageHashPSS=function(e,k,h){var d=hextorstr(e);e=d.length;var v=this.n.bitLength()-1,l=Math.ceil(v/8),a=function(d){return N.crypto.Util.hashHex(d,k)};if(-1===h||void 0===h)h=e;else if(-2===h)h=l-e-2;else if(-2>h)throw"invalid salt length";if(l<e+h+2)throw"data too long";var b="";0<h&&(b=Array(h),(new T).nextBytes(b),b=String.fromCharCode.apply(String,b));for(var c=hextorstr(a(rstrtohex("\x00\x00\x00\x00\x00\x00\x00\x00"+d+b))),f=[],d=0;d<l-
h-e-2;d+=1)f[d]=0;h=String.fromCharCode.apply(String,f)+"\u0001"+b;a=je(c,h.length,a);b=[];for(d=0;d<h.length;d+=1)b[d]=h.charCodeAt(d)^a.charCodeAt(d);b[0]&=~(65280>>8*l-v&255);for(d=0;d<e;d++)b.push(c.charCodeAt(d));b.push(188);return Ab(this.doPrivate(new z(b)).toString(16),this.n.bitLength())};A.prototype.signStringPSS=ke;A.prototype.signPSS=ke;A.SALT_LEN_HLEN=-1;A.SALT_LEN_MAX=-2;A.prototype.verifyWithMessageHash=function(e,k){k=k.replace(Jd,"");k=k.replace(/[ \n]+/g,"");var h=V(k,16);if(h.bitLength()>
this.n.bitLength())return 0;h=this.doPublic(h).toString(16).replace(/^1f+00/,"");h=Sd(h);return 0==h.length?!1:h[1]==e};A.prototype.verifyString=yd;A.prototype.verifyHexSignatureForMessage=ld;A.prototype.verify=yd;A.prototype.verifyHexSignatureForByteArrayMessage=ld;A.prototype.verifyWithMessageHashPSS=function(e,k,h,d){var v=new z(k,16);if(v.bitLength()>this.n.bitLength())return!1;k=function(d){return N.crypto.Util.hashHex(d,h)};e=hextorstr(e);var l=e.length,a=this.n.bitLength()-1,b=Math.ceil(a/
8);if(-1===d||void 0===d)d=l;else if(-2===d)d=b-l-2;else if(-2>d)throw"invalid salt length";if(b<l+d+2)throw"data too long";for(var c=this.doPublic(v).toByteArray(),v=0;v<c.length;v+=1)c[v]&=255;for(;c.length<b;)c.unshift(0);if(188!==c[b-1])throw"encoded message does not end in 0xbc";var c=String.fromCharCode.apply(String,c),f=c.substr(0,b-l-1),c=c.substr(f.length,l),g=65280>>8*b-a&255;if(0!==(f.charCodeAt(0)&g))throw"bits beyond keysize not zero";for(var m=je(c,f.length,k),a=[],v=0;v<f.length;v+=
1)a[v]=f.charCodeAt(v)^m.charCodeAt(v);a[0]&=~g;l=b-l-d-2;for(v=0;v<l;v+=1)if(0!==a[v])throw"leftmost octets not zero";if(1!==a[l])throw"0x01 marker not found";return c===hextorstr(k(rstrtohex("\x00\x00\x00\x00\x00\x00\x00\x00"+e+String.fromCharCode.apply(String,a.slice(-d)))))};A.prototype.verifyStringPSS=Td;A.prototype.verifyPSS=Td;A.SALT_LEN_RECOVER=-2;q.RSAKey=A;"undefined"!=typeof N&&N||(N={});"undefined"!=typeof N.crypto&&N.crypto||(N.crypto={});N.crypto.ECDSA=function(e){var k=new T;this.type=
"EC";this.getBigRandom=function(e){return(new z(e.bitLength(),k)).mod(e.subtract(z.ONE)).add(z.ONE)};this.setNamedCurve=function(e){this.ecparams=N.crypto.ECParameterDB.getByName(e);this.pubKeyHex=this.prvKeyHex=null;this.curveName=e};this.setPrivateKeyHex=function(e){this.isPrivate=!0;this.prvKeyHex=e};this.setPublicKeyHex=function(e){this.isPublic=!0;this.pubKeyHex=e};this.generateKeyPairHex=function(){var e=this.getBigRandom(this.ecparams.n),d=this.ecparams.G.multiply(e),k=d.getX().toBigInteger(),
d=d.getY().toBigInteger(),l=this.ecparams.keylen/4,e=("0000000000"+e.toString(16)).slice(-l),k=("0000000000"+k.toString(16)).slice(-l),d=("0000000000"+d.toString(16)).slice(-l),k="04"+k+d;this.setPrivateKeyHex(e);this.setPublicKeyHex(k);return{ecprvhex:e,ecpubhex:k}};this.signWithMessageHash=function(e){return this.signHex(e,this.prvKeyHex)};this.signHex=function(e,d){var k=new z(d,16),l=this.ecparams.n,a=new z(e,16);do var b=this.getBigRandom(l),c=this.ecparams.G.multiply(b).getX().toBigInteger().mod(l);
while(0>=c.compareTo(z.ZERO));k=b.modInverse(l).multiply(a.add(k.multiply(c))).mod(l);return N.crypto.ECDSA.biRSSigToASN1Sig(c,k)};this.sign=function(e,d){var k=this.ecparams.n,l=z.fromByteArrayUnsigned(e);do var a=this.getBigRandom(k),b=this.ecparams.G.multiply(a).getX().toBigInteger().mod(k);while(0>=b.compareTo(z.ZERO));k=a.modInverse(k).multiply(l.add(d.multiply(b))).mod(k);return this.serializeSig(b,k)};this.verifyWithMessageHash=function(e,d){return this.verifyHex(e,d,this.pubKeyHex)};this.verifyHex=
function(e,d,k){var l;l=N.crypto.ECDSA.parseSigHex(d);d=l.r;l=l.s;k=ECPointFp.decodeFromHex(this.ecparams.curve,k);e=new z(e,16);return this.verifyRaw(e,d,l,k)};this.verify=function(e,d,k){var l;if(Bitcoin.Util.isArray(d))d=this.parseSig(d),l=d.r,d=d.s;else if("object"===typeof d&&d.r&&d.s)l=d.r,d=d.s;else throw"Invalid value for signature";if(!(k instanceof ECPointFp))if(Bitcoin.Util.isArray(k))k=ECPointFp.decodeFrom(this.ecparams.curve,k);else throw"Invalid format for pubkey value, must be byte array or ECPointFp";
e=z.fromByteArrayUnsigned(e);return this.verifyRaw(e,l,d,k)};this.verifyRaw=function(e,d,k,l){var a=this.ecparams.n,b=this.ecparams.G;if(0>d.compareTo(z.ONE)||0<=d.compareTo(a)||0>k.compareTo(z.ONE)||0<=k.compareTo(a))return!1;k=k.modInverse(a);e=e.multiply(k).mod(a);k=d.multiply(k).mod(a);return b.multiply(e).add(l.multiply(k)).getX().toBigInteger().mod(a).equals(d)};this.serializeSig=function(e,d){var k=e.toByteArraySigned(),l=d.toByteArraySigned(),a=[];a.push(2);a.push(k.length);a=a.concat(k);
a.push(2);a.push(l.length);a=a.concat(l);a.unshift(a.length);a.unshift(48);return a};this.parseSig=function(e){var d;if(48!=e[0])throw Error("Signature not a valid DERSequence");d=2;if(2!=e[d])throw Error("First element in signature must be a DERInteger");var k=e.slice(d+2,d+2+e[d+1]);d+=2+e[d+1];if(2!=e[d])throw Error("Second element in signature must be a DERInteger");e=e.slice(d+2,d+2+e[d+1]);k=z.fromByteArrayUnsigned(k);e=z.fromByteArrayUnsigned(e);return{r:k,s:e}};this.parseSigCompact=function(e){if(65!==
e.length)throw"Signature has the wrong length";var d=e[0]-27;if(0>d||7<d)throw"Invalid signature type";var k=this.ecparams.n,l=z.fromByteArrayUnsigned(e.slice(1,33)).mod(k);e=z.fromByteArrayUnsigned(e.slice(33,65)).mod(k);return{r:l,s:e,i:d}};void 0!==e&&void 0!==e.curve&&(this.curveName=e.curve);void 0===this.curveName&&(this.curveName="secp256r1");this.setNamedCurve(this.curveName);void 0!==e&&(void 0!==e.prv&&this.setPrivateKeyHex(e.prv),void 0!==e.pub&&this.setPublicKeyHex(e.pub))};N.crypto.ECDSA.parseSigHex=
function(e){var k=N.crypto.ECDSA.parseSigHexInHexRS(e);e=new z(k.r,16);k=new z(k.s,16);return{r:e,s:k}};N.crypto.ECDSA.parseSigHexInHexRS=function(e){if("30"!=e.substr(0,2))throw"signature is not a ASN.1 sequence";var k=E.getPosArrayOfChildren_AtObj(e,0);if(2!=k.length)throw"number of signature ASN.1 sequence elements seem wrong";var h=k[0],k=k[1];if("02"!=e.substr(h,2))throw"1st item of sequene of signature is not ASN.1 integer";if("02"!=e.substr(k,2))throw"2nd item of sequene of signature is not ASN.1 integer";
h=E.getHexOfV_AtObj(e,h);e=E.getHexOfV_AtObj(e,k);return{r:h,s:e}};N.crypto.ECDSA.asn1SigToConcatSig=function(e){var k=N.crypto.ECDSA.parseSigHexInHexRS(e);e=k.r;k=k.s;"00"==e.substr(0,2)&&8==e.length/2*8%128&&(e=e.substr(2));"00"==k.substr(0,2)&&8==k.length/2*8%128&&(k=k.substr(2));if(0!=e.length/2*8%128)throw"unknown ECDSA sig r length error";if(0!=k.length/2*8%128)throw"unknown ECDSA sig s length error";return e+k};N.crypto.ECDSA.concatSigToASN1Sig=function(e){if(0!=e.length/2*8%128)throw"unknown ECDSA concatinated r-s sig  length error";
var k=e.substr(0,e.length/2);e=e.substr(e.length/2);return N.crypto.ECDSA.hexRSSigToASN1Sig(k,e)};N.crypto.ECDSA.hexRSSigToASN1Sig=function(e,k){var h=new z(e,16),d=new z(k,16);return N.crypto.ECDSA.biRSSigToASN1Sig(h,d)};N.crypto.ECDSA.biRSSigToASN1Sig=function(e,k){var h=new N.asn1.DERInteger({bigint:e}),d=new N.asn1.DERInteger({bigint:k});return(new N.asn1.DERSequence({array:[h,d]})).getEncodedHex()};dc=a;E=new function(){this.getByteLengthOfL_AtObj=function(e,k){if("8"!=e.substring(k+2,k+3))return 1;
var h=parseInt(e.substring(k+3,k+4));return 0==h?-1:0<h&&10>h?h+1:-2};this.getHexOfL_AtObj=function(e,k){var h=this.getByteLengthOfL_AtObj(e,k);return 1>h?"":e.substring(k+2,k+2+2*h)};this.getIntOfL_AtObj=function(e,k){var h=this.getHexOfL_AtObj(e,k);return""==h?-1:(8>parseInt(h.substring(0,1))?new z(h,16):new z(h.substring(2),16)).intValue()};this.getStartPosOfV_AtObj=function(e,k){var h=this.getByteLengthOfL_AtObj(e,k);return 0>h?h:k+2*(h+1)};this.getHexOfV_AtObj=function(e,k){var h=this.getStartPosOfV_AtObj(e,
k),d=this.getIntOfL_AtObj(e,k);return e.substring(h,h+2*d)};this.getHexOfTLV_AtObj=function(e,k){var h=e.substr(k,2),d=this.getHexOfL_AtObj(e,k),v=this.getHexOfV_AtObj(e,k);return h+d+v};this.getPosOfNextSibling_AtObj=function(e,k){var h=this.getStartPosOfV_AtObj(e,k),d=this.getIntOfL_AtObj(e,k);return h+2*d};this.getPosArrayOfChildren_AtObj=function(e,k){var h=[],d=this.getStartPosOfV_AtObj(e,k);h.push(d);for(var v=this.getIntOfL_AtObj(e,k),l=d,a=0;;){l=this.getPosOfNextSibling_AtObj(e,l);if(null==
l||l-d>=2*v)break;if(200<=a)break;h.push(l);a++}return h};this.getNthChildIndex_AtObj=function(e,k,h){return this.getPosArrayOfChildren_AtObj(e,k)[h]};this.getDecendantIndexByNthList=function(e,k,h){if(0==h.length)return k;var d=h.shift();k=this.getPosArrayOfChildren_AtObj(e,k);return this.getDecendantIndexByNthList(e,k[d],h)};this.getDecendantHexTLVByNthList=function(e,k,h){k=this.getDecendantIndexByNthList(e,k,h);return this.getHexOfTLV_AtObj(e,k)};this.getDecendantHexVByNthList=function(e,k,h){k=
this.getDecendantIndexByNthList(e,k,h);return this.getHexOfV_AtObj(e,k)}};E.getVbyList=function(e,k,h,d){k=this.getDecendantIndexByNthList(e,k,h);if(void 0===k)throw"can't find nthList object";if(void 0!==d&&e.substr(k,2)!=d)throw"checking tag doesn't match: "+e.substr(k,2)+"!="+d;return this.getHexOfV_AtObj(e,k)};E.hextooidstr=function(e){var k=function(d,e){return d.length>=e?d:Array(e-d.length+1).join("0")+d},h=[],d=e.substr(0,2),d=parseInt(d,16);h[0]=new String(Math.floor(d/40));h[1]=new String(d%
40);var v=e.substr(2);e=[];for(d=0;d<v.length/2;d++)e.push(parseInt(v.substr(2*d,2),16));for(var v=[],l="",d=0;d<e.length;d++)e[d]&128?l+=k((e[d]&127).toString(2),7):(l+=k((e[d]&127).toString(2),7),v.push(new String(parseInt(l,2))),l="");k=h.join(".");0<v.length&&(k=k+"."+v.join("."));return k};E.dump=function(e,k,h,d){var v=function(d,e){return d.length<=2*e?d:d.substr(0,e)+"..(total "+d.length/2+"bytes).."+d.substr(d.length-e,e)};void 0===k&&(k={ommit_long_octet:32});void 0===h&&(h=0);void 0===
d&&(d="");var l=k.ommit_long_octet;if("01"==e.substr(h,2))return e=E.getHexOfV_AtObj(e,h),"00"==e?d+"BOOLEAN FALSE\n":d+"BOOLEAN TRUE\n";if("02"==e.substr(h,2))return e=E.getHexOfV_AtObj(e,h),d+"INTEGER "+v(e,l)+"\n";if("03"==e.substr(h,2))return e=E.getHexOfV_AtObj(e,h),d+"BITSTRING "+v(e,l)+"\n";if("04"==e.substr(h,2))return e=E.getHexOfV_AtObj(e,h),E.isASN1HEX(e)?v=d+"OCTETSTRING, encapsulates\n"+E.dump(e,k,0,d+"  "):d+"OCTETSTRING "+v(e,l)+"\n";if("05"==e.substr(h,2))return d+"NULL\n";if("06"==
e.substr(h,2)){e=E.getHexOfV_AtObj(e,h);var a=N.asn1.ASN1Util.oidHexToInt(e),l=N.asn1.x509.OID.oid2name(a);e=a.replace(/\./g," ");return""!=l?d+"ObjectIdentifier "+l+" ("+e+")\n":d+"ObjectIdentifier ("+e+")\n"}if("0c"==e.substr(h,2))return d+"UTF8String '"+hextoutf8(E.getHexOfV_AtObj(e,h))+"'\n";if("13"==e.substr(h,2))return d+"PrintableString '"+hextoutf8(E.getHexOfV_AtObj(e,h))+"'\n";if("14"==e.substr(h,2))return d+"TeletexString '"+hextoutf8(E.getHexOfV_AtObj(e,h))+"'\n";if("16"==e.substr(h,2))return d+
"IA5String '"+hextoutf8(E.getHexOfV_AtObj(e,h))+"'\n";if("17"==e.substr(h,2))return d+"UTCTime "+hextoutf8(E.getHexOfV_AtObj(e,h))+"\n";if("18"==e.substr(h,2))return d+"GeneralizedTime "+hextoutf8(E.getHexOfV_AtObj(e,h))+"\n";if("30"==e.substr(h,2)){if("3000"==e.substr(h,4))return d+"SEQUENCE {}\n";v=d+"SEQUENCE\n";h=E.getPosArrayOfChildren_AtObj(e,h);l=k;2!=h.length&&3!=h.length||"06"!=e.substr(h[0],2)||"04"!=e.substr(h[h.length-1],2)||(l=E.getHexOfV_AtObj(e,h[0]),a=N.asn1.ASN1Util.oidHexToInt(l),
l=N.asn1.x509.OID.oid2name(a),k=JSON.parse(JSON.stringify(k)),k.x509ExtName=l,l=k);for(a=0;a<h.length;a++)v+=E.dump(e,l,h[a],d+"  ");return v}if("31"==e.substr(h,2)){v=d+"SET\n";h=E.getPosArrayOfChildren_AtObj(e,h);for(a=0;a<h.length;a++)v+=E.dump(e,k,h[a],d+"  ");return v}l=parseInt(e.substr(h,2),16);if(0!=(l&128)){v=l&31;if(0!=(l&32))for(v=d+"["+v+"]\n",h=E.getPosArrayOfChildren_AtObj(e,h),a=0;a<h.length;a++)v+=E.dump(e,k,h[a],d+"  ");else e=E.getHexOfV_AtObj(e,h),"68747470"==e.substr(0,8)&&(e=
hextoutf8(e)),"subjectAltName"===k.x509ExtName&&2==v&&(e=hextoutf8(e)),v=d+"["+v+"] "+e+"\n";return v}return d+"UNKNOWN("+e.substr(h,2)+") "+E.getHexOfV_AtObj(e,h)+"\n"};E.isASN1HEX=function(e){if(1==e.length%2)return!1;var k=E.getIntOfL_AtObj(e,0),h=e.substr(0,2),d=E.getHexOfL_AtObj(e,0);return e.length-h.length-d.length==2*k?!0:!1};q.ASN1HEX=E;u=a.b64tohex;A=a.RSAKey;E=a.ASN1HEX;da.pemToBase64=function(e){e=e.replace("-----BEGIN CERTIFICATE-----","");e=e.replace("-----END CERTIFICATE-----","");
return e=e.replace(/[ \n]+/g,"")};da.pemToHex=function(e){e=da.pemToBase64(e);return u(e)};da.getSubjectPublicKeyPosFromCertHex=function(e){var k=da.getSubjectPublicKeyInfoPosFromCertHex(e);if(-1==k)return-1;k=E.getPosArrayOfChildren_AtObj(e,k);if(2!=k.length)return-1;k=k[1];if("03"!=e.substring(k,k+2))return-1;k=E.getStartPosOfV_AtObj(e,k);return"00"!=e.substring(k,k+2)?-1:k+2};da.getSubjectPublicKeyInfoPosFromCertHex=function(e){var k=E.getStartPosOfV_AtObj(e,0),k=E.getPosArrayOfChildren_AtObj(e,
k);return 1>k.length?-1:"a003020102"==e.substring(k[0],k[0]+10)?6>k.length?-1:k[6]:5>k.length?-1:k[5]};da.getPublicKeyHexArrayFromCertHex=function(e){var k=da.getSubjectPublicKeyPosFromCertHex(e),h=E.getPosArrayOfChildren_AtObj(e,k);if(2!=h.length)return[];k=E.getHexOfV_AtObj(e,h[0]);e=E.getHexOfV_AtObj(e,h[1]);return null!=k&&null!=e?[k,e]:[]};da.getHexTbsCertificateFromCert=function(e){return E.getStartPosOfV_AtObj(e,0)};da.getPublicKeyHexArrayFromCertPEM=function(e){e=da.pemToHex(e);return da.getPublicKeyHexArrayFromCertHex(e)};
da.hex2dn=function(e){for(var k="",h=E.getPosArrayOfChildren_AtObj(e,0),d=0;d<h.length;d++)var v=E.getHexOfTLV_AtObj(e,h[d]),k=k+"/"+da.hex2rdn(v);return k};da.hex2rdn=function(e){var k=E.getDecendantHexTLVByNthList(e,0,[0,0]),h=E.getDecendantHexVByNthList(e,0,[0,1]);e="";try{e=da.DN_ATTRHEX[k]}catch(d){e=k}h=h.replace(/(..)/g,"%$1");k=decodeURIComponent(h);return e+"="+k};da.DN_ATTRHEX={"0603550406":"C","060355040a":"O","060355040b":"OU","0603550403":"CN","0603550405":"SN","0603550408":"ST","0603550407":"L"};
da.getPublicKeyFromCertPEM=function(e){var k=da.getPublicKeyInfoPropOfCertPEM(e);if("2a864886f70d010101"==k.algoid){var h=KEYUTIL.parsePublicRawRSAKeyHex(k.keyhex);e=new A;e.setPublic(h.n,h.e);return e}if("2a8648ce3d0201"==k.algoid)return e=new N.crypto.ECDSA({curve:N.crypto.OID.oidhex2name[k.algparam],info:k.keyhex}),e.setPublicKeyHex(k.keyhex),e;if("2a8648ce380401"==k.algoid){var h=E.getVbyList(k.algparam,0,[0],"02"),d=E.getVbyList(k.algparam,0,[1],"02"),v=E.getVbyList(k.algparam,0,[2],"02"),k=
E.getHexOfV_AtObj(k.keyhex,0),k=k.substr(2);e=new N.crypto.DSA;e.setPublic(new z(h,16),new z(d,16),new z(v,16),new z(k,16));return e}throw"unsupported key";};da.getPublicKeyInfoPropOfCertPEM=function(e){var k={algparam:null};e=da.pemToHex(e);var h=E.getPosArrayOfChildren_AtObj(e,0);if(3!=h.length)throw"malformed X.509 certificate PEM (code:001)";if("30"!=e.substr(h[0],2))throw"malformed X.509 certificate PEM (code:002)";h=E.getPosArrayOfChildren_AtObj(e,h[0]);if(7>h.length)throw"malformed X.509 certificate PEM (code:003)";
h=E.getPosArrayOfChildren_AtObj(e,h[6]);if(2!=h.length)throw"malformed X.509 certificate PEM (code:004)";var d=E.getPosArrayOfChildren_AtObj(e,h[0]);if(2!=d.length)throw"malformed X.509 certificate PEM (code:005)";k.algoid=E.getHexOfV_AtObj(e,d[0]);"06"==e.substr(d[1],2)?k.algparam=E.getHexOfV_AtObj(e,d[1]):"30"==e.substr(d[1],2)&&(k.algparam=E.getHexOfTLV_AtObj(e,d[1]));if("03"!=e.substr(h[1],2))throw"malformed X.509 certificate PEM (code:006)";e=E.getHexOfV_AtObj(e,h[1]);k.keyhex=e.substr(2);return k};
da.getPublicKeyInfoPosOfCertHEX=function(e){var k=E.getPosArrayOfChildren_AtObj(e,0);if(3!=k.length)throw"malformed X.509 certificate PEM (code:001)";if("30"!=e.substr(k[0],2))throw"malformed X.509 certificate PEM (code:002)";e=E.getPosArrayOfChildren_AtObj(e,k[0]);if(7>e.length)throw"malformed X.509 certificate PEM (code:003)";return e[6]};da.getV3ExtInfoListOfCertHex=function(e){var k=E.getPosArrayOfChildren_AtObj(e,0);if(3!=k.length)throw"malformed X.509 certificate PEM (code:001)";if("30"!=e.substr(k[0],
2))throw"malformed X.509 certificate PEM (code:002)";k=E.getPosArrayOfChildren_AtObj(e,k[0]);if(8>k.length)throw"malformed X.509 certificate PEM (code:003)";if("a3"!=e.substr(k[7],2))throw"malformed X.509 certificate PEM (code:004)";k=E.getPosArrayOfChildren_AtObj(e,k[7]);if(1!=k.length)throw"malformed X.509 certificate PEM (code:005)";if("30"!=e.substr(k[0],2))throw"malformed X.509 certificate PEM (code:006)";for(var k=E.getPosArrayOfChildren_AtObj(e,k[0]),h=k.length,d=Array(h),v=0;v<h;v++)d[v]=
da.getV3ExtItemInfo_AtObj(e,k[v]);return d};da.getV3ExtItemInfo_AtObj=function(e,k){var h={};h.posTLV=k;var d=E.getPosArrayOfChildren_AtObj(e,k);if(2!=d.length&&3!=d.length)throw"malformed X.509v3 Ext (code:001)";if("06"!=e.substr(d[0],2))throw"malformed X.509v3 Ext (code:002)";var v=E.getHexOfV_AtObj(e,d[0]);h.oid=E.hextooidstr(v);h.critical=!1;3==d.length&&(h.critical=!0);d=d[d.length-1];if("04"!=e.substr(d,2))throw"malformed X.509v3 Ext (code:003)";h.posV=E.getStartPosOfV_AtObj(e,d);return h};
da.getHexOfTLV_V3ExtValue=function(e,k){var h=da.getPosOfTLV_V3ExtValue(e,k);return-1==h?"":E.getHexOfTLV_AtObj(e,h)};da.getHexOfV_V3ExtValue=function(e,k){var h=da.getPosOfTLV_V3ExtValue(e,k);return-1==h?"":E.getHexOfV_AtObj(e,h)};da.getPosOfTLV_V3ExtValue=function(e,k){var h=k;k.match(/^[0-9.]+$/)||(h=N.asn1.x509.OID.name2oid(k));if(""==h)return-1;for(var d=da.getV3ExtInfoListOfCertHex(e),v=0;v<d.length;v++){var l=d[v];if(l.oid==h)return l.posV}return-1};da.KEYUSAGE_NAME="digitalSignature nonRepudiation keyEncipherment dataEncipherment keyAgreement keyCertSign cRLSign encipherOnly decipherOnly".split(" ");
da.getExtKeyUsageBin=function(e){var k=da.getHexOfV_V3ExtValue(e,"keyUsage");if(""==k)return"";if(0!=k.length%2||2>=k.length)throw"malformed key usage value";e=parseInt(k.substr(0,2));k=parseInt(k.substr(2),16).toString(2);return k.substr(0,k.length-e)};da.getExtKeyUsageString=function(e){e=da.getExtKeyUsageBin(e);for(var k=[],h=0;h<e.length;h++)"1"==e.substr(h,1)&&k.push(da.KEYUSAGE_NAME[h]);return k.join(",")};da.getExtAIAInfo=function(e){var k={ocsp:[],caissuer:[]},h=da.getPosOfTLV_V3ExtValue(e,
"authorityInfoAccess");if(-1==h)return null;if("30"!=e.substr(h,2))throw"malformed AIA Extn Value";for(var h=E.getPosArrayOfChildren_AtObj(e,h),d=0;d<h.length;d++){var v=E.getPosArrayOfChildren_AtObj(e,h[d]);if(2!=v.length)throw"malformed AccessDescription of AIA Extn";var l=v[0],v=v[1];"2b06010505073001"==E.getHexOfV_AtObj(e,l)&&"86"==e.substr(v,2)&&k.ocsp.push(hextoutf8(E.getHexOfV_AtObj(e,v)));"2b06010505073002"==E.getHexOfV_AtObj(e,l)&&"86"==e.substr(v,2)&&k.caissuer.push(hextoutf8(E.getHexOfV_AtObj(e,
v)))}return k};q.X509=da;var tc,z=function(e,k,h){null!=e&&("number"==typeof e?this.fromNumber(e,k,h):null==k&&"string"!=typeof e?this.fromString(e,256):this.fromString(e,k))};"Microsoft Internet Explorer"==navigator.appName?(z.prototype.am=le,tc=30):"Netscape"!=navigator.appName?(z.prototype.am=Fb,tc=26):(z.prototype.am=Ud,tc=28);z.prototype.DB=tc;z.prototype.DM=(1<<tc)-1;z.prototype.DV=1<<tc;z.prototype.FV=Math.pow(2,52);z.prototype.F1=52-tc;z.prototype.F2=2*tc-52;var Rb="0123456789abcdefghijklmnopqrstuvwxyz",
me=[],Gc,Tb;Gc=48;for(Tb=0;9>=Tb;++Tb)me[Gc++]=Tb;Gc=97;for(Tb=10;36>Tb;++Tb)me[Gc++]=Tb;Gc=65;for(Tb=10;36>Tb;++Tb)me[Gc++]=Tb;rc.prototype.convert=function(e){return 0>e.s||0<=e.compareTo(this.m)?e.mod(this.m):e};rc.prototype.revert=function(e){return e};rc.prototype.reduce=function(e){e.divRemTo(this.m,null,e)};rc.prototype.mulTo=function(e,k,h){e.multiplyTo(k,h);this.reduce(h)};rc.prototype.sqrTo=function(e,k){e.squareTo(k);this.reduce(k)};La.prototype.convert=function(e){var k=ga();e.abs().dlShiftTo(this.m.t,
k);k.divRemTo(this.m,null,k);0>e.s&&0<k.compareTo(z.ZERO)&&this.m.subTo(k,k);return k};La.prototype.revert=function(e){var k=ga();e.copyTo(k);this.reduce(k);return k};La.prototype.reduce=function(e){for(;e.t<=this.mt2;)e[e.t++]=0;for(var k=0;k<this.m.t;++k){var h=e[k]&32767,d=h*this.mpl+((h*this.mph+(e[k]>>15)*this.mpl&this.um)<<15)&e.DM,h=k+this.m.t;for(e[h]+=this.m.am(0,d,e,k,0,this.m.t);e[h]>=e.DV;)e[h]-=e.DV,e[++h]++}e.clamp();e.drShiftTo(this.m.t,e);0<=e.compareTo(this.m)&&e.subTo(this.m,e)};
La.prototype.mulTo=function(e,k,h){e.multiplyTo(k,h);this.reduce(h)};La.prototype.sqrTo=function(e,k){e.squareTo(k);this.reduce(k)};z.prototype.copyTo=function(e){for(var k=this.t-1;0<=k;--k)e[k]=this[k];e.t=this.t;e.s=this.s};z.prototype.fromInt=function(e){this.t=1;this.s=0>e?-1:0;0<e?this[0]=e:-1>e?this[0]=e+this.DV:this.t=0};z.prototype.fromString=function(e,k){var h;if(16==k)h=4;else if(8==k)h=3;else if(256==k)h=8;else if(2==k)h=1;else if(32==k)h=5;else if(4==k)h=2;else{this.fromRadix(e,k);return}this.s=
this.t=0;for(var d=e.length,v=!1,l=0;0<=--d;){var a=8==h?e[d]&255:Sc(e,d);0>a?"-"==e.charAt(d)&&(v=!0):(v=!1,0==l?this[this.t++]=a:l+h>this.DB?(this[this.t-1]|=(a&(1<<this.DB-l)-1)<<l,this[this.t++]=a>>this.DB-l):this[this.t-1]|=a<<l,l+=h,l>=this.DB&&(l-=this.DB))}8==h&&0!=(e[0]&128)&&(this.s=-1,0<l&&(this[this.t-1]|=(1<<this.DB-l)-1<<l));this.clamp();v&&z.ZERO.subTo(this,this)};z.prototype.clamp=function(){for(var e=this.s&this.DM;0<this.t&&this[this.t-1]==e;)--this.t};z.prototype.dlShiftTo=function(e,
k){var h;for(h=this.t-1;0<=h;--h)k[h+e]=this[h];for(h=e-1;0<=h;--h)k[h]=0;k.t=this.t+e;k.s=this.s};z.prototype.drShiftTo=function(e,k){for(var h=e;h<this.t;++h)k[h-e]=this[h];k.t=Math.max(this.t-e,0);k.s=this.s};z.prototype.lShiftTo=function(e,k){var h=e%this.DB,d=this.DB-h,v=(1<<d)-1,l=Math.floor(e/this.DB),a=this.s<<h&this.DM,b;for(b=this.t-1;0<=b;--b)k[b+l+1]=this[b]>>d|a,a=(this[b]&v)<<h;for(b=l-1;0<=b;--b)k[b]=0;k[l]=a;k.t=this.t+l+1;k.s=this.s;k.clamp()};z.prototype.rShiftTo=function(e,k){k.s=
this.s;var h=Math.floor(e/this.DB);if(h>=this.t)k.t=0;else{var d=e%this.DB,v=this.DB-d,l=(1<<d)-1;k[0]=this[h]>>d;for(var a=h+1;a<this.t;++a)k[a-h-1]|=(this[a]&l)<<v,k[a-h]=this[a]>>d;0<d&&(k[this.t-h-1]|=(this.s&l)<<v);k.t=this.t-h;k.clamp()}};z.prototype.subTo=function(e,k){for(var h=0,d=0,v=Math.min(e.t,this.t);h<v;)d+=this[h]-e[h],k[h++]=d&this.DM,d>>=this.DB;if(e.t<this.t){for(d-=e.s;h<this.t;)d+=this[h],k[h++]=d&this.DM,d>>=this.DB;d+=this.s}else{for(d+=this.s;h<e.t;)d-=e[h],k[h++]=d&this.DM,
d>>=this.DB;d-=e.s}k.s=0>d?-1:0;-1>d?k[h++]=this.DV+d:0<d&&(k[h++]=d);k.t=h;k.clamp()};z.prototype.multiplyTo=function(e,k){var h=this.abs(),d=e.abs(),v=h.t;for(k.t=v+d.t;0<=--v;)k[v]=0;for(v=0;v<d.t;++v)k[v+h.t]=h.am(0,d[v],k,v,0,h.t);k.s=0;k.clamp();this.s!=e.s&&z.ZERO.subTo(k,k)};z.prototype.squareTo=function(e){for(var k=this.abs(),h=e.t=2*k.t;0<=--h;)e[h]=0;for(h=0;h<k.t-1;++h){var d=k.am(h,k[h],e,2*h,0,1);(e[h+k.t]+=k.am(h+1,2*k[h],e,2*h+1,d,k.t-h-1))>=k.DV&&(e[h+k.t]-=k.DV,e[h+k.t+1]=1)}0<
e.t&&(e[e.t-1]+=k.am(h,k[h],e,2*h,0,1));e.s=0;e.clamp()};z.prototype.divRemTo=function(e,k,h){var d=e.abs();if(!(0>=d.t)){var v=this.abs();if(v.t<d.t)null!=k&&k.fromInt(0),null!=h&&this.copyTo(h);else{null==h&&(h=ga());var l=ga(),a=this.s;e=e.s;var b=this.DB-zd(d[d.t-1]);0<b?(d.lShiftTo(b,l),v.lShiftTo(b,h)):(d.copyTo(l),v.copyTo(h));d=l.t;v=l[d-1];if(0!=v){var c=v*(1<<this.F1)+(1<d?l[d-2]>>this.F2:0),f=this.FV/c,c=(1<<this.F1)/c,g=1<<this.F2,m=h.t,n=m-d,p=null==k?ga():k;l.dlShiftTo(n,p);0<=h.compareTo(p)&&
(h[h.t++]=1,h.subTo(p,h));z.ONE.dlShiftTo(d,p);for(p.subTo(l,l);l.t<d;)l[l.t++]=0;for(;0<=--n;){var s=h[--m]==v?this.DM:Math.floor(h[m]*f+(h[m-1]+g)*c);if((h[m]+=l.am(0,s,h,n,0,d))<s)for(l.dlShiftTo(n,p),h.subTo(p,h);h[m]<--s;)h.subTo(p,h)}null!=k&&(h.drShiftTo(d,k),a!=e&&z.ZERO.subTo(k,k));h.t=d;h.clamp();0<b&&h.rShiftTo(b,h);0>a&&z.ZERO.subTo(h,h)}}}};z.prototype.invDigit=function(){if(1>this.t)return 0;var e=this[0];if(0==(e&1))return 0;var k=e&3,k=k*(2-(e&15)*k)&15,k=k*(2-(e&255)*k)&255,k=k*(2-
((e&65535)*k&65535))&65535,k=k*(2-e*k%this.DV)%this.DV;return 0<k?this.DV-k:-k};z.prototype.isEven=function(){return 0==(0<this.t?this[0]&1:this.s)};z.prototype.exp=function(e,k){if(4294967295<e||1>e)return z.ONE;var h=ga(),d=ga(),v=k.convert(this),l=zd(e)-1;for(v.copyTo(h);0<=--l;)if(k.sqrTo(h,d),0<(e&1<<l))k.mulTo(d,v,h);else var a=h,h=d,d=a;return k.revert(h)};z.prototype.toString=function(e){if(0>this.s)return"-"+this.negate().toString(e);if(16==e)e=4;else if(8==e)e=3;else if(2==e)e=1;else if(32==
e)e=5;else if(4==e)e=2;else return this.toRadix(e);var k=(1<<e)-1,h,d=!1,v="",l=this.t,a=this.DB-l*this.DB%e;if(0<l--)for(a<this.DB&&0<(h=this[l]>>a)&&(d=!0,v=Rb.charAt(h));0<=l;)a<e?(h=(this[l]&(1<<a)-1)<<e-a,h|=this[--l]>>(a+=this.DB-e)):(h=this[l]>>(a-=e)&k,0>=a&&(a+=this.DB,--l)),0<h&&(d=!0),d&&(v+=Rb.charAt(h));return d?v:"0"};z.prototype.negate=function(){var e=ga();z.ZERO.subTo(this,e);return e};z.prototype.abs=function(){return 0>this.s?this.negate():this};z.prototype.compareTo=function(e){var k=
this.s-e.s;if(0!=k)return k;var h=this.t,k=h-e.t;if(0!=k)return 0>this.s?-k:k;for(;0<=--h;)if(0!=(k=this[h]-e[h]))return k;return 0};z.prototype.bitLength=function(){return 0>=this.t?0:this.DB*(this.t-1)+zd(this[this.t-1]^this.s&this.DM)};z.prototype.mod=function(e){var k=ga();this.abs().divRemTo(e,null,k);0>this.s&&0<k.compareTo(z.ZERO)&&e.subTo(k,k);return k};z.prototype.modPowInt=function(e,k){var h;h=256>e||k.isEven()?new rc(k):new La(k);return this.exp(e,h)};z.ZERO=Dc(0);z.ONE=Dc(1);Uc.prototype.convert=
Ad;Uc.prototype.revert=Ad;Uc.prototype.mulTo=function(e,k,h){e.multiplyTo(k,h)};Uc.prototype.sqrTo=function(e,k){e.squareTo(k)};Ec.prototype.convert=function(e){if(0>e.s||e.t>2*this.m.t)return e.mod(this.m);if(0>e.compareTo(this.m))return e;var k=ga();e.copyTo(k);this.reduce(k);return k};Ec.prototype.revert=function(e){return e};Ec.prototype.reduce=function(e){e.drShiftTo(this.m.t-1,this.r2);e.t>this.m.t+1&&(e.t=this.m.t+1,e.clamp());this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3);for(this.m.multiplyLowerTo(this.q3,
this.m.t+1,this.r2);0>e.compareTo(this.r2);)e.dAddOffset(1,this.m.t+1);for(e.subTo(this.r2,e);0<=e.compareTo(this.m);)e.subTo(this.m,e)};Ec.prototype.mulTo=function(e,k,h){e.multiplyTo(k,h);this.reduce(h)};Ec.prototype.sqrTo=function(e,k){e.squareTo(k);this.reduce(k)};var ob=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,
313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],Qe=67108864/ob[ob.length-1];z.prototype.chunkSize=function(e){return Math.floor(Math.LN2*
this.DB/Math.log(e))};z.prototype.toRadix=function(e){null==e&&(e=10);if(0==this.signum()||2>e||36<e)return"0";var k=this.chunkSize(e),k=Math.pow(e,k),h=Dc(k),d=ga(),v=ga(),l="";for(this.divRemTo(h,d,v);0<d.signum();)l=(k+v.intValue()).toString(e).substr(1)+l,d.divRemTo(h,d,v);return v.intValue().toString(e)+l};z.prototype.fromRadix=function(e,k){this.fromInt(0);null==k&&(k=10);for(var h=this.chunkSize(k),d=Math.pow(k,h),v=!1,l=0,a=0,b=0;b<e.length;++b){var c=Sc(e,b);0>c?"-"==e.charAt(b)&&0==this.signum()&&
(v=!0):(a=k*a+c,++l>=h&&(this.dMultiply(d),this.dAddOffset(a,0),a=l=0))}0<l&&(this.dMultiply(Math.pow(k,l)),this.dAddOffset(a,0));v&&z.ZERO.subTo(this,this)};z.prototype.fromNumber=function(e,k,h){if("number"==typeof k)if(2>e)this.fromInt(1);else for(this.fromNumber(e,h),this.testBit(e-1)||this.bitwiseTo(z.ONE.shiftLeft(e-1),Kd,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(k);)this.dAddOffset(2,0),this.bitLength()>e&&this.subTo(z.ONE.shiftLeft(e-1),this);else{h=[];var d=e&7;h.length=
(e>>3)+1;k.nextBytes(h);h[0]=0<d?h[0]&(1<<d)-1:0;this.fromString(h,256)}};z.prototype.bitwiseTo=function(e,k,h){var d,v,l=Math.min(e.t,this.t);for(d=0;d<l;++d)h[d]=k(this[d],e[d]);if(e.t<this.t){v=e.s&this.DM;for(d=l;d<this.t;++d)h[d]=k(this[d],v);h.t=this.t}else{v=this.s&this.DM;for(d=l;d<e.t;++d)h[d]=k(v,e[d]);h.t=e.t}h.s=k(this.s,e.s);h.clamp()};z.prototype.changeBit=function(e,k){var h=z.ONE.shiftLeft(e);this.bitwiseTo(h,k,h);return h};z.prototype.addTo=function(e,k){for(var h=0,d=0,v=Math.min(e.t,
this.t);h<v;)d+=this[h]+e[h],k[h++]=d&this.DM,d>>=this.DB;if(e.t<this.t){for(d+=e.s;h<this.t;)d+=this[h],k[h++]=d&this.DM,d>>=this.DB;d+=this.s}else{for(d+=this.s;h<e.t;)d+=e[h],k[h++]=d&this.DM,d>>=this.DB;d+=e.s}k.s=0>d?-1:0;0<d?k[h++]=d:-1>d&&(k[h++]=this.DV+d);k.t=h;k.clamp()};z.prototype.dMultiply=function(e){this[this.t]=this.am(0,e-1,this,0,0,this.t);++this.t;this.clamp()};z.prototype.dAddOffset=function(e,k){if(0!=e){for(;this.t<=k;)this[this.t++]=0;for(this[k]+=e;this[k]>=this.DV;)this[k]-=
this.DV,++k>=this.t&&(this[this.t++]=0),++this[k]}};z.prototype.multiplyLowerTo=function(e,k,h){var d=Math.min(this.t+e.t,k);h.s=0;for(h.t=d;0<d;)h[--d]=0;var v;for(v=h.t-this.t;d<v;++d)h[d+this.t]=this.am(0,e[d],h,d,0,this.t);for(v=Math.min(e.t,k);d<v;++d)this.am(0,e[d],h,d,0,k-d);h.clamp()};z.prototype.multiplyUpperTo=function(e,k,h){--k;var d=h.t=this.t+e.t-k;for(h.s=0;0<=--d;)h[d]=0;for(d=Math.max(k-this.t,0);d<e.t;++d)h[this.t+d-k]=this.am(k-d,e[d],h,0,0,this.t+d-k);h.clamp();h.drShiftTo(1,h)};
z.prototype.modInt=function(e){if(0>=e)return 0;var k=this.DV%e,h=0>this.s?e-1:0;if(0<this.t)if(0==k)h=this[0]%e;else for(var d=this.t-1;0<=d;--d)h=(k*h+this[d])%e;return h};z.prototype.millerRabin=function(e){var k=this.subtract(z.ONE),h=k.getLowestSetBit();if(0>=h)return!1;var d=k.shiftRight(h);e=e+1>>1;e>ob.length&&(e=ob.length);for(var v=ga(),l=0;l<e;++l){v.fromInt(ob[Math.floor(Math.random()*ob.length)]);var a=v.modPow(d,this);if(0!=a.compareTo(z.ONE)&&0!=a.compareTo(k)){for(var b=1;b++<h&&0!=
a.compareTo(k);)if(a=a.modPowInt(2,this),0==a.compareTo(z.ONE))return!1;if(0!=a.compareTo(k))return!1}}return!0};z.prototype.clone=function(){var e=ga();this.copyTo(e);return e};z.prototype.intValue=function(){if(0>this.s){if(1==this.t)return this[0]-this.DV;if(0==this.t)return-1}else{if(1==this.t)return this[0];if(0==this.t)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]};z.prototype.byteValue=function(){return 0==this.t?this.s:this[0]<<24>>24};z.prototype.shortValue=function(){return 0==
this.t?this.s:this[0]<<16>>16};z.prototype.signum=function(){return 0>this.s?-1:0>=this.t||1==this.t&&0>=this[0]?0:1};z.prototype.toByteArray=function(){var e=this.t,k=[];k[0]=this.s;var h=this.DB-e*this.DB%8,d,v=0;if(0<e--)for(h<this.DB&&(d=this[e]>>h)!=(this.s&this.DM)>>h&&(k[v++]=d|this.s<<this.DB-h);0<=e;)if(8>h?(d=(this[e]&(1<<h)-1)<<8-h,d|=this[--e]>>(h+=this.DB-8)):(d=this[e]>>(h-=8)&255,0>=h&&(h+=this.DB,--e)),0!=(d&128)&&(d|=-256),0==v&&(this.s&128)!=(d&128)&&++v,0<v||d!=this.s)k[v++]=d;
return k};z.prototype.equals=function(e){return 0==this.compareTo(e)};z.prototype.min=function(e){return 0>this.compareTo(e)?this:e};z.prototype.max=function(e){return 0<this.compareTo(e)?this:e};z.prototype.and=function(e){var k=ga();this.bitwiseTo(e,ue,k);return k};z.prototype.or=function(e){var k=ga();this.bitwiseTo(e,Kd,k);return k};z.prototype.xor=function(e){var k=ga();this.bitwiseTo(e,Ld,k);return k};z.prototype.andNot=function(e){var k=ga();this.bitwiseTo(e,Tc,k);return k};z.prototype.not=
function(){for(var e=ga(),k=0;k<this.t;++k)e[k]=this.DM&~this[k];e.t=this.t;e.s=~this.s;return e};z.prototype.shiftLeft=function(e){var k=ga();0>e?this.rShiftTo(-e,k):this.lShiftTo(e,k);return k};z.prototype.shiftRight=function(e){var k=ga();0>e?this.lShiftTo(-e,k):this.rShiftTo(e,k);return k};z.prototype.getLowestSetBit=function(){for(var e=0;e<this.t;++e)if(0!=this[e]){var k=e*this.DB;e=this[e];if(0==e)e=-1;else{var h=0;0==(e&65535)&&(e>>=16,h+=16);0==(e&255)&&(e>>=8,h+=8);0==(e&15)&&(e>>=4,h+=
4);0==(e&3)&&(e>>=2,h+=2);0==(e&1)&&++h;e=h}return k+e}return 0>this.s?this.t*this.DB:-1};z.prototype.bitCount=function(){for(var e=0,k=this.s&this.DM,h=0;h<this.t;++h){for(var d=this[h]^k,v=0;0!=d;)d&=d-1,++v;e+=v}return e};z.prototype.testBit=function(e){var k=Math.floor(e/this.DB);return k>=this.t?0!=this.s:0!=(this[k]&1<<e%this.DB)};z.prototype.setBit=function(e){return this.changeBit(e,Kd)};z.prototype.clearBit=function(e){return this.changeBit(e,Tc)};z.prototype.flipBit=function(e){return this.changeBit(e,
Ld)};z.prototype.add=function(e){var k=ga();this.addTo(e,k);return k};z.prototype.subtract=function(e){var k=ga();this.subTo(e,k);return k};z.prototype.multiply=function(e){var k=ga();this.multiplyTo(e,k);return k};z.prototype.divide=function(e){var k=ga();this.divRemTo(e,k,null);return k};z.prototype.remainder=function(e){var k=ga();this.divRemTo(e,null,k);return k};z.prototype.divideAndRemainder=function(e){var k=ga(),h=ga();this.divRemTo(e,k,h);return[k,h]};z.prototype.modPow=function(e,k){var h=
e.bitLength(),d,v=Dc(1),l;if(0>=h)return v;d=18>h?1:48>h?3:144>h?4:768>h?5:6;l=8>h?new rc(k):k.isEven()?new Ec(k):new La(k);var a=[],b=3,c=d-1,f=(1<<d)-1;a[1]=l.convert(this);if(1<d)for(h=ga(),l.sqrTo(a[1],h);b<=f;)a[b]=ga(),l.mulTo(h,a[b-2],a[b]),b+=2;for(var g=e.t-1,m,n=!0,p=ga(),h=zd(e[g])-1;0<=g;){h>=c?m=e[g]>>h-c&f:(m=(e[g]&(1<<h+1)-1)<<c-h,0<g&&(m|=e[g-1]>>this.DB+h-c));for(b=d;0==(m&1);)m>>=1,--b;0>(h-=b)&&(h+=this.DB,--g);if(n)a[m].copyTo(v),n=!1;else{for(;1<b;)l.sqrTo(v,p),l.sqrTo(p,v),b-=
2;0<b?l.sqrTo(v,p):(b=v,v=p,p=b);l.mulTo(p,a[m],v)}for(;0<=g&&0==(e[g]&1<<h);)l.sqrTo(v,p),b=v,v=p,p=b,0>--h&&(h=this.DB-1,--g)}return l.revert(v)};z.prototype.modInverse=function(e){var k=e.isEven();if(this.isEven()&&k||0==e.signum())return z.ZERO;for(var h=e.clone(),d=this.clone(),a=Dc(1),l=Dc(0),b=Dc(0),c=Dc(1);0!=h.signum();){for(;h.isEven();)h.rShiftTo(1,h),k?(a.isEven()&&l.isEven()||(a.addTo(this,a),l.subTo(e,l)),a.rShiftTo(1,a)):l.isEven()||l.subTo(e,l),l.rShiftTo(1,l);for(;d.isEven();)d.rShiftTo(1,
d),k?(b.isEven()&&c.isEven()||(b.addTo(this,b),c.subTo(e,c)),b.rShiftTo(1,b)):c.isEven()||c.subTo(e,c),c.rShiftTo(1,c);0<=h.compareTo(d)?(h.subTo(d,h),k&&a.subTo(b,a),l.subTo(c,l)):(d.subTo(h,d),k&&b.subTo(a,b),c.subTo(l,c))}if(0!=d.compareTo(z.ONE))return z.ZERO;if(0<=c.compareTo(e))return c.subtract(e);if(0>c.signum())c.addTo(e,c);else return c;return 0>c.signum()?c.add(e):c};z.prototype.pow=function(e){return this.exp(e,new Uc)};z.prototype.gcd=function(e){var k=0>this.s?this.negate():this.clone();
e=0>e.s?e.negate():e.clone();if(0>k.compareTo(e)){var h=k,k=e;e=h}var h=k.getLowestSetBit(),d=e.getLowestSetBit();if(0>d)return k;h<d&&(d=h);0<d&&(k.rShiftTo(d,k),e.rShiftTo(d,e));for(;0<k.signum();)0<(h=k.getLowestSetBit())&&k.rShiftTo(h,k),0<(h=e.getLowestSetBit())&&e.rShiftTo(h,e),0<=k.compareTo(e)?(k.subTo(e,k),k.rShiftTo(1,k)):(e.subTo(k,e),e.rShiftTo(1,e));0<d&&e.lShiftTo(d,e);return e};z.prototype.isProbablePrime=function(e){var k,h=this.abs();if(1==h.t&&h[0]<=ob[ob.length-1]){for(k=0;k<ob.length;++k)if(h[0]==
ob[k])return!0;return!1}if(h.isEven())return!1;for(k=1;k<ob.length;){for(var d=ob[k],a=k+1;a<ob.length&&d<Qe;)d*=ob[a++];for(d=h.modInt(d);k<a;)if(0==d%ob[k++])return!1}return h.millerRabin(e)};z.prototype.square=function(){var e=ga();this.squareTo(e);return e};q.BigInteger=z;var E=a.ASN1HEX,N=a.KJUR,A=a.RSAKey,u=a.b64tohex,q=a=a||{};q.createHash=function(e){if("sha256"!=e)throw Error("createHash: unsupported algorithm.");e={};e.md=new N.crypto.MessageDigest({alg:"sha256",prov:"cryptojs"});e.update=
function(e){this.md.updateHex(e.toString("hex"))};e.digest=function(e){var h=this.md.digest();return"hex"==e?h:"base64"==e?(new f(h,"hex")).toString("base64"):new f(h,"hex")};return e};q.createHmac=function(e,k){if("sha256"!==e)throw Error("createHmac: unsupported algorithm.");var h={};h.md=new N.crypto.Mac({alg:"HmacSHA256",pass:{hex:k.toString("hex")}});h.update=function(d){this.md.updateHex(d.toString("hex"))};h.digest=function(d){var e=this.md.doFinal();return"hex"==d?e:"base64"==d?(new f(e,"hex")).toString("base64"):
new f(e,"hex")};return h};q.createSign=function(e){if("RSA-SHA256"!=e)throw Error("createSign: unsupported algorithm.");return{arr:[],update:function(e){this.arr.push(e)},sign:function(e){var h=new A;h.readPrivateKeyFromPEMString(e);e=new N.crypto.Signature({alg:"SHA256withRSA",prov:"cryptojs/jsrsa"});e.initSign(h);for(h=0;h<this.arr.length;++h)e.updateHex(this.arr[h].toString("hex"));return new f(e.sign(),"hex")}}};q.createVerify=function(e){if("RSA-SHA256"!=e)throw Error("createSign: unsupported algorithm.");
return{arr:[],update:function(e){this.arr.push(e)},verify:function(e,h){for(var d=e.split("\n"),a="",l=1;l<d.length-1;l++)a+=d[l];d=(new f(a,"base64")).toString("hex");a=E.getPosArrayOfChildren_AtObj(d,0);2!=a.length?a=-1:(a=a[1],"03"!=d.substring(a,a+2)?a=-1:(a=E.getStartPosOfV_AtObj(d,a),a="00"!=d.substring(a,a+2)?-1:a+2));l=E.getPosArrayOfChildren_AtObj(d,a);2!=l.length?a=null:(a=E.getHexOfV_AtObj(d,l[0]),d=E.getHexOfV_AtObj(d,l[1]),l=new A,l.setPublic(a,d),a=l);d=new N.crypto.Signature({alg:"SHA256withRSA",
prov:"cryptojs/jsrsa"});d.initVerifyByPublicKey(a);for(a=0;a<this.arr.length;a++)d.updateHex(this.arr[a].toString("hex"));a=h.toString("hex");return d.verify(a)}}};q.randomBytes=function(e){for(var k=new f(e),h=0;h<e;++h)k[h]=Math.floor(256*Math.random());return k};q.toByteArray=function(e){var k=[];u(e).replace(/(..)/g,function(e){k.push(parseInt(e,16))});return k};var Wc={};(function(e){function k(e){e=e.charCodeAt(0);if(e===d)return 62;if(e===a)return 63;if(e<l)return-1;if(e<l+10)return e-l+52;
if(e<c+26)return e-c;if(e<b+26)return e-b+26}var h="undefined"!==typeof Uint8Array?Uint8Array:Array,d=43,a=47,l=48,b=97,c=65;e.toByteArray=function(d){function e(d){c[f++]=d}var l,a,v,b,c;if(0<d.length%4)throw Error("Invalid string. Length must be a multiple of 4");l=d.length;b="="===d.charAt(l-2)?2:"="===d.charAt(l-1)?1:0;c=new h(3*d.length/4-b);a=0<b?d.length-4:d.length;var f=0;for(l=0;l<a;l+=4)v=k(d.charAt(l))<<18|k(d.charAt(l+1))<<12|k(d.charAt(l+2))<<6|k(d.charAt(l+3)),e((v&16711680)>>16),e((v&
65280)>>8),e(v&255);2===b?(v=k(d.charAt(l))<<2|k(d.charAt(l+1))>>4,e(v&255)):1===b&&(v=k(d.charAt(l))<<10|k(d.charAt(l+1))<<4|k(d.charAt(l+2))>>2,e(v>>8&255),e(v&255));return c};e.fromByteArray=function(d){var e,h=d.length%3,k="",l,a;e=0;for(a=d.length-h;e<a;e+=3)l=(d[e]<<16)+(d[e+1]<<8)+d[e+2],l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(l>>18&63)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(l>>12&63)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(l>>
6&63)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(l&63),k+=l;switch(h){case 1:l=d[d.length-1];k+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(l>>2);k+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(l<<4&63);k+="==";break;case 2:l=(d[d.length-2]<<8)+d[d.length-1],k+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(l>>10),k+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(l>>
4&63),k+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(l<<2&63),k+="="}return k}})(Wc);q.ieee={read:function(e,k,h,d,a){var l;l=8*a-d-1;var b=(1<<l)-1,c=b>>1,f=-7;a=h?a-1:0;var g=h?-1:1,m=e[k+a];a+=g;h=m&(1<<-f)-1;m>>=-f;for(f+=l;0<f;h=256*h+e[k+a],a+=g,f-=8);l=h&(1<<-f)-1;h>>=-f;for(f+=d;0<f;l=256*l+e[k+a],a+=g,f-=8);if(0===h)h=1-c;else{if(h===b)return l?NaN:Infinity*(m?-1:1);l+=Math.pow(2,d);h-=c}return(m?-1:1)*l*Math.pow(2,h-d)},write:function(e,k,h,d,a,l){var b,c=8*
l-a-1,f=(1<<c)-1,g=f>>1,m=23===a?Math.pow(2,-24)-Math.pow(2,-77):0;l=d?0:l-1;var n=d?1:-1,p=0>k||0===k&&0>1/k?1:0;k=Math.abs(k);isNaN(k)||Infinity===k?(k=isNaN(k)?1:0,d=f):(d=Math.floor(Math.log(k)/Math.LN2),1>k*(b=Math.pow(2,-d))&&(d--,b*=2),k=1<=d+g?k+m/b:k+m*Math.pow(2,1-g),2<=k*b&&(d++,b/=2),d+g>=f?(k=0,d=f):1<=d+g?(k=(k*b-1)*Math.pow(2,a),d+=g):(k=k*Math.pow(2,g-1)*Math.pow(2,a),d=0));for(;8<=a;e[h+l]=k&255,l+=n,k/=256,a-=8);d=d<<a|k;for(c+=a;0<c;e[h+l]=d&255,l+=n,d/=256,c-=8);e[h+l-n]|=128*
p}};var Ha=a.ieee;q.Buffer=f;q.SlowBuffer=f;q.INSPECT_MAX_BYTES=50;f.poolSize=8192;f._useTypedArrays=function(){try{var e=new ArrayBuffer(0),k=new Uint8Array(e);k.foo=function(){return 42};return 42===k.foo()&&"function"===typeof k.subarray}catch(h){return!1}}();f.isEncoding=function(e){switch(String(e).toLowerCase()){case "hex":case "utf8":case "utf-8":case "ascii":case "binary":case "base64":case "raw":case "ucs2":case "ucs-2":case "utf16le":case "utf-16le":return!0;default:return!1}};f.isBuffer=
function(e){return!(null===e||void 0===e||!e._isBuffer)};f.byteLength=function(e,k){var h;e=e.toString();switch(k||"utf8"){case "hex":h=e.length/2;break;case "utf8":case "utf-8":h=f.utf8ToBytes(e).length;break;case "ascii":case "binary":case "raw":h=e.length;break;case "base64":h=f.base64ToBytes(e).length;break;case "ucs2":case "ucs-2":case "utf16le":case "utf-16le":h=2*e.length;break;default:throw Error("Unknown encoding");}return h};f.concat=function(e,k){f.assert(f.isArray(e),"Usage: Buffer.concat(list[, length])");
if(0===e.length)return new f(0);if(1===e.length)return e[0];var h;if(void 0===k)for(h=k=0;h<e.length;h++)k+=e[h].length;var d=new f(k),a=0;for(h=0;h<e.length;h++){var l=e[h];l.copy(d,a);a+=l.length}return d};f.compare=function(e,k){f.assert(f.isBuffer(e)&&f.isBuffer(k),"Arguments must be Buffers");for(var h=e.length,d=k.length,a=0,l=Math.min(h,d);a<l&&e[a]===k[a];a++);a!==l&&(h=e[a],d=k[a]);return h<d?-1:d<h?1:0};f.hexWrite=function(e,k,h,d){h=Number(h)||0;var a=e.length-h;d?(d=Number(d),d>a&&(d=
a)):d=a;a=k.length;f.assert(0===a%2,"Invalid hex string");d>a/2&&(d=a/2);for(a=0;a<d;a++){var l=parseInt(k.substr(2*a,2),16);f.assert(!isNaN(l),"Invalid hex string");e[h+a]=l}return a};f.utf8Write=function(e,k,h,d){return f.blitBuffer(f.utf8ToBytes(k),e,h,d)};f.asciiWrite=function(e,k,h,d){return f.blitBuffer(f.asciiToBytes(k),e,h,d)};f.binaryWrite=function(e,k,h,d){return f.asciiWrite(e,k,h,d)};f.base64Write=function(e,k,h,d){return f.blitBuffer(f.base64ToBytes(k),e,h,d)};f.utf16leWrite=function(e,
k,h,d){return f.blitBuffer(f.utf16leToBytes(k),e,h,d)};f.prototype.write=function(e,k,h,d){if(isFinite(k))isFinite(h)||(d=h,h=void 0);else{var a=d;d=k;k=h;h=a}k=Number(k)||0;a=this.length-k;h?(h=Number(h),h>a&&(h=a)):h=a;d=String(d||"utf8").toLowerCase();switch(d){case "hex":e=f.hexWrite(this,e,k,h);break;case "utf8":case "utf-8":e=f.utf8Write(this,e,k,h);break;case "ascii":e=f.asciiWrite(this,e,k,h);break;case "binary":e=f.binaryWrite(this,e,k,h);break;case "base64":e=f.base64Write(this,e,k,h);break;
case "ucs2":case "ucs-2":case "utf16le":case "utf-16le":e=f.utf16leWrite(this,e,k,h);break;default:throw Error("Unknown encoding");}return e};f.prototype.toString=function(e,k,h){e=String(e||"utf8").toLowerCase();k=Number(k)||0;h=void 0===h?this.length:Number(h);if(h===k)return"";switch(e){case "hex":e=f.hexSlice(this,k,h);break;case "utf8":case "utf-8":e=f.utf8Slice(this,k,h);break;case "ascii":e=f.asciiSlice(this,k,h);break;case "binary":e=f.binarySlice(this,k,h);break;case "base64":e=f.base64Slice(this,
k,h);break;case "ucs2":case "ucs-2":case "utf16le":case "utf-16le":e=this.slice(k,h);k="";for(h=0;h<e.length;h+=2)k+=String.fromCharCode(e[h]+256*e[h+1]);e=k;break;default:throw Error("Unknown encoding");}return e};f.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};f.prototype.equals=function(e){f.assert(f.isBuffer(e),"Argument must be a Buffer");return 0===f.compare(this,e)};f.prototype.compare=function(e){f.assert(f.isBuffer(e),"Argument must be a Buffer");
return f.compare(this,e)};f.prototype.copy=function(e,k,h,d){h||(h=0);d||0===d||(d=this.length);k||(k=0);if(d!==h&&0!==e.length&&0!==this.length)if(f.assert(d>=h,"sourceEnd < sourceStart"),f.assert(0<=k&&k<e.length,"targetStart out of bounds"),f.assert(0<=h&&h<this.length,"sourceStart out of bounds"),f.assert(0<=d&&d<=this.length,"sourceEnd out of bounds"),d>this.length&&(d=this.length),e.length-k<d-h&&(d=e.length-k+h),d-=h,100>d||!f._useTypedArrays)for(var a=0;a<d;a++)e[a+k]=this[a+h];else e._set(this.subarray(h,
h+d),k)};f.base64Slice=function(e,k,h){return 0===k&&h===e.length?Wc.fromByteArray(e):Wc.fromByteArray(e.slice(k,h))};f.utf8Slice=function(e,k,h){var d="",a="";for(h=Math.min(e.length,h);k<h;k++)127>=e[k]?(d+=f.decodeUtf8Char(a)+String.fromCharCode(e[k]),a=""):a+="%"+e[k].toString(16);return d+f.decodeUtf8Char(a)};f.asciiSlice=function(e,k,h){var d="";for(h=Math.min(e.length,h);k<h;k++)d+=String.fromCharCode(e[k]);return d};f.binarySlice=function(e,k,h){return f.asciiSlice(e,k,h)};f.hexSlice=function(e,
k,h){var d=e.length;if(!k||0>k)k=0;if(!h||0>h||h>d)h=d;for(d="";k<h;k++)d+=f.toHex(e[k]);return d};f.prototype.slice=function(e,k){var h=this.length;e=f.clamp(e,h,0);k=f.clamp(k,h,h);if(f._useTypedArrays)return f._augment(this.subarray(e,k));for(var h=k-e,d=new f(h,void 0,!0),a=0;a<h;a++)d[a]=this[a+e];return d};f.prototype.get=function(e){console.log(".get() is deprecated. Access using array indexes instead.");return this.readUInt8(e)};f.prototype.set=function(e,k){console.log(".set() is deprecated. Access using array indexes instead.");
return this.writeUInt8(e,k)};f.prototype.readUInt8=function(e,k){k||(f.assert(void 0!==e&&null!==e,"missing offset"),f.assert(e<this.length,"Trying to read beyond buffer length"));if(!(e>=this.length))return this[e]};f.readUInt16=function(e,k,h,d){d||(f.assert("boolean"===typeof h,"missing or invalid endian"),f.assert(void 0!==k&&null!==k,"missing offset"),f.assert(k+1<e.length,"Trying to read beyond buffer length"));d=e.length;if(!(k>=d))return h?(h=e[k],k+1<d&&(h|=e[k+1]<<8)):(h=e[k]<<8,k+1<d&&
(h|=e[k+1])),h};f.prototype.readUInt16LE=function(e,k){return f.readUInt16(this,e,!0,k)};f.prototype.readUInt16BE=function(e,k){return f.readUInt16(this,e,!1,k)};f.readUInt32=function(e,k,h,d){d||(f.assert("boolean"===typeof h,"missing or invalid endian"),f.assert(void 0!==k&&null!==k,"missing offset"),f.assert(k+3<e.length,"Trying to read beyond buffer length"));d=e.length;if(!(k>=d)){var a;h?(k+2<d&&(a=e[k+2]<<16),k+1<d&&(a|=e[k+1]<<8),a|=e[k],k+3<d&&(a+=e[k+3]<<24>>>0)):(k+1<d&&(a=e[k+1]<<16),
k+2<d&&(a|=e[k+2]<<8),k+3<d&&(a|=e[k+3]),a+=e[k]<<24>>>0);return a}};f.prototype.readUInt32LE=function(e,k){return f.readUInt32(this,e,!0,k)};f.prototype.readUInt32BE=function(e,k){return f.readUInt32(this,e,!1,k)};f.prototype.readInt8=function(e,k){k||(f.assert(void 0!==e&&null!==e,"missing offset"),f.assert(e<this.length,"Trying to read beyond buffer length"));if(!(e>=this.length))return this[e]&128?-1*(255-this[e]+1):this[e]};f.readInt16=function(e,k,h,d){d||(f.assert("boolean"===typeof h,"missing or invalid endian"),
f.assert(void 0!==k&&null!==k,"missing offset"),f.assert(k+1<e.length,"Trying to read beyond buffer length"));if(!(k>=e.length))return e=f.readUInt16(e,k,h,!0),e&32768?-1*(65535-e+1):e};f.prototype.readInt16LE=function(e,k){return f.readInt16(this,e,!0,k)};f.prototype.readInt16BE=function(e,k){return f.readInt16(this,e,!1,k)};f.readInt32=function(e,k,h,d){d||(f.assert("boolean"===typeof h,"missing or invalid endian"),f.assert(void 0!==k&&null!==k,"missing offset"),f.assert(k+3<e.length,"Trying to read beyond buffer length"));
if(!(k>=e.length))return e=f.readUInt32(e,k,h,!0),e&2147483648?-1*(4294967295-e+1):e};f.prototype.readInt32LE=function(e,k){return f.readInt32(this,e,!0,k)};f.prototype.readInt32BE=function(e,k){return f.readInt32(this,e,!1,k)};f.readFloat=function(e,k,h,d){d||(f.assert("boolean"===typeof h,"missing or invalid endian"),f.assert(k+3<e.length,"Trying to read beyond buffer length"));return Ha.read(e,k,h,23,4)};f.prototype.readFloatLE=function(e,k){return f.readFloat(this,e,!0,k)};f.prototype.readFloatBE=
function(e,k){return f.readFloat(this,e,!1,k)};f.readDouble=function(e,k,h,d){d||(f.assert("boolean"===typeof h,"missing or invalid endian"),f.assert(k+7<e.length,"Trying to read beyond buffer length"));return Ha.read(e,k,h,52,8)};f.prototype.readDoubleLE=function(e,k){return f.readDouble(this,e,!0,k)};f.prototype.readDoubleBE=function(e,k){return f.readDouble(this,e,!1,k)};f.prototype.writeUInt8=function(e,k,h){h||(f.assert(void 0!==e&&null!==e,"missing value"),f.assert(void 0!==k&&null!==k,"missing offset"),
f.assert(k<this.length,"trying to write beyond buffer length"),f.verifuint(e,255));if(!(k>=this.length))return this[k]=e,k+1};f.writeUInt16=function(e,k,h,d,a){a||(f.assert(void 0!==k&&null!==k,"missing value"),f.assert("boolean"===typeof d,"missing or invalid endian"),f.assert(void 0!==h&&null!==h,"missing offset"),f.assert(h+1<e.length,"trying to write beyond buffer length"),f.verifuint(k,65535));var l=e.length;if(!(h>=l)){a=0;for(l=Math.min(l-h,2);a<l;a++)e[h+a]=(k&255<<8*(d?a:1-a))>>>8*(d?a:1-
a);return h+2}};f.prototype.writeUInt16LE=function(e,k,h){return f.writeUInt16(this,e,k,!0,h)};f.prototype.writeUInt16BE=function(e,k,h){return f.writeUInt16(this,e,k,!1,h)};f.writeUInt32=function(e,k,h,d,a){a||(f.assert(void 0!==k&&null!==k,"missing value"),f.assert("boolean"===typeof d,"missing or invalid endian"),f.assert(void 0!==h&&null!==h,"missing offset"),f.assert(h+3<e.length,"trying to write beyond buffer length"),f.verifuint(k,4294967295));var l=e.length;if(!(h>=l)){a=0;for(l=Math.min(l-
h,4);a<l;a++)e[h+a]=k>>>8*(d?a:3-a)&255;return h+4}};f.prototype.writeUInt32LE=function(e,k,h){return f.writeUInt32(this,e,k,!0,h)};f.prototype.writeUInt32BE=function(e,k,h){return f.writeUInt32(this,e,k,!1,h)};f.prototype.writeInt8=function(e,k,h){h||(f.assert(void 0!==e&&null!==e,"missing value"),f.assert(void 0!==k&&null!==k,"missing offset"),f.assert(k<this.length,"Trying to write beyond buffer length"),f.verifsint(e,127,-128));if(!(k>=this.length))return 0<=e?this.writeUInt8(e,k,h):this.writeUInt8(255+
e+1,k,h),k+1};f.writeInt16=function(e,k,h,d,a){a||(f.assert(void 0!==k&&null!==k,"missing value"),f.assert("boolean"===typeof d,"missing or invalid endian"),f.assert(void 0!==h&&null!==h,"missing offset"),f.assert(h+1<e.length,"Trying to write beyond buffer length"),f.verifsint(k,32767,-32768));if(!(h>=e.length))return 0<=k?f.writeUInt16(e,k,h,d,a):f.writeUInt16(e,65535+k+1,h,d,a),h+2};f.prototype.writeInt16LE=function(e,k,h){return f.writeInt16(this,e,k,!0,h)};f.prototype.writeInt16BE=function(e,
k,h){return f.writeInt16(this,e,k,!1,h)};f.writeInt32=function(e,k,h,d,a){a||(f.assert(void 0!==k&&null!==k,"missing value"),f.assert("boolean"===typeof d,"missing or invalid endian"),f.assert(void 0!==h&&null!==h,"missing offset"),f.assert(h+3<e.length,"Trying to write beyond buffer length"),f.verifsint(k,2147483647,-2147483648));if(!(h>=e.length))return 0<=k?f.writeUInt32(e,k,h,d,a):f.writeUInt32(e,4294967295+k+1,h,d,a),h+4};f.prototype.writeInt32LE=function(e,k,h){return f.writeInt32(this,e,k,
!0,h)};f.prototype.writeInt32BE=function(e,k,h){return f.writeInt32(this,e,k,!1,h)};f.writeFloat=function(e,k,h,d,a){a||(f.assert(void 0!==k&&null!==k,"missing value"),f.assert("boolean"===typeof d,"missing or invalid endian"),f.assert(void 0!==h&&null!==h,"missing offset"),f.assert(h+3<e.length,"Trying to write beyond buffer length"),f.verifIEEE754(k,3.4028234663852886E38,-3.4028234663852886E38));if(!(h>=e.length))return Ha.write(e,k,h,d,23,4),h+4};f.prototype.writeFloatLE=function(e,k,h){return f.writeFloat(this,
e,k,!0,h)};f.prototype.writeFloatBE=function(e,k,h){return f.writeFloat(this,e,k,!1,h)};f.writeDouble=function(e,k,h,d,a){a||(f.assert(void 0!==k&&null!==k,"missing value"),f.assert("boolean"===typeof d,"missing or invalid endian"),f.assert(void 0!==h&&null!==h,"missing offset"),f.assert(h+7<e.length,"Trying to write beyond buffer length"),f.verifIEEE754(k,1.7976931348623157E308,-1.7976931348623157E308));if(!(h>=e.length))return Ha.write(e,k,h,d,52,8),h+8};f.prototype.writeDoubleLE=function(e,k,h){return f.writeDouble(this,
e,k,!0,h)};f.prototype.writeDoubleBE=function(e,k,h){return f.writeDouble(this,e,k,!1,h)};f.prototype.fill=function(e,k,h){e||(e=0);k||(k=0);h||(h=this.length);f.assert(h>=k,"end < start");if(h!==k&&0!==this.length){f.assert(0<=k&&k<this.length,"start out of bounds");f.assert(0<=h&&h<=this.length,"end out of bounds");if("number"===typeof e)for(;k<h;k++)this[k]=e;else{e=f.utf8ToBytes(e.toString());for(var d=e.length;k<h;k++)this[k]=e[k%d]}return this}};f.prototype.inspect=function(){for(var e=[],k=
this.length,h=0;h<k;h++)if(e[h]=f.toHex(this[h]),h===q.INSPECT_MAX_BYTES){e[h+1]="...";break}return"<Buffer "+e.join(" ")+">"};f.prototype.toArrayBuffer=function(){if("undefined"!==typeof Uint8Array){if(f._useTypedArrays)return(new f(this)).buffer;for(var e=new Uint8Array(this.length),k=0,h=e.length;k<h;k+=1)e[k]=this[k];return e.buffer}throw Error("Buffer.toArrayBuffer not supported in this browser");};var aa=f.prototype;f._augment=function(e){e._isBuffer=!0;e._get=e.get;e._set=e.set;e.get=aa.get;
e.set=aa.set;e.write=aa.write;e.toString=aa.toString;e.toLocaleString=aa.toString;e.toJSON=aa.toJSON;e.equals=aa.equals;e.compare=aa.compare;e.copy=aa.copy;e.slice=aa.slice;e.readUInt8=aa.readUInt8;e.readUInt16LE=aa.readUInt16LE;e.readUInt16BE=aa.readUInt16BE;e.readUInt32LE=aa.readUInt32LE;e.readUInt32BE=aa.readUInt32BE;e.readInt8=aa.readInt8;e.readInt16LE=aa.readInt16LE;e.readInt16BE=aa.readInt16BE;e.readInt32LE=aa.readInt32LE;e.readInt32BE=aa.readInt32BE;e.readFloatLE=aa.readFloatLE;e.readFloatBE=
aa.readFloatBE;e.readDoubleLE=aa.readDoubleLE;e.readDoubleBE=aa.readDoubleBE;e.writeUInt8=aa.writeUInt8;e.writeUInt16LE=aa.writeUInt16LE;e.writeUInt16BE=aa.writeUInt16BE;e.writeUInt32LE=aa.writeUInt32LE;e.writeUInt32BE=aa.writeUInt32BE;e.writeInt8=aa.writeInt8;e.writeInt16LE=aa.writeInt16LE;e.writeInt16BE=aa.writeInt16BE;e.writeInt32LE=aa.writeInt32LE;e.writeInt32BE=aa.writeInt32BE;e.writeFloatLE=aa.writeFloatLE;e.writeFloatBE=aa.writeFloatBE;e.writeDoubleLE=aa.writeDoubleLE;e.writeDoubleBE=aa.writeDoubleBE;
e.fill=aa.fill;e.inspect=aa.inspect;e.toArrayBuffer=aa.toArrayBuffer;return e};f.stringtrim=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")};f.clamp=function(e,k,h){if("number"!==typeof e)return h;e=~~e;if(e>=k)return k;if(0<=e)return e;e+=k;return 0<=e?e:0};f.coerce=function(e){e=~~Math.ceil(+e);return 0>e?0:e};f.isArray=function(e){return(Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)})(e)};f.isArrayish=function(e){return f.isArray(e)||f.isBuffer(e)||
e&&"object"===typeof e&&"number"===typeof e.length};f.toHex=function(e){return 16>e?"0"+e.toString(16):e.toString(16)};f.utf8ToBytes=function(e){for(var k=[],h=0;h<e.length;h++){var d=e.charCodeAt(h);if(127>=d)k.push(d);else{var a=h;55296<=d&&57343>=d&&h++;d=encodeURIComponent(e.slice(a,h+1)).substr(1).split("%");for(a=0;a<d.length;a++)k.push(parseInt(d[a],16))}}return k};f.asciiToBytes=function(e){for(var k=[],h=0;h<e.length;h++)k.push(e.charCodeAt(h)&255);return k};f.utf16leToBytes=function(e){for(var k,
h,d=[],a=0;a<e.length;a++)k=e.charCodeAt(a),h=k>>8,k%=256,d.push(k),d.push(h);return d};f.base64ToBytes=function(e){return Wc.toByteArray(e)};f.blitBuffer=function(e,k,h,d){for(var a=0;a<d&&!(a+h>=k.length||a>=e.length);a++)k[a+h]=e[a];return a};f.decodeUtf8Char=function(e){try{return decodeURIComponent(e)}catch(k){return String.fromCharCode(65533)}};f.verifuint=function(e,k){f.assert("number"===typeof e,"cannot write a non-number as a number");f.assert(0<=e,"specified a negative value for writing an unsigned value");
f.assert(e<=k,"value is larger than maximum value for type");f.assert(Math.floor(e)===e,"value has a fractional component")};f.verifsint=function(e,k,h){f.assert("number"===typeof e,"cannot write a non-number as a number");f.assert(e<=k,"value larger than maximum allowed value");f.assert(e>=h,"value smaller than minimum allowed value");f.assert(Math.floor(e)===e,"value has a fractional component")};f.verifIEEE754=function(e,k,h){f.assert("number"===typeof e,"cannot write a non-number as a number");
f.assert(e<=k,"value larger than maximum allowed value");f.assert(e>=h,"value smaller than minimum allowed value")};f.assert=function(e,k){if(!e)throw Error(k||"Failed assertion");};var Hc=function(){};q.Log=Hc;Hc.LOG=0;var Xc=a.printStackTrace,O={};q.NdnCommon=O;O.MAX_NDN_PACKET_SIZE=8800;O.getErrorWithStackTrace=function(e){return e+"\n"+Xc({e:e}).join("\n")};O.checkIndexedDb=function(e){try{var k=new Dexie("test-Dexie-support");k.version(1).stores({});k.open();setTimeout(function(){try{e(k.isOpen())}catch(d){e(!1)}},
200)}catch(h){e(!1)}};var O=a.NdnCommon,md=function(e,k,h,d){d=d||{};this.face=e;this.callerOnData=k;this.callerOnTimeout=h;this.maxInterestLifetime=d.maxInterestLifetime||16E3};q.ExponentialReExpress=md;md.makeOnTimeout=function(e,k,h,d){var a=new md(e,k,h,d);return function(d){a.onTimeout(d)}};md.prototype.onTimeout=function(e){var k=e.getInterestLifetimeMilliseconds();if(null==k){if(this.callerOnTimeout)try{this.callerOnTimeout(e)}catch(h){console.log("Error in onTimeout: "+O.getErrorWithStackTrace(h))}}else if(k*=
2,k>this.maxInterestLifetime){if(this.callerOnTimeout)try{this.callerOnTimeout(e)}catch(d){console.log("Error in onTimeout: "+O.getErrorWithStackTrace(d))}}else{e=e.clone();e.setInterestLifetimeMilliseconds(k);var a=this;this.face.expressInterest(e,this.callerOnData,function(d){a.onTimeout(d)})}};var p=function k(h,d){null==d&&(d=!0);null==h?this.buffer=null:"object"===typeof h&&h instanceof k?this.buffer=h.buffer:"string"===typeof h?this.buffer=new f(h,"utf8"):d?this.buffer=new f(h):f.isBuffer(h)?
this.buffer=h:this.buffer=new f(h);this.length=null!=this.buffer?this.buffer.length:0};q.Blob=p;p.prototype.size=function(){return null!=this.buffer?this.buffer.length:0};p.prototype.buf=function(){return this.buffer};p.prototype.isNull=function(){return null==this.buffer};p.prototype.toHex=function(){return null==this.buffer?"":this.buffer.toString("hex")};p.prototype.toString=function(){return null==this.buffer?"":this.buffer.toString("utf8")};p.prototype.equals=function(k){if(this.isNull())return k.isNull();
if(k.isNull())return!1;if(this.buffer!==k.buffer){if(this.buffer.length!=k.buffer.length)return!1;for(var h=0;h<this.buffer.length;++h)if(this.buffer[h]!=k.buffer[h])return!1}return!0};var p=a.Blob,Wa=function h(d,a,l){p.call(this,d);null==this.buffer?this.signedPortionEndOffset=this.signedPortionBeginOffset=0:"object"===typeof d&&d instanceof h?(this.signedPortionBeginOffset=null==a?d.signedPortionBeginOffset:a,this.signedPortionEndOffset=null==l?d.signedPortionEndOffset:l):(this.signedPortionBeginOffset=
a||0,this.signedPortionEndOffset=l||0);this.signedBuffer=null==this.buffer?null:this.buffer.slice(this.signedPortionBeginOffset,this.signedPortionEndOffset)};Wa.prototype=new p;Wa.prototype.name="SignedBlob";q.SignedBlob=Wa;Wa.prototype.signedSize=function(){return null!=this.signedBuffer?this.signedBuffer.length:0};Wa.prototype.signedBuf=function(){return this.signedBuffer};Wa.prototype.getSignedPortionBeginOffset=function(){return this.signedPortionBeginOffset};Wa.prototype.getSignedPortionEndOffset=
function(){return this.signedPortionEndOffset};var Xa=function(h){h||(h=16);this.array=new f(h)};q.DynamicBuffer=Xa;Xa.prototype.ensureLength=function(h){if(!(this.array.length>=h)){var d=2*this.array.length;h>d&&(d=h);h=new f(d);this.array.copy(h);this.array=h}};Xa.prototype.copy=function(h,d){this.ensureLength(h.length+d);f.isBuffer(h)?h.copy(this.array,d):(new f(h)).copy(this.array,d);return d+h.length};Xa.prototype.ensureLengthFromBack=function(h){if(!(this.array.length>=h)){var d=2*this.array.length;
h>d&&(d=h);h=new f(d);this.array.copy(h,h.length-this.array.length);this.array=h}};Xa.prototype.copyFromBack=function(h,d){this.ensureLengthFromBack(d);f.isBuffer(h)?h.copy(this.array,this.array.length-d):(new f(h)).copy(this.array,this.array.length-d)};Xa.prototype.slice=function(h,d){return void 0==d?this.array.slice(h):this.array.slice(h,d)};var ma=function(h){this.target=h;this.changeCount=null==h?0:h.getChangeCount()};q.ChangeCounter=ma;ma.prototype.get=function(){return this.target};ma.prototype.set=
function(h){this.target=h;this.changeCount=null==h?0:h.getChangeCount()};ma.prototype.checkChanged=function(){if(null==this.target)return!1;var h=this.target.getChangeCount();return this.changeCount!=h?(this.changeCount=h,!0):!1};var O=a.NdnCommon,b=function(h,d){this.value=h;this.isRejected=d};q.SyncPromise=b;b.prototype.then=function(h,d){if(this.isRejected)if(d)try{return d(this.value)}catch(a){return new b(a,!0)}else return this;else if(h)try{return h(this.value)}catch(l){return new b(l,!0)}else return this};
b.prototype.catch=function(h){return this.then(void 0,h)};b.resolve=function(h){return new b(h,!1)};b.reject=function(h){return new b(h,!0)};b.getValue=function(h){if(h instanceof b){if(h.isRejected)throw h.value;return h.value}throw Error("Cannot return immediately because promise is not a SyncPromise");};b.complete=function(h,d,a){var l;a?l=d:(a=d,l=null);if(h)a.then(function(d){try{h(d)}catch(a){console.log("Error in onComplete: "+O.getErrorWithStackTrace(a))}},function(d){if(l)try{l(d)}catch(h){console.log("Error in onError: "+
O.getErrorWithStackTrace(h))}else{if(a instanceof b)throw d;console.log("Uncaught exception from a Promise: "+O.getErrorWithStackTrace(d))}});else return b.getValue(a)};var L={};q.DataUtils=L;L.keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";L.stringtoBase64=function(h){var d="",a,l,b="",c,f,g="",m=0;do a=h.charCodeAt(m++),l=h.charCodeAt(m++),b=h.charCodeAt(m++),c=a>>2,a=(a&3)<<4|l>>4,f=(l&15)<<2|b>>6,g=b&63,isNaN(l)?f=g=64:isNaN(b)&&(g=64),d=d+L.keyStr.charAt(c)+L.keyStr.charAt(a)+
L.keyStr.charAt(f)+L.keyStr.charAt(g);while(m<h.length);return d};L.base64toString=function(h){var d="",a,l,b="",c,f="",g=0;/[^A-Za-z0-9\+\/\=]/g.exec(h)&&alert("There were invalid base64 characters in the input text.\nValid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\nExpect errors in decoding.");h=h.replace(/[^A-Za-z0-9\+\/\=]/g,"");do a=L.keyStr.indexOf(h.charAt(g++)),l=L.keyStr.indexOf(h.charAt(g++)),c=L.keyStr.indexOf(h.charAt(g++)),f=L.keyStr.indexOf(h.charAt(g++)),a=a<<2|l>>4,l=(l&
15)<<4|c>>2,b=(c&3)<<6|f,d+=String.fromCharCode(a),64!=c&&(d+=String.fromCharCode(l)),64!=f&&(d+=String.fromCharCode(b));while(g<h.length);return d};L.toHex=function(h){return h.toString("hex")};L.stringToHex=function(h){for(var d="",a=0;a<h.length;++a)var l=h.charCodeAt(a),d=d+((16>l?"0":"")+l.toString(16));return d};L.toString=function(h){return h.toString("binary")};L.toNumbers=function(h){return new f(h,"hex")};L.hexToRawString=function(h){if("string"==typeof h){var d="";h.replace(/(..)/g,function(h){d+=
String.fromCharCode(parseInt(h,16))});return d}};L.toNumbersFromString=function(h){return new f(h,"binary")};L.toNumbersIfString=function(h){return"string"===typeof h?new f(h,"binary"):h};L.stringToUtf8Array=function(h){return new f(h,"utf8")};L.concatArrays=function(h){return f.concat(h)};L.decodeUtf8=function(h){for(var d="",a=0,l=0,b=0;a<h.length;)if(l=h.charCodeAt(a),128>l)d+=String.fromCharCode(l),a++;else if(191<l&&224>l)b=h.charCodeAt(a+1),d+=String.fromCharCode((l&31)<<6|b&63),a+=2;else var b=
h.charCodeAt(a+1),c=h.charCodeAt(a+2),d=d+String.fromCharCode((l&15)<<12|(b&63)<<6|c&63),a=a+3;return d};L.arraysEqual=function(h,d){if(!h.slice)throw Error("DataUtils.arraysEqual: a1 is not an array");if(!d.slice)throw Error("DataUtils.arraysEqual: a2 is not an array");if(h.length!=d.length)return!1;for(var a=0;a<h.length;++a)if(h[a]!=d[a])return!1;return!0};L.bigEndianToUnsignedInt=function(h){for(var d=0,a=0;a<h.length;++a)d*=256,d+=h[a];return d};L.nonNegativeIntToBigEndian=function(h){h=Math.round(h);
if(0>=h)return new f(0);for(var d=new f(8),a=0;0!=h;)++a,d[8-a]=h&255,h=Math.floor(h/256);return d.slice(8-a,8)};L.shuffle=function(h){for(var d=h.length-1;1<=d;--d){var a=Math.floor(Math.random()*(d+1)),l=h[d];h[d]=h[a];h[a]=l}};L.privateKeyPemToDer=function(h){h=h.split("\n");for(var d="",a=1;a<h.length-1;a++)d+=h[a];return new f(d,"base64")};R.prototype=Error();R.prototype.name="DecodingException";q.DecodingException=R;var n=function(){};q.Tlv=n;n.Interest=5;n.Data=6;n.Name=7;n.ImplicitSha256DigestComponent=
1;n.ParametersSha256DigestComponent=2;n.NameComponent=8;n.Selectors=9;n.Nonce=10;n.InterestLifetime=12;n.MinSuffixComponents=13;n.MaxSuffixComponents=14;n.PublisherPublicKeyLocator=15;n.Exclude=16;n.ChildSelector=17;n.MustBeFresh=18;n.Any=19;n.MetaInfo=20;n.Content=21;n.SignatureInfo=22;n.SignatureValue=23;n.ContentType=24;n.FreshnessPeriod=25;n.FinalBlockId=26;n.SignatureType=27;n.KeyLocator=28;n.KeyLocatorDigest=29;n.ForwardingHint=30;n.SelectedDelegation=32;n.CanBePrefix=33;n.HopLimit=34;n.Parameters=
35;n.FaceInstance=128;n.ForwardingEntry=129;n.StatusResponse=130;n.Action=131;n.FaceID=132;n.IPProto=133;n.Host=134;n.Port=135;n.MulticastInterface=136;n.MulticastTTL=137;n.ForwardingFlags=138;n.StatusCode=139;n.StatusText=140;n.SignatureType_DigestSha256=0;n.SignatureType_SignatureSha256WithRsa=1;n.SignatureType_SignatureSha256WithEcdsa=3;n.SignatureType_SignatureHmacWithSha256=4;n.ContentType_Default=0;n.ContentType_Link=1;n.ContentType_Key=2;n.NfdCommand_ControlResponse=101;n.NfdCommand_StatusCode=
102;n.NfdCommand_StatusText=103;n.ControlParameters_ControlParameters=104;n.ControlParameters_FaceId=105;n.ControlParameters_Uri=114;n.ControlParameters_LocalUri=129;n.ControlParameters_LocalControlFeature=110;n.ControlParameters_Origin=111;n.ControlParameters_Cost=106;n.ControlParameters_Capacity=131;n.ControlParameters_Count=132;n.ControlParameters_BaseCongestionMarkingInterval=135;n.ControlParameters_DefaultCongestionThreshold=136;n.ControlParameters_Mtu=137;n.ControlParameters_Flags=108;n.ControlParameters_Mask=
112;n.ControlParameters_Strategy=107;n.ControlParameters_ExpirationPeriod=109;n.LpPacket_LpPacket=100;n.LpPacket_Fragment=80;n.LpPacket_Sequence=81;n.LpPacket_FragIndex=82;n.LpPacket_FragCount=83;n.LpPacket_Nack=800;n.LpPacket_NackReason=801;n.LpPacket_NextHopFaceId=816;n.LpPacket_IncomingFaceId=817;n.LpPacket_CachePolicy=820;n.LpPacket_CachePolicyType=821;n.LpPacket_CongestionMark=832;n.LpPacket_IGNORE_MIN=800;n.LpPacket_IGNORE_MAX=959;n.Link_Preference=30;n.Link_Delegation=31;n.Encrypt_EncryptedContent=
130;n.Encrypt_EncryptionAlgorithm=131;n.Encrypt_EncryptedPayload=132;n.Encrypt_InitialVector=133;n.SafeBag_SafeBag=128;n.SafeBag_EncryptedKeyBag=129;n.Encrypt_StartDate=134;n.Encrypt_EndDate=135;n.Encrypt_IntervalStartHour=136;n.Encrypt_IntervalEndHour=137;n.Encrypt_NRepeats=138;n.Encrypt_RepeatUnit=139;n.Encrypt_RepetitiveInterval=140;n.Encrypt_WhiteIntervalList=141;n.Encrypt_BlackIntervalList=142;n.Encrypt_Schedule=143;n.ValidityPeriod_ValidityPeriod=253;n.ValidityPeriod_NotBefore=254;n.ValidityPeriod_NotAfter=
255;n.getHighBytes=function(h){return(h-h%4294967296)/4294967296};var Xa=a.DynamicBuffer,n=a.Tlv,ta=function(h){this.output=new Xa(h||16);this.length=0};q.TlvEncoder=ta;ta.prototype.getLength=function(){return this.length};ta.prototype.writeVarNumber=function(h){if(253>h)this.length+=1,this.output.ensureLengthFromBack(this.length),this.output.array[this.output.array.length-this.length]=h&255;else if(65535>=h){this.length+=3;this.output.ensureLengthFromBack(this.length);var d=this.output.array.length-
this.length;this.output.array[d]=253;this.output.array[d+1]=h>>8&255;this.output.array[d+2]=h&255}else if(4294967295>=h)this.length+=5,this.output.ensureLengthFromBack(this.length),d=this.output.array.length-this.length,this.output.array[d]=254,this.output.array[d+1]=h>>24&255,this.output.array[d+2]=h>>16&255,this.output.array[d+3]=h>>8&255,this.output.array[d+4]=h&255;else{this.length+=9;this.output.ensureLengthFromBack(this.length);d=this.output.array.length-this.length;this.output.array[d]=255;
var a=n.getHighBytes(h);this.output.array[d+1]=a>>24&255;this.output.array[d+2]=a>>16&255;this.output.array[d+3]=a>>8&255;this.output.array[d+4]=a&255;this.output.array[d+5]=h>>24&255;this.output.array[d+6]=h>>16&255;this.output.array[d+7]=h>>8&255;this.output.array[d+8]=h&255}};ta.prototype.writeTypeAndLength=function(h,d){this.writeVarNumber(d);this.writeVarNumber(h)};ta.prototype.writeNonNegativeInteger=function(h){if(0>h)throw Error("TLV integer value may not be negative");h=Math.round(h);if(255>=
h)this.length+=1,this.output.ensureLengthFromBack(this.length),this.output.array[this.output.array.length-this.length]=h&255;else if(65535>=h){this.length+=2;this.output.ensureLengthFromBack(this.length);var d=this.output.array.length-this.length;this.output.array[d]=h>>8&255;this.output.array[d+1]=h&255}else if(4294967295>=h)this.length+=4,this.output.ensureLengthFromBack(this.length),d=this.output.array.length-this.length,this.output.array[d]=h>>24&255,this.output.array[d+1]=h>>16&255,this.output.array[d+
2]=h>>8&255,this.output.array[d+3]=h&255;else{this.length+=8;this.output.ensureLengthFromBack(this.length);var d=this.output.array.length-this.length,a=n.getHighBytes(h);this.output.array[d]=a>>24&255;this.output.array[d+1]=a>>16&255;this.output.array[d+2]=a>>8&255;this.output.array[d+3]=a&255;this.output.array[d+4]=h>>24&255;this.output.array[d+5]=h>>16&255;this.output.array[d+6]=h>>8&255;this.output.array[d+7]=h&255}};ta.prototype.writeNonNegativeIntegerTlv=function(h,d){var a=this.length;this.writeNonNegativeInteger(d);
this.writeTypeAndLength(h,this.length-a)};ta.prototype.writeOptionalNonNegativeIntegerTlv=function(h,d){null!=d&&0<=d&&this.writeNonNegativeIntegerTlv(h,d)};ta.prototype.writeBuffer=function(h){null!=h&&(this.length+=h.length,this.output.copyFromBack(h,this.length))};ta.prototype.writeBlobTlv=function(h,d){null==d?this.writeTypeAndLength(h,0):(this.writeBuffer(d),this.writeTypeAndLength(h,d.length))};ta.prototype.writeOptionalBlobTlv=function(h,d){null!=d&&0<d.length&&this.writeBlobTlv(h,d)};ta.prototype.getOutput=
function(){return this.output.array.slice(this.output.array.length-this.length)};var R=a.DecodingException,na=function(h){this.input=h;this.offset=0};q.TlvDecoder=na;na.prototype.readVarNumber=function(){var h=this.input[this.offset];this.offset+=1;return 253>h?h:this.readExtendedVarNumber(h)};na.prototype.readExtendedVarNumber=function(h){253==h?(h=(this.input[this.offset]<<8)+this.input[this.offset+1],this.offset+=2):254==h?(h=Math.abs(this.input[this.offset]<<24)+(this.input[this.offset+1]<<16)+
(this.input[this.offset+2]<<8)+this.input[this.offset+3],this.offset+=4):(h=4294967296*(Math.abs(this.input[this.offset]<<24)+(this.input[this.offset+1]<<16)+(this.input[this.offset+2]<<8)+this.input[this.offset+3])+(this.input[this.offset+4]<<24)+(this.input[this.offset+5]<<16)+(this.input[this.offset+6]<<8)+this.input[this.offset+7],this.offset+=8);return h};na.prototype.readTypeAndLength=function(h){if(this.readVarNumber()!=h)throw new R(Error("Did not get the expected TLV type"));h=this.readVarNumber();
if(this.offset+h>this.input.length)throw new R(Error("TLV length exceeds the buffer length"));return h};na.prototype.readNestedTlvsStart=function(h){return this.readTypeAndLength(h)+this.offset};na.prototype.finishNestedTlvs=function(h,d){if(this.offset!=h){for(void 0==d&&(d=!1);this.offset<h;){var a=this.readVarNumber();if((31>=a||1==(a&1))&&!d)throw new R(Error("Unrecognized critical type code "+a));a=this.readVarNumber();this.offset+=a;if(this.offset>this.input.length)throw new R(Error("TLV length exceeds the buffer length"));
}if(this.offset!=h)throw new R(Error("TLV length does not equal the total length of the nested TLVs"));}};na.prototype.peekType=function(h,d){if(this.offset>=d)return!1;var a=this.offset,l=this.readVarNumber();this.offset=a;return l==h};na.prototype.readNonNegativeInteger=function(h){var d;if(1==h)d=this.input[this.offset];else if(2==h)d=(this.input[this.offset]<<8)+this.input[this.offset+1];else if(4==h)d=Math.abs(this.input[this.offset]<<24)+(this.input[this.offset+1]<<16)+(this.input[this.offset+
2]<<8)+this.input[this.offset+3];else if(8==h)d=4294967296*(Math.abs(this.input[this.offset]<<24)+(this.input[this.offset+1]<<16)+(this.input[this.offset+2]<<8)+this.input[this.offset+3])+Math.abs(this.input[this.offset+4]<<24)+(this.input[this.offset+5]<<16)+(this.input[this.offset+6]<<8)+this.input[this.offset+7];else throw new R(Error("Invalid length for a TLV nonNegativeInteger"));this.offset+=h;return d};na.prototype.readNonNegativeIntegerTlv=function(h){h=this.readTypeAndLength(h);return this.readNonNegativeInteger(h)};
na.prototype.readOptionalNonNegativeIntegerTlv=function(h,d){return this.peekType(h,d)?this.readNonNegativeIntegerTlv(h):null};na.prototype.readBlobTlv=function(h){h=this.readTypeAndLength(h);var d=this.input.slice(this.offset,this.offset+h);this.offset+=h;return d};na.prototype.readOptionalBlobTlv=function(h,d){return this.peekType(h,d)?this.readBlobTlv(h):null};na.prototype.readBooleanTlv=function(h,d){if(this.peekType(h,d)){var a=this.readTypeAndLength(h);this.offset+=a;return!0}return!1};na.prototype.skipTlv=
function(h){h=this.readTypeAndLength(h);this.offset+=h};na.prototype.skipOptionalTlv=function(h,d){this.peekType(h,d)&&this.skipTlv(h)};na.prototype.getOffset=function(){return this.offset};na.prototype.seek=function(h){this.offset=h};na.prototype.getSlice=function(h,d){return this.input.slice(h,d)};var na=a.TlvDecoder,H=function d(){this.gotElementEnd_=!1;this.offset_=0;this.state_=d.READ_TYPE;this.headerLength_=0;this.useHeaderBuffer_=!1;this.headerBuffer_=new f(8);this.nBytesToRead_=0};q.TlvStructureDecoder=
H;H.READ_TYPE=0;H.READ_TYPE_BYTES=1;H.READ_LENGTH=2;H.READ_LENGTH_BYTES=3;H.READ_VALUE_BYTES=4;H.prototype.findElementEnd=function(d){if(this.gotElementEnd_)return!0;for(var a=new na(d);;){if(this.offset_>=d.length)return!1;if(this.state_==H.READ_TYPE){var l=d[this.offset_];this.offset_+=1;253>l?this.state_=H.READ_LENGTH:(this.nBytesToRead_=253==l?2:254==l?4:8,this.state_=H.READ_TYPE_BYTES)}else if(this.state_==H.READ_TYPE_BYTES){l=d.length-this.offset_;if(l<this.nBytesToRead_)return this.offset_+=
l,this.nBytesToRead_-=l,!1;this.offset_+=this.nBytesToRead_;this.state_=H.READ_LENGTH}else if(this.state_==H.READ_LENGTH)if(l=d[this.offset_],this.offset_+=1,253>l){this.nBytesToRead_=l;if(0==this.nBytesToRead_)return this.gotElementEnd_=!0;this.state_=H.READ_VALUE_BYTES}else this.nBytesToRead_=253==l?2:254==l?4:8,this.firstOctet_=l,this.state_=H.READ_LENGTH_BYTES;else if(this.state_==H.READ_LENGTH_BYTES){l=d.length-this.offset_;if(!this.useHeaderBuffer_&&l>=this.nBytesToRead_)a.seek(this.offset_),
this.nBytesToRead_=a.readExtendedVarNumber(this.firstOctet_),this.offset_=a.getOffset();else{this.useHeaderBuffer_=!0;var b=this.nBytesToRead_-this.headerLength_;if(b>l){if(this.headerLength_+l>this.headerBuffer_.length)throw Error("Cannot store more header bytes than the size of headerBuffer");d.slice(this.offset_,this.offset_+l).copy(this.headerBuffer_,this.headerLength_);this.offset_+=l;this.headerLength_+=l;return!1}if(this.headerLength_+b>this.headerBuffer_.length)throw Error("Cannot store more header bytes than the size of headerBuffer");
d.slice(this.offset_,this.offset_+b).copy(this.headerBuffer_,this.headerLength_);this.offset_+=b;this.nBytesToRead_=(new na(this.headerBuffer_)).readExtendedVarNumber(this.firstOctet_)}if(0==this.nBytesToRead_)return this.gotElementEnd_=!0;this.state_=H.READ_VALUE_BYTES}else{if(this.state_==H.READ_VALUE_BYTES){l=d.length-this.offset_;if(l<this.nBytesToRead_)return this.offset_+=l,this.nBytesToRead_-=l,!1;this.offset_+=this.nBytesToRead_;return this.gotElementEnd_=!0}throw Error("findElementEnd: unrecognized state");
}}};H.prototype.getOffset=function(){return this.offset_};H.prototype.seek=function(d){this.offset_=d};var ta=a.TlvEncoder,na=a.TlvDecoder,p=a.Blob,c=a.Name,eb=function(){};q.ProtobufTlv=eb;eb._Field=null;eb.establishField=function(){if(null===eb._Field)try{eb._Field=dcodeIO.ProtoBuf.Reflect.Message.Field}catch(d){eb._Field=a.Reflect.Message.Field}};eb.encode=function(d,a){eb.establishField();d.encodeAB();var l=new ta;eb._encodeMessageValue(d,a,l);return new p(l.getOutput(),!1)};eb.decode=function(d,
a,l){eb.establishField();l="object"===typeof l&&l instanceof p?l.buf():l;var b=new na(l);eb._decodeMessageValue(d,a,b,l.length)};eb._encodeMessageValue=function(d,a,l){a=a.getChildren(eb._Field);for(var b=a.length-1;0<=b;--b){var c=a[b],g=c.id,m;if(c.repeated)m=d[c.name];else if(null!=d[c.name])m=[d[c.name]];else continue;for(var n=m.length-1;0<=n;--n){var s=m[n];if("message"==c.type.name){var q=l.getLength();eb._encodeMessageValue(s,c.resolvedType,l);l.writeTypeAndLength(g,l.getLength()-q)}else if("uint32"==
c.type.name||"uint64"==c.type.name)l.writeNonNegativeIntegerTlv(g,s);else if("enum"==c.type.name){if(0>s)throw Error("ProtobufTlv.encode: ENUM value may not be negative");l.writeNonNegativeIntegerTlv(g,s)}else if("bytes"==c.type.name)q=s.toBuffer(),void 0==q.length&&(q=new Uint8Array(s.toArrayBuffer())),l.writeBlobTlv(g,q);else if("string"==c.type.name)l.writeBlobTlv(g,(new p(s,!1)).buf());else if("bool"==c.type.name)s&&l.writeTypeAndLength(g,0);else if("double"==c.type.name)q=new f(8),q.writeDoubleLE(s,
0),l.writeBlobTlv(g,q);else throw Error("ProtobufTlv.encode: Unknown field type");}}};eb._decodeMessageValue=function(d,a,l,b){a=a.getChildren(eb._Field);for(var c=0;c<a.length;++c){var f=a[c],g=f.id;if(f.required||l.peekType(g,b))if(f.repeated)for(;l.peekType(g,b);)if("message"==f.type.name){var m=l.readNestedTlvsStart(g),n=new (f.resolvedType.build());d.add(f.name,n);eb._decodeMessageValue(n,f.resolvedType,l,m);l.finishNestedTlvs(m)}else d.add(f.name,eb._decodeFieldValue(f,g,l,b));else"message"==
f.type.name?(m=l.readNestedTlvsStart(g),n=new (f.resolvedType.build()),d.set(f.name,n),eb._decodeMessageValue(n,f.resolvedType,l,m),l.finishNestedTlvs(m)):d.set(f.name,eb._decodeFieldValue(f,g,l,b))}};eb._decodeFieldValue=function(d,a,l,b){if("uint32"==d.type.name||"uint64"==d.type.name||"enum"==d.type.name)return l.readNonNegativeIntegerTlv(a);if("bytes"==d.type.name)return l.readBlobTlv(a);if("string"==d.type.name)return l.readBlobTlv(a).toString();if("bool"==d.type.name)return l.readBooleanTlv(a,
b);if("double"==d.type.name)return l.readBlobTlv(a).readDoubleLE(0);throw Error("ProtobufTlv.decode: Unknown field type");};eb.toName=function(d){for(var a=new c,l=0;l<d.length;++l)a.append(new p(new f(d[l].toBinary(),"binary"),!1));return a};var fb=function(d){if("string"===typeof d){d=d.split(".");this.oid=[];for(var a=0;a<d.length;++a)this.oid.push(parseInt(d[a]))}else this.oid=d.slice(0,d.length)};q.OID=fb;fb.prototype.getIntegerList=function(){return this.oid};fb.prototype.setIntegerList=function(d){this.oid=
d.slice(0,d.length)};fb.prototype.toString=function(){for(var d="",a=0;a<this.oid.length;++a)0!==a&&(d+="."),d+=this.oid[a];return d};fb.prototype.equals=function(d){if(!(d instanceof fb)||this.oid.length!==d.oid.length)return!1;for(var a=0;a<this.oid.length;++a)if(this.oid[a]!=d.oid[a])return!1;return!0};var s=function(){};q.WireFormat=s;s.prototype.encodeName=function(d){throw Error("encodeName is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.decodeName=
function(d,a,l){throw Error("decodeName is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.encodeInterest=function(d){throw Error("encodeInterest is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.decodeInterest=function(d,a,l){throw Error("decodeInterest is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.encodeData=function(d){throw Error("encodeData is unimplemented in the base WireFormat class.  You should use a derived class.");
};s.prototype.decodeData=function(d,a,l){throw Error("decodeData is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.encodeControlParameters=function(d){throw Error("encodeControlParameters is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.decodeControlParameters=function(d,a,l){throw Error("decodeControlParameters is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.encodeControlResponse=
function(d){throw Error("encodeControlResponse is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.decodeControlResponse=function(d,a,l){throw Error("decodeControlResponse is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.encodeSignatureInfo=function(d){throw Error("encodeSignatureInfo is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.decodeSignatureInfoAndValue=
function(d,a,l){throw Error("decodeSignatureInfoAndValue is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.encodeSignatureValue=function(d){throw Error("encodeSignatureValue is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.decodeLpPacket=function(d,a,l){throw Error("decodeLpPacket is unimplemented in the base WireFormat class. You should use a derived class.");};s.prototype.encodeDelegationSet=function(d){throw Error("encodeDelegationSet is unimplemented in the base WireFormat class. You should use a derived class.");
};s.prototype.decodeDelegationSet=function(d,a,l){throw Error("decodeDelegationSet is unimplemented in the base WireFormat class. You should use a derived class.");};s.prototype.encodeEncryptedContent=function(d){throw Error("encodeEncryptedContent is unimplemented in the base WireFormat class. You should use a derived class.");};s.prototype.decodeEncryptedContent=function(d,a,l){throw Error("decodeEncryptedContent is unimplemented in the base WireFormat class. You should use a derived class.");};
s.setDefaultWireFormat=function(d){s.defaultWireFormat=d};s.getDefaultWireFormat=function(){return s.defaultWireFormat};var bb=a.TlvWireFormat,L=a.DataUtils,n=a.Tlv,H=a.TlvStructureDecoder,R=a.DecodingException,O=a.NdnCommon,g=a.Log.LOG,Md=function(d){this.elementListener_=d;this.dataParts_=[];this.tlvStructureDecoder_=new H};q.ElementReader=Md;Md.prototype.onReceivedData=function(d){for(;;){var a,l;try{if(0===this.dataParts_.length&&0>=d.length)break;this.tlvStructureDecoder_.seek(0);a=this.tlvStructureDecoder_.findElementEnd(d);
l=this.tlvStructureDecoder_.getOffset()}catch(b){throw this.dataParts_=[],this.tlvStructureDecoder_=new H,b;}if(a){var c;0===this.dataParts_.length?c=d.slice(0,l):(this.dataParts_.push(d.slice(0,l)),c=L.concatArrays(this.dataParts_),this.dataParts_=[]);d=d.slice(l,d.length);this.tlvStructureDecoder_=new H;this.elementListener_.onReceivedElement(c);if(0==d.length)break}else{a=d.length;for(l=0;l<this.dataParts_.length;++l)a+=this.dataParts_[l].length;if(a>O.MAX_NDN_PACKET_SIZE)throw this.dataParts_=
[],this.tlvStructureDecoder_=new H,new R(Error("The incoming packet exceeds the maximum limit Face.getMaxNdnPacketSize()"));this.dataParts_.push(new f(d));3<g&&console.log("Incomplete packet received. Length "+d.length+". Wait for more input.");break}}};sa.prototype=Error();sa.prototype.name="DerDecodingException";q.DerDecodingException=sa;Gb.prototype=Error();Gb.prototype.name="DerEncodingException";q.DerEncodingException=Gb;var P=function(){};q.DerNodeType=P;P.Eoc=0;P.Boolean=1;P.Integer=2;P.BitString=
3;P.OctetString=4;P.Null=5;P.ObjectIdentifier=6;P.ObjectDescriptor=7;P.External=40;P.Real=9;P.Enumerated=10;P.EmbeddedPdv=43;P.Utf8String=12;P.RelativeOid=13;P.Sequence=48;P.Set=49;P.NumericString=18;P.PrintableString=19;P.T61String=20;P.VideoTexString=21;P.Ia5String=22;P.UtcTime=23;P.GeneralizedTime=24;P.GraphicString=25;P.VisibleString=26;P.GeneralString=27;P.UniversalString=28;P.CharacterString=29;P.BmpString=30;var Xa=a.DynamicBuffer,p=a.Blob,sa=a.DerDecodingException,Gb=a.DerEncodingException,
P=a.DerNodeType,m=function(d){this.nodeType_=d;this.parent_=null;this.header_=new f(0);this.payload_=new Xa(0);this.payloadPosition_=0};q.DerNode=m;m.prototype.getSize=function(){return this.header_.length+this.payloadPosition_};m.prototype.encodeHeader=function(d){var a=new Xa(10),l=0;a.array[l++]=this.nodeType_;if(0>d)throw Error("encodeHeader: DER object has negative length");if(127>=d)a.array[l++]=d&255;else{var b=new Xa(10),c=d;for(d=0;0!=c;)++d,b.ensureLengthFromBack(d),b.array[b.array.length-
d]=c&255,c>>=8;c=d+1;b.ensureLengthFromBack(c);b.array[b.array.length-c]=(128|d)&255;a.copy(b.slice(b.array.length-c),l);l+=c}this.header_=a.slice(0,l)};m.prototype.decodeHeader=function(d,a){var l=a,b=d[l]&255,l=l+1;this.nodeType_=b;var c=d[l]&255,l=l+1,f=new Xa(10),g=0;f.array[g++]=b;b=f.array[g++]=c;if(0!=(c&128))for(c&=127,b=0;0<c;){if(d.length<=l)throw new sa("DerNode.decodeHeader: The input length is too small");var m=d[l],l=l+1;f.ensureLength(g+1);f.array[g++]=m;b=256*b+(m&255);c-=1}this.header_=
f.slice(0,g);return b};m.prototype.encode=function(){var d=new f(this.getSize());this.header_.copy(d);this.payload_.slice(0,this.payloadPosition_).copy(d,this.header_.length);return new p(d,!1)};m.prototype.decode=function(d,a){var l=a,b=this.decodeHeader(d,l),c=this.header_.length;0<b&&(l+=c,this.payloadAppend(d.slice(l,l+b)))};m.prototype.payloadAppend=function(d){this.payloadPosition_=this.payload_.copy(d,this.payloadPosition_)};m.parse=function(d,a){void 0==a&&(a=0);if(d.length<=a)throw new sa("DerNode.parse: The input length is too small");
var l=d[a]&255;if(l===P.Boolean)l=new m.DerBoolean;else if(l===P.Integer)l=new m.DerInteger;else if(l===P.BitString)l=new m.DerBitString;else if(l===P.OctetString)l=new m.DerOctetString;else if(l===P.Null)l=new m.DerNull;else if(l===P.ObjectIdentifier)l=new m.DerOid;else if(l===P.Sequence)l=new m.DerSequence;else if(l===P.PrintableString)l=new m.DerPrintableString;else if(l===P.GeneralizedTime)l=new m.DerGeneralizedTime;else throw new sa(Error("Unimplemented DER type "+l));l.decode(d,a);return l};
m.prototype.toVal=function(){return this.encode()};m.prototype.getPayload=function(){return new p(this.payload_.slice(0,this.payloadPosition_),!0)};m.prototype.getChildren=function(){throw new sa(Error("getChildren: This DerNode is not DerSequence"));};m.getSequence=function(d,a){if(0>a||a>=d.length)throw new sa(Error("getSequence: Child index is out of bounds"));if(!(d[a]instanceof m.DerSequence))throw new sa(Error("getSequence: Child DerNode is not a DerSequence"));return d[a]};m.DerStructure=function(d){m.call(this,
d);this.childChanged_=!1;this.nodeList_=[];this.size_=0};m.DerStructure.prototype=new m;m.DerStructure.prototype.name="DerStructure";m.DerStructure.prototype.getSize=function(){this.childChanged_&&(this.updateSize(),this.childChanged_=!1);this.encodeHeader(this.size_);return this.size_+this.header_.length};m.DerStructure.prototype.getChildren=function(){return this.nodeList_};m.DerStructure.prototype.updateSize=function(){for(var d=0,a=0;a<this.nodeList_.length;++a)d+=this.nodeList_[a].getSize();
this.size_=d;this.childChanged_=!1};m.DerStructure.prototype.addChild=function(d,a){d.parent_=this;this.nodeList_.push(d);a&&null!=this.parent_&&this.parent_.setChildChanged();this.childChanged_=!0};m.DerStructure.prototype.setChildChanged=function(){null!=this.parent_&&this.parent_.setChildChanged();this.childChanged_=!0};m.DerStructure.prototype.encode=function(){var d=new Xa(10),a=0;this.updateSize();this.encodeHeader(this.size_);for(var a=d.copy(this.header_,a),l=0;l<this.nodeList_.length;++l)var b=
this.nodeList_[l].encode(),a=d.copy(b.buf(),a);return new p(d.slice(0,a),!1)};m.DerStructure.prototype.decode=function(d,a){var l=a;this.size_=this.decodeHeader(d,l);for(var l=l+this.header_.length,b=0;b<this.size_;){var c=m.parse(d,l),f=c.getSize(),l=l+f,b=b+f;this.addChild(c,!1)}};m.DerByteString=function(d,a){m.call(this,a);null!=d&&(this.payloadAppend(d),this.encodeHeader(d.length))};m.DerByteString.prototype=new m;m.DerByteString.prototype.name="DerByteString";m.DerByteString.prototype.toVal=
function(){return this.getPayload()};m.DerBoolean=function(d){m.call(this,P.Boolean);void 0!=d&&(d=d?255:0,this.payload_.ensureLength(this.payloadPosition_+1),this.payload_.array[this.payloadPosition_++]=d,this.encodeHeader(1))};m.DerBoolean.prototype=new m;m.DerBoolean.prototype.name="DerBoolean";m.DerBoolean.prototype.toVal=function(){return 0!=this.payload_.array[0]};m.DerInteger=function(d){m.call(this,P.Integer);if(void 0!=d){if(f.isBuffer(d)){if(0<d.length&&128<=d[0])throw new Gb(Error("DerInteger: Negative integers are not currently supported"));
0==d.length?this.payloadAppend(new f([0])):this.payloadAppend(d)}else{d=Math.round(d);if(0>d)throw new Gb(Error("DerInteger: Negative integers are not currently supported"));for(var a=new Xa(10),l=0;!(++l,a.ensureLengthFromBack(l),a.array[a.array.length-l]=d&255,d>>=8,0>=d););128<=a.array[a.array.length-l]&&(++l,a.ensureLengthFromBack(l),a.array[a.array.length-l]=0);this.payloadAppend(a.slice(a.array.length-l))}this.encodeHeader(this.payloadPosition_)}};m.DerInteger.prototype=new m;m.DerInteger.prototype.name=
"DerInteger";m.DerInteger.prototype.toVal=function(){if(0<this.payloadPosition_&&128<=this.payload_.array[0])throw new sa(Error("DerInteger: Negative integers are not currently supported"));for(var d=0,a=0;a<this.payloadPosition_;++a)d<<=8,d+=this.payload_.array[a];return d};m.DerBitString=function(d,a){m.call(this,P.BitString);void 0!=d&&(this.payload_.ensureLength(this.payloadPosition_+1),this.payload_.array[this.payloadPosition_++]=a&255,this.payloadAppend(d),this.encodeHeader(this.payloadPosition_))};
m.DerBitString.prototype=new m;m.DerBitString.prototype.name="DerBitString";m.DerOctetString=function(d){m.DerByteString.call(this,d,P.OctetString)};m.DerOctetString.prototype=new m.DerByteString;m.DerOctetString.prototype.name="DerOctetString";m.DerNull=function(){m.call(this,P.Null);this.encodeHeader(0)};m.DerNull.prototype=new m;m.DerNull.prototype.name="DerNull";m.DerOid=function(d){m.call(this,P.ObjectIdentifier);if(void 0!=d)if("string"===typeof d){d=d.split(".");for(var a=[],l=0;l<d.length;++l)a.push(parseInt(d[l]));
this.prepareEncoding(a)}else this.prepareEncoding(d.getIntegerList())};m.DerOid.prototype=new m;m.DerOid.prototype.name="DerOid";m.DerOid.prototype.prepareEncoding=function(d){var a;if(0==d.length)throw new Gb(Error("No integer in OID"));if(0<=d[0]&&2>=d[0])a=40*d[0];else throw new Gb(Error("First integer in OID is out of range"));if(2<=d.length)if(0<=d[1]&&39>=d[1])a+=d[1];else throw new Gb(Error("Second integer in OID is out of range"));var l=new Xa(10),b=0,b=l.copy(m.DerOid.encode128(a),b);if(2<
d.length)for(a=2;a<d.length;++a)b=l.copy(m.DerOid.encode128(d[a]),b);this.encodeHeader(b);this.payloadAppend(l.slice(0,b))};m.DerOid.encode128=function(d){var a=new Xa(10),l=0;if(128>d)++l,a.array[a.array.length-l]=d&127;else for(++l,a.array[a.array.length-l]=d&127,d>>=7;0!=d;)++l,a.ensureLengthFromBack(l),a.array[a.array.length-l]=d&127|128,d>>=7;return a.slice(a.array.length-l)};m.DerOid.prototype.decode128=function(d,a){for(var l=0,b=d;0!=(this.payload_.array[d]&128);)l=128*l+(this.payload_.array[d]&
255)-128,d+=1;l=128*l+(this.payload_.array[d]&255);a[0]=d-b+1;return l};m.DerOid.prototype.toVal=function(){for(var d=0,a=[];d<this.payloadPosition_;){var l=[0],b=this.decode128(d,l),d=d+l[0];a.push(b)}d=a[0];d=Math.floor(d/40)+"."+d%40;for(l=1;l<a.length;++l)d+="."+a[l];return d};m.DerSequence=function(){m.DerStructure.call(this,P.Sequence)};m.DerSequence.prototype=new m.DerStructure;m.DerSequence.prototype.name="DerSequence";m.DerPrintableString=function(d){m.DerByteString.call(this,d,P.PrintableString)};
m.DerPrintableString.prototype=new m.DerByteString;m.DerPrintableString.prototype.name="DerPrintableString";m.DerGeneralizedTime=function(d){m.call(this,P.GeneralizedTime);void 0!=d&&(d=m.DerGeneralizedTime.toDerTimeString(d),this.payloadAppend((new p(d)).buf()),this.encodeHeader(this.payloadPosition_))};m.DerGeneralizedTime.prototype=new m;m.DerGeneralizedTime.prototype.name="DerGeneralizedTime";m.DerGeneralizedTime.toDerTimeString=function(d){d=new Date(Math.round(d));return d.getUTCFullYear()+
m.DerGeneralizedTime.to2DigitString(d.getUTCMonth()+1)+m.DerGeneralizedTime.to2DigitString(d.getUTCDate())+m.DerGeneralizedTime.to2DigitString(d.getUTCHours())+m.DerGeneralizedTime.to2DigitString(d.getUTCMinutes())+m.DerGeneralizedTime.to2DigitString(d.getUTCSeconds())+"Z"};m.DerGeneralizedTime.to2DigitString=function(d){d=d.toString();return 1===d.length?"0"+d:d};m.DerGeneralizedTime.prototype.toVal=function(){var d=this.payload_.slice(0,this.payloadPosition_).toString();return Date.UTC(parseInt(d.substr(0,
4)),parseInt(d.substr(4,2)-1),parseInt(d.substr(6,2)),parseInt(d.substr(8,2)),parseInt(d.substr(10,2)),parseInt(d.substr(12,2)))};var Ib=a,Zb=function(d,a){this.subtrees=[];this.value=d;this.parent=a;this.lastChild=null};Zb.prototype.addSubtree=function(d,a){var l=this.find(d);null!==l?l.push(a):this.subtrees.push({key:d,value:[a]});a.parent=this;this.lastChild=a};Zb.prototype.createSubtree=function(d,a){var l=new Zb(a,this);this.addSubtree(d,l);return l};Zb.prototype.get=function(d){d=d.replace(/^\/+/,
"");if(0===d.length)return[this];var a=d.split("/");d=this.find(a[0]);if(null===d)return[];if(1==a.length)return d.slice(0);for(var a=a.slice(1).join("/"),l=[],b=0;b<d.length;++b)var c=d[b].get(a),l=l.concat(c);return l};Zb.prototype.getFirstValue=function(d){d=this.get(d);return 1<=d.length?d[0].value:null};Zb.prototype.getValue=function(){return this.value};Zb.prototype.getParent=function(){return this.parent};Zb.prototype.getLastChild=function(){return this.lastChild};Zb.prototype.prettyPrint=
function(d){d=d||1;var a=Array(d+1).join(" "),l="";null!=this.parent&&(this.value&&0<this.value.length&&(l+='"'+this.value+'"'),l+="\n");if(0<this.subtrees.length){this.parent&&(l+=a+"{\n");for(var b=Array(d+2+1).join(" "),c=0;c<this.subtrees.length;++c)for(var f=0;f<this.subtrees[c].value.length;++f)l+=b+this.subtrees[c].key+" "+this.subtrees[c].value[f].prettyPrint(d+2);this.parent&&(l+=a+"}\n")}return l};Zb.prototype.toString=function(){return this.prettyPrint()};Zb.prototype.find=function(d){for(var a=
0;a<this.subtrees.length;++a)if(this.subtrees[a].key==d)return this.subtrees[a].value;return null};var ec=function(){this.root=new Zb};q.BoostInfoParser=ec;q.BoostInfoTree=Zb;ec.prototype.read=function(d,a){var l;"string"==typeof a?l=d:(a=d,l=Ib.readFileSync(d).toString());var b=this.root,c=this;l.split(/\r?\n/).forEach(function(d){b=c.parseLine(d.trim(),b)})};ec.prototype.write=function(d){Ib.writeFileSync(d,""+this.root)};ec.prototype.getRoot=function(){return this.root};ec.shlex_split=function(d){var a=
[];if(""==d)return a;for(var l=0;;){for(;0<=" \t\n\r".indexOf(d[l]);)if(l+=1,l>=d.length)return a;for(var b=l,c=!1,f="";;){if("\\"==d[b]){if(f+=d.substring(l,b),b=l=b+1,b>=d.length)break}else if(c)'"'==d[b]&&(f+=d.substring(l,b),l=b+1,c=!1);else if('"'==d[b])f+=d.substring(l,b),l=b+1,c=!0;else if(0<=" \t\n\r".indexOf(d[b]))break;b+=1;if(b>=d.length)break}f+=d.substring(l,b);a.push(f);if(b>=d.length)return a;l=b}};ec.prototype.parseLine=function(d,a){var l=d.indexOf(";");0<=l&&(d=d.substring(0,l).trim());
if(0==d.length)return a;for(var l=ec.shlex_split(d),b=!1,c=!1,f=0;f<l.length;++f)b=b||"{"==l[f],c=c||"}"==l[f];if(!b&&!c){var b=l[0],g;1<l.length&&(g=l[1]);a.createSubtree(b,g);return a}l=d.indexOf("{");if(0<l)return g=d.substring(0,l),l=d.substring(l),g=this.parseLine(g,a),this.parseLine(l,g);if("{"==d[0])return a=a.getLastChild();if("}"==d[0])return a=a.getParent();throw runtime_error("BoostInfoParser: input line is malformed");};var c=a.Name,uc=a.InterestFilter,Fa=a.ForwardingFlags,s=a.WireFormat,
g=a.Log.LOG,Ma=function(d,a){a=a||1E3;this.face=d;this.cleanupIntervalMilliseconds=a;this.nextCleanupTime=(new Date).getTime()+a;this.onDataNotFoundForPrefix={};this.interestFilterIdList=[];this.registeredPrefixIdList=[];this.noStaleTimeCache=[];this.staleTimeCache=[];this.emptyComponent=new c.Component;this.pendingInterestTable=[];this.minimumCacheLifetime_=0;var l=this;this.storePendingInterestCallback=function(d,a,b,c,v){l.storePendingInterest(a,b)}};q.MemoryContentCache=Ma;Ma.prototype.registerPrefix=
function(d,a,l,b,c,f){var g=l,m=b,n=c;l="object"===typeof g&&1===g.length&&"function"===typeof g[0]?g[0]:null;b="function"===typeof g?g:"function"===typeof m?m:null;c=g instanceof Fa?g:m instanceof Fa?m:n instanceof Fa?n:new Fa;f=g instanceof s?g:m instanceof s?m:n instanceof s?n:f instanceof s?f:s.getDefaultWireFormat();b&&(this.onDataNotFoundForPrefix[d.toUri()]=b);d=this.face.registerPrefix(d,this.onInterest.bind(this),a,l,c,f);this.registeredPrefixIdList.push(d)};Ma.prototype.setInterestFilter=
function(d,a){if(a){var l;l="object"===typeof d&&d instanceof uc?d.getPrefix():d;this.onDataNotFoundForPrefix[l.toUri()]=a}l=this.face.setInterestFilter(d,this.onInterest.bind(this));this.interestFilterIdList.push(l)};Ma.prototype.unregisterAll=function(){for(var d=0;d<this.interestFilterIdList.length;++d)this.face.unsetInterestFilter(this.interestFilterIdList[d]);this.interestFilterIdList=[];for(d=0;d<this.registeredPrefixIdList.length;++d)this.face.removeRegisteredPrefix(this.registeredPrefixIdList[d]);
this.registeredPrefixIdList=[];this.onDataNotFoundForPrefix={}};Ma.prototype.add=function(d){var a=(new Date).getTime();this.doCleanup(a);if(null!=d.getMetaInfo().getFreshnessPeriod()&&0<=d.getMetaInfo().getFreshnessPeriod()){for(var l=new Ma.StaleTimeContent(d,a,this.minimumCacheLifetime_),b=this.staleTimeCache.length-1;0<=b&&!(this.staleTimeCache[b].cacheRemovalTimeMilliseconds_<=l.cacheRemovalTimeMilliseconds_);)--b;this.staleTimeCache.splice(b+1,0,l)}else this.noStaleTimeCache.push(new Ma.Content(d));
for(b=this.pendingInterestTable.length-1;0<=b;--b)if(this.pendingInterestTable[b].isTimedOut(a))this.pendingInterestTable.splice(b,1);else if(this.pendingInterestTable[b].getInterest().matchesName(d.getName())){try{this.pendingInterestTable[b].getFace().send(d.wireEncode().buf())}catch(c){0<g&&console.log(""+c);break}this.pendingInterestTable.splice(b,1)}};Ma.prototype.storePendingInterest=function(d,a){this.pendingInterestTable.push(new Ma.PendingInterest(d,a))};Ma.prototype.getStorePendingInterest=
function(){return this.storePendingInterestCallback};Ma.prototype.getMinimumCacheLifetime=function(){return this.minimumCacheLifetime_};Ma.prototype.setMinimumCacheLifetime=function(d){this.minimumCacheLifetime_=d};Ma.prototype.onInterest=function(d,a,l,b,c){var f=(new Date).getTime();this.doCleanup(f);for(var g=null,m=null,n=this.staleTimeCache.length+this.noStaleTimeCache.length,p=0;p<n;++p){var s,q=!0;p<this.staleTimeCache.length?(s=this.staleTimeCache[p],q=s.isFresh(f)):s=this.noStaleTimeCache[p-
this.staleTimeCache.length];if(a.matchesName(s.getName())&&(!a.getMustBeFresh()||q)){if(null==a.getChildSelector()){l.send(s.getDataEncoding());return}var q=s.getName().size()>a.getName().size()?s.getName().get(a.getName().size()):this.emptyComponent,x=!1;null===m?x=!0:0==a.getChildSelector()?0>q.compare(g)&&(x=!0):0<q.compare(g)&&(x=!0);x&&(g=q,m=s.getDataEncoding())}}null!==m?l.send(m):(f=this.onDataNotFoundForPrefix[d.toUri()])&&f(d,a,l,b,c)};Ma.prototype.doCleanup=function(d){if(d>=this.nextCleanupTime){for(;0<
this.staleTimeCache.length&&this.staleTimeCache[0].isPastRemovalTime(d);)this.staleTimeCache.shift();this.nextCleanupTime=d+this.cleanupIntervalMilliseconds}};Ma.Content=function(d){d&&(this.name=new c(d.getName()),this.dataEncoding=d.wireEncode().buf())};Ma.Content.prototype.getName=function(){return this.name};Ma.Content.prototype.getDataEncoding=function(){return this.dataEncoding};Ma.StaleTimeContent=function(d,a,l){Ma.Content.call(this,d);this.cacheRemovalTimeMilliseconds_=a+Math.max(d.getMetaInfo().getFreshnessPeriod(),
l);this.freshnessExpiryTimeMilliseconds_=a+d.getMetaInfo().getFreshnessPeriod()};Ma.StaleTimeContent.prototype=new Ma.Content;Ma.StaleTimeContent.prototype.name="StaleTimeContent";Ma.StaleTimeContent.prototype.isPastRemovalTime=function(d){return this.cacheRemovalTimeMilliseconds_<=d};Ma.StaleTimeContent.prototype.isFresh=function(d){return this.freshnessExpiryTimeMilliseconds_>d};Ma.PendingInterest=function(d,a){this.interest=d;this.face=a;var l=this.interest.getInterestLifetimeMilliseconds();if(null==
l||0>l)l=4E3;this.timeoutMilliseconds=(new Date).getTime()+l};Ma.PendingInterest.prototype.getInterest=function(){return this.interest};Ma.PendingInterest.prototype.getFace=function(){return this.face};Ma.PendingInterest.prototype.isTimedOut=function(d){return d>=this.timeoutTimeMilliseconds};var F=a.Interest,p=a.Blob,C=a.KeyChain,O=a.NdnCommon,ib=function(d,a,l,b,c){this.face=d;this.validatorKeyChain=a;this.verifySegment=l;this.onComplete=b;this.onError=c;this.contentParts=[]};q.SegmentFetcher=ib;
ib.ErrorCode={INTEREST_TIMEOUT:1,DATA_HAS_NO_SEGMENT:2,SEGMENT_VERIFICATION_FAILED:3};ib.DontVerifySegment=function(d){return!0};ib.fetch=function(d,a,l,b,c){null==l||l instanceof C?(new ib(d,l,ib.DontVerifySegment,b,c)).fetchFirstSegment(a):(new ib(d,null,l,b,c)).fetchFirstSegment(a)};ib.prototype.fetchFirstSegment=function(d){d=new F(d);d.setChildSelector(1);d.setMustBeFresh(!0);var a=this;this.face.expressInterest(d,function(d,b){a.onData(d,b)},function(d){a.onTimeout(d)})};ib.prototype.fetchNextSegment=
function(d,a,l){d=new F(d);d.setChildSelector(0);d.setMustBeFresh(!1);d.setName(a.getPrefix(-1).appendSegment(l));var b=this;this.face.expressInterest(d,function(d,a){b.onData(d,a)},function(d){b.onTimeout(d)})};ib.prototype.onData=function(d,a){if(null!=this.validatorKeyChain)try{var l=this;this.validatorKeyChain.verifyData(a,function(a){l.onVerified(a,d)},this.onValidationFailed.bind(this))}catch(b){console.log("Error in KeyChain.verifyData: "+b)}else if(this.verifySegment(a))this.onVerified(a,
d);else try{this.onError(ib.ErrorCode.SEGMENT_VERIFICATION_FAILED,"Segment verification failed")}catch(c){console.log("Error in onError: "+O.getErrorWithStackTrace(c))}};ib.prototype.onVerified=function(d,a){if(ib.endsWithSegmentNumber(d.getName())){var l=0;try{l=d.getName().get(-1).toSegment()}catch(b){try{this.onError(ib.ErrorCode.DATA_HAS_NO_SEGMENT,"Error decoding the name segment number "+d.getName().get(-1).toEscapedString()+": "+b)}catch(c){console.log("Error in onError: "+O.getErrorWithStackTrace(c))}return}var g=
this.contentParts.length;if(l!=g)this.fetchNextSegment(a,d.getName(),g);else{this.contentParts.push(d.getContent().buf());if(0<d.getMetaInfo().getFinalBlockId().getValue().size()){var m=0;try{m=d.getMetaInfo().getFinalBlockId().toSegment()}catch(n){try{this.onError(ib.ErrorCode.DATA_HAS_NO_SEGMENT,"Error decoding the FinalBlockId segment number "+d.getMetaInfo().getFinalBlockId().toEscapedString()+": "+n)}catch(s){console.log("Error in onError: "+O.getErrorWithStackTrace(s))}return}if(l==m){l=f.concat(this.contentParts);
try{this.onComplete(new p(l,!1))}catch(q){console.log("Error in onComplete: "+O.getErrorWithStackTrace(q))}return}}this.fetchNextSegment(a,d.getName(),g+1)}}else try{this.onError(ib.ErrorCode.DATA_HAS_NO_SEGMENT,"Got an unexpected packet without a segment number: "+d.getName().toUri())}catch(x){console.log("Error in onError: "+O.getErrorWithStackTrace(x))}};ib.prototype.onValidationFailed=function(d,a){try{this.onError(ib.ErrorCode.SEGMENT_VERIFICATION_FAILED,"Segment verification failed for "+d.getName().toUri()+
" . Reason: "+a)}catch(l){console.log("Error in onError: "+O.getErrorWithStackTrace(l))}};ib.prototype.onTimeout=function(d){try{this.onError(ib.ErrorCode.INTEREST_TIMEOUT,"Time out for interest "+d.getName().toUri())}catch(a){console.log("Error in onError: "+O.getErrorWithStackTrace(a))}};ib.endsWithSegmentNumber=function(d){return 1<=d.size()&&d.get(-1).isSegment()};var Ic=function(){this.backrefs_=[]};q.NdnRegexBackrefManager=Ic;Ic.prototype.pushRef=function(d){last=this.backrefs_.length;this.backrefs_.push(d);
return last};Ic.prototype.popRef=function(){this.backrefs_.pop()};Ic.prototype.size=function(){return this.backrefs_.length};Ic.prototype.getBackref=function(d){return this.backrefs_[d]};var Ic=a.NdnRegexBackrefManager,X=function(d,a,l){this.matchers_=[];this.matchResult_=[];this.expr_=d;this.type_=a;void 0==l&&(l=new Ic);this.backrefManager_=l};q.NdnRegexMatcherBase=X;X.Error=function(d){if(d)return d.__proto__=X.Error.prototype,d};X.Error.prototype=Error();X.Error.prototype.name="NdnRegexMatcherBaseError";
X.NdnRegexExprType={TOP:0,PATTERN_LIST:1,REPEAT_PATTERN:2,BACKREF:3,COMPONENT_SET:4,COMPONENT:5,PSEUDO:6};X.prototype.match=function(d,a,l){var b=!1;this.matchResult_=[];if(this.recursiveMatch_(0,d,a,l)){for(b=a;b<a+l;)this.matchResult_.push(d.get(b)),++b;b=!0}else b=!1;return b};X.prototype.getMatchResult=function(){return this.matchResult_};X.prototype.getExpr=function(){return this.expr_};X.prototype.compile_=function(){throw Error("NdnRegexMatcherBase.compile is not implemented");};X.prototype.recursiveMatch_=
function(d,a,l,b){var c=b;if(d>=this.matchers_.length)return 0==b;for(var f=this.matchers_[d];0<=c;){if(f.match(a,l,c)&&this.recursiveMatch_(d+1,a,l+c,b-c))return!0;--c}return!1};var X=a.NdnRegexMatcherBase,Yc=function(d,a){X.call(this,d,X.NdnRegexExprType.BACKREF,a)};Yc.prototype=new X;Yc.prototype.name="NdnRegexBackrefMatcher";q.NdnRegexBackrefMatcher=Yc;Yc.prototype.lateCompile=function(){this.compile_()};Yc.prototype.compile_=function(){if(2>this.expr_.length)throw new X.Error(Error("Unrecognized format: "+
this.expr_));var d=this.expr_.length-1;if("("===this.expr_[0]&&")"===this.expr_[d])d=new fc(this.expr_.substring(1,d),this.backrefManager_),this.matchers_.push(d);else throw new X.Error(Error("Unrecognized format: "+this.expr_));};var fc=a.NdnRegexPatternListMatcher,X=a.NdnRegexMatcherBase,Zc=a.NdnRegexPseudoMatcher,nd=function(d,a,l){X.call(this,d,X.NdnRegexExprType.COMPONENT,a);void 0===l&&(l=!0);this.componentRegex_=null;this.pseudoMatchers_=[];this.isExactMatch_=l;this.compile_()};nd.prototype=
new X;nd.prototype.name="NdnRegexComponentMatcher";q.NdnRegexComponentMatcher=nd;nd.prototype.match=function(d,a,l){this.matchResult_=[];if(""==this.expr_)return this.matchResult_.push(d.get(a)),!0;if(this.isExactMatch_){if(l=d.get(a).toEscapedString().match(this.componentRegex_),null!==l){for(var b=1;b<l.length;++b)this.pseudoMatchers_[b].resetMatchResult(),this.pseudoMatchers_[b].setMatchResult(l[b]);this.matchResult_.push(d.get(a));return!0}}else throw new X.Error(Error("Non-exact component search is not supported yet"));
return!1};nd.prototype.compile_=function(){this.componentRegex_=new RegExp(this.expr_);this.pseudoMatchers_=[];this.pseudoMatchers_.push(new Zc);if(0<=this.expr_.indexOf("\\("))throw new X.Error(Error("Can't count subexpressions in regex with escaped parentheses: "+expr_));for(var d=0,a=0;a<this.expr_.length;++a)"("===this.expr_[a]&&++d;for(a=1;a<=d;++a){var l=new Zc;this.pseudoMatchers_.push(l);this.backrefManager_.pushRef(l)}};var X=a.NdnRegexMatcherBase,Jc=function(d,a){X.call(this,d,X.NdnRegexExprType.COMPONENT_SET,
a);this.components_=[];this.isInclusion_=!0;this.compile_()};Jc.prototype=new X;Jc.prototype.name="NdnRegexComponentSetMatcher";q.NdnRegexComponentSetMatcher=Jc;Jc.prototype.match=function(d,a,l){isMatched=!1;if(1!==l)return!1;for(var b=0;b<this.components_.length;++b)if(this.components_[b].match(d,a,l)){isMatched=!0;break}this.matchResult_=[];return(this.isInclusion_?isMatched:!isMatched)?(this.matchResult_.push(d.get(a)),!0):!1};Jc.prototype.compile_=function(){if(2>this.expr_.length)throw new X.Error(Error("Regexp compile error (cannot parse "+
this.expr_+")"));if("<"===this.expr_[0])this.compileSingleComponent_();else if("["===this.expr_[0]){var d=this.expr_.length-1;if("]"!==this.expr_[d])throw new X.Error(Error("Regexp compile error (no matching ']' in "+this.expr_+")"));"^"===this.expr_[1]?(this.isInclusion_=!1,this.compileMultipleComponents_(2,d)):this.compileMultipleComponents_(1,d)}else throw new X.Error(Error("Regexp compile error (cannot parse "+this.expr_+")"));};Jc.prototype.extractComponent_=function(d){for(var a=1,l=0;a>l;){if(d>=
this.expr_.length)throw new X.Error(Error("Error: angle brackets mismatch"));"<"===this.expr_[d]?a+=1:">"===this.expr_[d]&&(l+=1);d+=1}return d};Jc.prototype.compileSingleComponent_=function(){var d=this.extractComponent_(1);if(this.expr_.length!==d)throw new X.Error(Error("Component expr error "+this.expr_));component=new nd(this.expr_.substring(1,d-1),this.backrefManager_);this.components_.push(component)};Jc.prototype.compileMultipleComponents_=function(d,a){for(var l=d,b=d;l<a;){if("<"!==this.expr_[l])throw new X.Error(Error("Component expr error "+
this.expr_));b=l+1;l=this.extractComponent_(b);component=new nd(this.expr_.substring(b,l-1),this.backrefManager_);this.components_.push(component)}if(l!=a)throw new X.Error(Error("Not sufficient expr to parse "+this.expr_));};nd=a.NdnRegexComponentMatcher;X=a.NdnRegexMatcherBase;fc=function(d,a){X.call(this,d,X.NdnRegexExprType.PATTERN_LIST,a);this.compile_()};fc.prototype=new X;fc.prototype.name="NdnRegexPatternListMatcher";q.NdnRegexPatternListMatcher=fc;fc.prototype.compile_=function(){for(var d=
this.expr_.length,a=[0],l=a[0];a[0]<d;)if(l=a[0],!this.extractPattern_(l,a))throw new X.Error(Error("Compile error"));};fc.prototype.extractPattern_=function(d,a){var l=d,b=d,c=d;if("("===this.expr_[d])c=d=this.extractSubPattern_("(",")",d+1),b=this.extractRepetition_(d),c===b?(l=new Yc(this.expr_.substring(l,b),this.backrefManager_),this.backrefManager_.pushRef(l),l.lateCompile(),this.matchers_.push(l)):this.matchers_.push(new vc(this.expr_.substring(l,b),this.backrefManager_,c-l));else if("<"===
this.expr_[d])d+=1,c=d=this.extractSubPattern_("<",">",d),b=this.extractRepetition_(d),this.matchers_.push(new vc(this.expr_.substring(l,b),this.backrefManager_,c-l));else if("["===this.expr_[d])d+=1,c=d=this.extractSubPattern_("[","]",d),b=this.extractRepetition_(d),this.matchers_.push(new vc(this.expr_.substring(l,b),this.backrefManager_,c-l));else throw new X.Error(Error("Unexpected syntax"));a[0]=b;return!0};fc.prototype.extractSubPattern_=function(d,a,l){for(var b=1,c=0;b>c;){if(l>=this.expr_.length)throw new X.Error(Error("Parenthesis mismatch"));
d==this.expr_[l]&&(b+=1);a==this.expr_[l]&&(c+=1);l+=1}return l};fc.prototype.extractRepetition_=function(d){var a=this.expr_.length;if(d===a)return d;if("+"==this.expr_[d]||"?"==this.expr_[d]||"*"==this.expr_[d])return++d,d;if("{"==this.expr_[d]){for(;"}"!=this.expr_[d]&&(++d,d!==a););if(d===a)throw new X.Error(Error("Missing right brace bracket"));++d}return d};var Yc=a.NdnRegexBackrefMatcher,vc=a.NdnRegexRepeatMatcher,c=a.Name,X=a.NdnRegexMatcherBase,Zc=function(){X.call(this,"",X.NdnRegexExprType.PSEUDO)};
Zc.prototype=new X;Zc.prototype.name="NdnRegexPseudoMatcher";q.NdnRegexPseudoMatcher=Zc;Zc.prototype.compile_=function(){};Zc.prototype.setMatchResult=function(d){this.matchResult_.push(new c.Component(d))};Zc.prototype.resetMatchResult=function(){this.matchResult_=[]};X=a.NdnRegexMatcherBase;vc=function(d,a,l){X.call(this,d,X.NdnRegexExprType.REPEAT_PATTERN,a);this.repeatMax_=this.repeatMin_=0;this.indicator_=l;this.compile_()};vc.prototype=new X;vc.prototype.name="NdnRegexRepeatMatcher";q.NdnRegexRepeatMatcher=
vc;vc.prototype.match=function(d,a,l){this.matchResult_=[];if(0===this.repeatMin_&&0===l)return!0;if(this.recursiveMatch2_(0,d,a,l)){for(var b=a;b<a+l;++b)this.matchResult_.push(d.get(b));return!0}return!1};vc.prototype.compile_=function(){var d;"("==this.expr_[0]?(d=new Yc(this.expr_.substring(0,this.indicator_),this.backrefManager_),this.backrefManager_.pushRef(d),d.lateCompile()):d=new Jc(this.expr_.substring(0,this.indicator_),this.backrefManager_);this.matchers_.push(d);this.parseRepetition_()};
vc.prototype.parseRepetition_=function(){var d=this.expr_.length;if(d===this.indicator_)return this.repeatMax_=this.repeatMin_=1,!0;if(d===this.indicator_+1){if("?"==this.expr_[this.indicator_])return this.repeatMin_=0,this.repeatMax_=1,!0;if("+"==this.expr_[this.indicator_])return this.repeatMin_=1,this.repeatMax_=32767,!0;if("*"==this.expr_[this.indicator_])return this.repeatMin_=0,this.repeatMax_=32767,!0}else{var d=this.expr_.substring(this.indicator_,d),a=d.length,l=0,b=0;if(null!=d.match(/\{[0-9]+,[0-9]+\}/))separator=
d.indexOf(","),l=parseInt(d.substring(1,separator)),b=parseInt(d.substring(separator+1,a-1));else if(null!=d.match(/\{,[0-9]+\}/))separator=d.indexOf(","),l=0,b=parseInt(d.substring(separator+1,a-1));else if(null!=d.match(/\{[0-9]+,\}/))separator=d.indexOf(","),l=parseInt(d.substring(1,separator)),b=32767;else if(null!=d.match(/\{[0-9]+\}/))b=l=parseInt(d.substring(1,a-1));else throw new X.Error(Error("Error: RegexRepeatMatcher.ParseRepetition(): Unrecognized format "+this.expr_));if(32767<l||32767<
b||l>b)throw new X.Error(Error("Error: RegexRepeatMatcher.ParseRepetition(): Wrong number "+this.expr_));this.repeatMin_=l;this.repeatMax_=b;return!0}return!1};vc.prototype.recursiveMatch2_=function(d,a,l,b){var c=b,f=this.matchers_[0];if(0<b&&d>=this.repeatMax_||0===b&&d<this.repeatMin_)return!1;if(0==b&&d>=this.repeatMin_)return!0;for(;0<=c;){if(f.match(a,l,c)&&this.recursiveMatch2_(d+1,a,l+c,b-c))return!0;--c}return!1};var Yc=a.NdnRegexBackrefMatcher,Jc=a.NdnRegexComponentSetMatcher,c=a.Name,X=
a.NdnRegexMatcherBase,Ic=a.NdnRegexBackrefManager,fc=a.NdnRegexPatternListMatcher,Ua=function(d,a){X.call(this,d,X.NdnRegexExprType.TOP);void 0==a&&(a="");this.secondaryMatcher_=this.primaryMatcher_=null;this.primaryBackrefManager_=new Ic;this.secondaryBackrefManager_=new Ic;this.isSecondaryUsed_=!1;this.expand_=a;this.compile_()};Ua.prototype=new X;Ua.prototype.name="NdnRegexTopMatcher";q.NdnRegexTopMatcher=Ua;Ua.prototype.match=function(d,a,l){this.isSecondaryUsed_=!1;this.matchResult_=[];if(this.primaryMatcher_.match(d,
0,d.size())){this.matchResult_=[];d=this.primaryMatcher_.getMatchResult();for(a=0;a<d.length;++a)this.matchResult_.push(d[a]);return!0}if(null!=this.secondaryMatcher_&&this.secondaryMatcher_.match(d,0,d.size())){this.matchResult_=[];d=this.secondaryMatcher_.getMatchResult();for(a=0;a<d.length;++a)this.matchResult_.push(d[a]);return this.isSecondaryUsed_=!0}return!1};Ua.prototype.expand=function(d){void 0==d&&(d="");var a=new c,l=this.isSecondaryUsed_?this.secondaryBackrefManager_:this.primaryBackrefManager_,
b=l.size();d=""!=d?d:this.expand_;for(var f=[0];f[0]<d.length;){var g=Ua.getItemFromExpand_(d,f);"<"==g[0]&&a.append(g.substring(1,g.length-1));if("\\"==g[0])if(g=parseInt(g.substring(1,g.length)),0===g)for(g=0;g<this.matchResult_.length;++g)a.append(this.matchResult_[g]);else if(g<=b)for(var m=l.getBackref(g-1).getMatchResult(),g=0;g<m.length;++g)a.append(m[g]);else throw new X.Error(Error("Exceeded the range of back reference"));}return a};Ua.fromName=function(d,a){void 0==a&&(a=!1);for(var l="^",
b=0;b<d.size();++b)l+="<",l+=Ua.convertSpecialChar_(d.get(b).toEscapedString()),l+=">";a&&(l+="$");return new Ua(l)};Ua.prototype.compile_=function(){var d=this.expr_,d="$"!=d[d.length-1]?d+"<.*>*":d.substring(0,d.length-1);"^"!=d[0]?this.secondaryMatcher_=new fc("<.*>*"+d,this.secondaryBackrefManager_):d=d.substring(1);this.primaryMatcher_=new fc(d,this.primaryBackrefManager_)};Ua.getItemFromExpand_=function(d,a){var l=a[0];if("\\"==d[a[0]]){++a[0];if(a[0]>=d.length)throw new X.Error(Error("Wrong format of expand string!"));
for(;a[0]<d.length&&"9">=d[a[0]]&&"0"<=d[a[0]];)if(++a[0],a[0]>d.length)throw new X.Error(Error("Wrong format of expand string!"));if(a[0]>l+1)return d.substring(l,a[0])}else if("<"==d[a[0]]){++a[0];if(a[0]>=d.length)throw new X.Error(Error("Wrong format of expand string!"));for(var b=1,c=0;c<b;)if("<"==d[a[0]]&&++b,">"==d[a[0]]&&++c,++a[0],a[0]>=d.length)throw new X.Error(Error("Wrong format of expand string!"));return d.substring(l,a[0])}throw new X.Error(Error("Wrong format of expand string!"));
};Ua.convertSpecialChar_=function(d){newStr="";for(var a=0;a<d.length;++a){var l=d[a];if("."==l||"["==l||"{"==l||"}"==l||"("==l||")"==l||"\\"==l||"*"==l||"+"==l||"?"==l||"|"==l||"^"==l||"$"==l)newStr+="\\";newStr+=l}return newStr};var pb=function(){};q.Transport=pb;pb.ConnectionInfo=function(){};pb.prototype.isLocal=function(d,a,l){l("Transport.isLocal is not implemented")};var gc=function(){pb.call(this);this.onReceivedObject=this.connectionInfo=this.elementReader=null;var d=this;window.addEventListener("message",
function(a){if(a.source==window&&a.data.type&&"FromMicroForwarderStub"==a.data.type)if(a=a.data.object,a.type&&"Buffer"==a.type){if(null!=d.elementReader)d.elementReader.onReceivedData(new f(a.data))}else if(d.onReceivedObject)d.onReceivedObject(a)},!1)};gc.prototype=new pb;gc.prototype.name="MicroForwarderTransport";gc.ConnectionInfo=function(){pb.ConnectionInfo.call(this)};gc.ConnectionInfo.prototype=new pb.ConnectionInfo;gc.ConnectionInfo.prototype.name="MicroForwarderTransport.ConnectionInfo";
gc.ConnectionInfo.prototype.equals=function(d){return null==d?!1:!0};gc.ConnectionInfo.prototype.toString=function(){return"{}"};gc.prototype.setOnReceivedObject=function(d){this.onReceivedObject=d};gc.prototype.isLocal=function(d,a,l){a(!0)};gc.prototype.connect=function(d,a,l,b){this.elementReader=new Md(a);this.connectionInfo=d;l()};gc.prototype.sendObject=function(d){window.postMessage({type:"FromMicroForwarderTransport",object:d},"*")};gc.prototype.send=function(d){null==this.connectionInfo?
console.log("MicroForwarderTransport connection is not established."):this.sendObject(d.toJSON())};var hc=function(d){pb.call(this);this.connectionInfo=this.elementReader=null;this.onReceivedObject=d;this.port=null};hc.prototype=new pb;hc.prototype.name="RuntimePortTransport";hc.ConnectionInfo=function(d){pb.ConnectionInfo.call(this);this.port=d};hc.ConnectionInfo.prototype=new pb.ConnectionInfo;hc.ConnectionInfo.prototype.name="RuntimePortTransport.ConnectionInfo";hc.ConnectionInfo.prototype.equals=
function(d){return null==d||void 0==d.port?!1:this.port==d.port};hc.ConnectionInfo.prototype.toString=function(){return"{}"};hc.prototype.setOnReceivedObject=function(d){this.onReceivedObject=d};hc.prototype.isLocal=function(d,a,l){a(!0)};hc.prototype.connect=function(d,a,l,b){this.elementReader=new Md(a);this.connectionInfo=d;this.port=this.connectionInfo.port;var c=this;this.port.onMessage.addListener(function(d){if("Buffer"==d.type)c.elementReader.onReceivedData(f.isBuffer(d.data)?d.data:new f(d.data));
else if(null!=c.onReceivedObject)c.onReceivedObject(d)});this.port.onDisconnect.addListener(function(){c.port=null;null!=b&&b()});l()};hc.prototype.sendObject=function(d){null==this.port?console.log("RuntimePortTransport connection is not established."):this.port.postMessage(d)};hc.prototype.send=function(d){this.sendObject(d.toJSON())};var Md=a.ElementReader,g=a.Log.LOG,pb=a.Transport,ca,Bb=function v(){pb.call(this);if(!WebSocket)throw Error("WebSocket support is not available on this platform.");
this.elementReader=this.connectionInfo=this.ws=null;this.defaultGetConnectionInfo=ca.makeShuffledHostGetConnectionInfo("A.ws.ndn.ucla.edu B.ws.ndn.ucla.edu C.ws.ndn.ucla.edu D.ws.ndn.ucla.edu E.ws.ndn.ucla.edu F.ws.ndn.ucla.edu G.ws.ndn.ucla.edu H.ws.ndn.ucla.edu I.ws.ndn.ucla.edu J.ws.ndn.ucla.edu K.ws.ndn.ucla.edu L.ws.ndn.ucla.edu M.ws.ndn.ucla.edu N.ws.ndn.ucla.edu".split(" "),9696,function(a,b){return new v.ConnectionInfo(a,b)})};Bb.prototype=new pb;Bb.prototype.name="WebSocketTransport";Bb.importFace=
function(a){ca=a};q.WebSocketTransport=Bb;Bb.ConnectionInfo=function(a,l){pb.ConnectionInfo.call(this);this.host=a;this.port=void 0!==l?l:9696};Bb.ConnectionInfo.prototype=new pb.ConnectionInfo;Bb.ConnectionInfo.prototype.name="WebSocketTransport.ConnectionInfo";Bb.ConnectionInfo.prototype.equals=function(a){return null==a||void 0==a.host||void 0==a.port?!1:this.host==a.host&&this.port==a.port};Bb.ConnectionInfo.prototype.toString=function(){return this.hostIsUri()?"{ uri: "+this.host+" }":"{ host: "+
this.host+", port: "+this.port+" }"};Bb.ConnectionInfo.prototype.hostIsUri=function(){return"ws:"==this.host.substr(0,3)||"wss:"==this.host.substr(0,4)};Bb.prototype.isLocal=function(a,l,b){l(!1)};Bb.prototype.connect=function(a,l,b,c){this.close();var m=a.hostIsUri()?a.host:"ws://"+a.host+":"+a.port;this.ws=new WebSocket(m);0<g&&console.log("ws connection created.");this.connectionInfo=a;this.ws.binaryType="arraybuffer";this.elementReader=new Md(l);var n=this;this.ws.onmessage=function(a){a=a.data;
if(null==a||void 0==a||""==a)console.log("INVALID ANSWER");else if(a instanceof ArrayBuffer){a=new f(new Uint8Array(a));3<g&&console.log("BINARY RESPONSE IS "+a.toString("hex"));try{n.elementReader.onReceivedData(a)}catch(l){console.log("NDN.ws.onmessage exception: "+l)}}};this.ws.onopen=function(a){3<g&&console.log(a);3<g&&console.log("ws.onopen: WebSocket connection opened.");3<g&&console.log("ws.onopen: ReadyState: "+this.readyState);b()};this.ws.onerror=function(a){console.log("ws.onerror: ReadyState: "+
this.readyState);console.log(a);console.log("ws.onerror: WebSocket error: "+a.data)};this.ws.onclose=function(a){console.log("ws.onclose: WebSocket connection closed.");n.ws=null;null!=c&&c()}};Bb.prototype.connectByFace=function(a,l){this.connect(a.connectionInfo,a,l,function(){a.closeByTransport()})};Bb.prototype.send=function(a){if(null!=this.ws){var l=new Uint8Array(a.length);l.set(a);this.ws.send(l.buffer);3<g&&console.log("ws.send() returned.")}else console.log("WebSocket connection is not established.")};
Bb.prototype.close=function(){null!=this.ws&&delete this.ws};q.TcpTransport=a.WebSocketTransport;var p=a.Blob,L=a.DataUtils,g=a.Log.LOG,R=a.DecodingException,c=function l(a){if("string"==typeof a)3<g&&console.log("Content Name String "+a),this.components=l.createNameArray(a);else if("object"===typeof a)if(this.components=[],a instanceof l)this.append(a);else for(var b=0;b<a.length;++b)this.append(a[b]);else null==a?this.components=[]:1<g&&console.log("NO CONTENT NAME GIVEN");this.changeCount=0},cb=
{IMPLICIT_SHA256_DIGEST:1,PARAMETERS_SHA256_DIGEST:2,GENERIC:8,OTHER_CODE:32767};q.Name=c;q.ComponentType=cb;c.Component=function(a,b,g){if("object"===typeof a&&a instanceof c.Component)this.value_=a.value_,this.type_=a.type_,this.otherTypeCode_=a.otherTypeCode_;else{this.value_=a?"object"===typeof a&&"undefined"!==typeof ArrayBuffer&&a instanceof ArrayBuffer?new p(new f(new Uint8Array(a)),!1):"object"===typeof a&&a instanceof p?a:new p(a):new p([]);if(b===cb.OTHER_CODE){if(void 0==g)throw Error("To use an other code, call Name.Component(value, ComponentType.OTHER_CODE, otherTypeCode)");
if(0>g)throw Error("Name.Component other type code must be non-negative");this.otherTypeCode_=g}else this.otherTypeCode_=-1;this.type_=void 0==b?cb.GENERIC:b}};c.Component.prototype.getValue=function(){return this.value_};c.Component.prototype.getValueAsBuffer=function(){return this.value_.buf()};c.Component.prototype.getType=function(){return this.type_};c.Component.prototype.getOtherTypeCode=function(){return this.otherTypeCode_};Object.defineProperty(c.Component.prototype,"value",{get:function(){return this.getValueAsBuffer()}});
c.Component.prototype.toEscapedString=function(){return this.type_===cb.IMPLICIT_SHA256_DIGEST?"sha256digest="+this.value_.toHex():this.type_===cb.PARAMETERS_SHA256_DIGEST?"params-sha256="+this.value_.toHex():(this.type_===cb.GENERIC?"":(this.type_===cb.OTHER_CODE?this.otherTypeCode_:this.type_)+"=")+c.toEscapedString(this.value_.buf())};c.Component.prototype.isSegment=function(){return 1<=this.value_.size()&&0==this.value_.buf()[0]&&this.isGeneric()};c.Component.prototype.isSegmentOffset=function(){return 1<=
this.value_.size()&&251==this.value_.buf()[0]&&this.isGeneric()};c.Component.prototype.isVersion=function(){return 1<=this.value_.size()&&253==this.value_.buf()[0]&&this.isGeneric()};c.Component.prototype.isTimestamp=function(){return 1<=this.value_.size()&&252==this.value_.buf()[0]&&this.isGeneric()};c.Component.prototype.isSequenceNumber=function(){return 1<=this.value_.size()&&254==this.value_.buf()[0]&&this.isGeneric()};c.Component.prototype.isGeneric=function(){return this.type_===cb.GENERIC};
c.Component.prototype.isImplicitSha256Digest=function(){return this.type_===cb.IMPLICIT_SHA256_DIGEST};c.Component.prototype.isParametersSha256Digest=function(){return this.type_===cb.PARAMETERS_SHA256_DIGEST};c.Component.prototype.toNumber=function(){return L.bigEndianToUnsignedInt(this.value_.buf())};c.Component.prototype.toNumberWithMarker=function(a){if(0==this.value_.size()||this.value_.buf()[0]!=a)throw Error("Name component does not begin with the expected marker");return L.bigEndianToUnsignedInt(this.value_.buf().slice(1))};
c.Component.prototype.toSegment=function(){return this.toNumberWithMarker(0)};c.Component.prototype.toSegmentOffset=function(){return this.toNumberWithMarker(251)};c.Component.prototype.toVersion=function(){return this.toNumberWithMarker(253)};c.Component.prototype.toTimestamp=function(){return this.toNumberWithMarker(252)};c.Component.prototype.toSequenceNumber=function(){return this.toNumberWithMarker(254)};c.Component.fromNumber=function(a,b,f){var g=new ta(8);g.writeNonNegativeInteger(a);return new c.Component(new p(g.getOutput(),
!1),b,f)};c.Component.fromNumberWithMarker=function(a,b){var f=new ta(9);f.writeNonNegativeInteger(a);f.writeNonNegativeInteger(b);return new c.Component(new p(f.getOutput(),!1))};c.Component.fromSegment=function(a){return c.Component.fromNumberWithMarker(a,0)};c.Component.fromSegmentOffset=function(a){return c.Component.fromNumberWithMarker(a,251)};c.Component.fromVersion=function(a){return c.Component.fromNumberWithMarker(a,253)};c.Component.fromTimestamp=function(a){return c.Component.fromNumberWithMarker(a,
252)};c.Component.fromSequenceNumber=function(a){return c.Component.fromNumberWithMarker(a,254)};c.Component.fromImplicitSha256Digest=function(a){digestBlob="object"===typeof a&&a instanceof p?a:new p(a,!0);if(32!==digestBlob.size())throw new R("Name.Component.fromImplicitSha256Digest: The digest length must be 32 bytes");a=new c.Component(digestBlob);a.type_=cb.IMPLICIT_SHA256_DIGEST;return a};c.Component.fromParametersSha256Digest=function(a){digestBlob="object"===typeof a&&a instanceof p?a:new p(a,
!0);if(32!==digestBlob.size())throw new R("Name.Component.fromParametersSha256Digest: The digest length must be 32 bytes");a=new c.Component(digestBlob);a.type_=cb.PARAMETERS_SHA256_DIGEST;return a};c.Component.prototype.getSuccessor=function(){for(var a=new f(this.value_.size()+1),b=!0,g=this.value_.size()-1;0<=g;--g)b?(a[g]=this.value_.buf()[g]+1&255,b=0===a[g]):a[g]=this.value_.buf()[g];b?a[a.length-1]=0:a=a.slice(0,this.value_.size());return new c.Component(new p(a,!1),this.type_,this.otherTypeCode_)};
c.Component.prototype.equals=function(a){return"object"===typeof a&&a instanceof c.Component?this.type_===cb.OTHER_CODE?this.value_.equals(a.value_)&&a.type_===cb.OTHER_CODE&&this.otherTypeCode_==a.otherTypeCode_:this.value_.equals(a.value_)&&this.type_===a.type_:!1};c.Component.prototype.compare=function(a){var b=this.type_===cb.OTHER_CODE?this.otherTypeCode_:this.type_,f=a.type_===cb.OTHER_CODE?a.otherTypeCode_:a.type_;return b<f?-1:b>f?1:c.Component.compareBuffers(this.value_.buf(),a.value_.buf())};
c.Component.compareBuffers=function(a,b){if(a.length<b.length)return-1;if(a.length>b.length)return 1;for(var c=0;c<a.length;++c){if(a[c]<b[c])return-1;if(a[c]>b[c])return 1}return 0};c.prototype.getName=function(){return this.toUri()};c.createNameArray=function(a){a=a.trim();if(0>=a.length)return[];var b=a.indexOf(":");if(0<=b){var g=a.indexOf("/");if(0>g||b<g)a=a.substr(b+1,a.length-b-1).trim()}if("/"==a[0])if(2<=a.length&&"/"==a[1]){b=a.indexOf("/",2);if(0>b)return[];a=a.substr(b+1,a.length-b-1).trim()}else a=
a.substr(1,a.length-1).trim();b=a.split("/");for(g=0;g<b.length;++g){var m=b[g];if("sha256digest="==m.substr(0,13))m=m.substr(13).trim(),m=c.Component.fromImplicitSha256Digest(new p(new f(m,"hex")),!1);else if("params-sha256="==m.substr(0,14))m=m.substr(14).trim(),m=c.Component.fromParametersSha256Digest(new p(new f(m,"hex")),!1);else{var n=cb.GENERIC,s=-1,q=m.indexOf("=");if(0<=q){n=m.substring(0,q);s=parseInt(n);if(isNaN(s))throw Error("Can't parse decimal Name Component type: "+n+" in URI "+a);
n=s==cb.GENERIC||s==cb.IMPLICIT_SHA256_DIGEST||s==cb.PARAMETERS_SHA256_DIGEST?s:cb.OTHER_CODE;m=m.substring(q+1)}m=new c.Component(c.fromEscapedString(m),n,s)}m.getValue().isNull()?(b.splice(g,1),--g):b[g]=m}return b};c.prototype.set=function(a){this.components=c.createNameArray(a);++this.changeCount};c.prototype.append=function(a,b,g){if("object"==typeof a&&a instanceof c)for(a=a==this?this.components.slice(0,this.components.length):a.components,b=0;b<a.length;++b)this.components.push(new c.Component(a[b]));
else"object"===typeof a&&a instanceof c.Component?this.components.push(a):this.components.push(new c.Component(a,b,g));++this.changeCount;return this};c.prototype.add=function(a){return this.append(a)};c.prototype.clear=function(){this.components=[];++this.changeCount};c.prototype.toUri=function(a){if(0==this.size())return a?"ndn:/":"/";a=a?"ndn:":"";for(var b=0;b<this.size();++b)a+="/"+this.components[b].toEscapedString();return a};c.prototype.to_uri=function(){return this.toUri()};c.prototype.toString=
function(){return this.toUri()};c.prototype.appendSegment=function(a){return this.append(c.Component.fromSegment(a))};c.prototype.appendSegmentOffset=function(a){return this.append(c.Component.fromSegmentOffset(a))};c.prototype.appendVersion=function(a){return this.append(c.Component.fromVersion(a))};c.prototype.appendTimestamp=function(a){return this.append(c.Component.fromTimestamp(a))};c.prototype.appendSequenceNumber=function(a){return this.append(c.Component.fromSequenceNumber(a))};c.prototype.appendImplicitSha256Digest=
function(a){return this.append(c.Component.fromImplicitSha256Digest(a))};c.prototype.appendParametersSha256Digest=function(a){return this.append(c.Component.fromParametersSha256Digest(a))};c.prototype.addSegment=function(a){return this.appendSegment(a)};c.prototype.getSubName=function(a,b){0>a&&(a=this.components.length- -a);void 0==b&&(b=this.components.length-a);for(var g=new c,f=a+b,m=a;m<f&&m<this.components.length;++m)g.components.push(this.components[m]);return g};c.prototype.getPrefix=function(a){return 0>
a?this.getSubName(0,this.components.length+a):this.getSubName(0,a)};c.prototype.cut=function(a){return new c(this.components.slice(0,this.components.length-a))};c.prototype.size=function(){return this.components.length};c.prototype.get=function(a){if(0<=a){if(a>=this.components.length)throw Error("Name.get: Index is out of bounds");return this.components[a]}if(a<-this.components.length)throw Error("Name.get: Index is out of bounds");return this.components[this.components.length- -a]};c.prototype.getComponentCount=
function(){return this.components.length};c.prototype.getComponent=function(a){return new f(this.components[a].getValue().buf())};c.prototype.indexOfFileName=function(){for(var a=this.size()-1;0<=a;--a){var b=this.components[a].getValue().buf();if(!(0>=b.length||0==b[0]||192==b[0]||193==b[0]||245<=b[0]&&255>=b[0]))return a}return-1};c.prototype.wireEncode=function(a){a=a||s.getDefaultWireFormat();return a.encodeName(this)};c.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();"object"===
typeof a&&a instanceof p?b.decodeName(this,a.buf(),!1):b.decodeName(this,a,!0)};c.prototype.compare=function(a,b,g,f,m){a instanceof c&&(g=a,a=0,b=this.size());void 0==f&&(f=0);void 0==m&&(m=g.size());0>a&&(a=this.size()- -a);0>f&&(f=g.size()- -f);b=Math.min(b,this.size()-a);m=Math.min(m,g.size()-f);for(var n=Math.min(b,m),p=0;p<n;++p){var s=this.components[a+p].compare(g.components[f+p]);if(0!=s)return s}return b<m?-1:b>m?1:0};c.prototype.equals=function(a){if(this.components.length!=a.components.length)return!1;
for(var b=this.components.length-1;0<=b;--b)if(!this.components[b].equals(a.components[b]))return!1;return!0};c.prototype.equalsName=function(a){return this.equals(a)};c.prototype.getContentDigestValue=function(){for(var a=this.size()-1;0<=a;--a){var b=c.getComponentContentDigestValue(this.components[a]);if(null!=b)return b}return null};c.getComponentContentDigestValue=function(a){"object"==typeof a&&a instanceof c.Component&&(a=a.getValue().buf());return a.length==c.ContentDigestPrefix.length+32+
c.ContentDigestSuffix.length&&L.arraysEqual(a.slice(0,c.ContentDigestPrefix.length),c.ContentDigestPrefix)&&L.arraysEqual(a.slice(a.length-c.ContentDigestSuffix.length,a.length),c.ContentDigestSuffix)?a.slice(c.ContentDigestPrefix.length,c.ContentDigestPrefix.length+32):null};c.ContentDigestPrefix=new f([193,46,77,46,71,193,1,170,2,133]);c.ContentDigestSuffix=new f([0]);c.toEscapedString=function(a){"object"==typeof a&&a instanceof c.Component?a=a.getValue().buf():"object"===typeof a&&a instanceof
p&&(a=a.buf());for(var b="",g=!1,f=0;f<a.length;++f)if(46!=a[f]){g=!0;break}if(g)for(f=0;f<a.length;++f)g=a[f],b=48<=g&&57>=g||65<=g&&90>=g||97<=g&&122>=g||43==g||45==g||46==g||95==g?b+String.fromCharCode(g):b+("%"+(16>g?"0":"")+g.toString(16).toUpperCase());else for(b="...",f=0;f<a.length;++f)b+=".";return b};c.fromEscapedString=function(a){a=unescape(a.trim());return null==a.match(/[^.]/)?2>=a.length?new p:new p(L.toNumbersFromString(a.substr(3,a.length-3)),!1):new p(L.toNumbersFromString(a),!1)};
c.fromEscapedStringAsBuffer=function(a){return c.fromEscapedString(a).buf()};c.prototype.getSuccessor=function(){return 0==this.size()?new c("/sha256digest=0000000000000000000000000000000000000000000000000000000000000000"):this.getPrefix(-1).append(this.get(-1).getSuccessor())};c.prototype.match=function(a){var b=this.components;a=a.components;if(b.length>a.length)return!1;for(var c=b.length-1;0<=c;--c)if(!b[c].equals(a[c]))return!1;return!0};c.prototype.isPrefixOf=function(a){return this.match(a)};
c.prototype.getChangeCount=function(){return this.changeCount};var ta=a.TlvEncoder,s=a.WireFormat,p=a.Blob,ma=a.ChangeCounter,c=a.Name,Ga={KEYNAME:1,KEY_LOCATOR_DIGEST:2};q.KeyLocatorType=Ga;var U=function kd(a,b){"object"===typeof a&&a instanceof kd?(this.type_=a.type_,this.keyName_=new ma(new c(a.getKeyName())),this.keyData_=a.keyData_):(this.type_=b,this.keyName_=new ma(new c),this.keyData_=new p,b==Ga.KEYNAME?this.keyName_.set("object"===typeof a&&a instanceof c?new c(a):new c):b==Ga.KEY_LOCATOR_DIGEST&&
(this.keyData_=new p(a)));this.changeCount_=0};q.KeyLocator=U;U.prototype.getType=function(){return this.type_};U.prototype.getKeyName=function(){return this.keyName_.get()};U.prototype.getKeyData=function(){return this.keyData_};U.prototype.getKeyDataAsBuffer=function(){return this.getKeyData().buf()};U.prototype.setType=function(a){this.type_=a;++this.changeCount_};U.prototype.setKeyName=function(a){this.keyName_.set("object"===typeof a&&a instanceof c?new c(a):new c);++this.changeCount_};U.prototype.setKeyData=
function(a){this.keyData_="object"===typeof a&&a instanceof p?a:new p(a);++this.changeCount_};U.prototype.clear=function(){this.type_=null;this.keyName_.set(new c);this.keyData_=new p;++this.changeCount_};U.prototype.equals=function(a){if(this.type_!=a.type_)return!1;if(this.type_==Ga.KEYNAME){if(!this.getKeyName().equals(a.getKeyName()))return!1}else if(this.type_==Ga.KEY_LOCATOR_DIGEST&&!this.getKeyData().equals(a.getKeyData()))return!1;return!0};U.canGetFromSignature=function(a){return a instanceof
Da||a instanceof Sa||a instanceof jb};U.getFromSignature=function(a){if(a instanceof Da||a instanceof Sa||a instanceof jb)return a.getKeyLocator();throw Error("KeyLocator.getFromSignature: Signature type does not have a KeyLocator");};U.prototype.getChangeCount=function(){this.keyName_.checkChanged()&&++this.changeCount_;return this.changeCount_};Object.defineProperty(U.prototype,"type",{get:function(){return this.getType()},set:function(a){this.setType(a)}});Object.defineProperty(U.prototype,"keyData",
{get:function(){return this.getKeyDataAsBuffer()},set:function(a){this.setKeyData(a)}});var Da=a.Sha256WithRsaSignature,Sa=a.Sha256WithEcdsaSignature,jb=a.HmacWithSha256Signature,c=a.Name,ya={BLOB:0,LINK:1,KEY:2,NACK:3,OTHER_CODE:32767};q.ContentType=ya;var Ya=function He(a,b,c,g,f,m){if(b)throw Error("MetaInfo constructor: timestamp support has been removed.");if(g)throw Error("MetaInfo constructor: locator support has been removed.");if("object"===typeof a&&a instanceof He)this.publisher_=a.publisher_,
this.type_=a.type_,this.otherTypeCode_=a.otherTypeCode_,this.freshnessPeriod_=a.freshnessPeriod_,this.finalBlockId_=a.finalBlockId_;else{if(a)throw Error("MetaInfo constructor: publisher support has been removed.");this.type=null==c||0>c?ya.BLOB:c;this.otherTypeCode_=-1;this.freshnessSeconds=f;this.finalBlockID=m}this.changeCount_=0};q.MetaInfo=Ya;Ya.prototype.getType=function(){return this.type_};Ya.prototype.getOtherTypeCode=function(){return this.otherTypeCode_};Ya.prototype.getFreshnessPeriod=
function(){return this.freshnessPeriod_};Ya.prototype.getFinalBlockId=function(){return this.finalBlockId_};Ya.prototype.getFinalBlockID=function(){return this.getFinalBlockId()};Ya.prototype.getFinalBlockIDAsBuffer=function(){return this.finalBlockId_.getValue().buf()};Ya.prototype.setType=function(a){this.type_=null==a||0>a?ya.BLOB:a;++this.changeCount_};Ya.prototype.setOtherTypeCode=function(a){if(0>a)throw Error("MetaInfo other type code must be non-negative");this.otherTypeCode_=a;++this.changeCount_};
Ya.prototype.setFreshnessPeriod=function(a){this.freshnessPeriod_=null==a||0>a?null:a;++this.changeCount_};Ya.prototype.setFinalBlockId=function(a){this.finalBlockId_="object"===typeof a&&a instanceof c.Component?a:new c.Component(a);++this.changeCount_};Ya.prototype.setFinalBlockID=function(a){this.setFinalBlockId(a)};Ya.prototype.getChangeCount=function(){return this.changeCount_};Object.defineProperty(Ya.prototype,"type",{get:function(){return this.getType()},set:function(a){this.setType(a)}});
Object.defineProperty(Ya.prototype,"freshnessSeconds",{get:function(){return null==this.freshnessPeriod_||0>this.freshnessPeriod_?null:this.freshnessPeriod_/1E3},set:function(a){this.freshnessPeriod_=null==a||0>a?null:1E3*a;++this.changeCount_}});Object.defineProperty(Ya.prototype,"finalBlockID",{get:function(){return this.getFinalBlockIDAsBuffer()},set:function(a){this.setFinalBlockId(a)}});var p=a.Blob,ma=a.ChangeCounter,U=a.KeyLocator,za=a.ValidityPeriod,Sa=function Ie(a){"object"===typeof a&&
a instanceof Ie?(this.keyLocator_=new ma(new U(a.getKeyLocator())),this.validityPeriod_=new ma(new za(a.getValidityPeriod())),this.signature_=a.signature_):(this.keyLocator_=new ma(new U),this.validityPeriod_=new ma(new za),this.signature_=new p);this.changeCount_=0};q.Sha256WithEcdsaSignature=Sa;Sa.prototype.clone=function(){return new Sa(this)};Sa.prototype.getKeyLocator=function(){return this.keyLocator_.get()};Sa.prototype.getValidityPeriod=function(){return this.validityPeriod_.get()};Sa.prototype.getSignature=
function(){return this.signature_};Sa.prototype.setKeyLocator=function(a){this.keyLocator_.set("object"===typeof a&&a instanceof U?new U(a):new U);++this.changeCount_};Sa.prototype.setValidityPeriod=function(a){this.validityPeriod_.set("object"===typeof a&&a instanceof za?new za(a):new za);++this.changeCount_};Sa.prototype.setSignature=function(a){this.signature_="object"===typeof a&&a instanceof p?a:new p(a);++this.changeCount_};Sa.prototype.getChangeCount=function(){var a=this.keyLocator_.checkChanged();
(a=this.validityPeriod_.checkChanged()||a)&&++this.changeCount_;return this.changeCount_};p=a.Blob;ma=a.ChangeCounter;U=a.KeyLocator;za=a.ValidityPeriod;Da=function Je(a){"object"===typeof a&&a instanceof Je?(this.keyLocator_=new ma(new U(a.getKeyLocator())),this.validityPeriod_=new ma(new za(a.getValidityPeriod())),this.signature_=a.signature_):(this.keyLocator_=new ma(new U),this.validityPeriod_=new ma(new za),this.signature_=new p);this.changeCount_=0};q.Sha256WithRsaSignature=Da;Da.prototype.clone=
function(){return new Da(this)};Da.prototype.getKeyLocator=function(){return this.keyLocator_.get()};Da.prototype.getValidityPeriod=function(){return this.validityPeriod_.get()};Da.prototype.getSignature=function(){return this.signature_};Da.prototype.getSignatureAsBuffer=function(){return this.signature_.buf()};Da.prototype.setKeyLocator=function(a){this.keyLocator_.set("object"===typeof a&&a instanceof U?new U(a):new U);++this.changeCount_};Da.prototype.setValidityPeriod=function(a){this.validityPeriod_.set("object"===
typeof a&&a instanceof za?new za(a):new za);++this.changeCount_};Da.prototype.setSignature=function(a){this.signature_="object"===typeof a&&a instanceof p?a:new p(a);++this.changeCount_};Da.prototype.getChangeCount=function(){var a=this.keyLocator_.checkChanged();(a=this.validityPeriod_.checkChanged()||a)&&++this.changeCount_;return this.changeCount_};Object.defineProperty(Da.prototype,"keyLocator",{get:function(){return this.getKeyLocator()},set:function(a){this.setKeyLocator(a)}});Object.defineProperty(Da.prototype,
"signature",{get:function(){return this.getSignatureAsBuffer()},set:function(a){this.setSignature(a)}});var p=a.Blob,Ub=function Ke(a){"object"===typeof a&&a instanceof Ke?(this.signature_=a.signature_,this.signatureInfoEncoding_=a.signatureInfoEncoding_,this.typeCode_=a.typeCode_):(this.signature_=new p,this.signatureInfoEncoding_=new p,this.typeCode_=null);this.changeCount_=0};q.GenericSignature=Ub;Ub.prototype.clone=function(){return new Ub(this)};Ub.prototype.getSignature=function(){return this.signature_};
Ub.prototype.getSignatureAsBuffer=function(){return this.signature_.buf()};Ub.prototype.getSignatureInfoEncoding=function(){return this.signatureInfoEncoding_};Ub.prototype.getTypeCode=function(){return this.typeCode_};Ub.prototype.setSignature=function(a){this.signature_="object"===typeof a&&a instanceof p?a:new p(a);++this.changeCount_};Ub.prototype.setSignatureInfoEncoding=function(a,b){this.signatureInfoEncoding_="object"===typeof a&&a instanceof p?a:new p(a);this.typeCode_=b;++this.changeCount_};
Ub.prototype.getChangeCount=function(){return this.changeCount_};Object.defineProperty(Ub.prototype,"signature",{get:function(){return this.getSignatureAsBuffer()},set:function(a){this.setSignature(a)}});p=a.Blob;ma=a.ChangeCounter;U=a.KeyLocator;jb=function Oe(a){"object"===typeof a&&a instanceof Oe?(this.keyLocator_=new ma(new U(a.getKeyLocator())),this.signature_=a.signature_):(this.keyLocator_=new ma(new U),this.signature_=new p);this.changeCount_=0};q.HmacWithSha256Signature=jb;jb.prototype.clone=
function(){return new jb(this)};jb.prototype.getKeyLocator=function(){return this.keyLocator_.get()};jb.prototype.getSignature=function(){return this.signature_};jb.prototype.getSignatureAsBuffer=function(){return this.signature_.buf()};jb.prototype.setKeyLocator=function(a){this.keyLocator_.set("object"===typeof a&&a instanceof U?new U(a):new U);++this.changeCount_};jb.prototype.setSignature=function(a){this.signature_="object"===typeof a&&a instanceof p?a:new p(a);++this.changeCount_};jb.prototype.getChangeCount=
function(){this.keyLocator_.checkChanged()&&++this.changeCount_;return this.changeCount_};Object.defineProperty(jb.prototype,"keyLocator",{get:function(){return this.getKeyLocator()},set:function(a){this.setKeyLocator(a)}});Object.defineProperty(jb.prototype,"signature",{get:function(){return this.getSignatureAsBuffer()},set:function(a){this.setSignature(a)}});var p=a.Blob,qb=function Le(a){this.signature_="object"===typeof a&&a instanceof Le?a.signature_:new p;this.changeCount_=0};q.DigestSha256Signature=
qb;qb.prototype.clone=function(){return new qb(this)};qb.prototype.getSignature=function(){return this.signature_};qb.prototype.setSignature=function(a){this.signature_="object"===typeof a&&a instanceof p?a:new p(a);++this.changeCount_};qb.prototype.getChangeCount=function(){return this.changeCount_};Object.defineProperty(qb.prototype,"signature",{get:function(){return this.getSignature()},set:function(a){this.setSignature(a)}});var p=a.Blob,Wa=a.SignedBlob,ma=a.ChangeCounter,c=a.Name,Da=a.Sha256WithRsaSignature,
Ya=a.MetaInfo,wc=a.IncomingFaceId,$c=a.CongestionMark,s=a.WireFormat,ea=a,Q=function Me(a,b,g){a instanceof Me?(this.name_=new ma(new c(a.getName())),this.metaInfo_=new ma(new Ya(a.getMetaInfo())),this.signature_=new ma(a.getSignature().clone()),this.content_=a.content_,this.defaultWireEncoding_=a.getDefaultWireEncoding(),this.defaultFullName_=new c(a.defaultFullName_),this.defaultWireEncodingFormat_=a.defaultWireEncodingFormat_):(this.name_="string"===typeof a?new ma(new c(a)):new ma("object"===
typeof a&&a instanceof c?new c(a):new c),"object"===typeof b&&b instanceof Ya?(a=b,b=g):a=null,this.metaInfo_=new ma("object"===typeof a&&a instanceof Ya?new Ya(a):new Ya),this.content_="object"===typeof b&&b instanceof p?b:new p(b,!0),this.signature_=new ma(new Da),this.defaultWireEncoding_=new Wa,this.defaultFullName_=new c,this.defaultWireEncodingFormat_=null);this.changeCount_=this.getDefaultWireEncodingChangeCount_=0;this.lpPacket_=null};q.Data=Q;Q.prototype.getName=function(){return this.name_.get()};
Q.prototype.getMetaInfo=function(){return this.metaInfo_.get()};Q.prototype.getSignature=function(){return this.signature_.get()};Q.prototype.getContent=function(){return this.content_};Q.prototype.getContentAsBuffer=function(){return this.content_.buf()};Q.prototype.getDefaultWireEncoding=function(){this.getDefaultWireEncodingChangeCount_!=this.getChangeCount()&&(this.defaultWireEncoding_=new Wa,this.defaultWireEncodingFormat_=null,this.getDefaultWireEncodingChangeCount_=this.getChangeCount());return this.defaultWireEncoding_};
Q.prototype.getDefaultWireEncodingFormat=function(){return this.defaultWireEncodingFormat_};Q.prototype.getIncomingFaceId=function(){var a=null===this.lpPacket_?null:wc.getFirstHeader(this.lpPacket_);return null===a?null:a.getFaceId()};Q.prototype.getCongestionMark=function(){var a=null===this.lpPacket_?null:$c.getFirstHeader(this.lpPacket_);return null===a?0:a.getCongestionMark()};Q.prototype.getFullName=function(a){a=a||s.getDefaultWireFormat();if(!this.getDefaultWireEncoding().isNull()&&0<this.defaultFullName_.size()&&
this.getDefaultWireEncodingFormat()==a)return this.defaultFullName_;var b=new c(this.getName()),g=ea.createHash("sha256");g.update(this.wireEncode(a).buf());b.appendImplicitSha256Digest(new p(g.digest(),!1));a==s.getDefaultWireFormat()&&(this.defaultFullName_=b);return b};Q.prototype.setName=function(a){this.name_.set("object"===typeof a&&a instanceof c?new c(a):new c);++this.changeCount_;return this};Q.prototype.setMetaInfo=function(a){this.metaInfo_.set("object"===typeof a&&a instanceof Ya?new Ya(a):
new Ya);++this.changeCount_;return this};Q.prototype.setSignature=function(a){this.signature_.set(null==a?new Da:a.clone());++this.changeCount_;return this};Q.prototype.setContent=function(a){this.content_="object"===typeof a&&a instanceof p?a:new p(a,!0);++this.changeCount_;return this};Q.prototype.wireEncode=function(a){a=a||s.getDefaultWireFormat();if(!this.getDefaultWireEncoding().isNull()&&this.getDefaultWireEncodingFormat()==a)return this.getDefaultWireEncoding();var b=a.encodeData(this),b=
new Wa(b.encoding,b.signedPortionBeginOffset,b.signedPortionEndOffset);a==s.getDefaultWireFormat()&&this.setDefaultWireEncoding(b,s.getDefaultWireFormat());return b};Q.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();var c;c="object"===typeof a&&a instanceof p?b.decodeData(this,a.buf(),!1):b.decodeData(this,a,!0);b==s.getDefaultWireFormat()?this.setDefaultWireEncoding(new Wa(new p(a,!0),c.signedPortionBeginOffset,c.signedPortionEndOffset),s.getDefaultWireFormat()):this.setDefaultWireEncoding(new Wa,
null)};Q.prototype.setLpPacket=function(a){this.lpPacket_=a;return this};Q.prototype.getChangeCount=function(){var a=this.name_.checkChanged(),a=this.metaInfo_.checkChanged()||a;(a=this.signature_.checkChanged()||a)&&++this.changeCount_;return this.changeCount_};Q.prototype.setDefaultWireEncoding=function(a,b){this.defaultWireEncoding_=a;this.defaultWireEncodingFormat_=b;this.getDefaultWireEncodingChangeCount_=this.getChangeCount()};Object.defineProperty(Q.prototype,"name",{get:function(){return this.getName()},
set:function(a){this.setName(a)}});Object.defineProperty(Q.prototype,"metaInfo",{get:function(){return this.getMetaInfo()},set:function(a){this.setMetaInfo(a)}});Object.defineProperty(Q.prototype,"signature",{get:function(){return this.getSignature()},set:function(a){this.setSignature(a)}});Object.defineProperty(Q.prototype,"content",{get:function(){return this.getContentAsBuffer()},set:function(a){this.setContent(a)}});x.prototype=Error();x.prototype.name="SecurityException";q.SecurityException=
x;Fc.prototype=new x;Fc.prototype.name="UnrecognizedKeyFormatException";q.UnrecognizedKeyFormatException=Fc;D.prototype=new x;D.prototype.name="UnrecognizedDigestAlgorithmException";q.UnrecognizedDigestAlgorithmException=D;Yb.prototype=Error();Yb.prototype.name="InvalidArgumentException";q.InvalidArgumentException=Yb;var ba=function(){};q.KeyType=ba;ba.RSA=0;ba.EC=1;ba.ECDSA=1;ba.AES=128;var ad=function(){};q.KeyClass=ad;ad.PUBLIC=1;ad.PRIVATE=2;ad.SYMMETRIC=3;var Aa=function(){};q.DigestAlgorithm=
Aa;Aa.SHA256=1;var ea=a,F=a.Interest,s=a.WireFormat,ta=a.TlvEncoder,p=a.Blob,bd=function(){this.lastUsedTimestamp_=Math.round((new Date).getTime());this.nowOffsetMilliseconds_=0};q.CommandInterestPreparer=bd;bd.prototype.prepareCommandInterestName=function(a,b){void 0==b&&s.getDefaultWireFormat();for(var c=(new Date).getTime()+this.nowOffsetMilliseconds_,c=Math.round(c);c<=this.lastUsedTimestamp_;)c+=1;this.lastUsedTimestamp_=c;var g=new ta(8);g.writeNonNegativeInteger(c);a.getName().append(new p(g.getOutput(),
!1));a.getName().append(new p(ea.randomBytes(8),!1))};bd.prototype.setNowOffsetMilliseconds_=function(a){this.nowOffsetMilliseconds_=a};var F=a.Interest,s=a.WireFormat,Y=a.SigningInfo,bd=a.CommandInterestPreparer,ic=function(a){bd.call(this);this.keyChain_=a};ic.prototype=new bd;ic.prototype.name="CommandInterestSigner";q.CommandInterestSigner=ic;ic.POS_SIGNATURE_VALUE=-1;ic.POS_SIGNATURE_INFO=-2;ic.POS_NONCE=-3;ic.POS_TIMESTAMP=-4;ic.MINIMUM_SIZE=4;ic.prototype.makeCommandInterest=function(a,b,c,
g,f){var m=b,n=c,p=g;b=m instanceof Y?m:void 0;c=m instanceof s?m:n instanceof s?n:void 0;"function"===typeof m?(g=m,f=n):"function"===typeof n?(g=n,f=p):"function"===typeof p?g=p:f=g=void 0;void 0==b&&(b=new Y);void 0==c&&(c=s.getDefaultWireFormat());a=new F(a);this.prepareCommandInterestName(a,c);return this.keyChain_.sign(a,b,c,g,f)};var rb=function(){};q.KeyIdType=rb;rb.USER_SPECIFIED=0;rb.SHA256=1;rb.RANDOM=2;var c=a.Name,rb=a.KeyIdType,ba=a.KeyType,Cb=function(a,b){this.keyType_=a;if(b instanceof
c.Component){if(0==b.getValue().size())throw Error("KeyParams: keyId is empty");this.keyIdType_=rb.USER_SPECIFIED;this.keyId_=b}else{if(b==rb.USER_SPECIFIED)throw Error("KeyParams: KeyIdType is USER_SPECIFIED");this.keyIdType_=b;this.keyId_=new c.Component}};q.KeyParams=Cb;Cb.prototype.getKeyType=function(){return this.keyType_};Cb.prototype.getKeyIdType=function(){return this.keyIdType_};Cb.prototype.getKeyId=function(){return this.keyId_};Cb.prototype.setKeyId=function(a){this.keyId_=a};var Vb=
function Vd(a,b){if(a instanceof c.Component)Cb.call(this,Vd.getType(),a),this.size_=void 0==b?Vd.getDefaultSize():b;else if(void 0!=a){var g=void 0!=b?b:rb.RANDOM;Cb.call(this,Vd.getType(),g);this.size_=a}else Cb.call(this,Vd.getType(),rb.RANDOM),this.size_=Vd.getDefaultSize()};Vb.prototype=new Cb;Vb.prototype.name="RsaKeyParams";q.RsaKeyParams=Vb;Vb.prototype.getKeySize=function(){return this.size_};Vb.getDefaultSize=function(){return 2048};Vb.getType=function(){return ba.RSA};var Kc=function Wd(a,
b){if(a instanceof c.Component)Cb.call(this,Wd.getType(),a),this.size_=void 0==b?Wd.getDefaultSize():b;else if(void 0!=a){var g=void 0!=b?b:rb.RANDOM;Cb.call(this,Wd.getType(),g);this.size_=a}else Cb.call(this,Wd.getType(),rb.RANDOM),this.size_=Wd.getDefaultSize()};Kc.prototype=new Cb;Kc.prototype.name="EcKeyParams";q.EcKeyParams=Kc;Kc.prototype.getKeySize=function(){return this.size_};Kc.getDefaultSize=function(){return 256};Kc.getType=function(){return ba.EC};var Yd=function(a,b){Kc.call(this,a,
b)};Yd.prototype=new Kc;Yd.prototype.name="EcdsaKeyParams";q.EcdsaKeyParams=Yd;Yd.getDefaultSize=function(){return Kc.getDefaultSize()};Yd.getType=function(){return Kc.getType()};var od=function Xd(a,b){if(a instanceof c.Component)Cb.call(this,Xd.getType(),a),this.size_=void 0==b?Xd.getDefaultSize():b;else if(void 0!=a){var g=void 0!=b?b:rb.RANDOM;Cb.call(this,Xd.getType(),g);this.size_=a}else Cb.call(this,Xd.getType(),rb.RANDOM),this.size_=Xd.getDefaultSize()};od.prototype=new Cb;od.prototype.name=
"AesKeyParams";q.AesKeyParams=od;od.prototype.getKeySize=function(){return this.size_};od.getDefaultSize=function(){return 64};od.getType=function(){return ba.AES};var c=a.Name,Q=a.Data,ya=a.ContentType,Da=a.Sha256WithRsaSignature,Sa=a.Sha256WithEcdsaSignature,U=a.KeyLocator,Ga=a.KeyLocatorType,s=a.WireFormat,Aa=a.DigestAlgorithm,ba=a.KeyType,za=a.ValidityPeriod,M=a.CertificateV2,b=a.SyncPromise,Za=a.Tpm,Wb=a.TpmBackEndMemory,p=a.Blob,n=a.Tlv,ta=a.TlvEncoder,na=a.TlvDecoder,bb=a.TlvWireFormat,Ba=
a.PublicKey,Nd=function Ne(a,b,g,f,y,w){a instanceof c?(void 0==y&&(y=Aa.SHA256),void 0==w&&(w=s.getDefaultWireFormat()),this.certificate_=Ne.makeSelfSignedCertificate_(a,b,g,f,y,w),this.privateKeyBag_=b):a instanceof Q?(this.certificate_=new Q(a),this.privateKeyBag_=b):this.wireDecode(a)};q.SafeBag=Nd;Nd.prototype.getCertificate=function(){return this.certificate_};Nd.prototype.getPrivateKeyBag=function(){return this.privateKeyBag_};Nd.prototype.wireDecode=function(a){"object"===typeof a&&a instanceof
p&&(a=a.buf());a=new na(a);var b=a.readNestedTlvsStart(n.SafeBag_SafeBag),c=a.getOffset(),g=a.readNestedTlvsStart(n.Data);a.seek(g);this.certificate_=new Q;this.certificate_.wireDecode(a.getSlice(c,g),bb.get());this.privateKeyBag_=new p(a.readBlobTlv(n.SafeBag_EncryptedKeyBag),!0);a.finishNestedTlvs(b)};Nd.prototype.wireEncode=function(){var a=new ta(256),b=a.getLength();a.writeBlobTlv(n.SafeBag_EncryptedKeyBag,this.privateKeyBag_.buf());a.writeBuffer(this.certificate_.wireEncode(bb.get()).buf());
a.writeTypeAndLength(n.SafeBag_SafeBag,a.getLength()-b);return new p(a.getOutput(),!1)};Nd.makeSelfSignedCertificate_=function(a,g,f,m,n,y){var w=new M,r=(new Date).getTime(),pa=new c(a);pa.append("self").appendVersion(r);w.setName(pa);w.getMetaInfo().setType(ya.KEY);w.getMetaInfo().setFreshnessPeriod(36E5);pa=new Ba(f);w.setContent(pa.getKeyDer());f=new Za("","",new Wb);b.complete(null,f.importPrivateKeyPromise_(a,g.buf(),m,!0));if(pa.getKeyType()==ba.RSA)w.setSignature(new Da);else if(pa.getKeyType()==
ba.EC)w.setSignature(new Sa);else throw Error("Unsupported key type");g=w.getSignature();U.getFromSignature(g).setType(Ga.KEYNAME);U.getFromSignature(g).setKeyName(a);za.getFromSignature(g).setPeriod(r,r+63072E7);r=w.wireEncode(y);a=b.complete(null,f.signPromise(r.signedBuf(),a,n,!0));g.setSignature(a);w.wireEncode(y);return w};var c=a.Name,Jb=a.PibIdentity,oa=a.PibKey,Aa=a.DigestAlgorithm,za=a.ValidityPeriod,Y=function ve(a,b){this.validityPeriod_=new za;if(void 0==a)this.reset(ve.SignerType.NULL),
this.digestAlgorithm_=Aa.SHA256;else if("number"===typeof a)this.reset(a),void 0!=b&&(this.name_=new c(b)),this.digestAlgorithm_=Aa.SHA256;else if(a instanceof Jb)this.digestAlgorithm_=Aa.SHA256,this.setPibIdentity(a);else if(a instanceof oa)this.digestAlgorithm_=Aa.SHA256,this.setPibKey(a);else if("string"===typeof a){if(signingString=a,this.reset(ve.SignerType.NULL),this.digestAlgorithm_=Aa.SHA256,""!=signingString){var g=signingString.indexOf(":");if(0>g)throw Error("Invalid signing string cannot represent SigningInfo");
var y=signingString.substring(0,g),g=signingString.substring(g+1);if("id"==y)g==ve.getDigestSha256Identity().toUri()?this.setSha256Signing():this.setSigningIdentity(new c(g));else if("key"==y)this.setSigningKeyName(new c(g));else if("cert"==y)this.setSigningCertificateName(new c(g));else throw Error("Invalid signing string scheme");}}else throw Error("SigningInfo: Unrecognized type");};q.SigningInfo=Y;Y.SignerType=function(){};Y.SignerType.NULL=0;Y.SignerType.ID=1;Y.SignerType.KEY=2;Y.SignerType.CERT=
3;Y.SignerType.SHA256=4;Y.prototype.setSigningIdentity=function(a){this.reset(Y.SignerType.ID);this.name_=new c(a);return this};Y.prototype.setSigningKeyName=function(a){this.reset(Y.SignerType.KEY);this.name_=new c(a);return this};Y.prototype.setSigningCertificateName=function(a){this.reset(Y.SignerType.CERT);this.name_=new c(a);return this};Y.prototype.setSha256Signing=function(){this.reset(Y.SignerType.SHA256);this.digestAlgorithm_=Aa.SHA256;return this};Y.prototype.setPibIdentity=function(a){this.reset(Y.SignerType.ID);
null!=a&&(this.name_=a.getName());this.identity_=a;return this};Y.prototype.setPibKey=function(a){this.reset(Y.SignerType.KEY);null!=a&&(this.name_=a.getName());this.key_=a;return this};Y.prototype.getSignerType=function(){return this.type_};Y.prototype.getSignerName=function(){return this.name_};Y.prototype.getPibIdentity=function(){if(this.type_!=Y.SignerType.ID)throw Error("getPibIdentity: The signer type is not SignerType.ID");return this.identity_};Y.prototype.getPibKey=function(){if(this.type_!=
Y.SignerType.KEY)throw Error("getPibKey: The signer type is not SignerType.KEY");return this.key_};Y.prototype.setDigestAlgorithm=function(a){this.digestAlgorithm_=a;return this};Y.prototype.getDigestAlgorithm=function(){return this.digestAlgorithm_};Y.prototype.setValidityPeriod=function(a){this.validityPeriod_=new za(a);return this};Y.prototype.getValidityPeriod=function(){return this.validityPeriod_};Y.prototype.toString=function(){if(this.type_==Y.SignerType.NULL)return"";if(this.type_==Y.SignerType.ID)return"id:"+
this.getSignerName().toUri();if(this.type_==Y.SignerType.KEY)return"key:"+this.getSignerName().toUri();if(this.type_==Y.SignerType.CERT)return"cert:"+this.getSignerName().toUri();if(this.type_==Y.SignerType.SHA256)return"id:"+Y.getDigestSha256Identity().toUri();throw Error("Unknown signer type");};Y.getDigestSha256Identity=function(){return new c("/localhost/identity/digest-sha256")};Y.prototype.reset=function(a){if(a!=Y.SignerType.NULL&&a!=Y.SignerType.ID&&a!=Y.SignerType.KEY&&a!=Y.SignerType.CERT&&
a!=Y.SignerType.SHA256)throw Error("SigningInfo: The signerType is not valid");this.type_=a;this.name_=new c;this.key_=this.identity_=null;this.validityPeriod_=new za};za=function Pe(a,b){this.changeCount_=0;"object"===typeof a&&a instanceof Pe?(validityPeriod=a,this.notBefore_=validityPeriod.notBefore_,this.notAfter_=validityPeriod.notAfter_):void 0!=b?(notBefore=a,this.setPeriod(notBefore,b)):this.clear()};q.ValidityPeriod=za;za.prototype.hasPeriod=function(){return!(this.notBefore_===Number.MAX_VALUE&&
this.notAfter_===-Number.MAX_VALUE)};za.prototype.getNotBefore=function(){return this.notBefore_};za.prototype.getNotAfter=function(){return this.notAfter_};za.prototype.clear=function(){this.notBefore_=Number.MAX_VALUE;this.notAfter_=-Number.MAX_VALUE;++this.changeCount_};za.prototype.setPeriod=function(a,b){this.notBefore_=Math.round(1E3*Math.ceil(Math.round(a)/1E3));this.notAfter_=Math.round(1E3*Math.floor(Math.round(b)/1E3));++this.changeCount_;return this};za.prototype.isValid=function(a){void 0==
a&&(a=Math.round(1E3*Math.ceil(Math.round((new Date).getTime())/1E3)));return this.notBefore_<=a&&a<=this.notAfter_};za.canGetFromSignature=function(a){return void 0!=a.constructor&&("Sha256WithRsaSignature"===a.constructor.name||"Sha256WithEcdsaSignature"===a.constructor.name)};za.getFromSignature=function(a){if(void 0==a.constructor||"Sha256WithRsaSignature"!==a.constructor.name&&"Sha256WithEcdsaSignature"!==a.constructor.name)throw Error("ValidityPeriod.getFromSignature: Signature type does not have a ValidityPeriod");
return a.getValidityPeriod()};za.prototype.getChangeCount=function(){return this.changeCount_};var ea=a,b=a.SyncPromise,p=a.Blob,s=a.WireFormat,ba=a.KeyType,Aa=a.DigestAlgorithm,yb=a.UseSubtleCrypto,M=a.CertificateV2,Ba=a.PublicKey,Na=function(){};q.VerificationHelpers=Na;Na.verifySignaturePromise=function(a,c,g,y,w){"boolean"===typeof y&&(w=y,y=void 0);a instanceof p&&(a=a.buf());c instanceof p&&(c=c.buf());if(!(g instanceof Ba))try{g instanceof p||(g=new p(g)),g=new Ba(g)}catch(r){return b.reject(Error("verifySignaturePromise: Error decoding public key DER: "+
r))}void 0==y&&(y=Aa.SHA256);if(y==Aa.SHA256)if(g.getKeyType()==ba.RSA){if(yb()&&!w){var pa={name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};return crypto.subtle.importKey("spki",g.getKeyDer().buf().buffer,pa,!0,["verify"]).then(function(y){return crypto.subtle.verify(pa,y,c,a)})}try{null===Na.verifyUsesString_&&Na.setVerifyUsesString_();for(var t=g.getKeyDer().buf().toString("base64"),B="-----BEGIN PUBLIC KEY-----\n",f=0;f<t.length;f+=64)B+=t.substr(f,64)+"\n";var B=B+"-----END PUBLIC KEY-----",
Lb=ea.createVerify("RSA-SHA256");Lb.update(a);var m=Na.verifyUsesString_?c.toString("binary"):c;return b.resolve(Lb.verify(B,m))}catch(n){return b.reject(Error("verifySignaturePromise: Error is RSA verify: "+n))}}else if(g.getKeyType()==ba.EC)try{null===Na.verifyUsesString_&&Na.setVerifyUsesString_();t=g.getKeyDer().buf().toString("base64");B="-----BEGIN PUBLIC KEY-----\n";for(f=0;f<t.length;f+=64)B+=t.substr(f,64)+"\n";B+="-----END PUBLIC KEY-----";Lb=ea.createVerify("sha256");Lb.update(a);m=Na.verifyUsesString_?
c.toString("binary"):c;return b.resolve(Lb.verify(B,m))}catch(s){return b.reject(Error("verifySignaturePromise: Error is ECDSA verify: "+s))}else return b.reject(Error("verifySignaturePromise: Invalid key type"));else return b.reject(Error("verifySignaturePromise: Invalid digest algorithm"))};Na.verifySignature=function(a,c,g,y,w,r){"function"===typeof y&&(r=w,w=y,y=void 0);return b.complete(w,r,this.verifySignaturePromise(a,c,g,y,!w))};Na.verifyDataSignaturePromise=function(a,c,g,y,w){var r=g,pa=
y;g="number"===typeof r?r:void 0;y=r instanceof s?r:pa instanceof s?pa:void 0;w="boolean"===typeof r?r:"boolean"===typeof pa?pa:"boolean"===typeof w?w:!1;var t;if(c instanceof M)try{t=c.getPublicKey()}catch(B){return b.resolve(!1)}else t=c;c=a.wireEncode(y);return Na.verifySignaturePromise(c.signedBuf(),a.getSignature().getSignature(),t,g,w)};Na.verifyInterestSignaturePromise=function(a,c,g,y,w){var r=g,pa=y;g="number"===typeof r?r:void 0;y=r instanceof s?r:pa instanceof s?pa:void 0;w="boolean"===
typeof r?r:"boolean"===typeof pa?pa:"boolean"===typeof w?w:!1;var t;if(c instanceof M)try{t=c.getPublicKey()}catch(B){return b.resolve(!1)}else t=c;void 0==y&&(y=s.getDefaultWireFormat());c=Na.extractSignature_(a,y);if(null==c)return b.resolve(!1);a=a.wireEncode(y);return Na.verifySignaturePromise(a.signedBuf(),c.getSignature(),t,g,w)};Na.verifyDigest=function(a,b,c){a instanceof p&&(a=a.buf());b instanceof p&&(b=b.buf());if(c==Aa.SHA256){c=ea.createHash("sha256");c.update(a);a=c.digest();if(b.length!=
a.length)return!1;for(c=0;c<b.length;++c)if(b[c]!=a[c])return!1;return!0}throw Error("verifyDigest: Invalid digest algorithm");};Na.extractSignature_=function(a,b){if(2>a.getName().size())return null;try{return b.decodeSignatureInfoAndValue(a.getName().get(-2).getValue().buf(),a.getName().get(-1).getValue().buf(),!1)}catch(c){return null}};Na.verifyUsesString_=null;Na.setVerifyUsesString_=function(){var a=ea.createHash("sha256").digest();Na.verifyUsesString_="string"===typeof a};var pd=a.constants,
ea=a,p=a.Blob,m=a.DerNode,x=a.SecurityException,Fc=a.UnrecognizedKeyFormatException,ba=a.KeyType,ha=a.EncryptAlgorithmType,b=a.SyncPromise,yb=a.UseSubtleCrypto,Aa=a.DigestAlgorithm,Ba=function Ae(a){if(a){this.keyDer=a;var y=null;try{var b=m.parse(a.buf(),0).getChildren(),y=m.getSequence(b,0).getChildren()[0].toVal()}catch(r){throw new Fc(Error("PublicKey.decodeKeyType: Error decoding the public key: "+r.message));}y==Ae.RSA_ENCRYPTION_OID?this.keyType=ba.RSA:y==Ae.EC_ENCRYPTION_OID&&(this.keyType=
ba.EC)}else this.keyDer=new p,this.keyType=null};q.PublicKey=Ba;Ba.prototype.toDer=function(){return m.parse(this.keyDer.buf())};Ba.prototype.getKeyType=function(){return this.keyType};Ba.prototype.getDigest=function(a){void 0==a&&(a=Aa.SHA256);if(a==Aa.SHA256)return a=ea.createHash("sha256"),a.update(this.keyDer.buf()),new p(a.digest(),!1);throw new x(Error("Wrong format!"));};Ba.prototype.getKeyDer=function(){return this.keyDer};Ba.prototype.encryptPromise=function(a,c,y){"object"===typeof a&&a instanceof
p&&(a=a.buf());if(yb()&&!y&&c!=ha.RsaPkcs)return c==ha.RsaOaep?this.keyType!=ba.RSA?Promise.reject(Error("The key type must be RSA")):crypto.subtle.importKey("spki",this.keyDer.buf(),{name:"RSA-OAEP",hash:{name:"SHA-1"}},!1,["encrypt"]).then(function(y){return crypto.subtle.encrypt({name:"RSA-OAEP"},y,a)}).then(function(a){return Promise.resolve(new p(new Uint8Array(a),!1))}):Promise.reject(Error("unsupported padding scheme"));var w=this.keyDer.buf().toString("base64");y="-----BEGIN PUBLIC KEY-----\n";
for(var r=0;r<w.length;r+=64)y+=w.substr(r,64)+"\n";y+="-----END PUBLIC KEY-----";if(c==ha.RsaPkcs){if(this.keyType!=ba.RSA)return b.reject(Error("The key type must be RSA"));c=pd.RSA_PKCS1_PADDING}else if(c==ha.RsaOaep){if(this.keyType!=ba.RSA)return b.reject(Error("The key type must be RSA"));c=pd.RSA_PKCS1_OAEP_PADDING}else return b.reject(Error("unsupported padding scheme"));try{return b.resolve(new p(ea.publicEncrypt({key:y,padding:c},a),!1))}catch(pa){return b.reject(pa)}};Ba.prototype.encrypt=
function(a,c){return b.getValue(this.encryptPromise(a,c,!0))};Ba.RSA_ENCRYPTION_OID="1.2.840.113549.1.1.1";Ba.EC_ENCRYPTION_OID="1.2.840.10045.2.1";var m=a.DerNode,fb=a.OID,qd=function(a,b,y){this.extensionId="string"===typeof a?new fb(a):a;this.isCritical=b;this.extensionValue=y};q.CertificateExtension=qd;qd.prototype.toDer=function(){var a=new m.DerSequence,b=new m.DerOid(this.extensionId),y=new m.DerBoolean(this.isCritical),w=new m.DerOctetString(this.extensionValue.buf());a.addChild(b);a.addChild(y);
a.addChild(w);a.getSize();return a};qd.prototype.toDerBlob=function(){return this.toDer().encode()};qd.prototype.getOid=function(){return this.extensionId};qd.prototype.getIsCritical=function(){return this.isCritical};qd.prototype.getValue=function(){return this.extensionValue};var p=a.Blob,fb=a.OID,m=a.DerNode,cd=function(a,b){this.oid="string"===typeof a?new fb(a):a;this.value=b};q.CertificateSubjectDescription=cd;cd.prototype.toDer=function(){var a=new m.DerSequence,b=new m.DerOid(this.oid),y=
new m.DerPrintableString((new p(this.value)).buf());a.addChild(b);a.addChild(y);return a};cd.prototype.getOidString=function(){return this.oid.toString()};cd.prototype.getValue=function(){return this.value};var Q=a.Data,ya=a.ContentType,s=a.WireFormat,m=a.DerNode,ba=a.KeyType,Ba=a.PublicKey,cd=a.CertificateSubjectDescription,qd=a.CertificateExtension,wa=function(a){void 0!=a?Q.call(this,a):Q.call(this);this.subjectDescriptionList=[];this.extensionList=[];this.notBefore=Number.MAX_VALUE;this.notAfter=
-Number.MAX_VALUE;this.key=new Ba;void 0!=a&&this.decode()};wa.prototype=new Q;wa.prototype.name="Certificate";q.Certificate=wa;wa.prototype.encode=function(){var a=this.toDer();this.setContent(a.encode());this.getMetaInfo().setType(ya.KEY)};wa.prototype.addSubjectDescription=function(a){this.subjectDescriptionList.push(a)};wa.prototype.getSubjectDescriptionList=function(){return this.subjectDescriptionList};wa.prototype.addExtension=function(a){this.extensionList.push(a)};wa.prototype.getExtensionList=
function(){return this.extensionList};wa.prototype.setNotBefore=function(a){this.notBefore=a};wa.prototype.getNotBefore=function(){return this.notBefore};wa.prototype.setNotAfter=function(a){this.notAfter=a};wa.prototype.getNotAfter=function(){return this.notAfter};wa.prototype.setPublicKeyInfo=function(a){this.key=a};wa.prototype.getPublicKeyInfo=function(){return this.key};wa.prototype.getPublicKeyDer=function(){if(this.key.getKeyDer().isNull())throw Error("The public key is not set");return this.key.getKeyDer()};
wa.prototype.isTooEarly=function(){return(new Date).getTime()<this.getNotBefore()};wa.prototype.isTooLate=function(){return(new Date).getTime()>this.getNotAfter()};wa.prototype.isInValidityPeriod=function(a){return this.getSignature().getValidityPeriod().isValid(a)};wa.prototype.toDer=function(){var a=new m.DerSequence,b=new m.DerSequence,y=new m.DerGeneralizedTime(this.getNotBefore()),w=new m.DerGeneralizedTime(this.getNotAfter());b.addChild(y);b.addChild(w);a.addChild(b);y=new m.DerSequence;for(b=
0;b<this.subjectDescriptionList.length;++b)y.addChild(this.subjectDescriptionList[b].toDer());a.addChild(y);a.addChild(this.key.toDer());if(0<this.extensionList.length){y=new m.DerSequence;for(b=0;b<this.extensionList.length;++b)y.addChild(this.extensionList[b].toDer());a.addChild(y)}return a};wa.prototype.decode=function(){var a=m.parse(this.getContent().buf()).getChildren(),b=m.getSequence(a,0).getChildren();this.notBefore=b[0].toVal();this.notAfter=b[1].toVal();for(var y=m.getSequence(a,1).getChildren(),
b=0;b<y.length;++b){var w=m.getSequence(y,b).getChildren(),r=w[0].toVal(),w=w[1].toVal().buf().toString("binary");this.addSubjectDescription(new cd(r,w))}b=a[2].encode();this.key=new Ba(b);if(3<a.length)for(a=m.getSequence(a,3).getChildren(),b=0;b<a.length;++b)w=m.getSequence(a,b).getChildren(),r=w[0].toVal(),y=w[1].toVal(),w=w[2].toVal(),this.addExtension(new qd(r,y,w))};wa.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();Q.prototype.wireDecode.call(this,a,b);this.decode()};wa.prototype.toString=
function(){var a;a="Certificate name:\n"+("  "+this.getName().toUri()+"\n");a+="Validity:\n";var b=wa.toIsoString(Math.round(this.getNotBefore())),y=wa.toIsoString(Math.round(this.getNotAfter()));a=a+("  NotBefore: "+b+"\n")+("  NotAfter: "+y+"\n");for(b=0;b<this.subjectDescriptionList.length;++b)y=this.subjectDescriptionList[b],a+="Subject Description:\n",a+="  "+y.getOidString()+": "+y.getValue()+"\n";a+="Public key bits:\n";y=this.getPublicKeyDer().buf().toString("base64");for(b=0;b<y.length;b+=
64)a+=y.substring(b,Math.min(b+64,y.length))+"\n";if(0<this.extensionList.length)for(a+="Extensions:\n",b=0;b<this.extensionList.length;++b)y=this.extensionList[b],a+="  OID: "+y.getOid()+"\n",a+="  Is critical: "+(y.getIsCritical()?"Y":"N")+"\n",a+="  Value: "+y.getValue().toHex()+"\n";return a};wa.toIsoString=function(a){a=new Date(Math.round(a));return a.getUTCFullYear()+wa.to2DigitString(a.getUTCMonth()+1)+wa.to2DigitString(a.getUTCDate())+"T"+wa.to2DigitString(a.getUTCHours())+wa.to2DigitString(a.getUTCMinutes())+
wa.to2DigitString(a.getUTCSeconds())};wa.to2DigitString=function(a){a=a.toString();return 1===a.length?"0"+a:a};var Q=a.Data,c=a.Name,x=a.SecurityException,wa=a.Certificate,s=a.WireFormat,Ia=function Be(a){void 0!=a?wa.call(this,a):wa.call(this);this.publicKeyName=new c;if(a instanceof Be)this.publicKeyName=new c(a.publicKeyName);else if(a instanceof Q){if(!Be.isCorrectName(a.getName()))throw new x(Error("Wrong Identity Certificate Name!"));this.setPublicKeyName()}};Ia.prototype=new wa;Ia.prototype.name=
"IdentityCertificate";q.IdentityCertificate=Ia;Ia.prototype.setName=function(a){if(!Ia.isCorrectName(a))throw new x(Error("Wrong Identity Certificate Name!"));wa.prototype.setName.call(this,a);this.setPublicKeyName();return this};Ia.prototype.wireDecode=function(a,y){y=y||s.getDefaultWireFormat();wa.prototype.wireDecode.call(this,a,y);this.setPublicKeyName()};Ia.prototype.getPublicKeyName=function(){return this.publicKeyName};Ia.isIdentityCertificate=function(a){return Ia.isCorrectName(a.getName())};
Ia.certificateNameToPublicKeyName=function(a){for(var y=!1,b=a.size()-1;0<b+1;--b)if("ID-CERT"==a.get(b).toEscapedString()){y=!0;break}if(!y)throw Error("Incorrect identity certificate name "+a.toUri());for(var y=a.getSubName(0,b),b=!1,r=0;r<y.size();r++)if("KEY"==y.get(r).toEscapedString()){b=!0;break}if(!b)throw Error("Incorrect identity certificate name "+a.toUri());return y.getSubName(0,r).append(y.getSubName(r+1,y.size()-r-1))};Ia.isCorrectName=function(a){for(var y=a.size()-1;0<=y&&"ID-CERT"!=
a.get(y).toEscapedString();y--);if(0>y)return!1;for(y=0;y<a.size()&&"KEY"!=a.get(y).toEscapedString();y++);return y>=a.size()?!1:!0};Ia.prototype.setPublicKeyName=function(){this.publicKeyName=Ia.certificateNameToPublicKeyName(this.getName())};var c=a.Name,x=a.SecurityException,b=a.SyncPromise,Z=function(){};q.IdentityStorage=Z;Z.prototype.doesIdentityExistPromise=function(a,y){return b.reject(Error("IdentityStorage.doesIdentityExistPromise is not implemented"))};Z.prototype.doesIdentityExist=function(a){return b.getValue(this.doesIdentityExistPromise(a,
!0))};Z.prototype.addIdentityPromise=function(a,y){return b.reject(Error("IdentityStorage.addIdentityPromise is not implemented"))};Z.prototype.addIdentity=function(a){return b.getValue(this.addIdentityPromise(a,!0))};Z.prototype.revokeIdentity=function(){return b.reject(Error("IdentityStorage.revokeIdentity is not implemented"))};Z.prototype.getNewKeyNamePromise=function(a,y,w){for(var r=Math.floor((new Date).getTime()/1E3);r<=Z.lastTimestamp;)r+=1;Z.lastTimestamp=r;r=""+r;y=y?"ksk-"+r:"dsk-"+r;
var pa=(new c(a)).append(y);return this.doesKeyExistPromise(pa,w).then(function(a){if(a)throw new x(Error("Key name already exists"));return b.resolve(pa)})};Z.prototype.getNewKeyName=function(a,y){return b.getValue(this.getNewKeyNamePromise(a,y,!0))};Z.prototype.doesKeyExistPromise=function(a,y){return b.reject(Error("IdentityStorage.doesKeyExistPromise is not implemented"))};Z.prototype.doesKeyExist=function(a){return b.getValue(this.doesKeyExistPromise(a,!0))};Z.prototype.addKeyPromise=function(a,
y,w,r){return b.reject(Error("IdentityStorage.addKeyPromise is not implemented"))};Z.prototype.addKey=function(a,y,w){return b.getValue(this.addKeyPromise(a,y,w,!0))};Z.prototype.getKeyPromise=function(a,y){return b.reject(Error("IdentityStorage.getKeyPromise is not implemented"))};Z.prototype.getKey=function(a){return b.getValue(this.getKeyPromise(a,!0))};Z.prototype.activateKey=function(a){throw Error("IdentityStorage.activateKey is not implemented");};Z.prototype.deactivateKey=function(a){throw Error("IdentityStorage.deactivateKey is not implemented");
};Z.prototype.doesCertificateExistPromise=function(a,y){return b.reject(Error("IdentityStorage.doesCertificateExistPromise is not implemented"))};Z.prototype.doesCertificateExist=function(a){return b.getValue(this.doesCertificateExistPromise(a,!0))};Z.prototype.addCertificatePromise=function(a,y){return b.reject(Error("IdentityStorage.addCertificatePromise is not implemented"))};Z.prototype.addCertificate=function(a){return b.getValue(this.addCertificatePromise(a,!0))};Z.prototype.getCertificatePromise=
function(a,y){return b.reject(Error("IdentityStorage.getCertificatePromise is not implemented"))};Z.prototype.getCertificate=function(a){return b.getValue(this.getValuePromise(a,!0))};Z.prototype.getTpmLocatorPromise=function(a){return b.reject(Error("IdentityStorage.getTpmLocatorPromise is not implemented"))};Z.prototype.getTpmLocator=function(){return b.getValue(this.getTpmLocatorPromise(!0))};Z.prototype.getDefaultIdentityPromise=function(a){return b.reject(Error("IdentityStorage.getDefaultIdentityPromise is not implemented"))};
Z.prototype.getDefaultIdentity=function(){return b.getValue(this.getDefaultIdentityPromise(!0))};Z.prototype.getDefaultKeyNameForIdentityPromise=function(a,y){return b.reject(Error("IdentityStorage.getDefaultKeyNameForIdentityPromise is not implemented"))};Z.prototype.getDefaultKeyNameForIdentity=function(a){return b.getValue(this.getDefaultKeyNameForIdentityPromise(a,!0))};Z.prototype.getDefaultCertificateNameForIdentityPromise=function(a,y){var b=this;return this.getDefaultKeyNameForIdentityPromise(a).then(function(a){return b.getDefaultCertificateNameForKeyPromise(a)})};
Z.prototype.getDefaultCertificateNameForIdentity=function(a){return b.getValue(this.getDefaultCertificateNameForIdentityPromise(a,!0))};Z.prototype.getDefaultCertificateNameForKeyPromise=function(a,y){return b.reject(Error("IdentityStorage.getDefaultCertificateNameForKeyPromise is not implemented"))};Z.prototype.getDefaultCertificateNameForKey=function(a){return b.getValue(this.getDefaultCertificateNameForKeyPromise(a,!0))};Z.prototype.getAllIdentitiesPromise=function(a,y,w){return b.reject(Error("IdentityStorage.getAllIdentitiesPromise is not implemented"))};
Z.prototype.getAllKeyNamesOfIdentityPromise=function(a,y,w,r){return b.reject(Error("IdentityStorage.getAllKeyNamesOfIdentityPromise is not implemented"))};Z.prototype.getAllCertificateNamesOfKeyPromise=function(a,y,w,r){return b.reject(Error("IdentityStorage.getAllCertificateNamesOfKeyPromise is not implemented"))};Z.prototype.getAllKeyNamesOfIdentity=function(a,y,w){return b.getValue(this.getAllKeyNamesOfIdentityPromise(a,y,w,!0))};Z.prototype.setDefaultIdentityPromise=function(a,y){return b.reject(Error("IdentityStorage.setDefaultIdentityPromise is not implemented"))};
Z.prototype.setDefaultIdentity=function(a){return b.getValue(this.setDefaultIdentityPromise(a,!0))};Z.prototype.setDefaultKeyNameForIdentityPromise=function(a,y,w){return b.reject(Error("IdentityStorage.setDefaultKeyNameForIdentityPromise is not implemented"))};Z.prototype.setDefaultKeyNameForIdentity=function(a,y){return b.getValue(this.setDefaultKeyNameForIdentityPromise(a,y,!0))};Z.prototype.setDefaultCertificateNameForKeyPromise=function(a,y,w){return b.reject(Error("IdentityStorage.setDefaultCertificateNameForKeyPromise is not implemented"))};
Z.prototype.setDefaultCertificateNameForKey=function(a,y){return b.getValue(this.setDefaultCertificateNameForKeyPromise(a,y,!0))};Z.prototype.getDefaultCertificatePromise=function(a){var y=this;return this.getDefaultIdentityPromise(a).then(function(b){return y.getDefaultCertificateNameForIdentityPromise(b,a)},function(a){return b.resolve(null)}).then(function(w){return null==w?b.resolve(null):y.getCertificatePromise(w,a)})};Z.prototype.getDefaultCertificate=function(){return b.getValue(this.getDefaultCertificatePromise(!0))};
Z.prototype.deleteCertificateInfoPromise=function(a,y){return b.reject(Error("IdentityStorage.deleteCertificateInfoPromise is not implemented"))};Z.prototype.deleteCertificateInfo=function(a){return b.getValue(this.deleteCertificateInfoPromise(a,!0))};Z.prototype.deletePublicKeyInfoPromise=function(a,y){return b.reject(Error("IdentityStorage.deletePublicKeyInfoPromise is not implemented"))};Z.prototype.deletePublicKeyInfo=function(a){return b.getValue(this.deletePublicKeyInfoPromise(a,!0))};Z.prototype.deleteIdentityInfoPromise=
function(a,y){return b.reject(Error("IdentityStorage.deleteIdentityInfoPromise is not implemented"))};Z.prototype.deleteIdentityInfo=function(a){return b.getValue(this.deleteIdentityInfoPromise(a,!0))};Z.lastTimestamp=Math.floor((new Date).getTime()/1E3);new Z;var c=a.Name,p=a.Blob,x=a.SecurityException,Ia=a.IdentityCertificate,b=a.SyncPromise,Z=a.IdentityStorage,sb=function(){Z.call(this);this.identityStore={};this.defaultIdentity="";this.keyStore={};this.certificateStore={}};sb.prototype=new Z;
sb.prototype.name="MemoryIdentityStorage";q.MemoryIdentityStorage=sb;sb.prototype.doesIdentityExistPromise=function(a){return b.resolve(void 0!==this.identityStore[a.toUri()])};sb.prototype.addIdentityPromise=function(a){a=a.toUri();void 0===this.identityStore[a]&&(this.identityStore[a]={defaultKey:null});return b.resolve()};sb.prototype.doesKeyExistPromise=function(a){return b.resolve(void 0!==this.keyStore[a.toUri()])};sb.prototype.addKeyPromise=function(a,y,w){if(0===a.size()||this.doesKeyExist(a))return b.resolve();
var r=a.getSubName(0,a.size()-1);this.addIdentity(r);this.keyStore[a.toUri()]={keyType:y,keyDer:new p(w),defaultCertificate:null};return b.resolve()};sb.prototype.getKeyPromise=function(a){if(0===a.size())return b.reject(new x(Error("MemoryIdentityStorage.getKeyPromise: Empty keyName")));a=a.toUri();a=this.keyStore[a];return void 0===a?b.reject(new x(Error("MemoryIdentityStorage.getKeyPromise: The key does not exist"))):b.resolve(a.keyDer)};sb.prototype.doesCertificateExistPromise=function(a){return b.resolve(void 0!==
this.certificateStore[a.toUri()])};sb.prototype.addCertificatePromise=function(a){var y=a.getName(),w=a.getPublicKeyName();this.addKey(w,a.getPublicKeyInfo().getKeyType(),a.getPublicKeyInfo().getKeyDer());if(this.doesCertificateExist(y))return b.resolve();this.certificateStore[y.toUri()]=a.wireEncode();return b.resolve()};sb.prototype.getCertificatePromise=function(a){a=a.toUri();if(void 0===this.certificateStore[a])return b.reject(new x(Error("MemoryIdentityStorage.getCertificatePromise: The certificate does not exist")));
var y=new Ia;try{y.wireDecode(this.certificateStore[a])}catch(w){return b.reject(new x(Error("MemoryIdentityStorage.getCertificatePromise: The certificate cannot be decoded")))}return b.resolve(y)};Z.prototype.getTpmLocatorPromise=function(a){return b.resolve("tpm-memory:")};sb.prototype.getDefaultIdentityPromise=function(){return 0===this.defaultIdentity.length?b.reject(new x(Error("MemoryIdentityStorage.getDefaultIdentity: The default identity is not defined"))):b.resolve(new c(this.defaultIdentity))};
sb.prototype.getDefaultKeyNameForIdentityPromise=function(a){a=a.toUri();return void 0!==this.identityStore[a]?null!=this.identityStore[a].defaultKey?b.resolve(this.identityStore[a].defaultKey):b.reject(new x(Error("No default key set."))):b.reject(new x(Error("Identity not found.")))};sb.prototype.getDefaultCertificateNameForKeyPromise=function(a){a=a.toUri();return void 0!==this.keyStore[a]?null!=this.keyStore[a].defaultCertificate?b.resolve(this.keyStore[a].defaultCertificate):b.reject(new x(Error("No default certificate set."))):
b.reject(new x(Error("Key not found.")))};sb.prototype.setDefaultIdentityPromise=function(a){a=a.toUri();this.defaultIdentity=void 0!==this.identityStore[a]?a:"";return b.resolve()};sb.prototype.setDefaultKeyNameForIdentityPromise=function(a,y){y=y instanceof c?y:null;var w=a.getPrefix(-1);if(null!=y&&0<y.size()&&!y.equals(w))return b.reject(new x(Error("The specified identity name does not match the key name")));w=w.toUri();void 0!==this.identityStore[w]&&(this.identityStore[w].defaultKey=new c(a));
return b.resolve()};sb.prototype.setDefaultCertificateNameForKeyPromise=function(a,y){var w=a.toUri();void 0!==this.keyStore[w]&&(this.keyStore[w].defaultCertificate=new c(y));return b.resolve()};sb.prototype.deleteCertificateInfoPromise=function(a){return b.reject(Error("MemoryIdentityStorage.deleteCertificateInfoPromise is not implemented"))};sb.prototype.deletePublicKeyInfoPromise=function(a){return b.reject(Error("MemoryIdentityStorage.deletePublicKeyInfoPromise is not implemented"))};sb.prototype.deleteIdentityInfoPromise=
function(a){return b.reject(Error("MemoryIdentityStorage.deleteIdentityInfoPromise is not implemented"))};var b=a.SyncPromise,m=a.DerNode,qa=function(){};q.PrivateKeyStorage=qa;qa.prototype.generateKeyPairPromise=function(a,y,w){return b.reject(Error("PrivateKeyStorage.generateKeyPairPromise is not implemented"))};qa.prototype.generateKeyPair=function(a,y){b.getValue(this.generateKeyPairPromise(a,y,!0))};qa.prototype.deleteKeyPairPromise=function(a,y){return b.reject(Error("PrivateKeyStorage.deleteKeyPairPromise is not implemented"))};
qa.prototype.deleteKeyPair=function(a){b.getValue(this.deleteKeyPairPromise(a,!0))};qa.prototype.getPublicKeyPromise=function(a,y){return b.reject(Error("PrivateKeyStorage.getPublicKeyPromise is not implemented"))};qa.prototype.getPublicKey=function(a){return b.getValue(this.getPublicKeyPromise(a,!0))};qa.prototype.signPromise=function(a,y,w,r){return b.reject(Error("PrivateKeyStorage.sign is not implemented"))};qa.prototype.sign=function(a,y,w){return b.getValue(this.signPromise(a,y,w,!0))};qa.prototype.decrypt=
function(a,y,b){throw Error("PrivateKeyStorage.decrypt is not implemented");};qa.prototype.encrypt=function(a,y,b){throw Error("PrivateKeyStorage.encrypt is not implemented");};qa.prototype.generateKey=function(a,y){throw Error("PrivateKeyStorage.generateKey is not implemented");};qa.prototype.doesKeyExistPromise=function(a,y,w){return b.reject(Error("PrivateKeyStorage.doesKeyExist is not implemented"))};qa.prototype.doesKeyExist=function(a,y){return b.getValue(this.doesKeyExistPromise(a,y,!0))};
qa.encodePkcs8PrivateKey=function(a,y,b){var r=new m.DerSequence;r.addChild(new m.DerOid(y));r.addChild(b);y=new m.DerSequence;y.addChild(new m.DerInteger(0));y.addChild(r);y.addChild(new m.DerOctetString(a));return y.encode()};qa.encodePkcs1PrivateKeyFromRSAKey=function(a){var y=new m.DerSequence;y.addChild(new m.DerInteger(0));y.addChild(new m.DerInteger(qa.bigIntegerToBuffer(a.n)));y.addChild(new m.DerInteger(a.e));y.addChild(new m.DerInteger(qa.bigIntegerToBuffer(a.d)));y.addChild(new m.DerInteger(qa.bigIntegerToBuffer(a.p)));
y.addChild(new m.DerInteger(qa.bigIntegerToBuffer(a.q)));y.addChild(new m.DerInteger(qa.bigIntegerToBuffer(a.dmp1)));y.addChild(new m.DerInteger(qa.bigIntegerToBuffer(a.dmq1)));y.addChild(new m.DerInteger(qa.bigIntegerToBuffer(a.coeff)));return y.encode()};qa.encodePublicKeyFromRSAKey=function(a){var y=new m.DerSequence;y.addChild(new m.DerInteger(qa.bigIntegerToBuffer(a.n)));y.addChild(new m.DerInteger(a.e));a=new m.DerSequence;a.addChild(new m.DerOid(new fb(qa.RSA_ENCRYPTION_OID)));a.addChild(new m.DerNull);
var b=new m.DerSequence;b.addChild(a);b.addChild(new m.DerBitString(y.encode().buf(),0));return b.encode()};qa.bigIntegerToBuffer=function(a){a=a.toString(16);if("-"==a.substr(0,1))throw Error("PrivateKeyStorage.bigIntegerToBuffer: Negative integers are not currently supported");1==a.length%2?a="0"+a:a.match(/^[0-7]/)||(a="00"+a);return new f(a,"hex")};qa.RSA_ENCRYPTION_OID="1.2.840.113549.1.1.1";qa.EC_ENCRYPTION_OID="1.2.840.10045.2.1";var ea=a,p=a.Blob,x=a.SecurityException,Ba=a.PublicKey,ad=a.KeyClass,
ba=a.KeyType,Aa=a.DigestAlgorithm,L=a.DataUtils,qa=a.PrivateKeyStorage,m=a.DerNode,fb=a.OID,b=a.SyncPromise,yb=a.UseSubtleCrypto,xc=null;try{xc=a}catch($e){}var yc=function(){qa.call(this);this.publicKeyStore={};this.privateKeyStore={}};yc.prototype=new qa;yc.prototype.name="MemoryPrivateKeyStorage";q.MemoryPrivateKeyStorage=yc;yc.prototype.setPublicKeyForKeyName=function(a,y,b){this.publicKeyStore[a.toUri()]=new Ba(new p(b,!0))};yc.prototype.setPrivateKeyForKeyName=function(a,y,b){b=b.toString("base64");
var r;if(y===ba.RSA){r="-----BEGIN RSA PRIVATE KEY-----\n";for(var c=0;c<b.length;c+=64)r+=b.substr(c,64)+"\n";r+="-----END RSA PRIVATE KEY-----"}else if(y===ba.EC){r="-----BEGIN EC PRIVATE KEY-----\n";for(c=0;c<b.length;c+=64)r+=b.substr(c,64)+"\n";r+="-----END EC PRIVATE KEY-----"}else throw new x(Error("MemoryPrivateKeyStorage: KeyType is not supported"));this.privateKeyStore[a.toUri()]={keyType:y,privateKey:r}};yc.prototype.setKeyPairForKeyName=function(a,y,b,r){this.setPublicKeyForKeyName(a,
y,b);this.setPrivateKeyForKeyName(a,y,r)};yc.prototype.generateKeyPairPromise=function(a,y,w){if(this.doesKeyExist(a,ad.PUBLIC))return b.reject(new x(Error("Public key already exists")));if(this.doesKeyExist(a,ad.PRIVATE))return b.reject(new x(Error("Private key already exists")));var r=this;if(yb()&&!w){if(y.getKeyType()===ba.RSA){var c=null,t=null;return crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:y.getKeySize(),publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},
!0,["sign","verify"]).then(function(a){c=a.privateKey;return crypto.subtle.exportKey("spki",a.publicKey)}).then(function(a){t=(new p(new Uint8Array(a),!1)).buf();return crypto.subtle.exportKey("pkcs8",c)}).then(function(b){b=m.parse((new p(new Uint8Array(b),!1)).buf()).getChildren()[2].toVal();r.setKeyPairForKeyName(a,y.getKeyType(),t,b.buf());r.privateKeyStore[a.toUri()].subtleKey=c;return Promise.resolve()})}return b.reject(new x(Error("Only RSA key generation currently supported")))}return b.resolve().then(function(){if("undefined"!==
typeof A)if(y.getKeyType()===ba.RSA){var w=new A;w.generate(y.getKeySize(),"010001");r.setKeyPairForKeyName(a,y.getKeyType(),qa.encodePublicKeyFromRSAKey(w).buf(),qa.encodePkcs1PrivateKeyFromRSAKey(w).buf())}else return b.reject(new x(Error("Only RSA key generation currently supported")));else{var c;if(y.getKeyType()===ba.RSA){if(!xc)return b.reject(new x(Error("Need to install rsa-keygen: sudo npm install rsa-keygen")));c=xc.generate(y.getKeySize());w=c.public_key.toString().replace("-----BEGIN PUBLIC KEY-----",
"").replace("-----END PUBLIC KEY-----","");w=new f(w,"base64");c=c.private_key.toString()}else return b.reject(new x(Error("Only RSA key generation currently supported")));r.setPublicKeyForKeyName(a,y.getKeyType(),w);r.privateKeyStore[a.toUri()]={keyType:y.getKeyType(),privateKey:c}}return b.resolve()})};yc.prototype.deleteKeyPairPromise=function(a){a=a.toUri();delete this.publicKeyStore[a];delete this.privateKeyStore[a];return b.resolve()};yc.prototype.getPublicKeyPromise=function(a){var y=a.toUri(),
y=this.publicKeyStore[y];return void 0===y?b.reject(new x(Error("MemoryPrivateKeyStorage: Cannot find public key "+a.toUri()))):b.resolve(y)};yc.prototype.signPromise=function(a,y,w,r){r="boolean"===typeof w?w:r;w="boolean"!==typeof w&&w?w:Aa.SHA256;if(w!=Aa.SHA256)return b.reject(new x(Error("MemoryPrivateKeyStorage.sign: Unsupported digest algorithm")));y=y.toUri();var c=this.privateKeyStore[y];if(void 0===c)return b.reject(new x(Error("MemoryPrivateKeyStorage: Cannot find private key "+y)));if(yb()&&
!r){var t={name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};c.subtleKey?r=crypto.subtle.sign(t,c.subtleKey,a):(r=L.privateKeyPemToDer(c.privateKey),r=qa.encodePkcs8PrivateKey(r,new fb(qa.RSA_ENCRYPTION_OID),new m.DerNull).buf(),r=crypto.subtle.importKey("pkcs8",r.buffer,t,!0,["sign"]).then(function(y){c.subtleKey=y;return crypto.subtle.sign(t,y,a)}));return r.then(function(a){a=new p(new Uint8Array(a),!0);return Promise.resolve(a)})}if(c.keyType===ba.RSA)r=ea.createSign("RSA-SHA256");else if(c.keyType===
ba.EC)r=ea.createSign("sha256");else return b.reject(new x(Error("MemoryPrivateKeyStorage.sign: Unrecognized private key type")));r.update(a);r=new f(L.toNumbersIfString(r.sign(c.privateKey)));r=new p(r,!1);return b.resolve(r)};yc.prototype.doesKeyExistPromise=function(a,y){var w=a.toUri(),r=!1;y==ad.PUBLIC?r=void 0!==this.publicKeyStore[w]:y==ad.PRIVATE&&(r=void 0!==this.privateKeyStore[w]);return b.resolve(r)};ea=a;new qa;var ea=a,c=a.Name,Q=a.Data,p=a.Blob,rd=a.ConfigFile,qb=a.DigestSha256Signature,
Da=a.Sha256WithRsaSignature,Sa=a.Sha256WithEcdsaSignature,Ga=a.KeyLocatorType,s=a.WireFormat,x=a.SecurityException,Aa=a.DigestAlgorithm,ba=a.KeyType,Vb=a.RsaKeyParams,Ia=a.IdentityCertificate,Ba=a.PublicKey,cd=a.CertificateSubjectDescription,b=a.SyncPromise,we=a.BasicIdentityStorage,Ee=a.FilePrivateKeyStorage,ia=function y(a,b){if(b){if(!a)throw Error("IdentityManager: A custom privateKeyStorage is supplied with a null identityStorage");this.identityStorage=a;this.privateKeyStorage=b}else{if(!rd)throw new x(Error("IdentityManager: If not in Node.js then you must supply identityStorage and privateKeyStorage."));
var c=new rd,t=[null],B=this;this.identityStorage=a?a:y.getDefaultIdentityStorage_(c,function(){return B.checkTpmPromise_(t[0])});this.privateKeyStorage=y.getDefaultPrivateKeyStorage_(c,t)}};q.IdentityManager=ia;ia.prototype.createIdentityAndCertificatePromise=function(a,w,r){var c=this,t=!0,B=null;return this.identityStorage.addIdentityPromise(a,r).then(function(){return c.identityStorage.getDefaultKeyNameForIdentityPromise(a,r).then(function(a){B=a;return c.identityStorage.getKeyPromise(B,r).then(function(a){(new Ba(a)).getKeyType()==
w.getKeyType()&&(t=!1);return b.resolve()})},function(a){if(!(a instanceof x))throw a;return b.resolve()})}).then(function(){return t?c.generateKeyPairPromise(a,!0,w,r).then(function(a){B=a;return c.identityStorage.setDefaultKeyNameForIdentityPromise(B,r)}):b.resolve()}).then(function(){return c.identityStorage.getDefaultCertificateNameForKeyPromise(B,r).then(function(a){return b.resolve(a)},function(a){if(!(a instanceof x))throw a;var y;return c.selfSignPromise(B,r).then(function(a){y=a.getName();
return c.addCertificateAsIdentityDefaultPromise(a,r)}).then(function(){return b.resolve(y)})})})};ia.prototype.createIdentityAndCertificate=function(a,w,r,c){return b.complete(r,c,this.createIdentityAndCertificatePromise(a,w,!r))};ia.prototype.createIdentity=function(a,b){return Ia.certificateNameToPublicKeyName(this.createIdentityAndCertificate(a,b))};ia.prototype.deleteIdentity=function(a,w,r){var c=this,t=!0,B=this.identityStorage.getDefaultIdentityPromise(!w).then(function(w){w.equals(a)&&(t=
!1);return b.resolve()},function(a){return b.resolve()}).then(function(){if(!t)return b.resolve();var w=[];return c.identityStorage.getAllKeyNamesOfIdentityPromise(a,w,!0).then(function(){return c.identityStorage.getAllKeyNamesOfIdentityPromise(a,w,!1)}).then(function(){return c.identityStorage.deleteIdentityInfoPromise(a)}).then(function(){function a(y){return y>=w.length?b.resolve():c.privateKeyStorage.deleteKeyPairPromise(w[y]).then(function(){return a(y+1)})}return a(0)})});return b.complete(w,
r,B)};ia.prototype.setDefaultIdentityPromise=function(a,b){return this.identityStorage.setDefaultIdentityPromise(a,b)};ia.prototype.setDefaultIdentity=function(a,w,r){return b.complete(w,r,this.identityStorage.setDefaultIdentityPromise(a,!w))};ia.prototype.getDefaultIdentityPromise=function(a){return this.identityStorage.getDefaultIdentityPromise(a)};ia.prototype.getDefaultIdentity=function(a,w){return b.complete(a,w,this.identityStorage.getDefaultIdentityPromise(!a))};ia.prototype.getDefaultCertificatePromise=
function(a){return this.identityStorage.getDefaultCertificatePromise(a)};ia.prototype.generateRSAKeyPair=function(a,w,r){return b.getValue(this.generateKeyPairPromise(a,w,new Vb(r),!0))};ia.prototype.setDefaultKeyForIdentity=function(a,w,r,pa){pa="function"===typeof w?r:pa;r="function"===typeof w?w:r;w="function"!==typeof w&&w?w:new c;return b.complete(r,pa,this.identityStorage.setDefaultKeyNameForIdentityPromise(a,w,!r))};ia.prototype.getDefaultKeyNameForIdentity=function(a,w,r){return b.complete(w,
r,this.identityStorage.getDefaultKeyNameForIdentityPromise(a,!w))};ia.prototype.generateRSAKeyPairAsDefaultPromise=function(a,w,r,c){var t,B=this;return this.generateKeyPairPromise(a,w,new Vb(r)).then(function(a){t=a;return B.identityStorage.setDefaultKeyNameForIdentityPromise(t)}).then(function(){return b.resolve(t)})};ia.prototype.generateRSAKeyPairAsDefault=function(a,w,r){return b.getValue(this.generateRSAKeyPairAsDefaultPromise(a,w,r,!0))};ia.prototype.getPublicKey=function(a,w,r){return b.complete(w,
r,this.identityStorage.getKeyPromise(a,!w).then(function(a){return b.resolve(new Ba(a))}))};ia.prototype.prepareUnsignedIdentityCertificate=function(a,w,r,pa,t,B,g,f,m){w instanceof Ba||(m=f,f=g,g=B,B=t,t=pa,pa=r,r=w,w=null);var n=g,p=f;g=n instanceof c?n:null;"function"===typeof n?(f=n,m=p):"function"===typeof p?f=p:m=f=null;a=null==w?this.prepareUnsignedIdentityCertificatePromise(a,r,pa,t,B,g,!f):this.prepareUnsignedIdentityCertificatePromise(a,w,r,pa,t,B,g,!f);return b.complete(f,m,a)};ia.prototype.prepareUnsignedIdentityCertificatePromise=
function(a,w,r,pa,t,B,g,f){w instanceof Ba||(f=g,g=B,B=t,t=pa,pa=r,r=w,w=null);var m=g;g=m instanceof c?m:null;return(null==w?this.identityStorage.getKeyPromise(a,"boolean"===typeof m?m:"boolean"===typeof f?f:!1).then(function(a){w=new Ba(a);return b.resolve()}):b.resolve()).then(function(){return b.resolve(ia.prepareUnsignedIdentityCertificateHelper_(a,w,r,pa,t,B,g))})};ia.prepareUnsignedIdentityCertificateHelper_=function(a,b,r,pa,t,B,g){if(1>a.size())return null;var f=a.get(-1).toEscapedString();
if(4>f.length)return null;keyIdPrefix=f.substr(0,4);if("ksk-"!=keyIdPrefix&&"dsk-"!=keyIdPrefix)return null;var f=new Ia,m=new c;if(null==g)r.match(a)?m.append(r).append("KEY").append(a.getSubName(r.size())).append("ID-CERT").appendVersion((new Date).getTime()):m.append(a.getPrefix(-1)).append("KEY").append(a.get(-1)).append("ID-CERT").appendVersion((new Date).getTime());else if(g.match(a)&&!g.equals(a))m.append(g).append("KEY").append(a.getSubName(g.size())).append("ID-CERT").appendVersion((new Date).getTime());
else return null;f.setName(m);f.setNotBefore(pa);f.setNotAfter(t);f.setPublicKeyInfo(b);if(null==B||0===B.length)f.addSubjectDescription(new cd("2.5.4.41",a.getPrefix(-1).toUri()));else for(a=0;a<B.length;++a)f.addSubjectDescription(B[a]);try{f.encode()}catch(n){throw x(Error("DerEncodingException: "+n));}return f};ia.prototype.addCertificate=function(a,w,r){return b.complete(w,r,this.identityStorage.addCertificatePromise(a,!w))};ia.prototype.setDefaultCertificateForKeyPromise=function(a,b){var r=
this,c=a.getPublicKeyName();return this.identityStorage.doesKeyExistPromise(c,b).then(function(t){if(!t)throw new x(Error("No corresponding Key record for certificate!"));return r.identityStorage.setDefaultCertificateNameForKeyPromise(c,a.getName(),b)})};ia.prototype.setDefaultCertificateForKey=function(a,w,r){return b.complete(w,r,this.setDefaultCertificateForKeyPromise(a,!w))};ia.prototype.addCertificateAsIdentityDefaultPromise=function(a,b){var r=this;return this.identityStorage.addCertificatePromise(a,
b).then(function(){var c=a.getPublicKeyName();return r.identityStorage.setDefaultKeyNameForIdentityPromise(c,b)}).then(function(){return r.setDefaultCertificateForKeyPromise(a,b)})};ia.prototype.addCertificateAsDefault=function(a,w,r){var c=!w,t=this;return b.complete(w,r,this.identityStorage.addCertificatePromise(a,c).then(function(){return t.setDefaultCertificateForKeyPromise(a,c)}))};ia.prototype.getCertificate=function(a,w,r){return b.complete(w,r,this.identityStorage.getCertificatePromise(a,
!1,!w))};ia.prototype.getDefaultCertificateNameForIdentityPromise=function(a,b){return this.identityStorage.getDefaultCertificateNameForIdentityPromise(a,b)};ia.prototype.getDefaultCertificateNameForIdentity=function(a,w,r){return b.complete(w,r,this.identityStorage.getDefaultCertificateNameForIdentityPromise(a,!w))};ia.prototype.getDefaultCertificateName=function(a,w){var r=!a,c=this;return b.complete(a,w,this.identityStorage.getDefaultIdentityPromise(r).then(function(a){return c.identityStorage.getDefaultCertificateNameForIdentityPromise(a,
r)}))};ia.prototype.getAllIdentities=function(a,w,r,c){return b.complete(r,c,this.identityStorage.getAllIdentitiesPromise(a,w,!r))};ia.prototype.getAllKeyNamesOfIdentity=function(a,w,r,c,t){return b.complete(c,t,this.identityStorage.getAllKeyNamesOfIdentityPromise(a,w,r,!c))};ia.prototype.getAllCertificateNamesOfKey=function(a,w,r,c,t){return b.complete(c,t,this.identityStorage.getAllCertificateNamesOfKeyPromise(a,w,r,!c))};ia.prototype.signByCertificatePromise=function(a,w,c,g){g="boolean"===typeof c?
c:g;c="boolean"!==typeof c&&c?c:s.getDefaultWireFormat();var t=ia.certificateNameToPublicKeyName(w),B=this;if(a instanceof Q){var f=[0];return this.makeSignatureByCertificatePromise(w,f,g).then(function(b){a.setSignature(b);b=a.wireEncode(c);return B.privateKeyStorage.signPromise(b.signedBuf(),t,f[0],g)}).then(function(w){a.getSignature().setSignature(w);a.wireEncode(c);return b.resolve(a)})}f=[0];return this.makeSignatureByCertificatePromise(w,f,g).then(function(b){return B.privateKeyStorage.signPromise(a,
t,f[0],g)}).then(function(a){signature.setSignature(a);return b.resolve(signature)})};ia.prototype.signByCertificate=function(a,w,c,g,t){t="function"===typeof c?g:t;g="function"===typeof c?c:g;c="function"!==typeof c&&c?c:s.getDefaultWireFormat();return b.complete(g,t,this.signByCertificatePromise(a,w,c,!g))};ia.prototype.signInterestByCertificatePromise=function(a,w,r,g){g="boolean"===typeof r?r:g;r="boolean"!==typeof r&&r?r:s.getDefaultWireFormat();var t=this,B,f=[0];return this.makeSignatureByCertificatePromise(w,
f,g).then(function(b){B=b;a.getName().append(r.encodeSignatureInfo(B));a.getName().append(new c.Component);b=a.wireEncode(r);var m=ia.certificateNameToPublicKeyName(w);return t.privateKeyStorage.signPromise(b.signedBuf(),m,f[0],g)}).then(function(w){B.setSignature(w);a.setName(a.getName().getPrefix(-1).append(r.encodeSignatureValue(B)));return b.resolve(a)})};ia.prototype.signInterestByCertificate=function(a,w,c,g,t){t="function"===typeof c?g:t;g="function"===typeof c?c:g;c="function"!==typeof c&&
c?c:s.getDefaultWireFormat();return b.complete(g,t,this.signInterestByCertificatePromise(a,w,c,!g))};ia.prototype.signWithSha256=function(a,b){b=b||s.getDefaultWireFormat();a.setSignature(new qb);var c=a.wireEncode(b),g=ea.createHash("sha256");g.update(c.signedBuf());a.getSignature().setSignature(new p(g.digest(),!1));a.wireEncode(b)};ia.prototype.signInterestWithSha256=function(a,b){b=b||s.getDefaultWireFormat();var r=new qb;a.getName().append(b.encodeSignatureInfo(r));a.getName().append(new c.Component);
var g=a.wireEncode(b),t=ea.createHash("sha256");t.update(g.signedBuf());r.setSignature(new p(t.digest(),!1));a.setName(a.getName().getPrefix(-1).append(b.encodeSignatureValue(r)))};ia.prototype.selfSignPromise=function(a,b){var c=new Ia,g=this;return this.identityStorage.getKeyPromise(a,b).then(function(t){t=new Ba(t);var B=(new Date).getTime(),f=B+63072E6;c.setNotBefore(B);c.setNotAfter(f);B=a.getPrefix(-1).append("KEY").append(a.get(-1)).append("ID-CERT").appendVersion(c.getNotBefore());c.setName(B);
c.setPublicKeyInfo(t);c.addSubjectDescription(new cd("2.5.4.41",a.toUri()));c.encode();return g.signByCertificatePromise(c,c.getName(),b)})};ia.prototype.selfSign=function(a,w,c){return b.complete(w,c,this.selfSignPromise(a,!w))};ia.certificateNameToPublicKeyName=function(a){for(var b=a.size()-1;0<=b&&"ID-CERT"!=a.get(b).toEscapedString();)--b;a=a.getSubName(0,b);for(b=0;b<a.size()&&"KEY"!=a.get(b).toEscapedString();)++b;return a.getSubName(0,b).append(a.getSubName(b+1,a.size()-b-1))};ia.prototype.makeSignatureByCertificatePromise=
function(a,w,c){var g=ia.certificateNameToPublicKeyName(a);return this.privateKeyStorage.getPublicKeyPromise(g,c).then(function(c){c=c.getKeyType();var r=null;if(c==ba.RSA)r=new Da,w[0]=Aa.SHA256,r.getKeyLocator().setType(Ga.KEYNAME),r.getKeyLocator().setKeyName(a.getPrefix(-1));else if(c==ba.EC)r=new Sa,w[0]=Aa.SHA256,r.getKeyLocator().setType(Ga.KEYNAME),r.getKeyLocator().setKeyName(a.getPrefix(-1));else throw new x(Error("Key type is not recognized"));return b.resolve(r)})};ia.prototype.generateKeyPairPromise=
function(a,w,c,g){var t,B=this;return this.identityStorage.getNewKeyNamePromise(a,w,g).then(function(a){t=a;return B.privateKeyStorage.generateKeyPairPromise(t,c,g)}).then(function(){return B.privateKeyStorage.getPublicKeyPromise(t,g)}).then(function(a){return B.identityStorage.addKeyPromise(t,c.getKeyType(),a.getKeyDer())}).then(function(){return b.resolve(t)})};ia.getDefaultIdentityStorage_=function(a,b){var c=a.get("pib","");if(""!==c&&"pib-sqlite3"!==c)throw new x(Error("Invalid config file pib value: "+
c));return new we(b)};ia.getDefaultPrivateKeyStorage_=function(a,b){var c=a.get("tpm","");if(""===c){if("darwin"===process.platform)throw b[0]="tpm-osxkeychain:",new x(Error("IdentityManager: OS X key chain storage is not yet implemented. You must supply a privateKeyStorage."));b[0]="tpm-file:";return new Ee}if("tpm-osxkeychain"===c)throw b[0]="tpm-osxkeychain:",new x(Error("IdentityManager: tpm-osxkeychain is not yet implemented."));if("tpm-file"===c)return b[0]="tpm-file:",new Ee;throw new x(Error("Invalid config file tpm value: "+
c));};ia.prototype.checkTpmPromise_=function(a){return this.identityStorage.getTpmLocatorPromise().then(function(b){return""!==b&&b!==a?Promise.reject(new x(Error("The TPM locator supplied does not match the TPM locator in the PIB: "+b+" != "+a))):Promise.resolve()},function(a){return Promise.resolve()})};var c=a.Name,b=a.SyncPromise,M=a.CertificateV2,Lc=function(a,b,r){this.certificates_={};this.keyName_=new c(a);this.pibImpl_=b;if(null==b)throw Error("The pibImpl is null");this.certificateNameUris_=
[];for(var g in r)this.certificateNameUris_.push(r[g].toUri())};q.PibCertificateContainer=Lc;Lc.makePromise=function(a,w,c){return null==w?b.reject(Error("The pibImpl is null")):w.getCertificatesOfKeyPromise(a,c).then(function(c){return b.resolve(new Lc(a,w,c))})};Lc.prototype.size=function(){return this.certificateNameUris_.length};Lc.prototype.addPromise=function(a,w){if(!this.keyName_.equals(a.getKeyName()))return b.reject(Error("The certificate name `"+a.getKeyName().toUri()+"` does not match the key name"));
var c=a.getName().toUri();0>this.certificateNameUris_.indexOf(c)&&this.certificateNameUris_.push(c);this.certificates_[c]=new M(a);return this.pibImpl_.addCertificatePromise(a,w)};Lc.prototype.removePromise=function(a,w){if(!M.isValidName(a)||!M.extractKeyNameFromCertName(a).equals(this.keyName_))return b.reject(Error("Certificate name `"+a.toUri()+"` is invalid or does not match key name"));var c=a.toUri(),g=this.certificateNameUris_.indexOf(c);0<=g&&this.certificateNameUris_.splice(g,1);delete this.certificates_[c];
return this.pibImpl_.removeCertificatePromise(a,w)};Lc.prototype.getPromise=function(a,c){var r=a.toUri(),g=this.certificates_[r];if(void 0!=g)return b.resolve(new M(g));if(!M.isValidName(a)||!M.extractKeyNameFromCertName(a).equals(this.keyName_))return b.reject(Error("Certificate name `"+a.toUri()+"` is invalid or does not match key name"));var t=this;return this.pibImpl_.getCertificatePromise(a,c).then(function(a){t.certificates_[r]=a;return b.resolve(new M(a))})};var c=a.Name,Jb=a.PibIdentity,
jc=a.PibIdentityImpl,b=a.SyncPromise,zc=function(a,b){this.identities_={};this.pibImpl_=a;if(null==a)throw Error("The pibImpl is null");this.identityNameUris_=[];for(var c in b)this.identityNameUris_.push(b[c].toUri())};q.PibIdentityContainer=zc;zc.makePromise=function(a,c){return null==a?b.reject(Error("The pibImpl is null")):a.getIdentitiesPromise(c).then(function(c){return b.resolve(new zc(a,c))})};zc.prototype.size=function(){return this.identityNameUris_.length};zc.prototype.addPromise=function(a,
b){var c=a.toUri();if(0>this.identityNameUris_.indexOf(c)){var g=this;this.identityNameUris_.push(c);return jc.makePromise(a,this.pibImpl_,!0,b).then(function(t){g.identities_[c]=t;return g.getPromise(a,b)})}return this.getPromise(a,b)};zc.prototype.removePromise=function(a,b){var c=a.toUri(),g=this.identityNameUris_.indexOf(c);0<=g&&this.identityNameUris_.splice(g,1);delete this.identities_[c];return this.pibImpl_.removeIdentityPromise(a,b)};zc.prototype.getPromise=function(a,c){var r=a.toUri(),
g=this.identities_[r];if(void 0==g){var t=this;return jc.makePromise(a,this.pibImpl_,!1,c).then(function(a){t.identities_[r]=a;return b.resolve(new Jb(a))})}return b.resolve(new Jb(g))};zc.prototype.resetPromise=function(a){var c=this;this.identities_={};return this.pibImpl_.getIdentitiesPromise(a).then(function(a){c.identityNameUris_=[];for(var y in a)c.identityNameUris_.push(a[y].toUri());return b.resolve()})};b=a.SyncPromise;Jb=function(a){this.impl_=a};q.PibIdentity=Jb;Jb.prototype.getName=function(){return this.lock_().getName()};
Jb.prototype.getKeyPromise=function(a,c){try{return this.lock_().getKeyPromise(a,c)}catch(r){return b.reject(r)}};Jb.prototype.getKey=function(a,c,r){return b.complete(c,r,this.getKeyPromise(a,!c))};Jb.prototype.getDefaultKeyPromise=function(a){try{return this.lock_().getDefaultKeyPromise(a)}catch(c){return b.reject(c)}};Jb.prototype.getDefaultKey=function(a,c){return b.complete(a,c,this.getDefaultKeyPromise(!a))};Jb.prototype.addKeyPromise_=function(a,c,r){try{return this.lock_().addKeyPromise(a,
c,r)}catch(g){return b.reject(g)}};Jb.prototype.removeKeyPromise_=function(a,c){try{return this.lock_().removeKeyPromise(a,c)}catch(r){return b.reject(r)}};Jb.prototype.setDefaultKeyPromise_=function(a,c,r){try{return this.lock_().setDefaultKeyPromise(a,c,r)}catch(g){return b.reject(g)}};Jb.prototype.getKeys_=function(){return this.lock_().keys_};Jb.prototype.lock_=function(){if(null==this.impl_)throw Error("Invalid key instance");return this.impl_};var b=a.SyncPromise,$=function(){};q.PibImpl=$;
$.Error=function(a){if(a)return a.__proto__=$.Error.prototype,a};$.Error.prototype=Error();$.Error.prototype.name="PibImplError";$.prototype.setTpmLocatorPromise=function(a,c){return b.reject(Error("PibImpl.setTpmLocatorPromise is not implemented"))};$.prototype.getTpmLocatorPromise=function(a){return b.reject(Error("PibImpl.getTpmLocatorPromise is not implemented"))};$.prototype.hasIdentityPromise=function(a,c){return b.reject(Error("PibImpl.hasIdentityPromise is not implemented"))};$.prototype.addIdentityPromise=
function(a,c){return b.reject(Error("PibImpl.addIdentityPromise is not implemented"))};$.prototype.removeIdentityPromise=function(a,c){return b.reject(Error("PibImpl.removeIdentityPromise is not implemented"))};$.prototype.clearIdentitiesPromise=function(a){return b.reject(Error("PibImpl.clearIdentitiesPromise is not implemented"))};$.prototype.getIdentitiesPromise=function(a){return b.reject(Error("PibImpl.getIdentitiesPromise is not implemented"))};$.prototype.setDefaultIdentityPromise=function(a,
c){return b.reject(Error("PibImpl.setDefaultIdentityPromise is not implemented"))};$.prototype.getDefaultIdentityPromise=function(a){return b.reject(Error("PibImpl.getDefaultIdentityPromise is not implemented"))};$.prototype.hasKeyPromise=function(a,c){return b.reject(Error("PibImpl.hasKeyPromise is not implemented"))};$.prototype.addKeyPromise=function(a,c,r,g){return b.reject(Error("PibImpl.addKeyPromise is not implemented"))};$.prototype.removeKeyPromise=function(a,c){return b.reject(Error("PibImpl.removeKeyPromise is not implemented"))};
$.prototype.getKeyBitsPromise=function(a,c){return b.reject(Error("PibImpl.getKeyBitsPromise is not implemented"))};$.prototype.getKeysOfIdentityPromise=function(a,c){return b.reject(Error("PibImpl.getKeysOfIdentityPromise is not implemented"))};$.prototype.setDefaultKeyOfIdentityPromise=function(a,c,r){return b.reject(Error("PibImpl.setDefaultKeyOfIdentityPromise is not implemented"))};$.prototype.getDefaultKeyOfIdentityPromise=function(a,c){return b.reject(Error("PibImpl.getDefaultKeyOfIdentityPromise is not implemented"))};
$.prototype.hasCertificatePromise=function(a,c){return b.reject(Error("PibImpl.hasCertificatePromise is not implemented"))};$.prototype.addCertificatePromise=function(a,c){return b.reject(Error("PibImpl.addCertificatePromise is not implemented"))};$.prototype.removeCertificatePromise=function(a,c){return b.reject(Error("PibImpl.removeCertificatePromise is not implemented"))};$.prototype.getCertificatePromise=function(a,c){return b.reject(Error("PibImpl.getCertificatePromise is not implemented"))};
$.prototype.getCertificatesOfKeyPromise=function(a,c){return b.reject(Error("PibImpl.getCertificatesOfKeyPromise is not implemented"))};$.prototype.setDefaultCertificateOfKeyPromise=function(a,c,r){return b.reject(Error("PibImpl.setDefaultCertificateOfKeyPromise is not implemented"))};$.prototype.getDefaultCertificateOfKeyPromise=function(a,c){return b.reject(Error("PibImpl.getDefaultCertificateOfKeyPromise is not implemented"))};var Va=function(){$.call(this);this.database=new Dexie("pib");this.database.version(1).stores({globals:"key",
identities:"identityNameUri",keys:"keyNameUri",certificates:"certificateNameUri"});this.database.open()};Va.prototype=new $;Va.prototype.name="PibIndexedDb";q.PibIndexedDb=Va;Va.getScheme=function(){return"pib-indexeddb"};Va.prototype.setTpmLocatorPromise=function(a,b){return b?Promise.reject(new $.Error(Error("PibIndexedDb.setTpmLocatorPromise is only supported for async"))):this.database.globals.put({key:"tpmLocator",value:a})};Va.prototype.getTpmLocatorPromise=function(a){return a?Promise.reject(new $.Error(Error("PibIndexedDb.getTpmLocatorPromise is only supported for async"))):
this.database.globals.get("tpmLocator").then(function(a){return a?Promise.resolve(a.value):Promise.resolve("")})};Va.prototype.hasIdentityPromise=function(a,b){return b?Promise.reject(new $.Error(Error("PibIndexedDb.hasIdentityPromise is only supported for async"))):this.database.identities.where("identityNameUri").equals(a.toUri()).count().then(function(a){return Promise.resolve(0<a)})};Va.prototype.addIdentityPromise=function(a,b){if(b)return Promise.reject(new $.Error(Error("PibIndexedDb.addIdentityPromise is only supported for async")));
var c=this;return this.hasIdentityPromise(a).then(function(b){return b?Promise.resolve():c.database.identities.put({identityNameUri:a.toUri(),defaultKeyUri:null})}).then(function(){return c.database.globals.get("defaultIdentityUri")}).then(function(b){return b?Promise.resolve():c.setDefaultIdentityPromise(a)})};Va.prototype.removeIdentityPromise=function(a,b){if(b)return Promise.reject(new $.Error(Error("PibIndexedDb.removeIdentityPromise is only supported for async")));var r=a.toUri(),g=this;return this.database.certificates.each(function(b){M.extractIdentityFromCertName(new c(b.certificateNameUri)).equals(a)&&
g.database.certificates.delete(b.certificateNameUri)}).then(function(){return g.database.keys.each(function(b){oa.extractIdentityFromKeyName(new c(b.keyNameUri)).equals(a)&&g.database.keys.delete(b.keyNameUri)})}).then(function(){return g.database.identities.delete(r)}).then(function(){return g.database.globals.get("defaultIdentityUri")}).then(function(a){return a&&a.value==r?g.database.globals.delete("defaultIdentityUri"):Promise.resolve()})};Va.prototype.clearIdentitiesPromise=function(a){if(a)return Promise.reject(new $.Error(Error("PibIndexedDb.clearIdentitiesPromise is only supported for async")));
var b=this;return this.database.globals.delete("defaultIdentityUri").then(function(){return b.database.certificates.clear()}).then(function(){return b.database.keys.clear()}).then(function(){return b.database.identities.clear()})};Va.prototype.getIdentitiesPromise=function(a){if(a)return Promise.reject(new $.Error(Error("PibIndexedDb.getIdentitiesPromise is only supported for async")));var b=[];return this.database.identities.each(function(a){b.push(new c(a.identityNameUri))}).then(function(){return Promise.resolve(b)})};
Va.prototype.setDefaultIdentityPromise=function(a,b){if(b)return Promise.reject(new $.Error(Error("PibIndexedDb.setDefaultIdentityPromise is only supported for async")));var c=this;return this.hasIdentityPromise(a).then(function(b){return b?Promise.resolve():c.database.identities.put({identityNameUri:a.toUri(),defaultKeyUri:null})}).then(function(){return c.database.globals.put({key:"defaultIdentityUri",value:a.toUri()})})};Va.prototype.getDefaultIdentityPromise=function(a){return a?Promise.reject(new $.Error(Error("PibIndexedDb.getDefaultIdentityPromise is only supported for async"))):
this.database.globals.get("defaultIdentityUri").then(function(a){return a?Promise.resolve(new c(a.value)):Promise.reject(new la.Error(Error("No default identity")))})};Va.prototype.hasKeyPromise=function(a,b){return b?Promise.reject(new $.Error(Error("PibIndexedDb.hasKeyPromise is only supported for async"))):this.database.keys.where("keyNameUri").equals(a.toUri()).count().then(function(a){return Promise.resolve(0<a)})};Va.prototype.addKeyPromise=function(a,b,r,g){if(g)return Promise.reject(new $.Error(Error("PibIndexedDb.addKeyPromise is only supported for async")));
var t=this;return this.addIdentityPromise(a).then(function(){return t.hasKeyPromise(b)}).then(function(a){return a?t.database.keys.update(b.toUri(),{keyDer:r}):t.database.keys.put({keyNameUri:b.toUri(),keyDer:r,defaultCertificateUri:null})}).then(function(){return t.database.identities.get(a.toUri())}).then(function(a){return a&&null!=a.defaultKeyUri?t.hasKeyPromise(new c(a.defaultKeyUri)):Promise.resolve(!1)}).then(function(c){return c?Promise.resolve():t.setDefaultKeyOfIdentityPromise(a,b)})};Va.prototype.removeKeyPromise=
function(a,b){if(b)return Promise.reject(new $.Error(Error("PibIndexedDb.removeKeyPromise is only supported for async")));var r=this;return this.database.certificates.each(function(b){M.extractKeyNameFromCertName(new c(b.certificateNameUri)).equals(a)&&r.database.certificates.delete(b.certificateNameUri)}).then(function(){return r.database.keys.delete(a.toUri())})};Va.prototype.getKeyBitsPromise=function(a,b){return b?Promise.reject(new $.Error(Error("PibIndexedDb.getKeyBitsPromise is only supported for async"))):
this.database.keys.get(a.toUri()).then(function(b){return b?Promise.resolve(new p(b.keyDer)):Promise.reject(new la.Error(Error("Key `"+a.toUri()+"` does not exist")))})};Va.prototype.getKeysOfIdentityPromise=function(a,b){if(b)return Promise.reject(new $.Error(Error("PibIndexedDb.getKeysOfIdentityPromise is only supported for async")));var r=[];return this.database.keys.each(function(b){b=new c(b.keyNameUri);oa.extractIdentityFromKeyName(b).equals(a)&&r.push(b)}).then(function(){return Promise.resolve(r)})};
Va.prototype.setDefaultKeyOfIdentityPromise=function(a,b,c){if(c)return Promise.reject(new $.Error(Error("PibIndexedDb.setDefaultKeyOfIdentityPromise is only supported for async")));var g=this;return this.hasKeyPromise(b).then(function(a){return a?Promise.resolve():Promise.reject(new la.Error(Error("Key `"+b.toUri()+"` does not exist")))}).then(function(){return g.database.identities.update(a.toUri(),{defaultKeyUri:b.toUri()})})};Va.prototype.getDefaultKeyOfIdentityPromise=function(a,b){if(b)return Promise.reject(new $.Error(Error("PibIndexedDb.getDefaultKeyOfIdentityPromise is only supported for async")));
var r=this;return this.database.identities.get(a.toUri()).then(function(b){if(b){if(null!=b.defaultKeyUri){var w=new c(b.defaultKeyUri);return r.hasKeyPromise(w).then(function(b){return b?Promise.resolve(w):Promise.reject(new la.Error(Error("No default key for identity `"+a.toUri()+"`")))})}return Promise.reject(new la.Error(Error("No default key for identity `"+a.toUri()+"`")))}return Promise.reject(new la.Error(Error("Identity `"+a.toUri()+"` does not exist")))})};Va.prototype.hasCertificatePromise=
function(a,b){return b?Promise.reject(new $.Error(Error("PibIndexedDb.hasCertificatePromise is only supported for async"))):this.database.certificates.where("certificateNameUri").equals(a.toUri()).count().then(function(a){return Promise.resolve(0<a)})};Va.prototype.addCertificatePromise=function(a,b){if(b)return Promise.reject(new $.Error(Error("PibIndexedDb.addCertificatePromise is only supported for async")));var r=a.getKeyName(),g=r.toUri(),t=this,B=a.getContent();return this.addKeyPromise(a.getIdentity(),
r,B.buf()).then(function(){return t.database.certificates.put({certificateNameUri:a.getName().toUri(),encoding:a.wireEncode().buf()})}).then(function(){return t.database.keys.get(g)}).then(function(a){return a&&null!=a.defaultCertificateUri?t.hasCertificatePromise(new c(a.defaultCertificateUri)):Promise.resolve(!1)}).then(function(b){return b?Promise.resolve():t.setDefaultCertificateOfKeyPromise(r,a.getName())})};Va.prototype.removeCertificatePromise=function(a,b){return b?Promise.reject(new $.Error(Error("PibIndexedDb.removeCertificatePromise is only supported for async"))):
this.database.certificates.delete(a.toUri())};Va.prototype.getCertificatePromise=function(a,b){return b?Promise.reject(new $.Error(Error("PibIndexedDb.getCertificatePromise is only supported for async"))):this.database.certificates.get(a.toUri()).then(function(b){if(b){var c=new M;c.wireDecode(b.encoding);return Promise.resolve(c)}return Promise.reject(new la.Error(Error("Certificate `"+a.toUri()+"` does not exit")))})};Va.prototype.getCertificatesOfKeyPromise=function(a,b){if(b)return Promise.reject(new $.Error(Error("PibIndexedDb.getCertificatesOfKeyPromise is only supported for async")));
var r=[];return this.database.certificates.each(function(b){b=new c(b.certificateNameUri);M.extractKeyNameFromCertName(b).equals(a)&&r.push(b)}).then(function(){return Promise.resolve(r)})};Va.prototype.setDefaultCertificateOfKeyPromise=function(a,b,c){if(c)return Promise.reject(new $.Error(Error("PibIndexedDb.setDefaultCertificateOfKeyPromise is only supported for async")));var g=this;return this.hasCertificatePromise(b).then(function(a){return a?Promise.resolve():Promise.reject(new la.Error(Error("Certificate `"+
b.toUri()+"` does not exist")))}).then(function(){return g.database.keys.update(a.toUri(),{defaultCertificateUri:b.toUri()})})};Va.prototype.getDefaultCertificateOfKeyPromise=function(a,b){if(b)return Promise.reject(new $.Error(Error("PibIndexedDb.getDefaultCertificateOfKeyPromise is only supported for async")));var r=this;return this.database.keys.get(a.toUri()).then(function(b){return b&&null!=b.defaultCertificateUri?r.getCertificatePromise(new c(b.defaultCertificateUri)):Promise.reject(new la.Error(Error("No default certificate for key `"+
a.toUri()+"`")))})};var c=a.Name,oa=a.PibKey,Mb=a.PibKeyImpl,b=a.SyncPromise,Mc=function(a,b,r){this.keys_={};this.identityName_=new c(a);this.pibImpl_=b;if(null==b)throw Error("The pibImpl is null");this.keyNameUris_=[];for(var g in r)this.keyNameUris_.push(r[g].toUri())};q.PibKeyContainer=Mc;Mc.makePromise=function(a,c,r){return null==c?b.reject(Error("The pibImpl is null")):c.getKeysOfIdentityPromise(a,r).then(function(r){return b.resolve(new Mc(a,c,r))})};Mc.prototype.size=function(){return this.keyNameUris_.length};
Mc.prototype.addPromise=function(a,c,r){if(!this.identityName_.equals(oa.extractIdentityFromKeyName(c)))return b.reject(Error("The key name `"+c.toUri()+"` does not match the identity name `"+this.identityName_.toUri()+"`"));var g=c.toUri();0>this.keyNameUris_.indexOf(g)&&this.keyNameUris_.push(g);var t=this;return Mb.makePromise(c,a,this.pibImpl_,r).then(function(a){t.keys_[g]=a;return t.getPromise(c,r)})};Mc.prototype.removePromise=function(a,c){if(!this.identityName_.equals(oa.extractIdentityFromKeyName(a)))return b.reject(Error("Key name `"+
a.toUri()+"` does not match identity `"+this.identityName_.toUri()+"`"));var r=a.toUri(),g=this.keyNameUris_.indexOf(r);0<=g&&this.keyNameUris_.splice(g,1);delete this.keys_[r];return this.pibImpl_.removeKeyPromise(a,c)};Mc.prototype.getPromise=function(a,c){if(!this.identityName_.equals(oa.extractIdentityFromKeyName(a)))return b.reject(Error("Key name `"+a.toUri()+"` does not match identity `"+this.identityName_.toUri()+"`"));var r=a.toUri(),g=this.keys_[r];if(void 0==g){var t=this;return Mb.makePromise(a,
this.pibImpl_,c).then(function(a){t.keys_[r]=a;return b.resolve(new oa(a))})}return b.resolve(new oa(g))};Mc.prototype.getKeyNames=function(){var a=[],b;for(b in this.keys_)a.push(new c(b));return a};c=a.Name;M=a.CertificateV2;b=a.SyncPromise;oa=function(a){this.impl_=a};q.PibKey=oa;oa.prototype.getName=function(){return this.lock_().getName()};oa.prototype.getIdentityName=function(){return this.lock_().getIdentityName()};oa.prototype.getKeyType=function(){return this.lock_().getKeyType()};oa.prototype.getPublicKey=
function(){return this.lock_().getPublicKey()};oa.prototype.getCertificatePromise=function(a,c){try{return this.lock_().getCertificatePromise(a,c)}catch(r){return b.reject(r)}};oa.prototype.getCertificate=function(a,c,r){return b.complete(c,r,this.getCertificatePromise(a,!c))};oa.prototype.getDefaultCertificatePromise=function(a){try{return this.lock_().getDefaultCertificatePromise(a)}catch(c){return b.reject(c)}};oa.prototype.getDefaultCertificate=function(a,c){return b.complete(a,c,this.getDefaultCertificatePromise(!a))};
oa.constructKeyName=function(a,b){var r=new c(a);r.append(M.KEY_COMPONENT).append(b);return r};oa.isValidKeyName=function(a){return a.size()>M.MIN_KEY_NAME_LENGTH&&a.get(-M.MIN_KEY_NAME_LENGTH).equals(M.KEY_COMPONENT)};oa.extractIdentityFromKeyName=function(a){if(!oa.isValidKeyName(a))throw Error("Key name `"+a.toUri()+"` does not follow the naming conventions");return a.getPrefix(-M.MIN_KEY_NAME_LENGTH)};oa.prototype.addCertificatePromise_=function(a,b){return this.lock_().addCertificatePromise(a,
b)};oa.prototype.removeCertificatePromise_=function(a,b){return this.lock_().removeCertificatePromise(a,b)};oa.prototype.setDefaultCertificatePromise_=function(a,b){return this.lock_().setDefaultCertificatePromise(a,b)};oa.prototype.getCertificates_=function(){return this.lock_().certificates_};oa.prototype.lock_=function(){if(null==this.impl_)throw Error("Invalid key instance");return this.impl_};var c=a.Name,p=a.Blob,M=a.CertificateV2,la=a.Pib,oa=a.PibKey,b=a.SyncPromise,$=a.PibImpl,ua=function(){$.call(this);
this.tpmLocator_="";this.defaultIdentityName_=null;this.identityNames_=[];this.defaultKeyNames_={};this.keys_={};this.defaultCertificateNames_={};this.certificates_={}};ua.prototype=new $;ua.prototype.name="PibMemory";q.PibMemory=ua;ua.getScheme=function(){return"pib-memory"};ua.prototype.setTpmLocatorPromise=function(a){this.tpmLocator_=a;return b.resolve()};ua.prototype.getTpmLocatorPromise=function(){return b.resolve(this.tpmLocator_)};ua.prototype.hasIdentityPromise=function(a){return b.resolve(this.hasIdentity_(a))};
ua.prototype.hasIdentity_=function(a){for(var b in this.identityNames_)if(this.identityNames_[b].equals(a))return!0;return!1};ua.prototype.addIdentityPromise=function(a){this.addIdentity_(a);return b.resolve()};ua.prototype.addIdentity_=function(a){a=new c(a);this.hasIdentity_(a)||this.identityNames_.push(a);null===this.defaultIdentityName_&&(this.defaultIdentityName_=a)};ua.prototype.removeIdentityPromise=function(a){for(var c=this.identityNames_.length-1;0<=c;--c)this.identityNames_[c].equals(a)&&
this.identityNames_.splice(c,1);null!==this.defaultIdentityName_&&a.equals(this.defaultIdentityName_)&&(this.defaultIdentityName_=null);a=this.getKeysOfIdentity_(a);for(c in a)this.removeKey_(a[c]);return b.resolve()};ua.prototype.clearIdentitiesPromise=function(){this.defaultIdentityName_=null;this.identityNames_=[];this.defaultKeyNames_={};this.keys_={};this.defaultCertificateNames_={};this.certificates_={};return b.resolve()};ua.prototype.getIdentitiesPromise=function(){var a=[],w;for(w in this.identityNames_)a.push(new c(this.identityNames_[w]));
return b.resolve(a)};ua.prototype.setDefaultIdentityPromise=function(a){this.addIdentity_(a);this.defaultIdentityName_=new c(a);return b.resolve()};ua.prototype.getDefaultIdentityPromise=function(){return null!==this.defaultIdentityName_?b.resolve(new c(this.defaultIdentityName_)):b.reject(new la.Error(Error("No default identity")))};ua.prototype.hasKeyPromise=function(a){return b.resolve(this.hasKey_(a))};ua.prototype.hasKey_=function(a){return a.toUri()in this.keys_};ua.prototype.addKeyPromise=
function(a,c,r){this.addKey_(a,c,r);return b.resolve()};ua.prototype.addKey_=function(a,b,r){this.addIdentity_(a);b=new c(b);this.keys_[b.toUri()]=new p(r,!0);a=a.toUri();a in this.defaultKeyNames_||(this.defaultKeyNames_[a]=b)};ua.prototype.removeKeyPromise=function(a){this.removeKey_(a);return b.resolve()};ua.prototype.removeKey_=function(a){var b=oa.extractIdentityFromKeyName(a);delete this.keys_[a.toUri()];delete this.defaultKeyNames_[b.toUri()];a=this.getCertificatesOfKey_(a);for(var c in a)this.removeCertificate_(a[c])};
ua.prototype.getKeyBitsPromise=function(a){if(!this.hasKey_(a))return b.reject(new la.Error(Error("Key `"+a.toUri()+"` not found")));a=this.keys_[a.toUri()];return b.resolve(a)};ua.prototype.getKeysOfIdentityPromise=function(a){return b.resolve(this.getKeysOfIdentity_(a))};ua.prototype.getKeysOfIdentity_=function(a){var b=[],r;for(r in this.keys_){var g=new c(r);a.equals(oa.extractIdentityFromKeyName(g))&&b.push(g)}return b};ua.prototype.setDefaultKeyOfIdentityPromise=function(a,w){if(!this.hasKey_(w))return b.reject(new la.Error(Error("Key `"+
w.toUri()+"` not found")));this.defaultKeyNames_[a.toUri()]=new c(w);return b.resolve()};ua.prototype.getDefaultKeyOfIdentityPromise=function(a){var w=this.defaultKeyNames_[a.toUri()];return void 0==w?b.reject(new la.Error(Error("No default key for identity `"+a.toUri()+"`"))):b.resolve(new c(w))};ua.prototype.hasCertificatePromise=function(a){return b.resolve(this.hasCertificate_(a))};ua.prototype.hasCertificate_=function(a){return a.toUri()in this.certificates_};ua.prototype.addCertificatePromise=
function(a){var w=new c(a.getName()),r=a.getKeyName(),g=a.getIdentity();this.addKey_(g,r,a.getContent().buf());this.certificates_[w.toUri()]=new M(a);a=r.toUri();a in this.defaultCertificateNames_||(this.defaultCertificateNames_[a]=w);return b.resolve()};ua.prototype.removeCertificatePromise=function(a){this.removeCertificate_(a);return b.resolve()};ua.prototype.removeCertificate_=function(a){delete this.certificates_[a.toUri()];var b=M.extractKeyNameFromCertName(a).toUri(),c=this.defaultCertificateNames_[b];
void 0!=c&&c.equals(a)&&delete this.defaultCertificateNames_[b]};ua.prototype.getCertificatePromise=function(a){return this.hasCertificate_(a)?b.resolve(new M(this.certificates_[a.toUri()])):b.reject(new la.Error(Error("Certificate `"+a.toUri()+"` does not exist")))};ua.prototype.getCertificatesOfKeyPromise=function(a){return b.resolve(this.getCertificatesOfKey_(a))};ua.prototype.getCertificatesOfKey_=function(a){var b=[],r;for(r in this.certificates_)M.extractKeyNameFromCertName(this.certificates_[r].getName()).equals(a)&&
b.push(new c(r));return b};ua.prototype.setDefaultCertificateOfKeyPromise=function(a,w){if(!this.hasCertificate_(w))return b.reject(new la.Error(Error("Certificate `"+w.toUri()+"` does not exist")));this.defaultCertificateNames_[a.toUri()]=new c(w);return b.resolve()};ua.prototype.getDefaultCertificateOfKeyPromise=function(a){var c=this.defaultCertificateNames_[a.toUri()];if(void 0==c)return b.reject(new la.Error(Error("No default certificate for key `"+a.toUri()+"`")));a=this.certificates_[c.toUri()];
return b.resolve(new M(a))};rd=a.ConfigFile;b=a.SyncPromise;la=function(a,b,c){this.defaultIdentity_=null;this.scheme_=a;this.location_=b;this.identities_=null;this.pibImpl_=c;this.initializeTpmLocator_=this.initializePibLocator_=this.initializeTpm_=null;this.isInitialized_=this.initializeAllowReset_=!1;if(null==c)throw Error("The pibImpl is null");};q.Pib=la;la.Error=function(a){if(a)return a.__proto__=la.Error.prototype,a};la.Error.prototype=Error();la.Error.prototype.name="PibError";la.prototype.getScheme=
function(){return this.scheme_};la.prototype.getPibLocator=function(){return this.scheme_+":"+this.location_};la.prototype.setTpmLocatorPromise=function(a,b){var c=this;return this.initializePromise_(b).then(function(){return c.doSetTpmLocatorPromise_(a,b)})};la.prototype.doSetTpmLocatorPromise_=function(a,c){var r=this;return this.pibImpl_.getTpmLocatorPromise(c).then(function(g){return a==g?b.resolve():r.resetPromise_(c).then(function(){return r.pibImpl_.setTpmLocatorPromise(a,c)})})};la.prototype.getTpmLocatorPromise=
function(a){var c=this;return this.initializePromise_(a).then(function(){return c.pibImpl_.getTpmLocatorPromise(a)}).then(function(a){return""==a?b.reject(new la.Error(Error("TPM info does not exist"))):b.resolve(a)})};la.prototype.getIdentityPromise=function(a,b){var c=this;return this.initializePromise_(b).then(function(){return c.identities_.getPromise(a,b)})};la.prototype.getIdentity=function(a,c,r){return b.complete(c,r,this.getIdentityPromise(a,!c))};la.prototype.getDefaultIdentityPromise=function(a){if(null==
this.defaultIdentity_){var c=this;return this.initializePromise_(a).then(function(){return c.pibImpl_.getDefaultIdentityPromise(a)}).then(function(b){return c.identities_.getPromise(b,a)}).then(function(a){c.defaultIdentity_=a;return b.resolve(c.defaultIdentity_)})}return b.resolve(this.defaultIdentity_)};la.prototype.getDefaultIdentity=function(a,c){return b.complete(a,c,this.getDefaultIdentityPromise(!a))};la.prototype.resetPromise_=function(a){var b=this;return this.pibImpl_.clearIdentitiesPromise(a).then(function(){return b.pibImpl_.setTpmLocatorPromise("",
a)}).then(function(){b.defaultIdentity_=null;return zc.makePromise(b.pibImpl_,a)}).then(function(c){b.identities_=c;return b.identities_.resetPromise(a)})};la.prototype.addIdentityPromise_=function(a,b){var c=this;return this.initializePromise_(b).then(function(){return c.identities_.addPromise(a,b)})};la.prototype.removeIdentityPromise_=function(a,b){null!=this.defaultIdentity_&&this.defaultIdentity_.getName().equals(a)&&(this.defaultIdentity_=null);var c=this;return this.initializePromise_(b).then(function(){return c.identities_.removePromise(a,
b)})};la.prototype.setDefaultIdentityPromise_=function(a,c){var r=this;return this.initializePromise_(c).then(function(){return r.identities_.addPromise(a,c)}).then(function(b){r.defaultIdentity_=b;return r.pibImpl_.setDefaultIdentityPromise(a)}).then(function(){return b.resolve(r.defaultIdentity_)})};la.prototype.initializePromise_=function(a){if(this.isInitialized_)return b.resolve();var c=this;return zc.makePromise(this.pibImpl_,a).then(function(r){c.identities_=r;return null!=c.initializeTpm_?
c.initializeFromLocatorsPromise_(a):b.resolve()}).then(function(){c.isInitialized_=!0;return b.resolve()})};la.prototype.initializeFromLocatorsPromise_=function(a){var c=[null],r=[null];C.parseAndCheckPibLocator_(this.initializePibLocator_,c,r);var g=c[0]+":"+r[0],t,B=this;return this.pibImpl_.getTpmLocatorPromise(a).then(function(c){var r=[null],w=[null];C.parseAndCheckTpmLocator_(B.initializeTpmLocator_,r,w);t=r[0]+":"+w[0];var r=!1,f;rd&&(f=new rd);if(rd&&g==C.getDefaultPibLocator_(f))""!=c&&c!=
C.getDefaultTpmLocator_(f)&&(r=!0,t=C.getDefaultTpmLocator_(f));else if(""!=c&&c!=t)if(B.initializeAllowReset_)r=!0;else return b.reject(new Zd(Error("The supplied TPM locator does not match the TPM locator in the PIB: "+c+" != "+t)));return r?B.resetPromise_(a):b.resolve()}).then(function(){C.setUpTpm_(B.initializeTpm_,t);B.initializeTpm_.isInitialized_=!0;return B.doSetTpmLocatorPromise_(t,a)})};var C=a.KeyChain,Zd=a.LocatorMismatchError,zc=a.PibIdentityContainer,c=a.Name,la=a.Pib,Mc=a.PibKeyContainer,
b=a.SyncPromise,jc=function(){};q.PibIdentityImpl=jc;jc.makePromise=function(a,w,r,g){var t=new jc;return Mc.makePromise(a,w,g).then(function(B){t.defaultKey_=null;t.identityName_=new c(a);t.keys_=B;t.pibImpl_=w;return null==w?b.reject(Error("The pibImpl is null")):r?w.addIdentityPromise(t.identityName_,g).then(function(){return b.resolve(t)}):w.hasIdentityPromise(t.identityName_,g).then(function(a){return a?b.resolve(t):b.reject(new la.Error(Error("Identity "+t.identityName_.toUri()+" does not exist")))})})};
jc.prototype.getName=function(){return this.identityName_};jc.prototype.addKeyPromise=function(a,b,c){return this.keys_.addPromise(a,b,c)};jc.prototype.removeKeyPromise=function(a,b){null!==this.defaultKey_&&this.defaultKey_.getName().equals(a)&&(this.defaultKey_=null);return this.keys_.removePromise(a,b)};jc.prototype.getKeyPromise=function(a,b){return this.keys_.getPromise(a,b)};jc.prototype.setDefaultKeyPromise=function(a,w,r){var g=this;if(a instanceof c){var t=a,B=w;return this.keys_.getPromise(t,
B).then(function(a){g.defaultKey_=a;return g.pibImpl_.setDefaultKeyOfIdentityPromise(g.identityName_,t,B)}).then(function(){return b.resolve(g.defaultKey_)})}t=w;B=r;return this.addKeyPromise(a,t,B).then(function(){return g.setDefaultKeyPromise(t,B)})};jc.prototype.getDefaultKeyPromise=function(a){var c=this;return null===this.defaultKey_?this.pibImpl_.getDefaultKeyOfIdentityPromise(this.identityName_,a).then(function(b){return c.keys_.getPromise(b,a)}).then(function(a){c.defaultKey_=a;return b.resolve(c.defaultKey_)}):
b.resolve(this.defaultKey_)};c=a.Name;Ba=a.PublicKey;p=a.Blob;la=a.Pib;oa=a.PibKey;$=a.PibImpl;Lc=a.PibCertificateContainer;b=a.SyncPromise;Mb=function(){};q.PibKeyImpl=Mb;Mb.makePromise=function(a,w,r,g){var t=new Mb;t.defaultCertificate_=null;if(w instanceof $){var B=w,f=r;return null==B?b.reject(Error("The pibImpl is null")):Lc.makePromise(a,B,f).then(function(b){t.identityName_=oa.extractIdentityFromKeyName(a);t.keyName_=new c(a);t.pibImpl_=B;t.certificates_=b;return t.pibImpl_.getKeyBitsPromise(t.keyName_,
f)}).then(function(a){t.keyEncoding_=a;try{publicKey=new Ba(t.keyEncoding_)}catch(c){return b.reject(new la.Error(Error("Error decoding public key")))}t.keyType_=publicKey.getKeyType();return b.resolve(t)})}B=r;f=g;return null==B?b.reject(Error("The pibImpl is null")):Lc.makePromise(a,B,f).then(function(r){t.identityName_=oa.extractIdentityFromKeyName(a);t.keyName_=new c(a);t.keyEncoding_=new p(w,!0);t.pibImpl_=B;t.certificates_=r;try{publicKey=new Ba(t.keyEncoding_),t.keyType_=publicKey.getKeyType()}catch(g){return b.reject(Error("Invalid key encoding"))}return t.pibImpl_.addKeyPromise(t.identityName_,
t.keyName_,w,f)}).then(function(){return b.resolve(t)})};Mb.prototype.getName=function(){return this.keyName_};Mb.prototype.getIdentityName=function(){return this.identityName_};Mb.prototype.getKeyType=function(){return this.keyType_};Mb.prototype.getPublicKey=function(){return this.keyEncoding_};Mb.prototype.addCertificatePromise=function(a,b){return this.certificates_.addPromise(a,b)};Mb.prototype.removeCertificatePromise=function(a,b){null!==this.defaultCertificate_&&this.defaultCertificate_.getName().equals(a)&&
(this.defaultCertificate_=null);return this.certificates_.removePromise(a,b)};Mb.prototype.getCertificatePromise=function(a,b){return this.certificates_.getPromise(a,b)};Mb.prototype.setDefaultCertificatePromise=function(a,w){var r=this,g;return b.resolve().then(function(){return a instanceof c?b.resolve(a):r.addCertificatePromise(a).then(function(){return b.resolve(a.getName())})}).then(function(a){g=a;return r.certificates_.getPromise(g,w)}).then(function(a){r.defaultCertificate_=a;return r.pibImpl_.setDefaultCertificateOfKeyPromise(r.keyName_,
g,w)}).then(function(){return b.resolve(r.defaultCertificate_)})};Mb.prototype.getDefaultCertificatePromise=function(a){var c=this;return null===this.defaultCertificate_?this.pibImpl_.getDefaultCertificateOfKeyPromise(this.keyName_,a).then(function(a){c.defaultCertificate_=a;return b.resolve(c.defaultCertificate_)}):b.resolve(c.defaultCertificate_)};var xe=function(a,b,c,g,t){this.interest=a;this.onVerified=b;this.onValidationFailed=c;this.retry=g;this.stepCount=t};q.ValidationRequest=xe;var ea=a,
p=a.Blob,L=a.DataUtils,x=a.SecurityException,qb=a.DigestSha256Signature,Da=a.Sha256WithRsaSignature,Sa=a.Sha256WithEcdsaSignature,Na=a.VerificationHelpers,Aa=a.DigestAlgorithm,Ba=a.PublicKey,b=a.SyncPromise,gb=function(){};q.PolicyManager=gb;gb.prototype.skipVerifyAndTrust=function(a){throw Error("PolicyManager.skipVerifyAndTrust is not implemented");};gb.prototype.requireVerify=function(a){throw Error("PolicyManager.requireVerify is not implemented");};gb.prototype.checkVerificationPolicy=function(a,
b,c,g,t){throw Error("PolicyManager.checkVerificationPolicy is not implemented");};gb.prototype.checkSigningPolicy=function(a,b){throw Error("PolicyManager.checkSigningPolicy is not implemented");};gb.prototype.inferSigningIdentity=function(a){throw Error("PolicyManager.inferSigningIdentity is not implemented");};gb.verifyUsesString_=null;gb.setVerifyUsesString_=function(){var a=ea.createHash("sha256").digest();gb.verifyUsesString_="string"===typeof a};gb.verifySignature=function(a,c,r,g){if(a instanceof
Da||a instanceof Sa)if(r.isNull())g(!1);else{var t;try{t=new Ba(r)}catch(B){throw new x(Error("PolicyManager.verify: Error decoding public key: "+B));}b.complete(g,Na.verifySignaturePromise(c.signedBuf(),a.getSignature(),t,Aa.SHA256,!g))}else if(a instanceof qb)g(Na.verifyDigest(c.signedBuf(),a.getSignature(),Aa.SHA256));else throw new x(Error("PolicyManager.verify: Signature type is unknown"));};var Ia=a.IdentityCertificate,dd=function(){this.cache={}};q.CertificateCache=dd;dd.prototype.insertCertificate=
function(a){var b=a.getName().getPrefix(-1);this.cache[b.toUri()]=a.wireEncode()};dd.prototype.deleteCertificate=function(a){delete this.cache[a.toUri()]};dd.prototype.getCertificate=function(a){a=this.cache[a.toUri()];if(void 0===a)return null;var b=new Ia;b.wireDecode(a);return b};dd.prototype.reset=function(){this.cache={}};var $d=Ib=a,c=a.Name,Q=a.Data,F=a.Interest,U=a.KeyLocator,Ga=a.KeyLocatorType,p=a.Blob,Ia=a.IdentityCertificate,M=a.CertificateV2,Xb=a.CertificateCacheV2,ec=a.BoostInfoParser,
Ua=a.NdnRegexTopMatcher,dd=a.CertificateCache,xe=a.ValidationRequest,x=a.SecurityException,s=a.WireFormat,gb=a.PolicyManager,O=a.NdnCommon,va=function(a,b,c,g,t,B){gb.call(this);void 0==b&&(b=null);void 0==c&&(c=5);void 0==g&&(g=3E3);void 0==t&&(t=36E5);void 0==B&&(B=1E3);null==b&&(b=new dd);b instanceof dd?(this.isSecurityV1_=!0,this.certificateCache_=b,this.certificateCacheV2_=null):(this.isSecurityV1_=!1,this.certificateCache_=null,this.certificateCacheV2_=b);this.maxDepth=c;this.keyGraceInterval=
g;this.keyTimestampTtl=t;this.maxTrackedKeys=B;this.reset();null!=a&&""!=a&&this.load(a)};va.prototype=new gb;va.prototype.name="ConfigPolicyManager";q.ConfigPolicyManager=va;va.prototype.reset=function(){this.isSecurityV1_?this.certificateCache_.reset():this.certificateCacheV2_.clear();this.fixedCertificateCache={};this.keyTimestamps={};this.requiresVerification=!0;this.config=new ec;this.refreshManager=new va.TrustAnchorRefreshManager(this.isSecurityV1_)};va.prototype.load=function(a,b){this.reset();
this.config.read(a,b);this.loadTrustAnchorCertificates()};va.prototype.requireVerify=function(a){return this.requiresVerification};va.prototype.checkSigningPolicy=function(a,b){return!0};va.prototype.skipVerifyAndTrust=function(a){return!this.requiresVerification};va.prototype.checkVerificationPolicy=function(a,b,c,g,t){var B=a.getName(),f="data";a instanceof F&&(B=B.getPrefix(-4),f="interest");t=va.extractSignature(a,t);if(null==t){try{g(a,"Cannot extract the signature from "+a.getName().toUri())}catch(m){console.log("Error in onValidationFailed: "+
O.getErrorWithStackTrace(m))}return null}var n=["unknown"],B=this.getCertificateInterest_(b,f,B,t,n);if(null==B){try{g(a,n[0])}catch(p){console.log("Error in onValidationFailed: "+O.getErrorWithStackTrace(p))}return null}if(0<B.getName().size()){var s=this;return new xe(B,function(t){var B;if(s.isSecurityV1_){try{B=new Ia(t)}catch(f){try{g(a,"Cannot decode certificate "+t.getName().toUri())}catch(m){console.log("Error in onValidationFailed: "+O.getErrorWithStackTrace(m))}return null}s.certificateCache_.insertCertificate(B)}else{try{B=
new M(t)}catch(Nc){try{g(a,"Cannot decode certificate "+t.getName().toUri())}catch(Lb){console.log("Error in onValidationFailed: "+O.getErrorWithStackTrace(Lb))}return null}s.certificateCacheV2_.insert(B)}s.checkVerificationPolicy(a,b+1,c,g)},g,2,b+1)}if(a instanceof F){var B=U.getFromSignature(t).getKeyName(),q;q=this.isSecurityV1_?Ia.certificateNameToPublicKeyName(B):B;var x=a.getName().get(-4).toNumber();if(!this.interestTimestampIsFresh(q,x,n)){try{g(a,n[0])}catch(Nc){console.log("Error in onValidationFailed: "+
O.getErrorWithStackTrace(Nc))}return null}}s=this;this.verify(t,a.wireEncode(),function(b,t){if(b){try{c(a)}catch(w){console.log("Error in onVerified: "+O.getErrorWithStackTrace(w))}a instanceof F&&s.updateTimestampForKey(q,x)}else try{g(a,t)}catch(B){console.log("Error in onValidationFailed: "+O.getErrorWithStackTrace(B))}})};va.prototype.getCertificateInterest_=function(a,b,c,g,t){if(a>this.maxDepth)return t[0]="The verification stepCount "+a+" exceeded the maxDepth "+this.maxDepth,null;var B;try{B=
this.findMatchingRule(c,b)}catch(f){return null}if(null==B)return t[0]="No matching rule found for "+c.toUri(),null;if(!U.canGetFromSignature(g))return t[0]="The signature type does not support a KeyLocator",null;a=a=U.getFromSignature(g);a=a.getKeyName();if(0==a.size())return t[0]="The signature KeyLocator doesn't have a key name",null;if(!this.checkSignatureMatch(a,c,B,t))return null;this.refreshManager.refreshAnchors();this.isSecurityV1_?(c=this.refreshManager.getCertificate(a),null==c&&(c=this.certificateCache_.getCertificate(a))):
(c=this.refreshManager.getCertificateV2(a),null==c&&(c=this.certificateCacheV2_.find(a)));return null==c?new F(a):new F};va.prototype.loadTrustAnchorCertificates=function(){for(var a=this.config.getRoot().get("validator/trust-anchor"),b=0;b<a.length;++b){var c=a[b],g=c.get("type")[0].getValue(),t=!1,B;if("file"==g)B=c.get("file-name")[0].getValue(),t=!0;else if("base64"==g)B=c.get("base64-string")[0].getValue(),t=!1;else if("dir"==g){g=c.get("dir")[0].getValue();t=0;c=c.get("refresh");1<=c.length&&
(c=c[0].getValue().match(/(\d+)([hms])/),null==c?t=0:(t=parseInt(c[1]),"s"!=c[2]&&(t*=60,"m"!=c[2]&&(t*=60))));this.refreshManager.addDirectory(g,1E3*t);continue}else if("any"==g){this.requiresVerification=!1;break}this.isSecurityV1_?this.lookupCertificate(B,t):this.lookupCertificateV2(B,t)}};va.prototype.checkSignatureMatch=function(a,b,r,g){r=r.get("checker")[0];var t=r.get("type")[0].getValue();if("fixed-signer"==t){b=r.get("signer")[0];r=b.get("type")[0].getValue();if("file"==r){if(r=this.isSecurityV1_?
this.lookupCertificate(b.get("file-name")[0].getValue(),!0):this.lookupCertificateV2(b.get("file-name")[0].getValue(),!0),null==r)return g[0]="Can't find fixed-signer certificate file: "+b.get("file-name")[0].getValue(),!1}else if("base64"==r){if(r=this.isSecurityV1_?this.lookupCertificate(b.get("base64-string")[0].getValue(),!1):this.lookupCertificateV2(b.get("base64-string")[0].getValue(),!1),null==r)return g[0]="Can't find fixed-signer certificate base64: "+b.get("base64-string")[0].getValue(),
!1}else return g[0]="Unrecognized fixed-signer signerType: "+r,!1;if(r.getName().equals(a))return!0;g[0]='fixed-signer cert name "'+r.getName().toUri()+'" does not equal signatureName "'+a.toUri()+'"';return!1}if("hierarchical"==t){r=new Ua("^([^<KEY>]*)<KEY>(<>*)<ksk-.+><ID-CERT>");if(r.match(a)){a=r.expand("\\1").append(r.expand("\\2"));if(va.matchesRelation(b,a,"is-prefix-of"))return!0;g[0]='The hierarchical objectName "'+b.toUri()+'" is not a prefix of "'+a.toUri()+'"';return!1}if(!this.isSecurityV1_&&
(r=new Ua("^(<>*)<KEY><>$"),r.match(a))){a=r.expand("\\1");if(va.matchesRelation(b,a,"is-prefix-of"))return!0;g[0]='The hierarchical objectName "'+b.toUri()+'" is not a prefix of "'+a.toUri()+'"';return!1}g[0]='The hierarchical identityRegex "^([^<KEY>]*)<KEY>(<>*)<ksk-.+><ID-CERT>" does not match signatureName "'+a.toUri()+'"';return!1}if("customized"==t){var B=r.get("key-locator")[0];r=B.getFirstValue("relation");if(null!=r){b=new c(B.get("name")[0].getValue());if(va.matchesRelation(a,b,r))return!0;
g[0]='The custom signatureName "'+a.toUri()+'" does not match matchName "'+b.toUri()+'" using relation '+r;return!1}var f=B.getFirstValue("regex");if(null!=f){if((new Ua(simpleKeyRegex)).match(a))return!0;g[0]='The custom signatureName "'+a.toUri()+'" does not regex match simpleKeyRegex "'+f+'"';return!1}r=B.get("hyper-relation");if(1<=r.length){r=r[0];var f=r.getFirstValue("k-regex"),m=r.getFirstValue("k-expand"),B=r.getFirstValue("p-regex"),n=r.getFirstValue("p-expand");r=r.getFirstValue("h-relation");
if(null!=f&&null!=m&&null!=B&&null!=n&&null!=r){t=new Ua(f);if(!t.match(a))return g[0]='The custom hyper-relation signatureName "'+a.toUri()+'" does not match the keyRegex "'+f+'"',!1;a=t.expand(m);t=new Ua(B);if(!t.match(b))return g[0]='The custom hyper-relation objectName "'+b.toUri()+'" does not match the nameRegex "'+B+'"',!1;b=t.expand(n);if(va.matchesRelation(b,a,r))return!0;g[0]='The custom hyper-relation nameMatch "'+b.toUri()+'" does not match the keyMatchPrefix "'+a.toUri()+'" using relation '+
r;return!1}}}g[0]="Unrecognized checkerType: "+t;return!1};va.prototype.lookupCertificate=function(a,b){if(!this.isSecurityV1_)throw new x(Error("lookupCertificate: For security v2, use lookupCertificateV2()"));var r;r=this.fixedCertificateCache[a];if(void 0===r){if(b)r=va.TrustAnchorRefreshManager.loadIdentityCertificateFromFile(a);else{var g=new f(a,"base64");r=new Ia;r.wireDecode(g)}g=r.getName().getPrefix(-1).toUri();this.fixedCertificateCache[a]=g;this.certificateCache_.insertCertificate(r)}else r=
this.certificateCache_.getCertificate(new c(r));return r};va.prototype.lookupCertificateV2=function(a,b){if(this.isSecurityV1_)throw new x(Error("lookupCertificateV2: For security v1, use lookupCertificate()"));var r;r=this.fixedCertificateCache[a];if(void 0===r){if(b)r=va.TrustAnchorRefreshManager.loadCertificateV2FromFile(a);else{var g=new f(a,"base64");r=new M;r.wireDecode(g)}g=r.getName().getPrefix(-1).toUri();this.fixedCertificateCache[a]=g;this.certificateCacheV2_.insert(r)}else r=this.certificateCacheV2_.find(new c(r));
return r};va.prototype.findMatchingRule=function(a,b){for(var r=this.config.getRoot().get("validator/rule"),g=0;g<r.length;++g){var t=r[g];if(t.get("for")[0].getValue()==b){var B=!0,f=t.get("filter");if(0==f.length)return t;for(var m=0;m<f.length;++m){var n=f[m],B=n.getFirstValue("regex");null===B?(B=n.get("relation")[0].getValue(),n=n.get("name")[0].getValue(),n=new c(n),B=va.matchesRelation(a,n,B)):B=(new Ua(B)).match(a);if(!B)break}if(B)return t}}return null};va.matchesRelation=function(a,b,c){var g=
!1;"is-strict-prefix-of"==c?b.size()==a.size()?g=!1:b.match(a)&&(g=!0):"is-prefix-of"==c?b.match(a)&&(g=!0):"equal"==c&&b.equals(a)&&(g=!0);return g};va.extractSignature=function(a,b){if(a instanceof Q)return a.getSignature();if(a instanceof F){b=b||s.getDefaultWireFormat();try{var c=b.decodeSignatureInfoAndValue(a.getName().get(-2).getValue().buf(),a.getName().get(-1).getValue().buf(),!1)}catch(g){return null}return c}return null};va.prototype.interestTimestampIsFresh=function(a,b,c){a=this.keyTimestamps[a.toUri()];
if(void 0==a){a=(new Date).getTime();var g=a+this.keyGraceInterval;if(b>a-this.keyGraceInterval&&b<g)return!0;c[0]="The command interest timestamp is not within the first use grace period of "+this.keyGraceInterval+" milliseconds.";return!1}return b<=a?(c[0]="The command interest timestamp is not newer than the previous timestamp",!1):!0};va.prototype.updateTimestampForKey=function(a,b){this.keyTimestamps[a.toUri()]=b;var c=0,g=[],t=(new Date).getTime(),f=t,m=null,n;for(n in this.keyTimestamps){++c;
var p=this.keyTimestamps[n];t-p>this.keyTimestampTtl?g.push(n):p<f&&(f=p,m=n)}if(c>=this.maxTrackedKeys){for(t=0;t<g.length;++t)delete this.keyTimestamps[g[t]],--c;c>this.maxTrackedKeys&&delete this.keyTimestamps[m]}};va.prototype.verify=function(a,b,c){var g=U.getFromSignature(a);if(g.getType()==Ga.KEYNAME){var g=g.getKeyName(),t;if(this.isSecurityV1_){var f=this.refreshManager.getCertificate(g);null==f&&(f=this.certificateCache_.getCertificate(g));if(null==f){c(!1,"Cannot find a certificate with name "+
g.toUri());return}t=f.getPublicKeyInfo().getKeyDer();if(t.isNull()){c(!1,"There is no public key in the certificate with name "+f.getName().toUri());return}}else{f=this.refreshManager.getCertificateV2(g);null==f&&(f=this.certificateCacheV2_.find(g));if(null==f){c(!1,"Cannot find a certificate with name "+g.toUri());return}try{t=f.getPublicKey()}catch(m){c(!1,"There is no public key in the certificate with name "+f.getName().toUri());return}}gb.verifySignature(a,b,t,function(a){a?c(!0):c(!1,"The signature did not verify with the given public key")})}else c(!1,
"The KeyLocator does not have a key name")};va.TrustAnchorRefreshManager=function(a){this.isSecurityV1_=a;this.certificateCache_=new dd;this.certificateCacheV2_=new Xb;this.refreshDirectories={}};va.TrustAnchorRefreshManager.loadIdentityCertificateFromFile=function(a){a=Ib.readFileSync(a).toString();a=new f(a,"base64");var b=new Ia;b.wireDecode(new p(a,!1));return b};va.TrustAnchorRefreshManager.loadCertificateV2FromFile=function(a){a=Ib.readFileSync(a).toString();a=new f(a,"base64");var b=new M;
b.wireDecode(new p(a,!1));return b};va.TrustAnchorRefreshManager.prototype.getCertificate=function(a){if(!this.isSecurityV1_)throw new x(Error("getCertificate: For security v2, use getCertificateV2()"));return this.certificateCache_.getCertificate(a)};va.TrustAnchorRefreshManager.prototype.getCertificateV2=function(a){if(this.isSecurityV1_)throw new x(Error("getCertificateV2: For security v1, use getCertificate()"));return this.certificateCacheV2_.find(a)};va.TrustAnchorRefreshManager.prototype.addDirectory=
function(a,b){var c;try{c=Ib.readdirSync(a)}catch(g){throw new x(Error("Cannot list files in directory "+a));}for(var t=[],f=0;f<c.length;++f){if(this.isSecurityV1_){var m;try{var n=$d.join(a,c[f]);m=va.TrustAnchorRefreshManager.loadIdentityCertificateFromFile(n)}catch(p){continue}var s=m.getName().getPrefix(-1).toUri();this.certificateCache_.insertCertificate(m)}else{try{n=$d.join(a,c[f]),m=va.TrustAnchorRefreshManager.loadCertificateV2FromFile(n)}catch(q){continue}s=M.extractKeyNameFromCertName(m.getName()).toUri();
this.certificateCacheV2_.insert(m)}t.push(s)}this.refreshDirectories[a]={certificates:t,nextRefresh:(new Date).getTime()+b,refreshPeriod:b}};va.TrustAnchorRefreshManager.prototype.refreshAnchors=function(){var a=(new Date).getTime(),b;for(b in this.refreshDirectories){var g=this.refreshDirectories[b];if(g.nextRefresh<=a){for(var f=g.certificates.slice(0),t=0;t<f.length;++t)try{if(this.isSecurityV1_)this.certificateCache_.deleteCertificate(new c(f[t]));else{var B=this.certificateCacheV2_.find(new c(f[t]));
null!=B&&this.certificateCacheV2_.deleteCertificate(B.getName())}}catch(m){}this.addDirectory(b,g.refreshPeriod)}}};var c=a.Name,gb=a.PolicyManager,O=a.NdnCommon,$b=function(){gb.call(this)};$b.prototype=new gb;$b.prototype.name="NoVerifyPolicyManager";q.NoVerifyPolicyManager=$b;$b.prototype.skipVerifyAndTrust=function(a){return!0};$b.prototype.requireVerify=function(a){return!1};$b.prototype.checkVerificationPolicy=function(a,b,c,g,t){try{c(a)}catch(f){console.log("Error in onVerified: "+O.getErrorWithStackTrace(f))}return null};
$b.prototype.checkSigningPolicy=function(a,b){return!0};$b.prototype.inferSigningIdentity=function(a){return new c};var c=a.Name,F=a.Interest,Q=a.Data,p=a.Blob,Ia=a.IdentityCertificate,U=a.KeyLocator,Ga=a.KeyLocatorType,x=a.SecurityException,s=a.WireFormat,b=a.SyncPromise,gb=a.PolicyManager,Z=a.IdentityStorage,O=a.NdnCommon,Oc=function(a){gb.call(this);a instanceof Z?(this.identityStorage_=a,this.pibImpl_=null):(this.identityStorage_=null,this.pibImpl_=a)};Oc.prototype=new gb;Oc.prototype.name="SelfVerifyPolicyManager";
q.SelfVerifyPolicyManager=Oc;Oc.prototype.skipVerifyAndTrust=function(a){return!1};Oc.prototype.requireVerify=function(a){return!0};Oc.prototype.checkVerificationPolicy=function(a,b,c,g,t){t=t||s.getDefaultWireFormat();if(a instanceof Q)this.verify(a.getSignature(),a.wireEncode(),function(b,t){if(b)try{c(a)}catch(w){console.log("Error in onVerified: "+O.getErrorWithStackTrace(w))}else try{g(a,t)}catch(f){console.log("Error in onValidationFailed: "+O.getErrorWithStackTrace(f))}});else if(a instanceof
F){if(2>a.getName().size()){try{g(a,"The signed interest has less than 2 components: "+a.getName().toUri())}catch(f){console.log("Error in onValidationFailed: "+O.getErrorWithStackTrace(f))}return}var m;try{m=t.decodeSignatureInfoAndValue(a.getName().get(-2).getValue().buf(),a.getName().get(-1).getValue().buf(),!1)}catch(n){try{g(a,"Error decoding the signed interest signature: "+n)}catch(p){console.log("Error in onValidationFailed: "+O.getErrorWithStackTrace(p))}return}this.verify(m,a.wireEncode(),
function(b,t){if(b)try{c(a)}catch(w){console.log("Error in onVerified: "+O.getErrorWithStackTrace(w))}else try{g(a,t)}catch(f){console.log("Error in onValidationFailed: "+O.getErrorWithStackTrace(f))}})}else throw new x(Error("checkVerificationPolicy: unrecognized type for dataOrInterest"));return null};Oc.prototype.checkSigningPolicy=function(a,b){return!0};Oc.prototype.inferSigningIdentity=function(a){return new c};Oc.prototype.verify=function(a,b,c){if(U.canGetFromSignature(a))this.getPublicKeyDer(U.getFromSignature(a),
function(g,f){if(g.isNull())c(!1,f);else try{gb.verifySignature(a,b,g,function(a){a?c(!0):c(!1,"The signature did not verify with the given public key")})}catch(m){c(!1,"Error in verifySignature: "+m)}});else try{gb.verifySignature(a,b,null,function(a){a?c(!0):c(!1,"The signature did not verify with the given public key")})}catch(g){c(!1,"Error in verifySignature: "+g)}};Oc.prototype.getPublicKeyDer=function(a,c){if(a.getType()==Ga.KEYNAME&&null!=this.identityStorage_){var g;try{g=Ia.certificateNameToPublicKeyName(a.getKeyName())}catch(f){c(new p,
"Cannot get a public key name from the certificate named: "+a.getKeyName().toUri());return}b.complete(c,function(a){c(new p,"The identityStorage doesn't have the key named "+g.toUri())},this.identityStorage_.getKeyPromise(g,!c))}else a.getType()==Ga.KEYNAME&&null!=this.pibImpl_?b.complete(c,function(a){c(new p,"The identityStorage doesn't have the key named "+g.toUri())},this.pibImpl_.getKeyBitsPromise(a.getKeyName(),!c)):c(new p,"The signature KeyLocator doesn't have a key name")};var ea=a,c=a.Name,
p=a.Blob,rb=a.KeyIdType,oa=a.PibKey,Za=a.Tpm,b=a.SyncPromise,Oa=function(){};q.TpmBackEnd=Oa;Oa.Error=function(a){if(a)return a.__proto__=Oa.Error.prototype,a};Oa.Error.prototype=Error();Oa.Error.prototype.name="TpmBackEndError";Oa.prototype.hasKeyPromise=function(a,b){return this.doHasKeyPromise_(a,b)};Oa.prototype.getKeyHandlePromise=function(a,b){return this.doGetKeyHandlePromise_(a,b)};Oa.prototype.createKeyPromise=function(a,g,r){var f=this;return b.resolve().then(function(){if(g.getKeyIdType()==
rb.USER_SPECIFIED){var t=oa.constructKeyName(a,g.getKeyId());return f.hasKeyPromise(t,r).then(function(a){return a?b.reject(new Za.Error(Error("Key `"+t.toUri()+"` already exists"))):b.resolve()})}if(g.getKeyIdType()==rb.SHA256)return b.resolve();if(g.getKeyIdType()==rb.RANDOM){var B,m=function(){var g=ea.randomBytes(8);B=new c.Component(new p(g,!1));g=oa.constructKeyName(a,B);return f.hasKeyPromise(g,r).then(function(a){return a?m():b.resolve()})};return m().then(function(){g.setKeyId(B);return b.resolve()})}return b.reject(new Za.Error(Error("Unsupported key id type")))}).then(function(){return f.doCreateKeyPromise_(a,
g,r)})};Oa.prototype.deleteKeyPromise=function(a,b){return this.doDeleteKeyPromise_(a,b)};Oa.prototype.importKeyPromise=function(a,c,g,f){var t=this;return this.hasKeyPromise(a,f).then(function(B){return B?b.reject(new Oa.Error(Error("Key `"+a.toUri()+"` already exists"))):t.doImportKeyPromise_(a,c,g,f)})};Oa.setKeyName=function(a,b,g){if(g.getKeyIdType()==rb.USER_SPECIFIED)g=g.getKeyId();else if(g.getKeyIdType()==rb.SHA256)g=ea.createHash("sha256"),g.update(a.derivePublicKey().buf()),g=c.Component(new p(g.digest(),
!1));else if(g.getKeyIdType()==rb.RANDOM){if(0==g.getKeyId().getValue().size())throw new Oa.Error(Error("setKeyName: The keyId is empty for type RANDOM"));g=g.getKeyId()}else throw new Oa.Error(Error("setKeyName: unrecognized params.getKeyIdType()"));a.setKeyName(oa.constructKeyName(b,g))};Oa.prototype.doHasKeyPromise_=function(a,c){return b.reject(Error("TpmBackEnd.doHasKeyPromise_ is not implemented"))};Oa.prototype.doGetKeyHandlePromise_=function(a,c){return b.reject(Error("TpmBackEnd.doGetKeyHandlePromise_ is not implemented"))};
Oa.prototype.doCreateKeyPromise_=function(a,c,g){return b.reject(Error("TpmBackEnd.doCreateKeyPromise_ is not implemented"))};Oa.prototype.doDeleteKeyPromise_=function(a,c){return b.reject(Error("TpmBackEnd.doDeleteKeyPromise_ is not implemented"))};Oa.prototype.doImportKeyPromise_=function(a,c,g,f){return b.reject(Error("TpmBackEnd.doImportKeyPromise_ is not implemented"))};var b=a.SyncPromise,W=a.TpmPrivateKey,sd=a.TpmKeyHandleMemory,Oa=a.TpmBackEnd,Wb=function(){Oa.call(this);this.keys_={}};Wb.prototype=
new Oa;Wb.prototype.name="TpmBackEndMemory";q.TpmBackEndMemory=Wb;Wb.getScheme=function(){return"tpm-memory"};Wb.prototype.doHasKeyPromise_=function(a,c){return b.resolve(a.toUri()in this.keys_)};Wb.prototype.doGetKeyHandlePromise_=function(a,c){var g=this.keys_[a.toUri()];return void 0==g?b.resolve(null):b.resolve(new sd(g))};Wb.prototype.doCreateKeyPromise_=function(a,c,g){var f=this;return W.generatePrivateKeyPromise(c,g).then(function(g){var r=new sd(g);Oa.setKeyName(r,a,c);f.keys_[r.getKeyName().toUri()]=
g;return b.resolve(r)},function(a){return b.reject(new Oa.Error(Error("Error in TpmPrivateKey.generatePrivateKey: "+a)))})};Wb.prototype.doDeleteKeyPromise_=function(a,c){delete this.keys_[a.toUri()];return b.resolve()};Wb.prototype.doImportKeyPromise_=function(a,c,g,f){if(null!=g)return b.reject(new Oa.Error(Error("Private key password-encryption is not implemented")));try{var t=new W;t.loadPkcs8(c);this.keys_[a.toUri()]=t;return b.resolve()}catch(B){return b.reject(new Oa.Error(Error("Cannot import private key: "+
B)))}};var c=a.Name,b=a.SyncPromise,ac=function(){this.keyName_=new c};q.TpmKeyHandle=ac;ac.prototype.signPromise=function(a,b,c){return this.doSignPromise_(a,b,c)};ac.prototype.decryptPromise=function(a,b){return this.doDecryptPromise_(a,b)};ac.prototype.derivePublicKey=function(a){return this.doDerivePublicKey_(a)};ac.prototype.setKeyName=function(a){this.keyName_=new c(a)};ac.prototype.getKeyName=function(){return this.keyName_};ac.prototype.doSignPromise_=function(a,c,g){return b.reject(Error("TpmKeyHandle.doSignPromise_ is not implemented"))};
ac.prototype.doDecryptPromise_=function(a,c){return b.reject(Error("TpmKeyHandle.doDecryptPromise_ is not implemented"))};ac.prototype.doDerivePublicKey_=function(a){return b.reject(Error("TpmKeyHandle.doDerivePublicKey_ is not implemented"))};p=a.Blob;b=a.SyncPromise;Aa=a.DigestAlgorithm;W=a.TpmPrivateKey;Oa=a.TpmBackEnd;ac=a.TpmKeyHandle;sd=function(a){ac.call(this);if(null==a)throw Error("The key is null");this.key_=a};sd.prototype=new ac;sd.prototype.name="TpmKeyHandleMemory";q.TpmKeyHandleMemory=
sd;sd.prototype.doSignPromise_=function(a,c,g){return a==Aa.SHA256?this.key_.signPromise(c,a,g).catch(function(a){return b.reject(new Oa.Error(Error("Error in TpmPrivateKey.sign: "+a)))}):b.resolve(new p)};sd.prototype.doDecryptPromise_=function(a,c){return this.key_.decryptPromise(a,c).catch(function(a){return b.reject(new Oa.Error(Error("Error in TpmPrivateKey.decrypt: "+a)))})};ac.prototype.doDerivePublicKey_=function(){try{return this.key_.derivePublicKey()}catch(a){throw new Oa.Error(Error("Error in TpmPrivateKey.derivePublicKey: "+
a));}};var pd=a.constants,ea=a,ba=a.KeyType,ha=a.EncryptAlgorithmType,Aa=a.DigestAlgorithm,L=a.DataUtils,b=a.SyncPromise,m=a.DerNode,ed=a.DerNode.DerInteger,fb=a.OID,p=a.Blob,yb=a.UseSubtleCrypto,xc=null;try{xc=a}catch(af){}W=function(){this.decryptSubtleKey_=this.subtleKey_=this.privateKey_=this.keyType_=null};q.TpmPrivateKey=W;W.Error=function(a){if(a)return a.__proto__=W.Error.prototype,a};W.Error.prototype=Error();W.Error.prototype.name="TpmPrivateKeyError";W.prototype.loadPkcs1=function(a,b){a instanceof
p&&(a=a.buf());if(void 0==b)try{var c=m.parse(a).getChildren();b=9==c.length&&c[0]instanceof ed&&0==c[0].toVal()&&c[1]instanceof ed&&c[2]instanceof ed&&c[3]instanceof ed&&c[4]instanceof ed&&c[5]instanceof ed&&c[6]instanceof ed&&c[7]instanceof ed&&c[8]instanceof ed?ba.RSA:ba.EC}catch(g){b=ba.EC}if(b==ba.EC){for(var c=a.toString("base64"),t="-----BEGIN EC PRIVATE KEY-----\n",f=0;f<c.length;f+=64)t+=c.substr(f,64)+"\n";this.privateKey_=t+"-----END EC PRIVATE KEY-----"}else if(b==ba.RSA){c=a.toString("base64");
t="-----BEGIN RSA PRIVATE KEY-----\n";for(f=0;f<c.length;f+=64)t+=c.substr(f,64)+"\n";this.privateKey_=t+="-----END RSA PRIVATE KEY-----"}else throw new W.Error(Error("loadPkcs1: Unrecognized keyType: "+b));this.keyType_=b;this.decryptSubtleKey_=this.subtleKey_=null};W.prototype.loadPkcs8=function(a,b){a instanceof p&&(a=a.buf());var c;if(void 0==b){var g;try{var t=m.parse(a),f=t.getChildren();g=m.getSequence(f,1).getChildren()[0].toVal();c=f[2].toVal()}catch(n){try{this.loadPkcs1(a);return}catch(Lb){throw new W.Error(Error("loadPkcs8: Error decoding private key: "+
Lb));}}if(g==W.EC_ENCRYPTION_OID)b=ba.EC;else if(g==W.RSA_ENCRYPTION_OID)b=ba.RSA;else throw new W.Error(Error("loadPkcs8: Unrecognized private key OID: "+g));}else t=m.parse(a),c=t.getChildren()[2].toVal();this.loadPkcs1(c,b)};W.prototype.derivePublicKey=function(){if(this.keyType_!=ba.RSA)throw new W.Error(Error("derivePublicKey: The private key is not loaded"));try{var a=L.privateKeyPemToDer(this.privateKey_),b=m.parse(a,0).getChildren(),c=b[1],g=b[2],t=new m.DerSequence;t.addChild(c);t.addChild(g);
var f=t.encode(),n=new m.DerSequence;n.addChild(new m.DerOid(new fb(W.RSA_ENCRYPTION_OID)));n.addChild(new m.DerNull);var Lb=new m.DerSequence;Lb.addChild(n);Lb.addChild(new m.DerBitString(f.buf(),0));return Lb.encode()}catch(p){throw new W.Error(Error("derivePublicKey: Error decoding private key "+p));}};W.prototype.decryptPromise=function(a,c,g){"boolean"===typeof c&&(g=c,c=void 0);void 0==c&&(c=ha.RsaOaep);if(null==this.keyType_)return b.reject(new W.Error(Error("decrypt: The private key is not loaded")));
if(yb()&&!g&&c!=ha.RsaPkcs)return c==ha.RsaOaep?this.getDecryptSubtleKeyPromise_().then(function(b){return crypto.subtle.decrypt({name:"RSA-OAEP"},b,a)}).then(function(a){return Promise.resolve(new p(new Uint8Array(a),!1))}):Promise.reject(Error("Unsupported padding scheme"));if(c==ha.RsaPkcs)c=pd.RSA_PKCS1_PADDING;else if(c==ha.RsaOaep)c=pd.RSA_PKCS1_OAEP_PADDING;else return b.reject(new W.Error(Error("Unsupported padding scheme")));try{return b.resolve(new p(ea.privateDecrypt({key:this.privateKey_,
padding:c},a),!1))}catch(f){return b.reject(new W.Error(f))}};W.prototype.signPromise=function(a,c,g){if(null==this.keyType_)return b.resolve(new p);if(c!=Aa.SHA256)return b.reject(new W.Error(Error("TpmPrivateKey.sign: Unsupported digest algorithm")));if(yb()&&!g){var m;if(this.keyType_===ba.RSA)m={name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};else return b.reject(new W.Error(Error("signPromise: Unrecognized key type "+this.keyType_)));return this.getSubtleKeyPromise_().then(function(b){return crypto.subtle.sign(m,
b,a)}).then(function(a){a=new p(new Uint8Array(a),!0);return Promise.resolve(a)})}if(this.keyType_===ba.RSA)c=ea.createSign("RSA-SHA256");else if(this.keyType===ba.EC)c=ea.createSign("sha256");else return b.reject(new W.Error(Error("signPromise: Unrecognized key type "+this.keyType_)));c.update(a);c=new f(L.toNumbersIfString(c.sign(this.privateKey_)));c=new p(c,!1);return b.resolve(c)};W.prototype.toPkcs1=function(){if(null==this.keyType_)throw new W.Error(Error("toPkcs1: The private key is not loaded"));
return new p(L.privateKeyPemToDer(this.privateKey_),!1)};W.prototype.toPkcs8=function(){if(null==this.keyType_)throw new W.Error(Error("toPkcs8: The private key is not loaded"));var a;if(this.keyType_===ba.RSA)a=new fb(W.RSA_ENCRYPTION_OID);else if(this.keyType===ba.EC)a=new fb(W.EC_ENCRYPTION_OID);else throw new W.Error(Error("toPkcs8: Unrecognized key type "+this.keyType_));return W.encodePkcs8PrivateKey(this.toPkcs1().buf(),a,new m.DerNull)};W.generatePrivateKeyPromise=function(a,c){if(yb()&&!c){if(a.getKeyType()===
ba.RSA){var g=null;return crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:a.getKeySize(),publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign"]).then(function(a){g=a.privateKey;return crypto.subtle.exportKey("pkcs8",a.privateKey)}).then(function(a){var c=new W;c.loadPkcs8(new p(new Uint8Array(a),!1),ba.RSA);c.subtleKey_=g;return b.resolve(c)})}return Promise.reject(Error("Cannot generate a key pair of type "+a.getKeyType()))}var f;if(a.getKeyType()===ba.RSA){if(!xc)return b.reject(new W.Error(Error("Need to install rsa-keygen: sudo npm install rsa-keygen")));
f=xc.generate(a.getKeySize()).private_key.toString()}else return b.reject(Error("Cannot generate a key pair of type "+a.getKeyType()));var t=new W;t.privateKey_=f;t.keyType_=a.getKeyType();return b.resolve(t)};W.encodePkcs8PrivateKey=function(a,b,c){var g=new m.DerSequence;g.addChild(new m.DerOid(b));g.addChild(c);b=new m.DerSequence;b.addChild(new m.DerInteger(0));b.addChild(g);b.addChild(new m.DerOctetString(a));return b.encode()};W.encodePkcs1PrivateKeyFromRSAKey=function(a){var b=new m.DerSequence;
b.addChild(new m.DerInteger(0));b.addChild(new m.DerInteger(W.bigIntegerToBuffer(a.n)));b.addChild(new m.DerInteger(a.e));b.addChild(new m.DerInteger(W.bigIntegerToBuffer(a.d)));b.addChild(new m.DerInteger(W.bigIntegerToBuffer(a.p)));b.addChild(new m.DerInteger(W.bigIntegerToBuffer(a.q)));b.addChild(new m.DerInteger(W.bigIntegerToBuffer(a.dmp1)));b.addChild(new m.DerInteger(W.bigIntegerToBuffer(a.dmq1)));b.addChild(new m.DerInteger(W.bigIntegerToBuffer(a.coeff)));return b.encode()};W.encodePublicKeyFromRSAKey=
function(a){var b=new m.DerSequence;b.addChild(new m.DerInteger(W.bigIntegerToBuffer(a.n)));b.addChild(new m.DerInteger(a.e));a=new m.DerSequence;a.addChild(new m.DerOid(new fb(W.RSA_ENCRYPTION_OID)));a.addChild(new m.DerNull);var c=new m.DerSequence;c.addChild(a);c.addChild(new m.DerBitString(b.encode().buf(),0));return c.encode()};W.bigIntegerToBuffer=function(a){a=a.toString(16);if("-"==a.substr(0,1))throw Error("TpmPrivateKey.bigIntegerToBuffer: Negative integers are not currently supported");
1==a.length%2?a="0"+a:a.match(/^[0-7]/)||(a="00"+a);return new f(a,"hex")};W.prototype.getSubtleKeyPromise_=function(){if(this.subtleKey_)return Promise.resolve(this.subtleKey_);if(this.keyType_===ba.RSA){var a=L.privateKeyPemToDer(this.privateKey_),a=W.encodePkcs8PrivateKey(a,new fb(W.RSA_ENCRYPTION_OID),new m.DerNull).buf(),c=this;return crypto.subtle.importKey("pkcs8",a,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]).then(function(a){c.subtleKey_=a;return Promise.resolve(c.subtleKey_)})}return b.reject(new W.Error(Error("Unrecognized key type "+
this.keyType_)))};W.prototype.getDecryptSubtleKeyPromise_=function(){if(this.decryptSubtleKey_)return Promise.resolve(this.decryptSubtleKey_);if(this.keyType_===ba.RSA){var a=L.privateKeyPemToDer(this.privateKey_),a=W.encodePkcs8PrivateKey(a,new fb(W.RSA_ENCRYPTION_OID),new m.DerNull).buf(),c=this;return crypto.subtle.importKey("pkcs8",a,{name:"RSA-OAEP",hash:{name:"SHA-1"}},!1,["decrypt"]).then(function(a){c.decryptSubtleKey_=a;return Promise.resolve(c.decryptSubtleKey_)})}return b.reject(new W.Error(Error("Unrecognized key type "+
this.keyType_)))};W.RSA_ENCRYPTION_OID="1.2.840.113549.1.1.1";W.EC_ENCRYPTION_OID="1.2.840.10045.2.1";ba=a.KeyType;b=a.SyncPromise;Za=function(a,b,c){this.keys_={};this.scheme_=a;this.location_=b;this.backEnd_=c;this.initializePib_=null;this.isInitialized_=!1};q.Tpm=Za;Za.Error=function(a){if(a)return a.__proto__=Za.Error.prototype,a};Za.Error.prototype=Error();Za.Error.prototype.name="TpmError";Za.prototype.getTpmLocator=function(){if(!this.isInitialized_)throw new Za.Error(Error("getTpmLocator: The Tpm is not initialized"));
return this.scheme_+":"+this.location_};Za.prototype.hasKeyPromise=function(a,b){var c=this;return this.initializePromise_(b).then(function(){return c.backEnd_.hasKeyPromise(a,b)})};Za.prototype.getPublicKeyPromise=function(a,c){var g=this;return this.initializePromise_(c).then(function(){return g.findKeyPromise_(a,c)}).then(function(a){return null==a?b.resolve(new p):b.resolve(a.derivePublicKey())})};Za.prototype.signPromise=function(a,c,g,f){var t=this;return this.initializePromise_(f).then(function(){return t.findKeyPromise_(c,
f)}).then(function(c){return null==c?b.resolve(new p):c.signPromise(g,a,f)})};Za.prototype.decryptPromise=function(a,c,g){var f=this;return this.initializePromise_(g).then(function(){return f.findKeyPromise_(c,g)}).then(function(c){return null==c?b.resolve(new p):c.decryptPromise(a,g)})};Za.prototype.createKeyPromise_=function(a,c,g){var f=this;return this.initializePromise_(g).then(function(){return c.getKeyType()==ba.RSA||c.getKeyType()==ba.EC?f.backEnd_.createKeyPromise(a,c,g).then(function(a){var c=
a.getKeyName();f.keys_[c.toUri()]=a;return b.resolve(c)}):b.resolve(new Za.Error(Error("createKey: Unsupported key type")))})};Za.prototype.deleteKeyPromise_=function(a,b){var c=this;return this.initializePromise_(b).then(function(){delete c.keys_[a.toUri()];return c.backEnd_.deleteKeyPromise(a,b)})};Za.prototype.importPrivateKeyPromise_=function(a,b,c,g){var t=this;return this.initializePromise_(g).then(function(){return t.backEnd_.importKeyPromise(a,b,c,g)})};Za.prototype.findKeyPromise_=function(a,
c){var g=this;return this.initializePromise_(c).then(function(){var f=a.toUri(),t=g.keys_[f];return void 0!=t?b.resolve(t):g.backEnd_.getKeyHandlePromise(a,c).then(function(a){return null!=a?(g.keys_[f]=a,b.resolve(a)):b.resolve(null)})})};Za.prototype.initializePromise_=function(a){return this.isInitialized_?b.resolve():null==this.initializePib_?(this.isInitialized_=!0,b.resolve()):this.initializePib_.initializePromise_(a)};var c=a.Name,oa=a.PibKey,I=a.ValidationError,Ta=a.ConfigNameRelation,Ua=
a.NdnRegexTopMatcher,ra=a.ValidatorConfigError,ub=function(){};q.ConfigChecker=ub;ub.prototype.check=function(a,b,c,g){return a?2>b.size()?!1:this.checkNames(b.getPrefix(-2),c,g):this.checkNames(b,c,g)};ub.create=function(a){var b=a.getFirstValue("type");if(null==b)throw new ra(Error("Expected <checker.type>"));if("customized"==b.toLowerCase())return ub.createCustomizedChecker_(a);if("hierarchical"==b.toLowerCase())return ub.createHierarchicalChecker_(a);throw new ra(Error("Unsupported checker type: "+
b));};ub.prototype.checkNames=function(a,b,c){throw Error("ConfigChecker.checkNames is not implemented");};ub.createCustomizedChecker_=function(a){keyLocatorSection=a.get("key-locator");if(1!=keyLocatorSection.length)throw new ra(Error("Expected one <checker.key-locator>"));return ub.createKeyLocatorChecker_(keyLocatorSection[0])};ub.createHierarchicalChecker_=function(a){return new Od("^(<>*)$","\\1","^(<>*)<KEY><>$","\\1",Ta.Relation.IS_PREFIX_OF)};ub.createKeyLocatorChecker_=function(a){var b=
a.getFirstValue("type");if(null==b)throw new ra(Error("Expected <checker.key-locator.type>"));if("name"==b.toLowerCase())return ub.createKeyLocatorNameChecker_(a);throw new ra(Error("Unsupported checker.key-locator.type: "+b));};ub.createKeyLocatorNameChecker_=function(a){var b=a.getFirstValue("name");if(null!=b){b=new c(b);a=a.getFirstValue("relation");if(null==a)throw new ra(Error("Expected <checker.key-locator.relation>"));B=Ta.getNameRelationFromString(a);return new ae(b,B)}b=a.getFirstValue("regex");
if(null!=b)try{return new be(b)}catch(g){throw new ra(Error("Invalid checker.key-locator.regex: "+b));}a=a.get("hyper-relation");if(1==a.length){var f=a[0];a=f.getFirstValue("k-regex");if(null==a)throw new ra(Error("Expected <checker.key-locator.hyper-relation.k-regex>"));b=f.getFirstValue("k-expand");if(null==b)throw new ra(Error("Expected <checker.key-locator.hyper-relation.k-expand"));B=f.getFirstValue("h-relation");if(null==B)throw new ra(Error("Expected <checker.key-locator.hyper-relation.h-relation>"));
var t=f.getFirstValue("p-regex");if(null==t)throw new ra(Error("Expected <checker.key-locator.hyper-relation.p-regex>"));f=f.getFirstValue("p-expand");if(null==f)throw new ra(Error("Expected <checker.key-locator.hyper-relation.p-expand>"));var B=Ta.getNameRelationFromString(B);try{return new Od(t,f,a,b,B)}catch(m){throw new ra(Error("Invalid regex for key-locator.hyper-relation"));}}throw new ra(Error("Unsupported checker.key-locator"));};var ae=function(a,b){ub.call(this);this.name_=a;this.relation_=
b};ae.prototype=new ub;ae.prototype.name="ConfigNameRelationChecker";q.ConfigNameRelationChecker=ae;ae.prototype.checkNames=function(a,b,c){var g=oa.extractIdentityFromKeyName(b),t=Ta.checkNameRelation(this.relation_,this.name_,g);t||c.fail(new I(I.POLICY_ERROR,"KeyLocator check failed: name relation "+this.name_.toUri()+" "+Ta.toString(this.relation_)+" for packet "+a.toUri()+" is invalid (KeyLocator="+b.toUri()+", identity="+g.toUri()+")"));return t};var be=function(a){ub.call(this);this.regex_=
new Ua(a)};be.prototype=new ub;be.prototype.name="ConfigRegexChecker";q.ConfigRegexChecker=be;be.prototype.checkNames=function(a,b,c){var g=this.regex_.match(b);g||c.fail(new I(I.POLICY_ERROR,"KeyLocator check failed: regex "+this.regex_.getExpr()+" for packet "+a.toUri()+" is invalid (KeyLocator="+b.toUri()+")"));return g};var Od=function(a,b,c,g,t){ub.call(this);this.packetNameRegex_=new Ua(a);this.packetNameExpansion_=b;this.keyNameRegex_=new Ua(c);this.keyNameExpansion_=g;this.hyperRelation_=
t};Od.prototype=new ub;Od.prototype.name="ConfigHyperRelationChecker";q.ConfigHyperRelationChecker=Od;Od.prototype.checkNames=function(a,b,c){if(!this.packetNameRegex_.match(a))return c.fail(new I(I.POLICY_ERROR,"The packet "+a.toUri()+" (KeyLocator="+b.toUri()+") does not match the hyper relation packet name regex "+this.packetNameRegex_.getExpr())),!1;if(!this.keyNameRegex_.match(b))return c.fail(new I(I.POLICY_ERROR,"The packet "+a.toUri()+" (KeyLocator="+b.toUri()+") does not match the hyper relation key name regex "+
this.keyNameRegex_.getExpr())),!1;var g=this.keyNameRegex_.expand(this.keyNameExpansion_),t=this.packetNameRegex_.expand(this.packetNameExpansion_),f=Ta.checkNameRelation(this.hyperRelation_,g,t);f||c.fail(new I(I.POLICY_ERROR,"KeyLocator check failed: hyper relation "+Ta.toString(this.hyperRelation_)+" packet name match="+t.toUri()+", key name match="+g.toUri()+" of packet "+a.toUri()+" (KeyLocator="+b.toUri()+") is invalid"));return f};var c=a.Name,Ta=a.ConfigNameRelation,Ua=a.NdnRegexTopMatcher,
ra=a.ValidatorConfigError,kc=function(){};q.ConfigFilter=kc;kc.prototype.match=function(a,b){return a?2>b.size()?!1:this.matchName(b.getPrefix(-2)):this.matchName(b)};kc.create=function(a){var b=a.getFirstValue("type");if(null==b)throw new ra(Error("Expected <filter.type>"));if("name"==b.toLowerCase())return kc.createNameFilter_(a);throw new ra(Error("Unsupported filter.type: "+b));};kc.prototype.matchName=function(a){throw Error("ConfigFilter.matchName is not implemented");};kc.createNameFilter_=
function(a){var b=a.getFirstValue("name");if(null!=b){b=new c(b);a=a.getFirstValue("relation");if(null==a)throw new ra(Error("Expected <filter.relation>"));a=Ta.getNameRelationFromString(a);return new ce(b,a)}b=a.getFirstValue("regex");if(null!=b)try{return new de(b)}catch(g){throw new ra(Error("Wrong filter.regex: "+b));}throw new ra(Error("Wrong filter(name) properties"));};var ce=function(a,b){kc.call(this);this.name_=new c(a);this.relation_=b};ce.prototype=new kc;ce.prototype.name="ConfigRelationNameFilter";
q.ConfigRelationNameFilter=ce;ce.prototype.matchName=function(a){return Ta.checkNameRelation(this.relation_,this.name_,a)};var de=function(a){kc.call(this);this.regex_=new Ua(a)};de.prototype=new kc;de.prototype.name="ConfigRegexNameFilter";q.ConfigRegexNameFilter=de;de.prototype.matchName=function(a){return this.regex_.match(a)};ra=a.ValidatorConfigError;Ta=function(){};q.ConfigNameRelation=Ta;Ta.Relation=function(){};Ta.Relation.EQUAL=0;Ta.Relation.IS_PREFIX_OF=1;Ta.Relation.IS_STRICT_PREFIX_OF=
2;Ta.toString=function(a){return a==Ta.Relation.EQUAL?"equal":a==Ta.Relation.IS_PREFIX_OF?"is-prefix-of":a==Ta.Relation.IS_STRICT_PREFIX_OF?"is-strict-prefix-of":""};Ta.checkNameRelation=function(a,b,c){return a==Ta.Relation.EQUAL?b.equals(c):a==Ta.Relation.IS_PREFIX_OF?b.isPrefixOf(c):a==Ta.Relation.IS_STRICT_PREFIX_OF?b.isPrefixOf(c)&&b.size()<c.size():!1};Ta.getNameRelationFromString=function(a){if("equal"==a.toLowerCase())return Ta.Relation.EQUAL;if("is-prefix-of"==a.toLowerCase())return Ta.Relation.IS_PREFIX_OF;
if("is-strict-prefix-of"==a.toLowerCase())return Ta.Relation.IS_STRICT_PREFIX_OF;throw new ra(Error("Unsupported relation: "+a));};var ub=a.ConfigChecker,kc=a.ConfigFilter,ra=a.ValidatorConfigError,g=a.Log.LOG,Ac=function(a,b){this.id_=a;this.isForInterest_=b;this.filters_=[];this.checkers_=[]};q.ConfigRule=Ac;Ac.prototype.getId=function(){return this.id_};Ac.prototype.getIsForInterest=function(){return this.isForInterest_};Ac.prototype.addFilter=function(a){this.filters_.push(a)};Ac.prototype.addChecker=
function(a){this.checkers_.push(a)};Ac.prototype.match=function(a,b){3<g&&console.log("Trying to match "+b.toUri());if(a!=this.isForInterest_)throw new ra(Error("Invalid packet type supplied ( "+(a?"interest":"data")+" != "+(this.isForInterest_?"interest":"data")+")"));if(0==this.filters_.length)return!0;for(var c=!1,f=0;f<this.filters_.length&&!(c=c||this.filters_[f].match(a,b));++f);return c};Ac.prototype.check=function(a,b,c,f){3<g&&console.log("Trying to check "+b.toUri()+" with keyLocator "+
c.toUri());if(a!=this.isForInterest_)throw new ra(Error("Invalid packet type supplied ( "+(a?"interest":"data")+" != "+(this.isForInterest_?"interest":"data")+")"));for(var t=!1,B=0;B<this.checkers_.length;++B){t=this.checkers_[B].check(a,b,c,f);if(!t)break;t=!0}return t};Ac.create=function(a){var b=a.getFirstValue("id");if(null==b)throw new ra(Error("Expecting <rule.id>"));var c=a.getFirstValue("for");if(null==c)throw new ra(Error("Expecting <rule.for> in rule: "+b));if("data"==c.toLowerCase())c=
!1;else if("interest"==c.toLowerCase())c=!0;else throw new ra(Error("Unrecognized <rule.for>: "+c+" in rule: "+b));for(var c=new Ac(b,c),g=a.get("filter"),t=0;t<g.length;++t)c.addFilter(kc.create(g[t]));a=a.get("checker");for(t=0;t<a.length;++t)c.addChecker(ub.create(a[t]));if(0==a.length)throw new ra(Error("No <rule.checker> is specified in rule: "+b));return c};var Ib=a,p=a.Blob,M=a.CertificateV2,lc=function(a,b){this.certificates_=a;this.id_=b;this.anchorNameUris_={}};q.TrustAnchorGroup=lc;lc.prototype.getId=
function(){return this.id_};lc.prototype.size=function(){return Object.keys(this.anchorNameUris_).length};lc.prototype.refresh=function(){};lc.readCertificate=function(a){try{var b=Ib.readFileSync(a).toString(),c=new f(b,"base64"),g=new M;g.wireDecode(new p(c,!1));return g}catch(t){return null}};var b=a.SyncPromise,I=a.ValidationError,g=a.Log.LOG,Na=a.VerificationHelpers,M=a.CertificateV2,zb=function(){this.certificateChain_=[];this.seenCertificateNameUris_={};this.outcome_=this.hasOutcome_=!1};q.ValidationState=
zb;zb.prototype.hasOutcome=function(){return this.hasOutcome_};zb.prototype.isOutcomeFailed=function(){return this.hasOutcome_&&!1==this.outcome_};zb.prototype.isOutcomeSuccess=function(){return this.hasOutcome_&&!0==this.outcome_};zb.prototype.fail=function(a){throw Error("ValidationState.fail is not implemented");};zb.prototype.getDepth=function(){return this.certificateChain_.length};zb.prototype.hasSeenCertificateName=function(a){a=a.toUri();if(void 0!==this.seenCertificateNameUris_[a])return!0;
this.seenCertificateNameUris_[a]=!0;return!1};zb.prototype.addCertificate=function(a){this.certificateChain_.unshift(new M(a))};zb.prototype.setOutcome=function(a){if(this.hasOutcome_)throw Error("The ValidationState already has an outcome");this.hasOutcome_=!0;this.outcome_=a};zb.prototype.verifyOriginalPacketPromise_=function(a){return b.reject(Error("ValidationState.verifyOriginalPacketPromise_ is not implemented"))};zb.prototype.bypassValidation_=function(){throw Error("ValidationState.bypassValidation_ is not implemented");
};zb.prototype.verifyCertificateChainPromise_=function(a){var c=a,f=this,m=function(a){if(a>=f.certificateChain_.length)return b.resolve(c);var B=f.certificateChain_[a];return Na.verifyDataSignaturePromise(B,c).then(function(n){if(n)3<g&&console.log("OK signature for certificate `"+B.getName().toUri()+"`"),c=B;else{for(f.fail(new I(I.INVALID_SIGNATURE,"Invalid signature of certificate `"+B.getName().toUri()+"`"));f.certificateChain_.length>a;)f.certificateChain_.splice(a,1);return b.resolve(null)}++a;
return m(a)})};return m(0)};var c=a.Name,fa=a.Schedule,M=a.CertificateV2,g=a.Log.LOG,Xb=function w(a){this.certificatesByName_=[];this.nextRefreshTime_=Number.MAX_VALUE;this.maxLifetimeMilliseconds_=void 0==a?w.getDefaultLifetime():a;this.nowOffsetMilliseconds_=0};q.CertificateCacheV2=Xb;Xb.prototype.insert=function(a){var b=a.getValidityPeriod().getNotAfter(),c=(new Date).getTime()+this.nowOffsetMilliseconds_;if(b<c)3<g&&console.log("Not adding "+a.getName().toUri()+": already expired at "+fa.toIsoString(b));
else{b=Math.min(b,c+this.maxLifetimeMilliseconds_);b<this.nextRefreshTime_&&(this.nextRefreshTime_=b);3<g&&console.log("Adding "+a.getName().toUri()+", will remove in "+(b-c)/36E5+" hours");a=new M(a);var c=a.getName(),t=this.findFirstByName_(c);if(0>t)t=this.certificatesByName_.length;else if(this.certificatesByName_[t].name.equals(c)){this.certificatesByName_[t].certificate=a;this.certificatesByName_[t].removalTime=b;return}this.certificatesByName_.splice(t,0,{name:c,certificate:a,removalTime:b})}};
Xb.prototype.find=function(a){if(a instanceof c){0<a.size()&&a.get(-1).isImplicitSha256Digest()&&console.log("Certificate search using a name with an implicit digest is not yet supported");this.refresh_();var b=this.findFirstByName_(a);if(0>b)return null;b=this.certificatesByName_[b];return a.isPrefixOf(b.certificate.getName())?b.certificate:null}null!=a.getChildSelector()&&console.log("Certificate search using a ChildSelector is not supported. Searching as if this selector not specified");0<a.getName().size()&&
a.getName().get(-1).isImplicitSha256Digest()&&console.log("Certificate search using a name with an implicit digest is not yet supported");this.refresh_();b=this.findFirstByName_(a.getName());if(0>b)return null;for(;b<this.certificatesByName_.length;++b){var g=this.certificatesByName_[b].certificate;if(!a.getName().isPrefixOf(g.getName()))break;if(a.matchesData(g))return g}return null};Xb.prototype.deleteCertificate=function(a){for(var b=0;b<this.certificatesByName_.length;++b)if(this.certificatesByName_[b].name.equals(a)){this.certificatesByName_.splice(b,
1);break}};Xb.prototype.clear=function(){this.certificatesByName_=[];this.nextRefreshTime_=Number.MAX_VALUE};Xb.getDefaultLifetime=function(){return 36E5};Xb.prototype.setNowOffsetMilliseconds_=function(a){this.nowOffsetMilliseconds_=a};Xb.prototype.findFirstByName_=function(a){for(var b=0;b<this.certificatesByName_.length;++b)if(0<=this.certificatesByName_[b].name.compare(a))return b;return-1};Xb.prototype.refresh_=function(){var a=(new Date).getTime()+this.nowOffsetMilliseconds_;if(!(a<this.nextRefreshTime_)){for(var b=
Number.MAX_VALUE,c=this.certificatesByName_.length-1;0<=c;--c){var g=this.certificatesByName_[c];g.removalTime<=a?this.certificatesByName_.splice(c,1):b=Math.min(b,g.removalTime)}this.nextRefreshTime_=b}};var ee=function(){};q.CertificateContainerInterface=ee;ee.prototype.add=function(a){throw Error("CertificateContainerInterface.add is unimplemented");};ee.prototype.remove=function(a){throw Error("CertificateContainerInterface.remove is unimplemented");};var g=a.Log.LOG,mc=function(){this.certificateStorage_=
null};q.CertificateFetcher=mc;mc.prototype.setCertificateStorage=function(a){this.certificateStorage_=a};mc.prototype.fetch=function(a,b,c){if(null==this.certificateStorage_)throw Error("CertificateFetcher.fetch: You must first call setCertificateStorage");var t=this.certificateStorage_.getUnverifiedCertificateCache().find(a.interest_);if(null!=t)3<g&&console.log("Found certificate in **un**verified key cache "+t.getName().toUri()),c(t,b);else{var f=this;this.doFetch_(a,b,function(a,b){f.certificateStorage_.cacheUnverifiedCertificate(a);
c(a,b)})}};mc.prototype.doFetch_=function(a,b,c){throw Error("CertificateFetcher.doFetch_ is not implemented");};var g=a.Log.LOG,M=a.CertificateV2,I=a.ValidationError,mc=a.CertificateFetcher,Cd=function(a){mc.call(this);this.face_=a};Cd.prototype=new mc;Cd.prototype.name="CertificateFetcherFromNetwork";q.CertificateFetcherFromNetwork=Cd;Cd.prototype.doFetch_=function(a,b,c){var t=this;try{t.face_.expressInterest(a.interest_,function(a,t){3<g&&console.log("Fetched certificate from network "+t.getName().toUri());
var f;try{f=new M(t)}catch(B){b.fail(new I(I.MALFORMED_CERTIFICATE,"Fetched a malformed certificate `"+t.getName().toUri()+"` ("+B+")"));return}try{c(f,b)}catch(m){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Error in continueValidation: "+m))}},function(f){3<g&&console.log("Timeout while fetching certificate "+a.interest_.getName().toUri()+", retrying");--a.nRetriesLeft_;if(0<=a.nRetriesLeft_)try{t.fetch(a,b,c)}catch(B){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Error in fetch: "+B))}else b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,
"Cannot fetch certificate after all retries `"+a.interest_.getName().toUri()+"`"))},function(f,B){3<g&&console.log("NACK ("+B.getReason()+") while fetching certificate "+a.interest_.getName().toUri());--a.nRetriesLeft_;if(0<=a.nRetriesLeft_)try{t.fetch(a,b,c)}catch(m){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Error in fetch: "+m))}else b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Cannot fetch certificate after all retries `"+a.interest_.getName().toUri()+"`"))})}catch(f){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,
"Error in expressInterest: "+f))}};var I=a.ValidationError,mc=a.CertificateFetcher,td=function(){mc.call(this)};td.prototype=new mc;td.prototype.name="CertificateFetcherOffline";q.CertificateFetcherOffline=td;td.prototype.doFetch_=function(a,b,c){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Cannot fetch certificate "+a.interest_.getName().toUri()+" in offline mode"))};var F=a.Interest,ud=function(a){void 0!=a?(this.interest_=new F(a),this.nRetriesLeft_=3):(this.interest_=new F,this.nRetriesLeft_=0)};
q.CertificateRequest=ud;var c=a.Name,db=a.TrustAnchorContainer,M=a.CertificateV2,Xb=a.CertificateCacheV2,Nb=function(){this.trustAnchors_=new db;this.verifiedCertificateCache_=new Xb(36E5);this.unverifiedCertificateCache_=new Xb(3E5)};q.CertificateStorage=Nb;Nb.prototype.findTrustedCertificate=function(a){var b=this.trustAnchors_.find(a);return null!=b?b:b=this.verifiedCertificateCache_.find(a)};Nb.prototype.isCertificateKnown=function(a){return null!=this.trustAnchors_.find(a)||null!=this.verifiedCertificateCache_.find(a)||
null!=this.unverifiedCertificateCache_.find(a)};Nb.prototype.cacheUnverifiedCertificate=function(a){this.unverifiedCertificateCache_.insert(a)};Nb.prototype.getTrustAnchors=function(){return this.trustAnchors_};Nb.prototype.getVerifiedCertificateCache=function(){return this.verifiedCertificateCache_};Nb.prototype.getUnverifiedCertificateCache=function(){return this.unverifiedCertificateCache_};Nb.prototype.loadAnchor=function(a,b,c,g){this.trustAnchors_.insert(a,b,c,g)};Nb.prototype.resetAnchors=
function(){this.trustAnchors_.clear()};Nb.prototype.cacheVerifiedCertificate=function(a){this.verifiedCertificateCache_.insert(a)};Nb.prototype.resetVerifiedCertificates=function(){this.verifiedCertificateCache_.clear()};Nb.prototype.setCacheNowOffsetMilliseconds_=function(a){this.verifiedCertificateCache_.setNowOffsetMilliseconds_(a);this.unverifiedCertificateCache_.setNowOffsetMilliseconds_(a)};c=a.Name;Q=a.Data;U=a.KeyLocator;Ga=a.KeyLocatorType;Da=a.Sha256WithRsaSignature;Sa=a.Sha256WithEcdsaSignature;
ya=a.ContentType;s=a.WireFormat;fa=a.Schedule;za=a.ValidityPeriod;Yb=a.InvalidArgumentException;M=function(a){void 0!=a?(Q.call(this,a),this.checkFormat_()):(Q.call(this),this.getMetaInfo().setType(ya.KEY))};M.prototype=new Q;M.prototype.name="CertificateV2";q.CertificateV2=M;M.Error=function(a){if(a)return a.__proto__=M.Error.prototype,a};M.Error.prototype=Error();M.Error.prototype.name="CertificateV2Error";M.prototype.checkFormat_=function(){if(!M.isValidName(this.getName()))throw new M.Error(Error("The Data Name does not follow the certificate naming convention"));
if(this.getMetaInfo().getType()!=ya.KEY)throw new M.Error(Error("The Data ContentType is not KEY"));if(0>this.getMetaInfo().getFreshnessPeriod())throw new M.Error(Error("The Data FreshnessPeriod is not set"));if(0==this.getContent().size())throw new M.Error(Error("The Data Content is empty"));};M.prototype.getKeyName=function(){return this.getName().getPrefix(M.KEY_ID_OFFSET+1)};M.prototype.getIdentity=function(){return this.getName().getPrefix(M.KEY_COMPONENT_OFFSET)};M.prototype.getKeyId=function(){return this.getName().get(M.KEY_ID_OFFSET)};
M.prototype.getIssuerId=function(){return this.getName().get(M.ISSUER_ID_OFFSET)};M.prototype.getPublicKey=function(){if(0==this.getContent().size())throw new M.Error(Error("The public key is not set (the Data content is empty)"));return this.getContent()};M.prototype.getValidityPeriod=function(){if(!za.canGetFromSignature(this.getSignature()))throw new Yb(Error("The SignatureInfo does not have a ValidityPeriod"));return za.getFromSignature(this.getSignature())};M.prototype.isValid=function(a){return this.getValidityPeriod().isValid(a)};
M.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();Q.prototype.wireDecode.call(this,a,b);this.checkFormat_()};M.prototype.toString=function(){var a;a="Certificate name:\n"+("  "+this.getName().toUri()+"\n");a+="Validity:\n";a+="  NotBefore: "+fa.toIsoString(this.getValidityPeriod().getNotBefore())+"\n";a+="  NotAfter: "+fa.toIsoString(this.getValidityPeriod().getNotAfter())+"\n";a+="Public key bits:\n";try{for(var b=this.getPublicKey().buf().toString("base64"),c=0;c<b.length;c+=64)a+=
b.substr(c,64)+"\n"}catch(g){}a+="Signature Information:\n";a+="  Signature Type: ";a=this.getSignature()instanceof Sa?a+"SignatureSha256WithEcdsa\n":this.getSignature()instanceof Da?a+"SignatureSha256WithRsa\n":a+"<unknown>\n";U.canGetFromSignature(this.getSignature())&&(a+="  Key Locator: ",b=U.getFromSignature(this.getSignature()),b.getType()==Ga.KEYNAME?(b.getKeyName().equals(this.getKeyName())&&(a+="Self-Signed "),a+="Name="+b.getKeyName().toUri()+"\n"):a+="<no KeyLocator key name>\n");return a};
M.isValidName=function(a){return a.size()>=M.MIN_CERT_NAME_LENGTH&&a.get(M.KEY_COMPONENT_OFFSET).equals(M.KEY_COMPONENT)};M.extractIdentityFromCertName=function(a){if(!M.isValidName(a))throw new Yb(Error("Certificate name `"+a.toUri()+"` does not follow the naming conventions"));return a.getPrefix(M.KEY_COMPONENT_OFFSET)};M.extractKeyNameFromCertName=function(a){if(!M.isValidName(a))throw new Yb(Error("Certificate name `"+a.toUri()+"` does not follow the naming conventions"));return a.getPrefix(M.KEY_ID_OFFSET+
1)};M.VERSION_OFFSET=-1;M.ISSUER_ID_OFFSET=-2;M.KEY_ID_OFFSET=-3;M.KEY_COMPONENT_OFFSET=-4;M.MIN_CERT_NAME_LENGTH=4;M.MIN_KEY_NAME_LENGTH=2;M.KEY_COMPONENT=new c.Component("KEY");var b=a.SyncPromise,Q=a.Data,g=a.Log.LOG,I=a.ValidationError,zb=a.ValidationState,Na=a.VerificationHelpers,O=a.NdnCommon,fd=function(a,b,c){zb.call(this);this.data_=new Q(a);this.successCallback_=b;this.failureCallback_=c;if(null==this.successCallback_)throw Error("The successCallback is null");if(null==this.failureCallback_)throw Error("The failureCallback is null");
};fd.prototype=new zb;fd.prototype.name="DataValidationState";q.DataValidationState=fd;fd.prototype.fail=function(a){3<g&&console.log(""+a);try{this.failureCallback_(this.data_,a)}catch(b){console.log("Error in failureCallback: "+O.getErrorWithStackTrace(b))}this.setOutcome(!1)};fd.prototype.getOriginalData=function(){return this.data_};fd.prototype.verifyOriginalPacketPromise_=function(a){var c=this;return Na.verifyDataSignaturePromise(this.data_,a).then(function(a){if(a){3<g&&console.log("OK signature for data `"+
c.data_.getName().toUri()+"`");try{c.successCallback_(c.data_)}catch(t){console.log("Error in successCallback: "+O.getErrorWithStackTrace(t))}c.setOutcome(!0)}else c.fail(new I(I.INVALID_SIGNATURE,"Invalid signature of data `"+c.data_.getName().toUri()+"`"));return b.resolve()})};fd.prototype.bypassValidation_=function(){3<g&&console.log("Signature verification bypassed for data `"+this.data_.getName().toUri()+"`");try{this.successCallback_(this.data_)}catch(a){console.log("Error in successCallback: "+
O.getErrorWithStackTrace(a))}this.setOutcome(!0)};var $d=Ib=a,lc=a.TrustAnchorGroup,c=a.Name,g=a.Log.LOG,Dd=function(a,b,c,t,f){lc.call(this,a,b);this.isDirectory_=f;this.path_=c;this.refreshPeriod_=t;this.expireTime_=0;if(0>=t)throw Error("Refresh period for the dynamic group must be positive");0<g&&console.log("Create a dynamic trust anchor group "+b+" for file/dir "+c+" with refresh time "+t);this.refresh()};Dd.prototype=new lc;Dd.prototype.name="DynamicTrustAnchorGroup";q.DynamicTrustAnchorGroup=
Dd;Dd.prototype.refresh=function(){var a=(new Date).getTime();if(!(this.expireTime_>a)){this.expireTime_=a+this.refreshPeriod_;0<g&&console.log("Reloading the dynamic trust anchor group");var a={},b;for(b in this.anchorNameUris_)a[b]=!0;if(this.isDirectory_){var f;try{f=Ib.readdirSync(this.path_)}catch(t){throw Error("Cannot list files in directory "+this.path_);}for(var B=0;B<f.length;++B)this.loadCertificate_($d.join(this.path_,f[B]),a)}else this.loadCertificate_(this.path_,a);for(b in a)delete this.anchorNameUris_[b],
this.certificates_.remove(new c(b))}};Dd.prototype.loadCertificate_=function(a,b){var c=lc.readCertificate(a);if(null!=c){var g=c.getName().toUri();this.anchorNameUris_[g]?delete b[g]:(this.anchorNameUris_[g]=!0,this.certificates_.add(c))}};var b=a.SyncPromise,F=a.Interest,g=a.Log.LOG,I=a.ValidationError,zb=a.ValidationState,Na=a.VerificationHelpers,O=a.NdnCommon,Pc=function(a,b,c){zb.call(this);this.interest_=new F(a);this.successCallbacks_=[b];this.failureCallback_=c;if(null==b)throw Error("The successCallback is null");
if(null==this.failureCallback_)throw Error("The failureCallback is null");};Pc.prototype=new zb;Pc.prototype.name="InterestValidationState";q.InterestValidationState=Pc;Pc.prototype.fail=function(a){3<g&&console.log(""+a);try{this.failureCallback_(this.interest_,a)}catch(b){console.log("Error in failureCallback: "+O.getErrorWithStackTrace(b))}this.setOutcome(!1)};Pc.prototype.getOriginalInterest=function(){return this.interest_};Pc.prototype.addSuccessCallback=function(a){this.successCallbacks_.push(a)};
Pc.prototype.verifyOriginalPacketPromise_=function(a){var c=this;return Na.verifyInterestSignaturePromise(this.interest_,a).then(function(a){if(a){3<g&&console.log("OK signature for interest `"+c.interest_.getName().toUri()+"`");for(a=0;a<c.successCallbacks_.length;++a)try{c.successCallbacks_[a](c.interest_)}catch(f){console.log("Error in successCallback: "+O.getErrorWithStackTrace(f))}c.setOutcome(!0)}else c.fail(new I(I.INVALID_SIGNATURE,"Invalid signature of interest `"+c.interest_.getName().toUri()+
"`"));return b.resolve()})};Pc.prototype.bypassValidation_=function(){3<g&&console.log("Signature verification bypassed for interest `"+this.interest_.getName().toUri()+"`");for(var a=0;a<this.successCallbacks_.length;++a)try{this.successCallbacks_[a](this.interest_)}catch(b){console.log("Error in successCallback: "+O.getErrorWithStackTrace(b))}this.setOutcome(!0)};var lc=a.TrustAnchorGroup,vd=function(a,b){lc.call(this,a,b)};vd.prototype=new lc;vd.prototype.name="StaticTrustAnchorGroup";q.StaticTrustAnchorGroup=
vd;vd.prototype.add=function(a){var b=a.getName().toUri();this.anchorNameUris_[b]||(this.anchorNameUris_[b]=!0,this.certificates_.add(a))};vd.prototype.remove=function(a){delete this.anchorNameUris_[a.toUri()];this.certificates_.remove(a)};c=a.Name;vd=a.StaticTrustAnchorGroup;Dd=a.DynamicTrustAnchorGroup;M=a.CertificateV2;ee=a.CertificateContainerInterface;db=function r(){this.groups_={};this.anchors_=new r.AnchorContainer_};q.TrustAnchorContainer=db;db.Error=function(a){if(a)return a.__proto__=db.Error.prototype,
a};db.Error.prototype=Error();db.Error.prototype.name="TrustAnchorContainerError";db.prototype.insert=function(a,b,c,g){if(b instanceof M){c=this.groups_[a];void 0===c&&(c=new vd(this.anchors_,a),this.groups_[a]=c);if(!(c instanceof vd))throw new db.Error(Error("Cannot add a static anchor to the non-static anchor group "+a));c.add(b)}else{null==g&&(g=!1);if(void 0!==this.groups_[a])throw new db.Error(Error("Cannot create the dynamic group, because group "+a+" already exists"));this.groups_[a]=new Dd(this.anchors_,
a,b,c,g)}};db.prototype.clear=function(){this.groups_={};this.anchors_.clear()};db.prototype.find=function(a){if(a instanceof c){this.refresh_();var b=this.anchors_.findFirstByName_(a);if(0>b)return null;var g=this.anchors_.anchorsByName_[b].certificate;return a.isPrefixOf(g.getName())?g:null}this.refresh_();b=this.anchors_.findFirstByName_(a.getName());if(0>b)return null;for(;b<this.anchors_.anchorsByName_.length;++b){g=this.anchors_.anchorsByName_[b].certificate;if(!a.getName().isPrefixOf(g.getName()))break;
if(a.matchesData(g))return g}return null};db.prototype.getGroup=function(a){var b=this.groups_[a];if(void 0===b)throw new db.Error(Error("Trust anchor group "+a+" does not exist"));return b};db.prototype.size=function(){return this.anchors_.size()};db.AnchorContainer_=function(){this.anchorsByName_=[]};db.AnchorContainer_.prototype=new ee;db.AnchorContainer_.prototype.name="TrustAnchorContainerAnchorContainer";db.AnchorContainer_.prototype.add=function(a){a=new M(a);var b=a.getName(),c=this.findFirstByName_(b);
if(0>c)c=this.anchorsByName_.length;else if(this.anchorsByName_[c].name.equals(b)){this.anchorsByName_[c].certificate=a;return}this.anchorsByName_.splice(c,0,{name:b,certificate:a})};db.AnchorContainer_.prototype.remove=function(a){for(var b=0;b<this.anchorsByName_.length;++b)if(this.anchorsByName_[b].name.equals(a)){this.anchorsByName_.splice(b,1);break}};db.AnchorContainer_.prototype.clear=function(){this.anchorsByName_=[]};db.AnchorContainer_.prototype.size=function(){return this.anchorsByName_.length};
db.AnchorContainer_.prototype.findFirstByName_=function(a){for(var b=0;b<this.anchorsByName_.length;++b)if(0<=this.anchorsByName_[b].name.compare(a))return b;return-1};db.prototype.refresh_=function(){for(var a in this.groups_)this.groups_[a].refresh()};I=function(a,b){this.code_=a;this.info_=void 0!=b?b:""};q.ValidationError=I;I.NO_ERROR=0;I.INVALID_SIGNATURE=1;I.NO_SIGNATURE=2;I.CANNOT_RETRIEVE_CERTIFICATE=3;I.EXPIRED_CERTIFICATE=4;I.LOOP_DETECTED=5;I.MALFORMED_CERTIFICATE=6;I.EXCEEDED_DEPTH_LIMIT=
7;I.INVALID_KEY_LOCATOR=8;I.POLICY_ERROR=9;I.IMPLEMENTATION_ERROR=255;I.USER_MIN=256;I.prototype.getCode=function(){return this.code_};I.prototype.getInfo=function(){return this.info_};I.prototype.toString=function(){var a;a=this.code_===I.NO_ERROR?"No error":this.code_===I.INVALID_SIGNATURE?"Invalid signature":this.code_===I.NO_SIGNATURE?"Missing signature":this.code_===I.CANNOT_RETRIEVE_CERTIFICATE?"Cannot retrieve certificate":this.code_===I.EXPIRED_CERTIFICATE?"Certificate expired":this.code_===
I.LOOP_DETECTED?"Loop detected in certification chain":this.code_===I.MALFORMED_CERTIFICATE?"Malformed certificate":this.code_===I.EXCEEDED_DEPTH_LIMIT?"Exceeded validation depth limit":this.code_===I.INVALID_KEY_LOCATOR?"Key locator violates validation policy":this.code_===I.POLICY_ERROR?"Validation policy error":this.code_===I.IMPLEMENTATION_ERROR?"Internal implementation error":this.code_>=I.USER_MIN?"Custom error code "+this.code_:"Unrecognized error code "+this.code_;0<this.info_.length&&(a+=
" ("+this.info_+")");return a};var c=a.Name,Q=a.Data,U=a.KeyLocator,Ga=a.KeyLocatorType,s=a.WireFormat,I=a.ValidationError,M=a.CertificateV2,Pa=function(){this.innerPolicy_=this.validator_=null};q.ValidationPolicy=Pa;Pa.prototype.setInnerPolicy=function(a){if(null==a)throw Error("The innerPolicy argument cannot be null");null!=this.validator_&&a.setValidator(this.validator_);null==this.innerPolicy_?this.innerPolicy_=a:this.innerPolicy_.setInnerPolicy(a)};Pa.prototype.hasInnerPolicy=function(){return null!=
this.innerPolicy_};Pa.prototype.getInnerPolicy=function(){return this.innerPolicy_};Pa.prototype.setValidator=function(a){this.validator_=a;null!=this.innerPolicy_&&this.innerPolicy_.setValidator(a)};Pa.prototype.checkPolicy=function(a,b,c){throw Error("ValidationPolicy.checkPolicy is not implemented");};Pa.prototype.checkCertificatePolicy=function(a,b,c){this.checkPolicy(a,b,c)};Pa.getKeyLocatorName=function(a,b){if(a instanceof Q)return Pa.getKeyLocatorNameFromSignature_(a.getSignature(),b);if(2>
a.getName().size())return b.fail(new I(I.INVALID_KEY_LOCATOR,"Invalid signed Interest: name too short")),new c;var g;try{g=s.getDefaultWireFormat().decodeSignatureInfoAndValue(a.getName().get(-2).getValue().buf(),a.getName().get(-1).getValue().buf())}catch(f){return b.fail(new I(I.INVALID_KEY_LOCATOR,"Invalid signed Interest: "+f)),new c}return Pa.getKeyLocatorNameFromSignature_(g,b)};Pa.getKeyLocatorNameFromSignature_=function(a,b){if(!U.canGetFromSignature(a))return b.fail(new I(I.INVALID_KEY_LOCATOR,
"KeyLocator is missing")),new c;var g=U.getFromSignature(a);return g.getType()!=Ga.KEYNAME?(b.fail(new I(I.INVALID_KEY_LOCATOR,"KeyLocator type is not Name")),new c):g.getKeyName()};var Pa=a.ValidationPolicy,Ed=function(){Pa.call(this)};Ed.prototype=new Pa;Ed.prototype.name="ValidationPolicyAcceptAll";q.ValidationPolicyAcceptAll=Ed;Ed.prototype.checkPolicy=function(a,b,c){c(null,b)};var c=a.Name,Q=a.Data,ic=a.CommandInterestSigner,I=a.ValidationError,Pa=a.ValidationPolicy,Ob=function pa(a,b){Pa.call(this);
this.options_=void 0==b?new pa.Options:new pa.Options(b);this.container_=[];this.nowOffsetMilliseconds_=0;if(null==a)throw Error("inner policy is missing");this.setInnerPolicy(a);0>this.options_.gracePeriod_&&(this.options_.gracePeriod_=0)};Ob.prototype=new Pa;Ob.prototype.name="ValidationPolicyCommandInterest";q.ValidationPolicyCommandInterest=Ob;Ob.Options=function(a,b,c){a instanceof Ob.Options?(this.gracePeriod_=a.gracePeriod_,this.maxRecords_=a.maxRecords_,this.recordLifetime_=a.recordLifetime_):
(void 0==a&&(a=12E4),void 0==b&&(b=1E3),void 0==c&&(c=36E5),this.gracePeriod_=a,this.maxRecords_=b,this.recordLifetime_=c)};Ob.prototype.checkPolicy=function(a,b,c){if(a instanceof Q)this.getInnerPolicy().checkPolicy(a,b,c);else{var g=[null],f=[0];Ob.parseCommandInterest_(a,b,g,f)&&this.checkTimestamp_(b,g[0],f[0])&&this.getInnerPolicy().checkPolicy(a,b,c)}};Ob.prototype.setNowOffsetMilliseconds_=function(a){this.nowOffsetMilliseconds_=a};Ob.LastTimestampRecord=function(a,b,g){this.keyName_=new c(a);
this.timestamp_=b;this.lastRefreshed_=g};Ob.prototype.cleanUp_=function(){for(var a=(new Date).getTime()+this.nowOffsetMilliseconds_-this.options_.recordLifetime_;0<this.container_.length&&this.container_[0].lastRefreshed_<=a||0<=this.options_.maxRecords_&&this.container_.length>this.options_.maxRecords_;)this.container_.shift()};Ob.parseCommandInterest_=function(a,b,g,f){g[0]=new c;f[0]=0;var m=a.getName();if(m.size()<ic.MINIMUM_SIZE)return b.fail(new I(I.POLICY_ERROR,"Command interest name `"+a.getName().toUri()+
"` is too short")),!1;f[0]=m.get(ic.POS_TIMESTAMP).toNumber();g[0]=Pa.getKeyLocatorName(a,b);return b.isOutcomeFailed()?!1:!0};Ob.prototype.checkTimestamp_=function(a,b,c){this.cleanUp_();var g=(new Date).getTime()+this.nowOffsetMilliseconds_;if(c<g-this.options_.gracePeriod_||c>g+this.options_.gracePeriod_)return a.fail(new I(I.POLICY_ERROR,"Timestamp is outside the grace period for key "+b.toUri())),!1;g=this.findByKeyName_(b);if(0<=g&&c<=this.container_[g].timestamp_)return a.fail(new I(I.POLICY_ERROR,
"Timestamp is reordered for key "+b.toUri())),!1;var f=this;a.addSuccessCallback(function(a){f.insertNewRecord_(a,b,c)});return!0};Ob.prototype.insertNewRecord_=function(a,b,c){a=(new Date).getTime()+this.nowOffsetMilliseconds_;c=new Ob.LastTimestampRecord(b,c,a);b=this.findByKeyName_(b);0<=b&&this.container_.splice(b,1);this.container_.push(c)};Ob.prototype.findByKeyName_=function(a){for(var b=0;b<this.container_.length;++b)if(this.container_[b].keyName_.equals(a))return b;return-1};var ec=a.BoostInfoParser,
ud=a.CertificateRequest,ra=a.ValidatorConfigError,I=a.ValidationError,M=a.CertificateV2,Ac=a.ConfigRule,Q=a.Data,F=a.Interest,Pa=a.ValidationPolicy,bc=function(){Pa.call(this);this.isConfigured_=this.shouldBypass_=!1;this.dataRules_=[];this.interestRules_=[]};bc.prototype=new Pa;bc.prototype.name="ValidationPolicyConfig";q.ValidationPolicyConfig=bc;bc.prototype.load=function(a,b){if("string"===typeof a&&void 0==b){var c=new ec;c.read(a);this.load(c.getRoot(),a)}else if("string"===typeof a&&"string"===
typeof b)c=new ec,c.read(a,b),this.load(c.getRoot(),b);else{this.isConfigured_&&(this.shouldBypass_=!1,this.dataRules_=[],this.interestRules_=[],this.validator_.resetAnchors(),this.validator_.resetVerifiedCertificates());this.isConfigured_=!0;c=a.get("validator");if(1!=c.length)throw new ra(Error("ValidationPolicyConfig: Expected one validator section"));for(var g=c[0],f=g.get("rule"),c=0;c<f.length;++c){var m=Ac.create(f[c]);m.getIsForInterest()?this.interestRules_.push(m):this.dataRules_.push(m)}g=
g.get("trust-anchor");for(c=0;c<g.length;++c)this.processConfigTrustAnchor_(g[c],b)}};bc.prototype.checkPolicy=function(a,b,c){if(this.hasInnerPolicy())throw new ra(Error("ValidationPolicyConfig must be a terminal inner policy"));if(this.shouldBypass_)c(null,b);else{var g=Pa.getKeyLocatorName(a,b);if(!b.isOutcomeFailed())if(a instanceof Q){for(var f=0;f<this.dataRules_.length;++f){var m=this.dataRules_[f];if(m.match(!1,a.getName())){m.check(!1,a.getName(),g,b)&&c(new ud(new F(g)),b);return}}b.fail(new I(I.POLICY_ERROR,
"No rule matched for data `"+a.getName().toUri()+"`"))}else{for(f=0;f<this.interestRules_.length;++f)if(m=this.interestRules_[f],m.match(!0,a.getName())){m.check(!0,a.getName(),g,b)&&c(new ud(new F(g)),b);return}b.fail(new I(I.POLICY_ERROR,"No rule matched for interest `"+a.getName().toUri()+"`"))}}};bc.prototype.processConfigTrustAnchor_=function(a,b){var c=a.getFirstValue("type");if(null==c)throw new ra(Error("Expected <trust-anchor.type>"));if("file"==c.toLowerCase()){var g=a.getFirstValue("file-name");
if(null==g)throw new ra(Error("Expected <trust-anchor.file-name>"));c=bc.getRefreshPeriod_(a);this.validator_.loadAnchor(g,g,c,!1)}else if("base64"==c.toLowerCase()){c=a.getFirstValue("base64-string");if(null==c)throw new ra(Error("Expected <trust-anchor.base64-string>"));c=new f(c,"base64");g=new M;try{g.wireDecode(c)}catch(m){throw new ra(Error("Cannot decode certificate from base64-string: "+m));}this.validator_.loadAnchor("",g)}else if("dir"==c.toLowerCase()){g=a.getFirstValue("dir");if(null==
g)throw new ra(Error("Expected <trust-anchor.dir>"));c=bc.getRefreshPeriod_(a);this.validator_.loadAnchor(g,g,c,!0)}else if("any"==c.toLowerCase())this.shouldBypass_=!0;else throw new ra(Error("Unsupported trust-anchor.type"));};bc.getRefreshPeriod_=function(a){var b=a.getFirstValue("refresh");if(null==b)return 1E14;a=0;b=b.match(/(\d+)([hms])/);null!=b&&(a=parseInt(b[1]),"s"!=b[2]&&(a*=60,"m"!=b[2]&&(a*=60)));return 0==a?36E5:1E3*a};var F=a.Interest,ud=a.CertificateRequest,oa=a.PibKey,I=a.ValidationError,
Pa=a.ValidationPolicy,fe=function(a){Pa.call(this);this.pib_=a};fe.prototype=new Pa;fe.prototype.name="ValidationPolicyFromPib";q.ValidationPolicyFromPib=fe;fe.prototype.checkPolicy=function(a,b,c){a=Pa.getKeyLocatorName(a,b);b.isOutcomeFailed()||this.checkPolicyHelper_(a,b,c)};fe.prototype.checkPolicyHelper_=function(a,b,c){var g;try{g=this.pib_.getIdentity(oa.extractIdentityFromKeyName(a))}catch(f){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Cannot get the PIB identity for key "+a.toUri()+": "+
f));return}var m;try{m=g.getKey(a)}catch(n){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Cannot get the PIB key "+a.toUri()+": "+n));return}var p;try{p=m.getDefaultCertificate()}catch(s){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Cannot get the default certificate for key "+a.toUri()+": "+s));return}this.validator_.resetAnchors();this.validator_.loadAnchor("",p);c(new ud(new F(a)),b);this.validator_.resetAnchors()};var ud=a.CertificateRequest,I=a.ValidationError,F=a.Interest,Pa=a.ValidationPolicy,
ne=function(){Pa.call(this)};ne.prototype=new Pa;ne.prototype.name="ValidationPolicySimpleHierarchy";q.ValidationPolicySimpleHierarchy=ne;ne.prototype.checkPolicy=function(a,b,c){keyLocatorName=Pa.getKeyLocatorName(a,b);b.isOutcomeFailed()||(keyLocatorName.getPrefix(-2).isPrefixOf(a.getName())?c(new ud(new F(keyLocatorName)),b):b.fail(new I(I.INVALID_KEY_LOCATOR,"Signing policy violation for "+a.getName().toUri()+" by "+keyLocatorName.toUri())))};var b=a.SyncPromise,I=a.ValidationError,td=a.CertificateFetcherOffline,
Nb=a.CertificateStorage,fd=a.DataValidationState,Pc=a.InterestValidationState,Q=a.Data,g=a.Log.LOG,Db=function(a,b){Nb.call(this);void 0==b&&(b=new td);this.policy_=a;this.certificateFetcher_=b;this.maxDepth_=25;if(null==this.policy_)throw Error("The policy is null");if(null==this.certificateFetcher_)throw Error("The certificateFetcher is null");this.policy_.setValidator(this);this.certificateFetcher_.setCertificateStorage(this)};Db.prototype=new Nb;Db.prototype.name="Validator";q.Validator=Db;Db.prototype.getPolicy=
function(){return this.policy_};Db.prototype.getFetcher=function(){return this.certificateFetcher_};Db.prototype.setMaxDepth=function(a){this.maxDepth_=a};Db.prototype.getMaxDepth=function(){return this.maxDepth_};Db.prototype.validate=function(a,b,c){a instanceof Q?(b=new fd(a,b,c),3<g&&console.log("Start validating data "+a.getName().toUri())):(b=new Pc(a,b,c),3<g&&console.log("Start validating interest "+a.getName().toUri()));var f=this;this.policy_.checkPolicy(a,b,function(a,b){null==a?b.bypassValidation_():
f.requestCertificate_(a,b)})};Db.prototype.validateCertificate_=function(a,b){3<g&&console.log("Start validating certificate "+a.getName().toUri());if(a.isValid()){var c=this;this.policy_.checkCertificatePolicy(a,b,function(b,g){null==b?g.fail(new I(I.POLICY_ERROR,"Validation policy is not allowed to designate `"+a.getName().toUri()+"` as a trust anchor")):(g.addCertificate(a),c.requestCertificate_(b,g))})}else b.fail(new I(I.EXPIRED_CERTIFICATE,"Retrieved certificate is not yet valid or expired `"+
a.getName().toUri()+"`"))};Db.prototype.requestCertificate_=function(a,c){if(c.getDepth()>=this.maxDepth_)c.fail(new I(I.EXCEEDED_DEPTH_LIMIT,"Exceeded validation depth limit"));else if(c.hasSeenCertificateName(a.interest_.getName()))c.fail(new I(I.LOOP_DETECTED,"Validation loop detected for certificate `"+a.interest_.getName().toUri()+"`"));else{3<g&&console.log("Retrieving "+a.interest_.getName().toUri());var f=this,m=this.findTrustedCertificate(a.interest_);null!=m?(3<g&&console.log("Found trusted certificate "+
m.getName().toUri()),c.verifyCertificateChainPromise_(m).then(function(a){return null!=a?c.verifyOriginalPacketPromise_(a):b.resolve()}).then(function(){for(var a=0;a<c.certificateChain_.length;++a)f.cacheVerifiedCertificate(c.certificateChain_[a])})):this.certificateFetcher_.fetch(a,c,function(a,b){f.validateCertificate_(a,b)})}};var ea=Ib=$d=a,g=a.Log.LOG,c=a.Name,F=a.Interest,Q=a.Data,ya=a.ContentType,p=a.Blob,rd=a.ConfigFile,s=a.WireFormat,x=a.SecurityException,Vb=a.RsaKeyParams,we=a.BasicIdentityStorage,
Ia=a.IdentityCertificate,Za=a.Tpm,oe=a.TpmBackEndFile,Wb=a.TpmBackEndMemory,b=a.SyncPromise,O=a.NdnCommon,ia=a.IdentityManager,M=a.CertificateV2,Y=a.SigningInfo,Da=a.Sha256WithRsaSignature,Sa=a.Sha256WithEcdsaSignature,qb=a.DigestSha256Signature,jb=a.HmacWithSha256Signature,U=a.KeyLocator,Ga=a.KeyLocatorType,Aa=a.DigestAlgorithm,ba=a.KeyType,za=a.ValidityPeriod,Na=a.VerificationHelpers,Ba=a.PublicKey,$b=a.NoVerifyPolicyManager,C=function t(a,b,c){this.identityManager_=null;this.policyManager_=new $b;
this.tpm_=this.pib_=this.face_=null;if(void 0==a){if(!rd)throw new x(Error("KeyChain: The default KeyChain constructor is not supported in the browser"));Ib.existsSync(we.getDefaultDatabaseFilePath())&&!Ib.existsSync(ge.getDefaultDatabaseFilePath())?(a=new ia,b=new $b):b=a=""}if("string"===typeof a){void 0==c&&(c=!1);this.isSecurityV1_=!1;var g=[null],f=[null];t.parseAndCheckPibLocator_(a,g,f);this.pib_=t.createPib_(g[0]+":"+f[0]);this.tpm_=new Za("","",null);this.pib_.initializeTpm_=this.tpm_;this.pib_.initializePibLocator_=
a;this.pib_.initializeTpmLocator_=b;this.pib_.initializeAllowReset_=c;this.tpm_.initializePib_=this.pib_}else a instanceof $?(void 0==c&&(c=new $b),this.isSecurityV1_=!1,this.policyManager_=c,this.pib_=new la("","",a),this.tpm_=new Za("","",b)):(c=b,this.isSecurityV1_=!0,void 0==a&&(a=new ia),void 0==c&&(c=new $b),this.identityManager_=a,this.policyManager_=c)};q.KeyChain=C;C.Error=function(a){if(a)return a.__proto__=C.Error.prototype,a};C.Error.prototype=Error();C.Error.prototype.name="KeyChainError";
C.prototype.getPib=function(){if(this.isSecurityV1_)throw new x(Error("getPib is not supported for security v1"));return this.pib_};C.prototype.getTpm=function(){if(this.isSecurityV1_)throw new x(Error("getTpm is not supported for security v1"));return this.tpm_};C.prototype.getIsSecurityV1=function(){return this.isSecurityV1_};C.prototype.createIdentityV2Promise=function(a,c,f){f="boolean"===typeof c?c:f;c="boolean"!==typeof c&&c?c:void 0;void 0==c&&(c=C.getDefaultKeyParams());var m=this,n;return this.pib_.addIdentityPromise_(a,
f).then(function(a){n=a;return n.getDefaultKeyPromise(f).catch(function(a){return a instanceof la.Error?m.createKeyPromise(n,c,f):b.reject(a)})}).then(function(a){return a.getDefaultCertificatePromise(f).catch(function(c){return c instanceof la.Error?(2<g&&console.log("No default cert for "+a.getName()+", requesting self-signing"),m.selfSignPromise(a,f)):b.reject(c)})}).then(function(){return b.resolve(n)})};C.prototype.createIdentityV2=function(a,c,g,f){f="function"===typeof c?g:f;g="function"===
typeof c?c:g;return b.complete(g,f,this.createIdentityV2Promise(a,"function"!==typeof c&&c?c:void 0,!g))};C.prototype.deleteIdentityPromise=function(a,g){function f(a){return a>=p.length?b.resolve():m.tpm_.deleteKeyPromise_(p[a],g).then(function(){return f(a+1)})}var m=this;if(a instanceof c)return this.isSecurityV1_?b.reject(new C.Error(Error("deleteIdentityPromise is not supported for security v1. Use deleteIdentity."))):this.pib_.getIdentityPromise(a,g).then(function(a){return m.deleteIdentityPromise(a,
g)}).catch(function(a){return b.resolve()});var n=a.getName(),p=a.getKeys_().getKeyNames();return f(0).then(function(){return m.pib_.removeIdentityPromise_(n,g)})};C.prototype.deleteIdentity=function(a,g,f){if(a instanceof c&&this.isSecurityV1_)this.identityManager_.deleteIdentity(a,g,f);else return b.complete(g,f,this.deleteIdentityPromise(a,!g))};C.prototype.setDefaultIdentityPromise=function(a,b){return this.pib_.setDefaultIdentityPromise_(a.getName(),b)};C.prototype.setDefaultIdentity=function(a,
c,g){return b.complete(c,g,this.setDefaultIdentityPromise(a,!c))};C.prototype.createKeyPromise=function(a,c,f){f="boolean"===typeof c?c:f;c="boolean"!==typeof c&&c?c:void 0;void 0==c&&(c=C.getDefaultKeyParams());var m=this,n,p;return this.tpm_.createKeyPromise_(a.getName(),c,f).then(function(a){p=a;return m.tpm_.getPublicKeyPromise(p,f)}).then(function(b){return a.addKeyPromise_(b.buf(),p,f)}).then(function(a){n=a;2<g&&console.log("Requesting self-signing for newly created key "+n.getName().toUri());
return m.selfSignPromise(n,f)}).then(function(){return b.resolve(n)})};C.prototype.createKey=function(a,c,g,f){f="function"===typeof c?g:f;g="function"===typeof c?c:g;return b.complete(g,f,this.createKeyPromise(a,"function"!==typeof c&&c?c:void 0,!g))};C.prototype.deleteKeyPromise=function(a,c,g){var f=c.getName();if(!a.getName().equals(c.getIdentityName()))return b.reject(Error("Identity `"+a.getName().toUri()+"` does not match key `"+f.toUri()+"`"));var m=this;return a.removeKeyPromise_(f,g).then(function(){return m.tpm_.deleteKeyPromise_(f,
g)})};C.prototype.deleteKey=function(a,c,g,f){return b.complete(g,f,this.deleteKeyPromise(a,c,!g))};C.prototype.setDefaultKeyPromise=function(a,c,g){return a.getName().equals(c.getIdentityName())?a.setDefaultKeyPromise_(c.getName(),g):b.reject(Error("Identity `"+a.getName().toUri()+"` does not match key `"+c.getName().toUri()+"`"))};C.prototype.setDefaultKey=function(a,c,g,f){return b.complete(g,f,this.setDefaultKeyPromise(a,c,!g))};C.prototype.addCertificatePromise=function(a,c,g){return a.getName().equals(c.getKeyName())&&
c.getContent().equals(a.getPublicKey())?a.addCertificatePromise_(c,g):b.reject(Error("Key `"+a.getName().toUri()+"` does not match certificate `"+c.getKeyName().toUri()+"`"))};C.prototype.addCertificate=function(a,c,g,f){return b.complete(g,f,this.addCertificatePromise(a,c,!g))};C.prototype.deleteCertificatePromise=function(a,c,g){return M.isValidName(c)?a.removeCertificatePromise_(c,g):b.reject(Error("Wrong certificate name `"+c.toUri()+"`"))};C.prototype.deleteCertificate=function(a,c,g,f){return b.complete(g,
f,this.deleteCertificatePromise(a,c,!g))};C.prototype.setDefaultCertificatePromise=function(a,b,c){return this.addCertificatePromise(a,b,c).then(function(){return a.setDefaultCertificatePromise_(b.getName(),c)})};C.prototype.setDefaultCertificate=function(a,c,g,f){return b.complete(g,f,this.setDefaultCertificatePromise(a,c,!g))};C.prototype.signPromise=function(a,g,f,m){var n=g,p=f,q=m;g=n instanceof Y||n instanceof c?n:void 0;f=n instanceof s?n:p instanceof s?p:void 0;m="boolean"===typeof n?n:"boolean"===
typeof p?p:"boolean"===typeof q?q:!1;void 0==f&&(f=s.getDefaultWireFormat());var H=this;return b.resolve().then(function(){if(void 0==g){if(H.isSecurityV1_)return H.prepareDefaultCertificateNamePromise_(m).then(function(a){g=a;return b.resolve()});g=C.defaultSigningInfo_}return b.resolve()}).then(function(){if(g instanceof c){var n=g;if(H.isSecurityV1_)return a instanceof F?H.identityManager_.signInterestByCertificatePromise(a,n,f,m):a instanceof Q?H.identityManager_.signByCertificatePromise(a,n,
f,m):H.identityManager_.signByCertificatePromise(a,n,m);if(!(a instanceof F||a instanceof Q))return b.reject(new x(Error("sign(buffer, certificateName) is not supported for security v2. Use sign with SigningInfo.")));var Nc=new Y;Nc.setSigningCertificateName(n);return H.signPromise(a,Nc,f,m).catch(function(a){return b.reject(new x(Error("Error in sign: "+a)))})}var tb=g;if(a instanceof Q){var p=[null];return H.prepareSignatureInfoPromise_(tb,p,m).then(function(b){a.setSignature(b);b=a.wireEncode(f);
return H.signBufferPromise_(b.signedBuf(),p[0],tb.getDigestAlgorithm(),m)}).then(function(c){a.getSignature().setSignature(c);a.wireEncode(f);return b.resolve(a)})}if(a instanceof F){var s,p=[null];return H.prepareSignatureInfoPromise_(tb,p,m).then(function(b){s=b;a.getName().append(f.encodeSignatureInfo(s));a.getName().append(new c.Component);b=a.wireEncode(f);return H.signBufferPromise_(b.signedBuf(),p[0],tb.getDigestAlgorithm(),m)}).then(function(c){s.setSignature(c);a.setName(a.getName().getPrefix(-1).append(f.encodeSignatureValue(s)));
return b.resolve(a)})}p=[null];return H.prepareSignatureInfoPromise_(tb,p,m).then(function(b){return H.signBufferPromise_(a,p[0],tb.getDigestAlgorithm(),m)})})};C.prototype.sign=function(a,g,f,m,n){var p=g,q=f,H=m;g=p instanceof Y||p instanceof c?p:null;f=p instanceof s?p:q instanceof s?q:null;"function"===typeof p?(m=p,n=q):"function"===typeof q?(m=q,n=H):"function"===typeof H?m=H:n=m=null;return b.complete(m,n,this.signPromise(a,g,f,!m))};C.prototype.selfSignPromise=function(a,g,f){var m=g,n=f;
g=m instanceof s?m:void 0;f="boolean"===typeof m?m:"boolean"===typeof n?n:!1;void 0==g&&(g=s.getDefaultWireFormat());var p=new M,m=(new Date).getTime(),n=new c(a.getName());n.append("self").appendVersion(m);p.setName(n);p.getMetaInfo().setType(ya.KEY);p.getMetaInfo().setFreshnessPeriod(36E5);p.setContent(a.getPublicKey());signingInfo=new Y(a);signingInfo.setValidityPeriod(new za(m,m+63072E7));return this.signPromise(p,signingInfo,g,f).then(function(){return a.addCertificatePromise_(p,f).catch(function(a){return b.reject(new C.Error(Error("Error encoding certificate: "+
a)))})}).then(function(){return b.resolve(p)})};C.prototype.selfSign=function(a,c,g,f){"function"===typeof c&&(f=g,g=c,c=void 0);void 0==c&&(c=s.getDefaultWireFormat());return b.complete(g,f,this.selfSignPromise(a,c,!g))};C.prototype.importSafeBagPromise=function(a,c,g){"boolean"===typeof c&&(g=c,c=void 0);var f;try{f=new M(a.getCertificate())}catch(m){return b.reject(Error("Error reading CertificateV2: "+m))}var n=f.getIdentity(),s=f.getKeyName(),q=f.getPublicKey(),H=new p([1,2,3,4]),Nc,tb=this;
return b.resolve().then(function(){return tb.tpm_.hasKeyPromise(s,g)}).then(function(a){return a?b.reject(new C.Error(Error("Private key `"+s.toUri()+"` already exists"))):tb.pib_.getIdentityPromise(n,g).then(function(a){return a.getKeyPromise(s,g)}).then(function(){return b.reject(new C.Error(Error("Public key `"+s.toUri()+"` already exists")))},function(a){return b.resolve()})}).then(function(){return tb.tpm_.importPrivateKeyPromise_(s,a.getPrivateKeyBag().buf(),c,g).catch(function(a){return b.reject(new C.Error(Error("Failed to import private key `"+
s.toUri()+"`: "+a)))})}).then(function(){return tb.tpm_.signPromise(H.buf(),s,Aa.SHA256,g).then(function(a){Nc=a;return b.resolve()},function(a){return tb.tpm_.deleteKeyPromise_(s,g).then(function(){return b.reject(new C.Error(Error("Invalid private key `"+s.toUri()+"`")))})})}).then(function(){var a;try{a=new Ba(q)}catch(c){return tb.tpm_.deleteKeyPromise_(s,g).then(function(){return b.reject(new C.Error(Error("Error decoding public key "+c)))})}return Na.verifySignaturePromise(H,Nc,a,g)}).then(function(a){return a?
tb.pib_.addIdentityPromise_(n,g):tb.tpm_.deleteKeyPromise_(s,g).then(function(){return b.reject(new C.Error(Error("Certificate `"+f.getName().toUri()+"` and private key `"+s.toUri()+"` do not match")))})}).then(function(a){return a.addKeyPromise_(f.getPublicKey().buf(),s,g)}).then(function(a){return a.addCertificatePromise_(f,g)})};C.prototype.importSafeBag=function(a,c,g,f){f="function"===typeof c?g:f;g="function"===typeof c?c:g;return b.complete(g,f,this.importSafeBagPromise(a,"function"===typeof c?
null:c,!g))};C.registerPibBackend=function(a,b){C.getPibFactories_()[a]=b};C.registerTpmBackend=function(a,b){C.getTpmFactories_()[a]=b};C.prototype.createIdentityAndCertificate=function(a,b,c,g){g="function"===typeof b?c:g;c="function"===typeof b?b:c;b="function"!==typeof b&&b?b:C.getDefaultKeyParams();return this.identityManager_.createIdentityAndCertificate(a,b,c,g)};C.prototype.createIdentity=function(a,b){return Ia.certificateNameToPublicKeyName(this.createIdentityAndCertificate(a,b))};C.prototype.getDefaultIdentity=
function(a,c){return this.isSecurityV1_?this.identityManager_.getDefaultIdentity(a,c):b.complete(a,c,this.pib_.getDefaultIdentityPromise(!a).then(function(a){return b.resolve(a.getName())}))};C.prototype.getDefaultCertificateName=function(a,c){return this.isSecurityV1_?this.identityManager_.getDefaultCertificateName(a,c):b.complete(a,c,this.pib_.getDefaultIdentityPromise(!a).then(function(b){return b.getDefaultKeyPromise(!a)}).then(function(b){return b.getDefaultCertificatePromise(!a)}).then(function(a){return b.resolve(a.getName())}))};
C.prototype.generateRSAKeyPair=function(a,b,c){if(!this.isSecurityV1_)throw new x(Error("generateRSAKeyPair is not supported for security v2. Use createIdentityV2."));(c="boolean"===typeof b?b:c)||(c=2048);return this.identityManager_.generateRSAKeyPair(a,"boolean"===typeof b?b:!1,c)};C.prototype.setDefaultKeyForIdentity=function(a,c,g,f){return this.isSecurityV1_?this.identityManager_.setDefaultKeyForIdentity(a,c,g,f):b.complete(g,f,b.reject(new x(Error("setDefaultKeyForIdentity is not supported for security v2. Use getPib() methods."))))};
C.prototype.generateRSAKeyPairAsDefault=function(a,b,c){if(!this.isSecurityV1_)throw new x(Error("generateRSAKeyPairAsDefault is not supported for security v2. Use createIdentityV2."));return this.identityManager_.generateRSAKeyPairAsDefault(a,b,c)};C.prototype.createSigningRequest=function(a){return this.isSecurityV1_?this.identityManager_.getPublicKey(a).getKeyDer():b.complete(null,null,this.pib_.getIdentityPromise(oa.extractIdentityFromKeyName(a,!0)).then(function(b){return b.getKeyPromise(a,!0)}).then(function(a){return b.resolve(a.getPublicKey())}))};
C.prototype.installIdentityCertificate=function(a,c,g){if(!this.isSecurityV1_)return b.complete(c,g,b.reject(new x(Error("installIdentityCertificate is not supported for security v2. Use getPib() methods."))));this.identityManager_.addCertificate(a,c,g)};C.prototype.setDefaultCertificateForKey=function(a,c,g){if(!this.isSecurityV1_)return b.complete(c,g,b.reject(new x(Error("setDefaultCertificateForKey is not supported for security v2. Use getPib() methods."))));this.identityManager_.setDefaultCertificateForKey(a,
c,g)};C.prototype.getCertificate=function(a,c,g){return this.isSecurityV1_?this.identityManager_.getCertificate(a,c,g):b.complete(c,g,b.reject(new x(Error("getCertificate is not supported for security v2. Use getPib() methods."))))};C.prototype.getIdentityCertificate=function(a,c,g){return this.isSecurityV1_?this.identityManager_.getCertificate(a,c,g):b.complete(c,g,b.reject(new x(Error("getIdentityCertificate is not supported for security v2. Use getPib() methods."))))};C.prototype.revokeKey=function(a){};
C.prototype.revokeCertificate=function(a){};C.prototype.getIdentityManager=function(){if(!this.isSecurityV1_)throw new x(Error("getIdentityManager is not supported for security v2"));return this.identityManager_};C.prototype.getPolicyManager=function(){return this.policyManager_};C.prototype.signByIdentity=function(a,g,f,m,n){n="function"===typeof f?m:n;m="function"===typeof f?f:m;f="function"!==typeof f&&f?f:s.getDefaultWireFormat();if(!this.isSecurityV1_)return b.complete(m,n,b.reject(new x(Error("signByIdentity(buffer, identityName) is not supported for security v2. Use sign with SigningInfo."))));
var p=!m,q=this;null==g&&(g=new c);if(a instanceof Q){var H=b.resolve().then(function(){if(0==g.size()){var b=q.policyManager_.inferSigningIdentity(a.getName());return 0==b.size()?q.identityManager_.getDefaultCertificateNamePromise(p):q.identityManager_.getDefaultCertificateNameForIdentityPromise(b,p)}return q.identityManager_.getDefaultCertificateNameForIdentityPromise(g,p)}).then(function(b){if(0==b.size())throw new x(Error("No qualified certificate name found!"));if(!q.policyManager_.checkSigningPolicy(a.getName(),
b))throw new x(Error("Signing Cert name does not comply with signing policy"));return q.identityManager_.signByCertificatePromise(a,b,f,p)});return b.complete(m,n,H)}return b.complete(m,n,this.identityManager_.getDefaultCertificateNameForIdentityPromise(g,p).then(function(b){if(0==b.size())throw new x(Error("No qualified certificate name found!"));return q.identityManager_.signByCertificatePromise(a,b,f,p)}))};C.prototype.signWithSha256=function(a,b){if(this.isSecurityV1_)a instanceof F?this.identityManager_.signInterestWithSha256(a,
b):this.identityManager_.signWithSha256(a,b);else{var c=Y();c.setSha256Signing();this.sign(a,c,b)}};C.prototype.verifyData=function(a,b,c,g){null==g&&(g=0);if(this.policyManager_.requireVerify(a)){var f=this.policyManager_.checkVerificationPolicy(a,g,b,c);if(null!=f){var m=this;this.face_.expressInterest(f.interest,function(a,b){m.onCertificateData(a,b,f)},function(b){m.onCertificateInterestTimeout(b,f.retry,c,a,f)})}}else if(this.policyManager_.skipVerifyAndTrust(a))try{b(a)}catch(n){console.log("Error in onVerified: "+
O.getErrorWithStackTrace(n))}else try{c(a,"The packet has no verify rule but skipVerifyAndTrust is false")}catch(p){console.log("Error in onValidationFailed: "+O.getErrorWithStackTrace(p))}};C.prototype.verifyInterest=function(a,b,c,g,f){null==g&&(g=0);f=f||s.getDefaultWireFormat();if(this.policyManager_.requireVerify(a)){var m=this.policyManager_.checkVerificationPolicy(a,g,b,c,f);if(null!=m){var n=this;this.face_.expressInterest(m.interest,function(a,b){n.onCertificateData(a,b,m)},function(b){n.onCertificateInterestTimeout(b,
m.retry,c,a,m)})}}else if(this.policyManager_.skipVerifyAndTrust(a))try{b(a)}catch(p){console.log("Error in onVerified: "+O.getErrorWithStackTrace(p))}else try{c(a,"The packet has no verify rule but skipVerifyAndTrust is false")}catch(q){console.log("Error in onValidationFailed: "+O.getErrorWithStackTrace(q))}};C.prototype.setFace=function(a){this.face_=a};C.signWithHmacWithSha256=function(a,b,g,f){g instanceof s&&(f=g,g=void 0);f=f||s.getDefaultWireFormat();if(a instanceof Q)g=a.wireEncode(f),b=
ea.createHmac("sha256",b.buf()),b.update(g.signedBuf()),a.getSignature().setSignature(new p(b.digest(),!1));else if(a instanceof F){if(null==g)throw new x(Error("signWithHmacWithSha256: keyName is required to sign an Interest"));var m=new jb;m.getKeyLocator().setType(Ga.KEYNAME);m.getKeyLocator().setKeyName(g);a.getName().append(f.encodeSignatureInfo(m));a.getName().append(new c.Component);g=a.wireEncode(f);b=ea.createHmac("sha256",b.buf());b.update(g.signedBuf());m.setSignature(new p(b.digest(),
!1));a.setName(a.getName().getPrefix(-1).append(f.encodeSignatureValue(m)))}else throw new x(Error("signWithHmacWithSha256: Unrecognized target type"));};C.verifyDataWithHmacWithSha256=function(a,b,c){c=c||s.getDefaultWireFormat();c=a.wireEncode(c);b=ea.createHmac("sha256",b.buf());b.update(c.signedBuf());return(new p(b.digest(),!1)).equals(a.getSignature().getSignature())};C.verifyInterestWithHmacWithSha256=function(a,b,c){c=c||s.getDefaultWireFormat();var g=c.decodeSignatureInfoAndValue(a.getName().get(-2).getValue().buf(),
a.getName().get(-1).getValue().buf());a=a.wireEncode(c);b=ea.createHmac("sha256",b.buf());b.update(a.signedBuf());return(new p(b.digest(),!1)).equals(g.getSignature())};C.getDefaultKeyParams=function(){return C.defaultKeyParams_};C.DEFAULT_KEY_PARAMS=new Vb;C.getPibFactories_=function(){null==C.pibFactories_&&(C.pibFactories_={},ge&&(C.pibFactories_[ge.getScheme()]=function(a){return new ge(a)}),C.pibFactories_[ua.getScheme()]=function(a){return new ua});return C.pibFactories_};C.getTpmFactories_=
function(){null==C.tpmFactories_&&(C.tpmFactories_={},oe&&(C.tpmFactories_[oe.getScheme()]=function(a){return new oe(a)}),C.tpmFactories_[Wb.getScheme()]=function(a){return new Wb});return C.tpmFactories_};C.parseLocatorUri_=function(a,b,c){iColon=a.indexOf(":");0<=iColon?(b[0]=a.substring(0,iColon),c[0]=a.substring(iColon+1)):(b[0]=a,c[0]="")};C.parseAndCheckPibLocator_=function(a,b,c){C.parseLocatorUri_(a,b,c);""==b[0]&&(b[0]=C.getDefaultPibScheme_());if(void 0==C.getPibFactories_()[b[0]])throw new C.Error(Error("PIB scheme `"+
b[0]+"` is not supported"));};C.parseAndCheckTpmLocator_=function(a,b,c){C.parseLocatorUri_(a,b,c);""==b[0]&&(b[0]=C.getDefaultTpmScheme_());if(void 0==C.getTpmFactories_()[b[0]])throw new C.Error(Error("TPM scheme `"+b[0]+"` is not supported"));};C.getDefaultPibScheme_=function(){return ge.getScheme()};C.getDefaultTpmScheme_=function(){if("darwin"===process.platform)throw new C.Error(Error("TpmBackEndOsx is not implemented. You must use tpm-file."));return oe.getScheme()};C.createPib_=function(a){var b=
[null],c=[null];C.parseAndCheckPibLocator_(a,b,c);a=C.getPibFactories_()[b[0]];return new la(b[0],c[0],a(c[0]))};C.setUpTpm_=function(a,b){var c=[null],g=[null];C.parseAndCheckTpmLocator_(b,c,g);var f=C.getTpmFactories_()[c[0]];a.scheme_=c[0];a.location_=g[0];a.backEnd_=f(g[0])};C.getDefaultPibLocator_=function(a){if(null!=C.defaultPibLocator_)return C.defaultPibLocator_;var b=process.env.NDN_CLIENT_PIB;C.defaultPibLocator_=void 0!=b&&""!=b?b:a.get("pib",C.getDefaultPibScheme_()+":");return C.defaultPibLocator_};
C.getDefaultTpmLocator_=function(a){if(null!=C.defaultTpmLocator_)return C.defaultTpmLocator_;var b=process.env.NDN_CLIENT_TPM;C.defaultTpmLocator_=void 0!=b&&""!=b?b:a.get("tpm",C.getDefaultTpmScheme_()+":");return C.defaultTpmLocator_};C.prototype.prepareSignatureInfoPromise_=function(a,c,g){var f=null,m=null,n=this;return b.resolve().then(function(){if(a.getSignerType()==Y.SignerType.NULL)return n.pib_.getDefaultIdentityPromise(g).then(function(a){f=a;return b.resolve(null)},function(a){c[0]=Y.getDigestSha256Identity();
return b.resolve(new qb)});if(a.getSignerType()==Y.SignerType.ID)return f=a.getPibIdentity(),null==f?n.pib_.getIdentityPromise(a.getSignerName(),g).then(function(a){f=a;return b.resolve(null)},function(c){return b.reject(new Qc(Error("Signing identity `"+a.getSignerName().toUri()+"` does not exist")))}):b.resolve(null);if(a.getSignerType()==Y.SignerType.KEY)return m=a.getPibKey(),null==m?(p=oa.extractIdentityFromKeyName(a.getSignerName()),n.pib_.getIdentityPromise(p,g).then(function(c){return c.getKeyPromise(a.getSignerName(),
g).then(function(a){m=a;f=null;return b.resolve(null)})},function(c){return b.reject(new Qc(Error("Signing key `"+a.getSignerName().toUri()+"` does not exist")))})):b.resolve(null);if(a.getSignerType()==Y.SignerType.CERT){var p=M.extractIdentityFromCertName(a.getSignerName());return n.pib_.getIdentityPromise(p,g).then(function(c){f=c;return f.getKeyPromise(M.extractKeyNameFromCertName(a.getSignerName()),g).then(function(a){m=a;return b.resolve(null)})},function(c){return b.reject(new Qc(Error("Signing certificate `"+
a.getSignerName().toUri()+"` does not exist")))})}return a.getSignerType()==Y.SignerType.SHA256?(c[0]=Y.getDigestSha256Identity(),b.resolve(new qb)):b.reject(new Qc(Error("Unrecognized signer type")))}).then(function(n){return null!=n?b.resolve(n):null==f&&null==m?b.reject(new Qc(Error("Cannot determine signing parameters"))):b.resolve().then(function(){return null!=f&&null==m?f.getDefaultKeyPromise(g).then(function(a){m=a;return b.resolve(null)},function(a){return b.reject(new Qc(Error("Signing identity `"+
f.getName().toUri()+"` does not have default certificate")))}):b.resolve()}).then(function(){if(m.getKeyType()==ba.RSA&&a.getDigestAlgorithm()==Aa.SHA256)signatureInfo=new Da;else if(m.getKeyType()==ba.EC&&a.getDigestAlgorithm()==Aa.SHA256)signatureInfo=new Sa;else return b.reject(new C.Error(Error("Unsupported key type")));a.getValidityPeriod().hasPeriod()&&za.canGetFromSignature(signatureInfo)&&za.getFromSignature(signatureInfo).setPeriod(a.getValidityPeriod().getNotBefore(),a.getValidityPeriod().getNotAfter());
var g=U.getFromSignature(signatureInfo);g.setType(Ga.KEYNAME);g.setKeyName(m.getName());c[0]=m.getName();return b.resolve(signatureInfo)})})};C.prototype.signBufferPromise_=function(a,c,g,f){return c.equals(Y.getDigestSha256Identity())?(c=ea.createHash("sha256"),c.update(a),b.resolve(new p(c.digest(),!1))):this.tpm_.signPromise(a,c,g,f)};C.prototype.onCertificateData=function(a,b,c){this.verifyData(b,c.onVerified,c.onValidationFailed,c.stepCount)};C.prototype.onCertificateInterestTimeout=function(a,
b,c,g,f){if(0<b){var m=this;this.face_.expressInterest(a,function(a,b){m.onCertificateData(a,b,f)},function(a){m.onCertificateInterestTimeout(a,b-1,c,g,f)})}else try{c(g,"The retry count is zero after timeout for fetching "+a.getName().toUri())}catch(n){console.log("Error in onValidationFailed: "+O.getErrorWithStackTrace(n))}};C.prototype.prepareDefaultCertificateNamePromise_=function(a){var c,g=this;return this.identityManager_.getDefaultCertificatePromise(a).then(function(f){c=f;return null!=c?
b.resolve():g.setDefaultCertificatePromise_(a).then(function(){return g.identityManager_.getDefaultCertificatePromise(a)}).then(function(a){c=a;return b.resolve()})}).then(function(){return b.resolve(c.getName())})};C.prototype.setDefaultCertificatePromise_=function(a){var g=this;return this.identityManager_.getDefaultCertificatePromise(a).then(function(f){if(null!=f)return b.resolve();var m;return g.identityManager_.getDefaultIdentityPromise(a).then(function(a){m=a;return b.resolve()},function(a){randomComponent=
ea.randomBytes(4);m=(new c).append("tmp-identity").append(new p(randomComponent,!1));return b.resolve()}).then(function(){return g.identityManager_.createIdentityAndCertificatePromise(m,C.getDefaultKeyParams(),a)}).then(function(){return g.identityManager_.setDefaultIdentityPromise(m,a)})})};C.defaultPibLocator_=null;C.defaultTpmLocator_=null;C.pibFactories_=null;C.tpmFactories_=null;C.defaultSigningInfo_=new Y;C.defaultKeyParams_=new Vb;var Qc=function(a){C.Error.call(this,a)};Qc.prototype=new C.Error;
Qc.prototype.name="InvalidSigningInfoError";q.InvalidSigningInfoError=Qc;q.InvalidSigningInfoError=Qc;Zd=function(a){C.Error.call(this,a)};Zd.prototype=new C.Error;Zd.prototype.name="LocatorMismatchError";q.LocatorMismatchError=Zd;var la=a.Pib,$=a.PibImpl,oa=a.PibKey,ge=a.PibSqlite3,ua=a.PibMemory,ra=function B(a){if(a)return a.__proto__=B.prototype,a};ra.prototype=Error();ra.prototype.name="ValidatorConfigError";q.ValidatorConfigError=ra;var mc=a.CertificateFetcher,bc=a.ValidationPolicyConfig,Cd=
a.CertificateFetcherFromNetwork,Db=a.Validator,pe=function(a){a instanceof mc?Db.call(this,new bc,a):Db.call(this,new bc,new Cd(a));this.policyConfig_=this.getPolicy()};pe.prototype=new Db(new bc,new Cd(null));pe.prototype.name="ValidatorConfig";q.ValidatorConfig=pe;pe.prototype.load=function(a,b){this.policyConfig_.load(a,b)};var Ed=a.ValidationPolicyAcceptAll,td=a.CertificateFetcherOffline,Db=a.Validator,ye=function(){Db.call(this,new Ed,new td)};ye.prototype=new Db(new Ed);ye.prototype.name="ValidatorNull";
q.ValidatorNull=ye;var c=a.Name,L=a.DataUtils,p=a.Blob,Ra=function De(a){this.values=[];if("object"===typeof a&&a instanceof De)this.values=a.values.slice(0);else if(a)for(var b=this.changeCount=0;b<a.length;++b)a[b]==De.ANY?this.appendAny():this.appendComponent(a[b]);this.changeCount=0};q.Exclude=Ra;Ra.ANY="*";Ra.prototype.size=function(){return this.values.length};Ra.prototype.get=function(a){return this.values[a]};Ra.prototype.appendAny=function(){this.values.push(Ra.ANY);++this.changeCount;return this};
Ra.prototype.appendComponent=function(a){this.values.push(new c.Component(a));++this.changeCount;return this};Ra.prototype.clear=function(){++this.changeCount;this.values=[]};Ra.prototype.toUri=function(){if(null==this.values||0==this.values.length)return"";for(var a="",b=0;b<this.values.length;++b)0<b&&(a+=","),a=this.values[b]==Ra.ANY?a+"*":a+this.values[b].toEscapedString();return a};Ra.prototype.matches=function(a){"object"==typeof a&&a instanceof c.Component||(a=new c.Component(a));for(var b=
0;b<this.values.length;++b)if(this.values[b]==Ra.ANY){var g=null;0<b&&(g=this.values[b-1]);var f,m=null;for(f=b+1;f<this.values.length;++f)if(this.values[f]!=Ra.ANY){m=this.values[f];break}if(null!=m){if(null!=g){if(0<a.compare(g)&&0>a.compare(m))return!0}else if(0>a.compare(m))return!0;b=f-1}else if(null!=g){if(0<a.compare(g))return!0}else return!0}else if(a.equals(this.values[b]))return!0;return!1};Ra.compareComponents=function(a,b){"object"==typeof a&&a instanceof c.Component&&(a=a.getValue().buf());
"object"==typeof b&&b instanceof c.Component&&(b=b.getValue().buf());return c.Component.compareBuffers(a,b)};Ra.prototype.getChangeCount=function(){return this.changeCount};var ea=a,p=a.Blob,Wa=a.SignedBlob,ma=a.ChangeCounter,c=a.Name,Ra=a.Exclude,wb=a.Link,U=a.KeyLocator,$a=a.DelegationSet,wc=a.IncomingFaceId,s=a.WireFormat,F=function Lb(a,b,g,f,m,n,tb,s,q,H){if(null!=f)throw Error("Interest constructor: PublisherPublicKeyDigest support has been removed.");if(null!=tb)throw Error("Interest constructor: answerOriginKind support has been removed. Use setMustBeFresh().");
if(null!=s)throw Error("Interest constructor: scope support has been removed.");if(null!=H)throw Error("Interest constructor: nonce support in the constructor has been removed.");null!=b&&console.log("Interest constructor: The minSuffixComponents param is deprecated. Use setMinSuffixComponents().");null!=g&&console.log("Interest constructor: The maxSuffixComponents param is deprecated. Use setMaxSuffixComponents().");null!=m&&console.log("Interest constructor: The exclude param is deprecated. Use setExclude().");
null!=n&&console.log("Interest constructor: The childSelector param is deprecated. Use setChildSelector().");null!=q&&console.log("Interest constructor: The interestLifetimeMilliseconds param is deprecated. Use setInterestLifetimeMilliseconds().");"object"===typeof a&&a instanceof Lb?(this.name_=new ma(new c(a.getName())),this.maxSuffixComponents_=a.maxSuffixComponents_,this.minSuffixComponents_=a.minSuffixComponents_,this.keyLocator_=new ma(new U(a.getKeyLocator())),this.exclude_=new ma(new Ra(a.getExclude())),
this.childSelector_=a.childSelector_,this.mustBeFresh_=a.mustBeFresh_,this.interestLifetimeMilliseconds_=a.interestLifetimeMilliseconds_,this.forwardingHint_=new ma(new $a(a.getForwardingHint())),this.nonce_=a.nonce_,this.linkWireEncoding_=a.linkWireEncoding_,this.linkWireEncodingFormat_=a.linkWireEncodingFormat_,this.link_=new ma(null),null!=a.link_.get()&&this.link_.set(new wb(a.link_.get())),this.selectedDelegationIndex_=a.selectedDelegationIndex_,this.defaultWireEncoding_=a.getDefaultWireEncoding(),
this.defaultWireEncodingFormat_=a.defaultWireEncodingFormat_):(this.name_=new ma(new c(a)),this.maxSuffixComponents_=g,this.minSuffixComponents_=b,this.keyLocator_=new ma(new U),this.exclude_=new ma("object"===typeof m&&m instanceof Ra?new Ra(m):new Ra),this.childSelector_=n,this.mustBeFresh_=!0,this.interestLifetimeMilliseconds_=q,this.forwardingHint_=new ma(new $a),this.nonce_=new p,this.linkWireEncoding_=new p,this.linkWireEncodingFormat_=null,this.link_=new ma(null),this.selectedDelegationIndex_=
null,this.defaultWireEncoding_=new Wa,this.defaultWireEncodingFormat_=null);this.changeCount_=this.getDefaultWireEncodingChangeCount_=this.getNonceChangeCount_=0;this.lpPacket_=null};q.Interest=F;F.RECURSIVE_POSTFIX="*";F.CHILD_SELECTOR_LEFT=0;F.CHILD_SELECTOR_RIGHT=1;F.prototype.matchesName=function(a){return!this.getName().match(a)||null!=this.minSuffixComponents_&&!(a.size()+1-this.getName().size()>=this.minSuffixComponents_)||null!=this.maxSuffixComponents_&&!(a.size()+1-this.getName().size()<=
this.maxSuffixComponents_)||null!=this.getExclude()&&a.size()>this.getName().size()&&this.getExclude().matches(a.get(this.getName().size()))?!1:!0};F.prototype.matches_name=function(a){return this.matchesName(a)};F.prototype.matchesData=function(a,b){b=b||s.getDefaultWireFormat();var c=this.getName().size(),g=a.getName(),f=g.size()+1,m=null!=this.getMinSuffixComponents()?this.getMinSuffixComponents():0;if(!(c+m<=f&&(null==this.getMaxSuffixComponents()||c+this.getMaxSuffixComponents()>=f)))return!1;
if(c===f)if(this.getName().get(-1).isImplicitSha256Digest()){if(!this.getName().equals(a.getFullName(b)))return!1}else return!1;else if(!this.getName().isPrefixOf(g))return!1;if(0<this.getExclude().size()&&f>c)if(c==f-1){if(this.getExclude().matches(a.getFullName(b).get(c)))return!1}else if(this.getExclude().matches(g.get(c)))return!1;c=this.getKeyLocator();return!c.getType()||(g=a.getSignature(),U.canGetFromSignature(g)&&c.equals(U.getFromSignature(g)))?!0:!1};F.prototype.clone=function(){return new F(this)};
F.prototype.getName=function(){return this.name_.get()};F.prototype.getMinSuffixComponents=function(){return this.minSuffixComponents_};F.prototype.getMaxSuffixComponents=function(){return this.maxSuffixComponents_};F.prototype.getCanBePrefix=function(){return 1!=this.maxSuffixComponents_};F.prototype.getKeyLocator=function(){return this.keyLocator_.get()};F.prototype.getExclude=function(){return this.exclude_.get()};F.prototype.getChildSelector=function(){return this.childSelector_};F.prototype.getMustBeFresh=
function(){return this.mustBeFresh_};F.prototype.getNonce=function(){this.getNonceChangeCount_!=this.getChangeCount()&&(this.nonce_=new p,this.getNonceChangeCount_=this.getChangeCount());return this.nonce_};F.prototype.getForwardingHint=function(){return this.forwardingHint_.get()};F.prototype.getNonceAsBuffer=function(){return this.getNonce().buf()};F.prototype.hasLink=function(){return null!=this.link_.get()||!this.linkWireEncoding_.isNull()};F.prototype.getLink=function(){if(null!=this.link_.get())return this.link_.get();
if(this.linkWireEncoding_.isNull())return null;var a=new wb;a.wireDecode(this.linkWireEncoding_,this.linkWireEncodingFormat_);this.link_.set(a);this.linkWireEncoding_=new p;this.linkWireEncodingFormat_=null;return a};F.prototype.getLinkWireEncoding=function(a){a=a||s.getDefaultWireFormat();if(!this.linkWireEncoding_.isNull()&&this.linkWireEncodingFormat_==a)return this.linkWireEncoding_;var b=this.getLink();return null!=b?b.wireEncode(a):new p};F.prototype.getSelectedDelegationIndex=function(){return this.selectedDelegationIndex_};
F.prototype.getInterestLifetimeMilliseconds=function(){return this.interestLifetimeMilliseconds_};F.prototype.getDefaultWireEncoding=function(){this.getDefaultWireEncodingChangeCount_!=this.getChangeCount()&&(this.defaultWireEncoding_=new Wa,this.defaultWireEncodingFormat_=null,this.getDefaultWireEncodingChangeCount_=this.getChangeCount());return this.defaultWireEncoding_};F.prototype.getDefaultWireEncodingFormat=function(){return this.defaultWireEncodingFormat_};F.prototype.getIncomingFaceId=function(){var a=
null===this.lpPacket_?null:wc.getFirstHeader(this.lpPacket_);return null===a?null:a.getFaceId()};F.prototype.setName=function(a){this.name_.set("object"===typeof a&&a instanceof c?new c(a):new c);++this.changeCount_;return this};F.prototype.setMinSuffixComponents=function(a){this.minSuffixComponents_=a;++this.changeCount_;return this};F.prototype.setMaxSuffixComponents=function(a){this.maxSuffixComponents_=a;++this.changeCount_;return this};F.prototype.setCanBePrefix=function(a){this.maxSuffixComponents_=
a?null:1;++this.changeCount_;return this};F.prototype.setKeyLocator=function(a){this.keyLocator_.set("object"===typeof a&&a instanceof U?new U(a):new U);++this.changeCount_;return this};F.prototype.setExclude=function(a){this.exclude_.set("object"===typeof a&&a instanceof Ra?new Ra(a):new Ra);++this.changeCount_;return this};F.prototype.setForwardingHint=function(a){this.forwardingHint_.set("object"===typeof a&&a instanceof $a?new $a(a):new $a);++this.changeCount_;return this};F.prototype.setLinkWireEncoding=
function(a,b){b=b||s.getDefaultWireFormat();this.linkWireEncoding_=a;this.linkWireEncodingFormat_=b;this.link_.set(null);++this.changeCount_;return this};F.prototype.unsetLink=function(){return this.setLinkWireEncoding(new p,null)};F.prototype.setSelectedDelegationIndex=function(a){this.selectedDelegationIndex_=a;++this.changeCount_;return this};F.prototype.setChildSelector=function(a){this.childSelector_=a;++this.changeCount_;return this};F.prototype.setMustBeFresh=function(a){this.mustBeFresh_=
a?!0:!1;++this.changeCount_;return this};F.prototype.setInterestLifetimeMilliseconds=function(a){this.interestLifetimeMilliseconds_=a;++this.changeCount_;return this};F.prototype.setNonce=function(a){this.nonce_="object"===typeof a&&a instanceof p?a:new p(a,!0);++this.changeCount_;this.getNonceChangeCount_=this.getChangeCount();return this};F.prototype.toUri=function(){var a="";null!=this.minSuffixComponents_&&(a+="&ndn.MinSuffixComponents="+this.minSuffixComponents_);null!=this.maxSuffixComponents_&&
(a+="&ndn.MaxSuffixComponents="+this.maxSuffixComponents_);null!=this.childSelector_&&(a+="&ndn.ChildSelector="+this.childSelector_);a+="&ndn.MustBeFresh="+(this.mustBeFresh_?1:0);null!=this.interestLifetimeMilliseconds_&&(a+="&ndn.InterestLifetime="+this.interestLifetimeMilliseconds_);0<this.getNonce().size()&&(a+="&ndn.Nonce="+c.toEscapedString(this.getNonce().buf()));null!=this.getExclude()&&0<this.getExclude().size()&&(a+="&ndn.Exclude="+this.getExclude().toUri());var b=this.getName().toUri();
""!=a&&(b+="?"+a.substr(1));return b};F.prototype.wireEncode=function(a){a=a||s.getDefaultWireFormat();if(!this.getDefaultWireEncoding().isNull()&&this.getDefaultWireEncodingFormat()==a)return this.getDefaultWireEncoding();var b=a.encodeInterest(this),b=new Wa(b.encoding,b.signedPortionBeginOffset,b.signedPortionEndOffset);a==s.getDefaultWireFormat()&&this.setDefaultWireEncoding(b,s.getDefaultWireFormat());return b};F.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();var c;c="object"===
typeof a&&a instanceof p?b.decodeInterest(this,a.buf(),!1):b.decodeInterest(this,a,!0);b==s.getDefaultWireFormat()?this.setDefaultWireEncoding(new Wa(new p(a,!0),c.signedPortionBeginOffset,c.signedPortionEndOffset),s.getDefaultWireFormat()):this.setDefaultWireEncoding(new Wa,null)};F.prototype.refreshNonce=function(){var a=this.getNonce();if(0!==a.size()){for(var b;b=new p(ea.randomBytes(a.size()),!1),b.equals(a););this.nonce_=b;++this.changeCount_;this.getNonceChangeCount_=this.getChangeCount()}};
F.prototype.setLpPacket=function(a){this.lpPacket_=a;return this};F.prototype.getChangeCount=function(){var a=this.name_.checkChanged(),a=this.keyLocator_.checkChanged()||a,a=this.exclude_.checkChanged()||a;(a=this.forwardingHint_.checkChanged()||a)&&++this.changeCount_;return this.changeCount_};F.prototype.setDefaultWireEncoding=function(a,b){this.defaultWireEncoding_=a;this.defaultWireEncodingFormat_=b;this.getDefaultWireEncodingChangeCount_=this.getChangeCount()};Object.defineProperty(F.prototype,
"name",{get:function(){return this.getName()},set:function(a){this.setName(a)}});Object.defineProperty(F.prototype,"minSuffixComponents",{get:function(){return this.getMinSuffixComponents()},set:function(a){this.setMinSuffixComponents(a)}});Object.defineProperty(F.prototype,"maxSuffixComponents",{get:function(){return this.getMaxSuffixComponents()},set:function(a){this.setMaxSuffixComponents(a)}});Object.defineProperty(F.prototype,"keyLocator",{get:function(){return this.getKeyLocator()},set:function(a){this.setKeyLocator(a)}});
Object.defineProperty(F.prototype,"exclude",{get:function(){return this.getExclude()},set:function(a){this.setExclude(a)}});Object.defineProperty(F.prototype,"childSelector",{get:function(){return this.getChildSelector()},set:function(a){this.setChildSelector(a)}});Object.defineProperty(F.prototype,"interestLifetime",{get:function(){return this.getInterestLifetimeMilliseconds()},set:function(a){this.setInterestLifetimeMilliseconds(a)}});Object.defineProperty(F.prototype,"nonce",{get:function(){return this.getNonceAsBuffer()},
set:function(a){this.setNonce(a)}});Fa=function Re(a){"object"===typeof a&&a instanceof Re?(this.childInherit=a.childInherit,this.capture=a.capture):(this.childInherit=!0,this.capture=!1)};q.ForwardingFlags=Fa;Fa.NfdForwardingFlags_CHILD_INHERIT=1;Fa.NfdForwardingFlags_CAPTURE=2;Fa.prototype.getNfdForwardingFlags=function(){var a=0;this.childInherit&&(a|=Fa.NfdForwardingFlags_CHILD_INHERIT);this.capture&&(a|=Fa.NfdForwardingFlags_CAPTURE);return a};Fa.prototype.setNfdForwardingFlags=function(a){this.childInherit=
0!=(a&Fa.NfdForwardingFlags_CHILD_INHERIT);this.capture=0!=(a&Fa.NfdForwardingFlags_CAPTURE)};Fa.prototype.getChildInherit=function(){return this.childInherit};Fa.prototype.getCapture=function(){return this.capture};Fa.prototype.setChildInherit=function(a){this.childInherit=a};Fa.prototype.setCapture=function(a){this.capture=a};var Fa=a.ForwardingFlags,c=a.Name,s=a.WireFormat,p=a.Blob,Qa=function Se(a){"object"===typeof a&&a instanceof Se?(this.name=null==a.name?null:new c(a.name),this.faceId=a.faceId,
this.uri=a.uri,this.localControlFeature=a.localControlFeature,this.origin=a.origin,this.cost=a.cost,this.forwardingFlags=new Fa(a.forwardingFlags),this.strategy=new c(a.strategy),this.expirationPeriod=a.expirationPeriod):(this.faceId=this.name=null,this.uri="",this.cost=this.origin=this.localControlFeature=null,this.forwardingFlags=new Fa,this.strategy=new c,this.expirationPeriod=null)};q.ControlParameters=Qa;Qa.prototype.clear=function(){this.faceId=this.name=null;this.uri="";this.cost=this.origin=
this.localControlFeature=null;this.forwardingFlags=new Fa;this.strategy=new c;this.expirationPeriod=null};Qa.prototype.wireEncode=function(a){a=a||s.getDefaultWireFormat();return a.encodeControlParameters(this)};Qa.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();"object"===typeof a&&a instanceof p?b.decodeControlParameters(this,a.buf(),!1):b.decodeControlParameters(this,a,!0)};Qa.prototype.getName=function(){return this.name};Qa.prototype.getFaceId=function(){return this.faceId};
Qa.prototype.getUri=function(){return this.uri};Qa.prototype.getLocalControlFeature=function(){return this.localControlFeature};Qa.prototype.getOrigin=function(){return this.origin};Qa.prototype.getCost=function(){return this.cost};Qa.prototype.getForwardingFlags=function(){return this.forwardingFlags};Qa.prototype.getStrategy=function(){return this.strategy};Qa.prototype.getExpirationPeriod=function(){return this.expirationPeriod};Qa.prototype.setName=function(a){this.name="object"===typeof a&&a instanceof
c?new c(a):null};Qa.prototype.setFaceId=function(a){this.faceId=a};Qa.prototype.setUri=function(a){this.uri=a||""};Qa.prototype.setLocalControlFeature=function(a){this.localControlFeature=a};Qa.prototype.setOrigin=function(a){this.origin=a};Qa.prototype.setCost=function(a){this.cost=a};Qa.prototype.setForwardingFlags=function(a){this.forwardingFlags="object"===typeof a&&a instanceof Fa?new Fa(a):new Fa};Qa.prototype.setStrategy=function(a){this.strategy="object"===typeof a&&a instanceof c?new c(a):
new c};Qa.prototype.setExpirationPeriod=function(a){this.expirationPeriod=a};var Qa=a.ControlParameters,s=a.WireFormat,p=a.Blob,nc=function Te(a){"object"===typeof a&&a instanceof Te?(this.statusCode_=a.statusCode_,this.statusText_=a.statusText_,this.bodyAsControlParameters_=null==a.bodyAsControlParameters_?null:new Qa(a.bodyAsControlParameters_)):(this.statusCode_=null,this.statusText_="",this.bodyAsControlParameters_=null)};q.ControlResponse=nc;nc.prototype.clear=function(){this.statusCode_=null;
this.statusText_="";this.bodyAsControlParameters_=null};nc.prototype.wireEncode=function(a){a=a||s.getDefaultWireFormat();return a.encodeControlResponse(this)};nc.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();"object"===typeof a&&a instanceof p?b.decodeControlResponse(this,a.buf(),!1):b.decodeControlResponse(this,a,!0)};nc.prototype.getStatusCode=function(){return this.statusCode_};nc.prototype.getStatusText=function(){return this.statusText_};nc.prototype.getBodyAsControlParameters=
function(){return this.bodyAsControlParameters_};nc.prototype.setStatusCode=function(a){this.statusCode_=a;return this};nc.prototype.setStatusText=function(a){this.statusText_=a||"";return this};nc.prototype.setBodyAsControlParameters=function(a){this.bodyAsControlParameters_="object"===typeof a&&a instanceof Qa?new Qa(a):null;return this};c=a.Name;Ua=a.NdnRegexTopMatcher;uc=function Ce(a,b){"object"===typeof a&&a instanceof Ce?(this.prefix=new c(a.prefix),this.regexFilter=a.regexFilter,this.regexFilterPattern=
a.regexFilterPattern):(this.prefix=new c(a),b?(this.regexFilter=b,this.regexFilterPattern=Ce.makePattern(b)):this.regexFilterPattern=this.regexFilter=null)};q.InterestFilter=uc;uc.prototype.doesMatch=function(a){return a.size()<this.prefix.size()?!1:this.hasRegexFilter()?this.prefix.match(a)?(new Ua(this.regexFilterPattern)).match(a.getSubName(this.prefix.size())):!1:this.prefix.match(a)};uc.prototype.getPrefix=function(){return this.prefix};uc.prototype.hasRegexFilter=function(){return null!=this.regexFilter};
uc.prototype.getRegexFilter=function(){return this.regexFilter};uc.makePattern=function(a){1<=a.length&&"^"==a[0]||(a="^"+a);1<=a.length&&"$"==a[-1]||(a+="$");return a};c=a.Name;p=a.Blob;s=a.WireFormat;$a=function Ye(a){this.delegations_="object"===typeof a&&a instanceof Ye?a.delegations_.slice(0):[];this.changeCount_=0};q.DelegationSet=$a;$a.Delegation=function(a,b){this.preference_=a;this.name_=new c(b)};$a.Delegation.prototype.getPreference=function(){return this.preference_};$a.Delegation.prototype.getName=
function(){return this.name_};$a.Delegation.prototype.compare=function(a){return this.preference_<a.preference_?-1:this.preference_>a.preference_?1:this.name_.compare(a.name_)};$a.prototype.add=function(a,b){this.remove(b);for(var c=new $a.Delegation(a,b),g=0;g<this.delegations_.length&&!(0<=this.delegations_[g].compare(c));)++g;this.delegations_.splice(g,0,c);++this.changeCount_};$a.prototype.addUnsorted=function(a,b){this.delegations_.push(new $a.Delegation(a,b));++this.changeCount_};$a.prototype.remove=
function(a){for(var b=!1,c=this.delegations_.length-1;0<=c;--c)this.delegations_[c].getName().equals(a)&&(b=!0,this.delegations_.splice(c,1));b&&++this.changeCount_;return b};$a.prototype.clear=function(){this.delegations_=[];++this.changeCount_};$a.prototype.size=function(){return this.delegations_.length};$a.prototype.get=function(a){return this.delegations_[a]};$a.prototype.find=function(a){for(var b=0;b<this.delegations_.length;++b)if(this.delegations_[b].getName().equals(a))return b;return-1};
$a.prototype.wireEncode=function(a){a=a||s.getDefaultWireFormat();return a.encodeDelegationSet(this)};$a.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();"object"===typeof a&&a instanceof p?b.decodeDelegationSet(this,a.buf(),!1):b.decodeDelegationSet(this,a,!0)};$a.prototype.getChangeCount=function(){return this.changeCount_};$a=a.DelegationSet;ya=a.ContentType;s=a.WireFormat;Q=a.Data;wb=function(a){this.delegations_=new $a;if(a instanceof Q){if(Q.call(this,a),!this.getContent().isNull())try{this.delegations_.wireDecode(this.getContent()),
this.getMetaInfo().setType(ya.LINK)}catch(b){this.delegations_.clear()}}else void 0!=a?Q.call(this,a):Q.call(this),this.getMetaInfo().setType(ya.LINK)};wb.prototype=new Q;wb.prototype.name="Link";q.Link=wb;wb.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();Q.prototype.wireDecode.call(this,a,b);if(this.getMetaInfo().getType()!=ya.LINK)throw Error("Link.wireDecode: MetaInfo ContentType is not LINK.");this.delegations_.wireDecode(this.getContent())};wb.prototype.addDelegation=function(a,
b,c){c=c||s.getDefaultWireFormat();this.delegations_.add(a,b);this.encodeContent(c);return this};wb.prototype.removeDelegation=function(a,b){b=b||s.getDefaultWireFormat();var c=this.delegations_.remove(a);c&&this.encodeContent(b);return c};wb.prototype.getDelegations=function(){return this.delegations_};wb.prototype.encodeContent=function(a){this.setContent(this.delegations_.wireEncode(a));this.getMetaInfo().setType(ya.LINK)};var hb=function Nc(){this.reason_=Nc.Reason.NONE;this.otherReasonCode_=
-1};q.NetworkNack=hb;hb.Reason={NONE:0,CONGESTION:50,DUPLICATE:100,NO_ROUTE:150,OTHER_CODE:32767};hb.prototype.getReason=function(){return this.reason_};hb.prototype.getOtherReasonCode=function(){return this.otherReasonCode_};hb.prototype.setReason=function(a){this.reason_=a};hb.prototype.setOtherReasonCode=function(a){if(0>a)throw Error("NetworkNack other reason code must be non-negative");this.otherReasonCode_=a};hb.getFirstHeader=function(a){for(var b=0;b<a.countHeaderFields();++b){var c=a.getHeaderField(b);
if(c instanceof hb)return c}return null};var ea=a,p=a.Blob,c=a.Name,cb=a.ComponentType,Fa=a.ForwardingFlags,n=a.Tlv,ta=a.TlvEncoder,na=a.TlvDecoder,s=a.WireFormat,Ra=a.Exclude,ya=a.ContentType,Ga=a.KeyLocatorType,Da=a.Sha256WithRsaSignature,Sa=a.Sha256WithEcdsaSignature,Ub=a.GenericSignature,jb=a.HmacWithSha256Signature,qb=a.DigestSha256Signature,Qa=a.ControlParameters,Fa=a.ForwardingFlags,hb=a.NetworkNack,fa=a.Schedule,wc=a.IncomingFaceId,$c=a.CongestionMark,R=a.DecodingException,G=function(){s.call(this)};
G.prototype=new s;G.prototype.name="Tlv0_2WireFormat";q.Tlv0_2WireFormat=G;G.instance=null;G.prototype.encodeName=function(a){var b=new ta;G.encodeName(a,b);return new p(b.getOutput(),!1)};G.prototype.decodeName=function(a,b,c){null==c&&(c=!0);b=new na(b);G.decodeName(a,b,c)};G.prototype.encodeInterest=function(a){var b=new ta(256),c=b.getLength();if(0<a.getForwardingHint().size()){if(null!=a.getSelectedDelegationIndex())throw Error("An Interest may not have a selected delegation when encoding a forwarding hint");
if(a.hasLink())throw Error("An Interest may not have a link object when encoding a forwarding hint");var g=b.getLength();G.encodeDelegationSet_(a.getForwardingHint(),b);b.writeTypeAndLength(n.ForwardingHint,b.getLength()-g)}b.writeOptionalNonNegativeIntegerTlv(n.SelectedDelegation,a.getSelectedDelegationIndex());g=a.getLinkWireEncoding(this);g.isNull()||b.writeBuffer(g.buf());b.writeOptionalNonNegativeIntegerTlv(n.InterestLifetime,a.getInterestLifetimeMilliseconds());if(a.getNonce().isNull()||0==
a.getNonce().size())b.writeBlobTlv(n.Nonce,ea.randomBytes(4));else if(4>a.getNonce().size()){g=f(4);a.getNonce().buf().copy(g);for(var m=a.getNonce().size();4>m;++m)g[m]=ea.randomBytes(1)[0];b.writeBlobTlv(n.Nonce,g)}else 4==a.getNonce().size()?b.writeBlobTlv(n.Nonce,a.getNonce().buf()):b.writeBlobTlv(n.Nonce,a.getNonce().buf().slice(0,4));G.encodeSelectors(a,b);g=G.encodeName(a.getName(),b);a=b.getLength()-g.signedPortionBeginOffset;g=b.getLength()-g.signedPortionEndOffset;b.writeTypeAndLength(n.Interest,
b.getLength()-c);c=b.getLength()-a;a=b.getLength()-g;return{encoding:new p(b.getOutput(),!1),signedPortionBeginOffset:c,signedPortionEndOffset:a}};G.prototype.decodeInterest=function(a,b,c){try{return this.decodeInterestV02_(a,b,c)}catch(g){try{return G.decodeInterestV03_(a,b,c)}catch(f){throw g;}}};G.prototype.decodeInterestV02_=function(a,b,c){null==c&&(c=!0);b=new na(b);var g=b.readNestedTlvsStart(n.Interest),f=G.decodeName(a.getName(),b,c);b.peekType(n.Selectors,g)?G.decodeSelectors(a,b,c):(a.setMinSuffixComponents(null),
a.setMaxSuffixComponents(null),a.getKeyLocator().clear(),a.getExclude().clear(),a.setChildSelector(null),a.setMustBeFresh(!1));var m=b.readBlobTlv(n.Nonce);a.setInterestLifetimeMilliseconds(b.readOptionalNonNegativeIntegerTlv(n.InterestLifetime,g));if(b.peekType(n.ForwardingHint,g)){var s=b.readNestedTlvsStart(n.ForwardingHint);G.decodeDelegationSet_(a.getForwardingHint(),s,b,c);b.finishNestedTlvs(s)}if(b.peekType(n.Data,g)){var s=b.getOffset(),q=b.readNestedTlvsStart(n.Data);b.seek(q);a.setLinkWireEncoding(new p(b.getSlice(s,
q),c),this)}else a.unsetLink();a.setSelectedDelegationIndex(b.readOptionalNonNegativeIntegerTlv(n.SelectedDelegation,g));if(null!=a.getSelectedDelegationIndex()&&0<=a.getSelectedDelegationIndex()&&!a.hasLink())throw Error("Interest has a selected delegation, but no link object");a.setNonce(new p(m,c));b.finishNestedTlvs(g);return f};G.prototype.encodeData=function(a){var b=new ta(1500),c=b.getLength();b.writeBlobTlv(n.SignatureValue,a.getSignature().getSignature().buf());var g=b.getLength();G.encodeSignatureInfo_(a.getSignature(),
b);b.writeBlobTlv(n.Content,a.getContent().buf());G.encodeMetaInfo(a.getMetaInfo(),b);G.encodeName(a.getName(),b);a=b.getLength();b.writeTypeAndLength(n.Data,b.getLength()-c);c=b.getLength()-a;g=b.getLength()-g;return{encoding:new p(b.getOutput(),!1),signedPortionBeginOffset:c,signedPortionEndOffset:g}};G.prototype.decodeData=function(a,b,c){null==c&&(c=!0);b=new na(b);var g=b.readNestedTlvsStart(n.Data),f=b.getOffset();G.decodeName(a.getName(),b,c);G.decodeMetaInfo(a.getMetaInfo(),b,c);a.setContent(new p(b.readBlobTlv(n.Content),
c));G.decodeSignatureInfo(a,b,c);var m=b.getOffset();a.getSignature().setSignature(new p(b.readBlobTlv(n.SignatureValue),c));b.finishNestedTlvs(g);return{signedPortionBeginOffset:f,signedPortionEndOffset:m}};G.prototype.encodeControlParameters=function(a){var b=new ta(256);G.encodeControlParameters(a,b);return new p(b.getOutput(),!1)};G.prototype.decodeControlParameters=function(a,b,c){null==c&&(c=!0);b=new na(b);G.decodeControlParameters(a,b,c)};G.prototype.encodeControlResponse=function(a){var b=
new ta(256),c=b.getLength();null!=a.getBodyAsControlParameters()&&G.encodeControlParameters(a.getBodyAsControlParameters(),b);b.writeBlobTlv(n.NfdCommand_StatusText,(new p(a.getStatusText())).buf());b.writeNonNegativeIntegerTlv(n.NfdCommand_StatusCode,a.getStatusCode());b.writeTypeAndLength(n.NfdCommand_ControlResponse,b.getLength()-c);return new p(b.getOutput(),!1)};G.prototype.decodeControlResponse=function(a,b,c){null==c&&(c=!0);b=new na(b);var g=b.readNestedTlvsStart(n.NfdCommand_ControlResponse);
a.setStatusCode(b.readNonNegativeIntegerTlv(n.NfdCommand_StatusCode));var f=new p(b.readBlobTlv(n.NfdCommand_StatusText),!1);a.setStatusText(f.toString());b.peekType(n.ControlParameters_ControlParameters,g)?(a.setBodyAsControlParameters(new Qa),G.decodeControlParameters(a.getBodyAsControlParameters(),b,c)):a.setBodyAsControlParameters(null);b.finishNestedTlvs(g)};G.prototype.encodeSignatureInfo=function(a){var b=new ta(256);G.encodeSignatureInfo_(a,b);return new p(b.getOutput(),!1)};G.SignatureHolder=
function(){};G.SignatureHolder.prototype.setSignature=function(a){this.signature=a};G.SignatureHolder.prototype.getSignature=function(){return this.signature};G.prototype.decodeSignatureInfoAndValue=function(a,b,c){null==c&&(c=!0);var g=new G.SignatureHolder;a=new na(a);G.decodeSignatureInfo(g,a,c);a=new na(b);g.getSignature().setSignature(new p(a.readBlobTlv(n.SignatureValue),c));return g.getSignature()};G.prototype.encodeSignatureValue=function(a){var b=new ta(256);b.writeBlobTlv(n.SignatureValue,
a.getSignature().buf());return new p(b.getOutput(),!1)};G.prototype.decodeLpPacket=function(a,b,c){null==c&&(c=!0);a.clear();for(var g=new na(b),f=g.readNestedTlvsStart(n.LpPacket_LpPacket);g.getOffset()<f;){var m=g.readVarNumber(),s=g.readVarNumber(),q=g.getOffset()+s;if(q>b.length)throw new R(Error("TLV length exceeds the buffer length"));if(m==n.LpPacket_Fragment){a.setFragmentWireEncoding(new p(g.getSlice(g.getOffset(),q),c));g.seek(q);break}else if(m==n.LpPacket_Nack)s=new hb,m=g.readOptionalNonNegativeIntegerTlv(n.LpPacket_NackReason,
q),0>m||m==hb.Reason.NONE?s.setReason(hb.Reason.NONE):m==hb.Reason.CONGESTION||m==hb.Reason.DUPLICATE||m==hb.Reason.NO_ROUTE?s.setReason(m):(s.setReason(hb.Reason.OTHER_CODE),s.setOtherReasonCode(m)),a.addHeaderField(s);else if(m==n.LpPacket_IncomingFaceId)m=new wc,m.setFaceId(g.readNonNegativeInteger(s)),a.addHeaderField(m);else if(m==n.LpPacket_CongestionMark)m=new $c,m.setCongestionMark(g.readNonNegativeInteger(s)),a.addHeaderField(m);else{if(!(m>=n.LpPacket_IGNORE_MIN&&m<=n.LpPacket_IGNORE_MAX&&
0==(m&3)))throw new R(Error("Did not get the expected TLV type"));g.seek(q)}g.finishNestedTlvs(q)}g.finishNestedTlvs(f)};G.prototype.encodeDelegationSet=function(a){var b=new ta(256);G.encodeDelegationSet_(a,b);return new p(b.getOutput(),!1)};G.prototype.decodeDelegationSet=function(a,b,c){null==c&&(c=!0);var g=new na(b);G.decodeDelegationSet_(a,b.length,g,c)};G.prototype.encodeEncryptedContent=function(a){var b=new ta(256),c=b.getLength();b.writeBlobTlv(n.Encrypt_EncryptedPayload,a.getPayload().buf());
b.writeOptionalBlobTlv(n.Encrypt_InitialVector,a.getInitialVector().buf());b.writeNonNegativeIntegerTlv(n.Encrypt_EncryptionAlgorithm,a.getAlgorithmType());G.encodeKeyLocator(n.KeyLocator,a.getKeyLocator(),b);b.writeTypeAndLength(n.Encrypt_EncryptedContent,b.getLength()-c);return new p(b.getOutput(),!1)};G.prototype.decodeEncryptedContent=function(a,b,c){null==c&&(c=!0);b=new na(b);var g=b.readNestedTlvsStart(n.Encrypt_EncryptedContent);G.decodeKeyLocator(n.KeyLocator,a.getKeyLocator(),b,c);a.setAlgorithmType(b.readNonNegativeIntegerTlv(n.Encrypt_EncryptionAlgorithm));
a.setInitialVector(new p(b.readOptionalBlobTlv(n.Encrypt_InitialVector,g),c));a.setPayload(new p(b.readBlobTlv(n.Encrypt_EncryptedPayload),c));b.finishNestedTlvs(g)};G.get=function(){null===G.instance&&(G.instance=new G);return G.instance};G.encodeNameComponent=function(a,b){var c;c=a.getType()===cb.OTHER_CODE?a.getOtherTypeCode():a.getType();b.writeBlobTlv(c,a.getValue().buf())};G.decodeNameComponent=function(a,b){null==b&&(b=!0);var g=a.getOffset(),f=a.readVarNumber();a.seek(g);g=new p(a.readBlobTlv(f),
b);return f===n.ImplicitSha256DigestComponent?c.Component.fromImplicitSha256Digest(g):f===n.ParametersSha256DigestComponent?c.Component.fromParametersSha256Digest(g):f===n.NameComponent?new c.Component(g):new c.Component(g,cb.OTHER_CODE,f)};G.encodeName=function(a,b){for(var c=b.getLength(),g,f=a.size()-1;0<=f;--f)G.encodeNameComponent(a.get(f),b),f==a.size()-1&&(g=b.getLength());f=b.getLength();b.writeTypeAndLength(n.Name,b.getLength()-c);c=b.getLength()-f;g=0==a.size()?c:b.getLength()-g;return{signedPortionBeginOffset:c,
signedPortionEndOffset:g}};G.decodeName=function(a,b,c){a.clear();for(var g=b.readNestedTlvsStart(n.Name),f=b.getOffset(),m=f;b.getOffset()<g;)m=b.getOffset(),a.append(G.decodeNameComponent(b,c));b.finishNestedTlvs(g);return{signedPortionBeginOffset:f,signedPortionEndOffset:m}};G.encodeSelectors=function(a,b){var c=b.getLength();a.getMustBeFresh()&&b.writeTypeAndLength(n.MustBeFresh,0);b.writeOptionalNonNegativeIntegerTlv(n.ChildSelector,a.getChildSelector());0<a.getExclude().size()&&G.encodeExclude(a.getExclude(),
b);null!=a.getKeyLocator().getType()&&G.encodeKeyLocator(n.PublisherPublicKeyLocator,a.getKeyLocator(),b);b.writeOptionalNonNegativeIntegerTlv(n.MaxSuffixComponents,a.getMaxSuffixComponents());b.writeOptionalNonNegativeIntegerTlv(n.MinSuffixComponents,a.getMinSuffixComponents());b.getLength()!=c&&b.writeTypeAndLength(n.Selectors,b.getLength()-c)};G.decodeSelectors=function(a,b,c){null==c&&(c=!0);var g=b.readNestedTlvsStart(n.Selectors);a.setMinSuffixComponents(b.readOptionalNonNegativeIntegerTlv(n.MinSuffixComponents,
g));a.setMaxSuffixComponents(b.readOptionalNonNegativeIntegerTlv(n.MaxSuffixComponents,g));b.peekType(n.PublisherPublicKeyLocator,g)?G.decodeKeyLocator(n.PublisherPublicKeyLocator,a.getKeyLocator(),b,c):a.getKeyLocator().clear();b.peekType(n.Exclude,g)?G.decodeExclude(a.getExclude(),b,c):a.getExclude().clear();a.setChildSelector(b.readOptionalNonNegativeIntegerTlv(n.ChildSelector,g));a.setMustBeFresh(b.readBooleanTlv(n.MustBeFresh,g));b.finishNestedTlvs(g)};G.encodeExclude=function(a,b){for(var c=
b.getLength(),g=a.size()-1;0<=g;--g){var f=a.get(g);f==Ra.ANY?b.writeTypeAndLength(n.Any,0):G.encodeNameComponent(f,b)}b.writeTypeAndLength(n.Exclude,b.getLength()-c)};G.decodeExclude=function(a,b,c){null==c&&(c=!0);var g=b.readNestedTlvsStart(n.Exclude);for(a.clear();b.getOffset()<g;)b.peekType(n.Any,g)?(b.readBooleanTlv(n.Any,g),a.appendAny()):a.appendComponent(G.decodeNameComponent(b,c));b.finishNestedTlvs(g)};G.encodeKeyLocator=function(a,b,c){var g=c.getLength();if(null!=b.getType())if(b.getType()==
Ga.KEYNAME)G.encodeName(b.getKeyName(),c);else if(b.getType()==Ga.KEY_LOCATOR_DIGEST&&0<b.getKeyData().size())c.writeBlobTlv(n.KeyLocatorDigest,b.getKeyData().buf());else throw Error("Unrecognized KeyLocatorType "+b.getType());c.writeTypeAndLength(a,c.getLength()-g)};G.decodeKeyLocator=function(a,b,c,g){null==g&&(g=!0);a=c.readNestedTlvsStart(a);b.clear();if(c.getOffset()!=a){if(c.peekType(n.Name,a))b.setType(Ga.KEYNAME),G.decodeName(b.getKeyName(),c,g);else if(c.peekType(n.KeyLocatorDigest,a))b.setType(Ga.KEY_LOCATOR_DIGEST),
b.setKeyData(new p(c.readBlobTlv(n.KeyLocatorDigest),g));else throw new R(Error("decodeKeyLocator: Unrecognized key locator type"));c.finishNestedTlvs(a)}};G.encodeValidityPeriod_=function(a,b){var c=b.getLength();b.writeBlobTlv(n.ValidityPeriod_NotAfter,(new p(fa.toIsoString(a.getNotAfter()))).buf());b.writeBlobTlv(n.ValidityPeriod_NotBefore,(new p(fa.toIsoString(a.getNotBefore()))).buf());b.writeTypeAndLength(n.ValidityPeriod_ValidityPeriod,b.getLength()-c)};G.decodeValidityPeriod_=function(a,b){var c=
b.readNestedTlvsStart(n.ValidityPeriod_ValidityPeriod);a.clear();var g=new p(b.readBlobTlv(n.ValidityPeriod_NotBefore),!1),f=fa.fromIsoString(g.toString()),g=new p(b.readBlobTlv(n.ValidityPeriod_NotAfter),!1),g=fa.fromIsoString(g.toString());a.setPeriod(f,g);b.finishNestedTlvs(c)};G.encodeSignatureInfo_=function(a,b){if(a instanceof Ub){var c=a.getSignatureInfoEncoding();try{var g=new na(c.buf()),f=g.readNestedTlvsStart(n.SignatureInfo);g.readNonNegativeIntegerTlv(n.SignatureType);g.finishNestedTlvs(f,
!0)}catch(m){throw Error("The GenericSignature encoding is not a valid NDN-TLV SignatureInfo: "+m.message);}b.writeBuffer(c.buf())}else{c=b.getLength();if(a instanceof Da)a.getValidityPeriod().hasPeriod()&&G.encodeValidityPeriod_(a.getValidityPeriod(),b),G.encodeKeyLocator(n.KeyLocator,a.getKeyLocator(),b),b.writeNonNegativeIntegerTlv(n.SignatureType,n.SignatureType_SignatureSha256WithRsa);else if(a instanceof Sa)a.getValidityPeriod().hasPeriod()&&G.encodeValidityPeriod_(a.getValidityPeriod(),b),
G.encodeKeyLocator(n.KeyLocator,a.getKeyLocator(),b),b.writeNonNegativeIntegerTlv(n.SignatureType,n.SignatureType_SignatureSha256WithEcdsa);else if(a instanceof jb)G.encodeKeyLocator(n.KeyLocator,a.getKeyLocator(),b),b.writeNonNegativeIntegerTlv(n.SignatureType,n.SignatureType_SignatureHmacWithSha256);else if(a instanceof qb)b.writeNonNegativeIntegerTlv(n.SignatureType,n.SignatureType_DigestSha256);else throw Error("encodeSignatureInfo: Unrecognized Signature object type");b.writeTypeAndLength(n.SignatureInfo,
b.getLength()-c)}};G.decodeSignatureInfo=function(a,b,c){null==c&&(c=!0);var g=b.getOffset(),f=b.readNestedTlvsStart(n.SignatureInfo),m=b.readNonNegativeIntegerTlv(n.SignatureType);m==n.SignatureType_SignatureSha256WithRsa?(a.setSignature(new Da),a=a.getSignature(),G.decodeKeyLocator(n.KeyLocator,a.getKeyLocator(),b,c),b.peekType(n.ValidityPeriod_ValidityPeriod,f)&&G.decodeValidityPeriod_(a.getValidityPeriod(),b)):m==n.SignatureType_SignatureSha256WithEcdsa?(a.setSignature(new Sa),a=a.getSignature(),
G.decodeKeyLocator(n.KeyLocator,a.getKeyLocator(),b,c),b.peekType(n.ValidityPeriod_ValidityPeriod,f)&&G.decodeValidityPeriod_(a.getValidityPeriod(),b)):m==n.SignatureType_SignatureHmacWithSha256?(a.setSignature(new jb),a=a.getSignature(),G.decodeKeyLocator(n.KeyLocator,a.getKeyLocator(),b,c)):m==n.SignatureType_DigestSha256?a.setSignature(new qb):(a.setSignature(new Ub),a=a.getSignature(),a.setSignatureInfoEncoding(new p(b.getSlice(g,f),c),m),b.finishNestedTlvs(f,!0));b.finishNestedTlvs(f)};G.encodeMetaInfo=
function(a,b){var c=b.getLength(),g=a.getFinalBlockId().getValue().buf();null!=g&&0<g.length&&(g=b.getLength(),G.encodeNameComponent(a.getFinalBlockId(),b),b.writeTypeAndLength(n.FinalBlockId,b.getLength()-g));b.writeOptionalNonNegativeIntegerTlv(n.FreshnessPeriod,a.getFreshnessPeriod());if(a.getType()!=ya.BLOB)if(a.getType()==ya.LINK||a.getType()==ya.KEY||a.getType()==ya.NACK)b.writeNonNegativeIntegerTlv(n.ContentType,a.getType());else if(a.getType()==ya.OTHER_CODE)b.writeNonNegativeIntegerTlv(n.ContentType,
a.getOtherTypeCode());else throw Error("unrecognized TLV ContentType");b.writeTypeAndLength(n.MetaInfo,b.getLength()-c)};G.decodeMetaInfo=function(a,b,c){null==c&&(c=!0);var g=b.readNestedTlvsStart(n.MetaInfo),f=b.readOptionalNonNegativeIntegerTlv(n.ContentType,g);null==f||0>f||f===ya.BLOB?a.setType(ya.BLOB):f===ya.LINK||f===ya.KEY||f===ya.NACK?a.setType(f):(a.setType(ya.OTHER_CODE),a.setOtherTypeCode(f));a.setFreshnessPeriod(b.readOptionalNonNegativeIntegerTlv(n.FreshnessPeriod,g));b.peekType(n.FinalBlockId,
g)?(f=b.readNestedTlvsStart(n.FinalBlockId),a.setFinalBlockId(G.decodeNameComponent(b,c)),b.finishNestedTlvs(f)):a.setFinalBlockId(null);b.finishNestedTlvs(g)};G.encodeControlParameters=function(a,b){var c=b.getLength();b.writeOptionalNonNegativeIntegerTlv(n.ControlParameters_ExpirationPeriod,a.getExpirationPeriod());if(0<a.getStrategy().size()){var g=b.getLength();G.encodeName(a.getStrategy(),b);b.writeTypeAndLength(n.ControlParameters_Strategy,b.getLength()-g)}g=a.getForwardingFlags().getNfdForwardingFlags();
g!=(new Fa).getNfdForwardingFlags()&&b.writeNonNegativeIntegerTlv(n.ControlParameters_Flags,g);b.writeOptionalNonNegativeIntegerTlv(n.ControlParameters_Cost,a.getCost());b.writeOptionalNonNegativeIntegerTlv(n.ControlParameters_Origin,a.getOrigin());b.writeOptionalNonNegativeIntegerTlv(n.ControlParameters_LocalControlFeature,a.getLocalControlFeature());0!=a.getUri().length&&b.writeBlobTlv(n.ControlParameters_Uri,(new p(a.getUri())).buf());b.writeOptionalNonNegativeIntegerTlv(n.ControlParameters_FaceId,
a.getFaceId());null!=a.getName()&&G.encodeName(a.getName(),b);b.writeTypeAndLength(n.ControlParameters_ControlParameters,b.getLength()-c)};G.decodeControlParameters=function(a,b,g){null==g&&(g=!0);a.clear();var f=b.readNestedTlvsStart(n.ControlParameters_ControlParameters);if(b.peekType(n.Name,f)){var m=new c;G.decodeName(m,b,g);a.setName(m)}a.setFaceId(b.readOptionalNonNegativeIntegerTlv(n.ControlParameters_FaceId,f));b.peekType(n.ControlParameters_Uri,f)&&(m=new p(b.readOptionalBlobTlv(n.ControlParameters_Uri,
f),!1),a.setUri(m.toString()));b.skipOptionalTlv(n.ControlParameters_LocalUri,f);a.setLocalControlFeature(b.readOptionalNonNegativeIntegerTlv(n.ControlParameters_LocalControlFeature,f));a.setOrigin(b.readOptionalNonNegativeIntegerTlv(n.ControlParameters_Origin,f));a.setCost(b.readOptionalNonNegativeIntegerTlv(n.ControlParameters_Cost,f));b.skipOptionalTlv(n.ControlParameters_Capacity,f);b.skipOptionalTlv(n.ControlParameters_Count,f);b.skipOptionalTlv(n.ControlParameters_BaseCongestionMarkingInterval,
f);b.skipOptionalTlv(n.ControlParameters_DefaultCongestionThreshold,f);b.skipOptionalTlv(n.ControlParameters_Mtu,f);b.peekType(n.ControlParameters_Flags,f)&&(m=new Fa,m.setNfdForwardingFlags(b.readNonNegativeIntegerTlv(n.ControlParameters_Flags,f)),a.setForwardingFlags(m));b.skipOptionalTlv(n.ControlParameters_Mask,f);b.peekType(n.ControlParameters_Strategy,f)&&(m=b.readNestedTlvsStart(n.ControlParameters_Strategy),G.decodeName(a.getStrategy(),b,g),b.finishNestedTlvs(m));a.setExpirationPeriod(b.readOptionalNonNegativeIntegerTlv(n.ControlParameters_ExpirationPeriod,
f));b.finishNestedTlvs(f)};G.encodeDelegationSet_=function(a,b){for(var c=a.size()-1;0<=c;--c){var g=b.getLength();G.encodeName(a.get(c).getName(),b);b.writeNonNegativeIntegerTlv(n.Link_Preference,a.get(c).getPreference());b.writeTypeAndLength(n.Link_Delegation,b.getLength()-g)}};G.decodeDelegationSet_=function(a,b,g,f){for(a.clear();g.getOffset()<b;){g.readTypeAndLength(n.Link_Delegation);var m=g.readNonNegativeIntegerTlv(n.Link_Preference),p=new c;G.decodeName(p,g,f);a.addUnsorted(m,p)}};G.decodeInterestV03_=
function(a,b,c){null==c&&(c=!0);b=new na(b);var g=b.readNestedTlvsStart(n.Interest),f=G.decodeName(a.getName(),b,c);a.setCanBePrefix(b.readBooleanTlv(n.CanBePrefix,g));a.setMustBeFresh(b.readBooleanTlv(n.MustBeFresh,g));if(b.peekType(n.ForwardingHint,g)){var m=b.readNestedTlvsStart(n.ForwardingHint);G.decodeDelegationSet_(a.getForwardingHint(),m,b,c);b.finishNestedTlvs(m)}else a.getForwardingHint().clear();m=b.readOptionalBlobTlv(n.Nonce,g);a.setInterestLifetimeMilliseconds(b.readOptionalNonNegativeIntegerTlv(n.InterestLifetime,
g));a.setMinSuffixComponents(null);a.getKeyLocator().clear();a.getExclude().clear();a.setChildSelector(null);a.unsetLink();a.setSelectedDelegationIndex(null);b.readOptionalBlobTlv(n.HopLimit,g);b.readOptionalBlobTlv(n.Parameters,g);a.setNonce(null==m?new p:new p(m,c));b.finishNestedTlvs(g);return f};var G=a.Tlv0_2WireFormat,oc=function(){G.call(this)};oc.prototype=new G;oc.prototype.name="Tlv0_1_1WireFormat";q.Tlv0_1_1WireFormat=oc;oc.instance=null;oc.get=function(){null===oc.instance&&(oc.instance=
new oc);return oc.instance};var s=a.WireFormat,oc=a.Tlv0_1_1WireFormat,gd=function(){oc.call(this)};gd.prototype=new oc;gd.prototype.name="Tlv0_1WireFormat";q.Tlv0_1WireFormat=gd;gd.instance=null;gd.get=function(){null===gd.instance&&(gd.instance=new gd);return gd.instance};s=a.WireFormat;G=a.Tlv0_2WireFormat;bb=function(){G.call(this)};bb.prototype=new G;bb.prototype.name="TlvWireFormat";q.TlvWireFormat=bb;bb.instance=null;bb.get=function(){null===bb.instance&&(bb.instance=new bb);return bb.instance};
s.setDefaultWireFormat(bb.get());var L=a.DataUtils,Ga=a.KeyLocatorType,F=a.Interest,Q=a.Data,Da=a.Sha256WithRsaSignature,Sa=a.Sha256WithEcdsaSignature,jb=a.HmacWithSha256Signature,qb=a.DigestSha256Signature,ya=a.ContentType,s=a.WireFormat,Fd=function(){};q.EncodingUtils=Fd;Fd.encodeToHexInterest=function(a,b){b=b||s.getDefaultWireFormat();return L.toHex(a.wireEncode(b).buf())};Fd.encodeToHexData=function(a,b){b=b||s.getDefaultWireFormat();return L.toHex(a.wireEncode(b).buf())};Fd.decodeHexInterest=
function(a,b){b=b||s.getDefaultWireFormat();var c=new F;c.wireDecode(L.toNumbers(a),b);return c};Fd.decodeHexData=function(a,b){b=b||s.getDefaultWireFormat();var c=new Q;c.wireDecode(L.toNumbers(a),b);return c};Fd.decodeSubjectPublicKeyInfo=function(a){a=L.toHex(a).toLowerCase();a=_x509_getPublicKeyHexArrayFromCertHex(a,_x509_getSubjectPublicKeyPosFromCertHex(a,0));var b=new A;b.setPublic(a[0],a[1]);return b};Fd.dataToHtml=function(a){function b(a){a=a.replace(/&/g,"&amp;");a=a.replace(/</g,"&lt;");
c+=a;c+="<br/>"}if(-1==a)return"NO CONTENT FOUND";if(-2==a)return"CONTENT NAME IS EMPTY";var c="";b("name: "+a.getName().toUri());0<a.getContent().size()?(b("content (raw): "+a.getContent().buf().toString("binary")),b("content (hex): "+a.getContent().toHex())):b("content: <empty>");a.getMetaInfo().getType()!=ya.BLOB&&(a.getMetaInfo().getType()==ya.KEY?b("metaInfo.type: KEY"):a.getMetaInfo().getType()==ya.LINK?b("metaInfo.type: LINK"):a.getMetaInfo().getType()==ya.NACK?b("metaInfo.type: NACK"):a.getMetaInfo().getType()==
ya.OTHER_CODE&&b("metaInfo.type: other code "+a.getMetaInfo().getOtherTypeCode()));b("metaInfo.freshnessPeriod (milliseconds): "+(0<=a.getMetaInfo().getFreshnessPeriod()?""+a.getMetaInfo().getFreshnessPeriod():"<none>"));b("metaInfo.finalBlockId: "+(0<a.getMetaInfo().getFinalBlockId().getValue().size()?a.getMetaInfo().getFinalBlockId().getValue().toHex():"<none>"));var g=null,f=a.getSignature();f instanceof Da?(f=a.getSignature(),b("Sha256WithRsa signature.signature: "+(0<f.getSignature().size()?
f.getSignature().toHex():"<none>")),g=f.getKeyLocator()):f instanceof Sa?(f=a.getSignature(),b("Sha256WithEcdsa signature.signature: "+(0<f.getSignature().size()?f.getSignature().toHex():"<none>")),g=f.getKeyLocator()):f instanceof jb?(f=a.getSignature(),b("HmacWithSha256 signature.signature: "+(0<f.getSignature().size()?f.getSignature().toHex():"<none>")),g=f.getKeyLocator()):f instanceof qb&&(f=a.getSignature(),b("DigestSha256 signature.signature: "+(0<f.getSignature().size()?f.getSignature().toHex():
"<none>")));null!==g&&(null==g.getType()?b("signature.keyLocator: <none>"):g.getType()==Ga.KEY_LOCATOR_DIGEST?b("signature.keyLocator: KeyLocatorDigest: "+g.getKeyData().toHex()):g.getType()==Ga.KEYNAME?b("signature.keyLocator: KeyName: "+g.getKeyName().toUri()):b("signature.keyLocator: <unrecognized ndn_KeyLocatorType>"));return c};var ea=a,p=a.Blob,Gd=a.DecryptKey,Qd=a.EncryptKey,ha=a.EncryptAlgorithmType,yb=a.UseSubtleCrypto,b=a.SyncPromise,Eb=function(){};q.AesAlgorithm=Eb;Eb.generateKey=function(a){a=
ea.randomBytes(a.getKeySize()/8);return new Gd(new p(a,!1))};Eb.deriveEncryptKey=function(a){return new Qd(a)};Eb.decryptPromise=function(a,c,g,m){if(yb()&&!m&&g.getAlgorithmType()!=ha.AesEcb)return g.getAlgorithmType()==ha.AesCbc?crypto.subtle.importKey("raw",a.buf(),{name:"AES-CBC"},!1,["encrypt","decrypt"]).then(function(a){return crypto.subtle.decrypt({name:"AES-CBC",iv:g.getInitialVector().buf()},a,c.buf())}).then(function(a){return Promise.resolve(new p(new Uint8Array(a),!1))}):Promise.reject(Error("unsupported encryption mode"));
if(g.getAlgorithmType()==ha.AesEcb)try{var n=ea.createDecipheriv(32==a.size()?"aes-256-ecb":"aes-128-ecb",a.buf(),"");return b.resolve(new p(f.concat([n.update(c.buf()),n.final()]),!1))}catch(s){return b.reject(s)}else if(g.getAlgorithmType()==ha.AesCbc)try{return n=ea.createDecipheriv(32==a.size()?"aes-256-cbc":"aes-128-cbc",a.buf(),g.getInitialVector().buf()),b.resolve(new p(f.concat([n.update(c.buf()),n.final()]),!1))}catch(q){return b.reject(q)}else return b.reject(Error("unsupported encryption mode"))};
Eb.decrypt=function(a,c,g){return b.getValue(this.decryptPromise(a,c,g,!0))};Eb.encryptPromise=function(a,c,g,m){return g.getAlgorithmType()==ha.AesCbc&&g.getInitialVector().size()!=Eb.BLOCK_SIZE?b.reject(Error("incorrect initial vector size")):yb()&&!m&&g.getAlgorithmType()!=ha.AesEcb?g.getAlgorithmType()==ha.AesCbc?crypto.subtle.importKey("raw",a.buf(),{name:"AES-CBC"},!1,["encrypt","decrypt"]).then(function(a){return crypto.subtle.encrypt({name:"AES-CBC",iv:g.getInitialVector().buf()},a,c.buf())}).then(function(a){return Promise.resolve(new p(new Uint8Array(a),
!1))}):Promise.reject(Error("unsupported encryption mode")):g.getAlgorithmType()==ha.AesEcb?(a=ea.createCipheriv(32==a.size()?"aes-256-ecb":"aes-128-ecb",a.buf(),""),b.resolve(new p(f.concat([a.update(c.buf()),a.final()]),!1))):g.getAlgorithmType()==ha.AesCbc?(a=ea.createCipheriv(32==a.size()?"aes-256-cbc":"aes-128-cbc",a.buf(),g.getInitialVector().buf()),b.resolve(new p(f.concat([a.update(c.buf()),a.final()]),!1))):b.reject(Error("unsupported encryption mode"))};Eb.encrypt=function(a,c,g){return b.getValue(this.encryptPromise(a,
c,g,!0))};Eb.BLOCK_SIZE=16;ea=a;p=a.Blob;ha=function(){};q.EncryptAlgorithmType=ha;ha.AesEcb=0;ha.AesCbc=1;ha.RsaPkcs=2;ha.RsaOaep=3;var Pb=function(a,b){this.algorithmType_=a;if(null!=b&&0<b){var c=ea.randomBytes(b);this.initialVector_=new p(c,!1)}else this.initialVector_=new p};q.EncryptParams=Pb;Pb.prototype.getAlgorithmType=function(){return this.algorithmType_};Pb.prototype.getInitialVector=function(){return this.initialVector_};Pb.prototype.setAlgorithmType=function(a){this.algorithmType_=a;
return this};Pb.prototype.setInitialVector=function(a){this.initialVector_="object"===typeof a&&a instanceof p?a:new p(a);return this};var ea=a,c=a.Name,U=a.KeyLocator,Ga=a.KeyLocatorType,bb=a.TlvWireFormat,p=a.Blob,Eb=a.AesAlgorithm,kb=a.RsaAlgorithm,Pb=a.EncryptParams,ha=a.EncryptAlgorithmType,xb=a.EncryptedContent,b=a.SyncPromise,xa=function(a){};q.Encryptor=xa;xa.NAME_COMPONENT_FOR=new c.Component("FOR");xa.NAME_COMPONENT_READ=new c.Component("READ");xa.NAME_COMPONENT_SAMPLE=new c.Component("SAMPLE");
xa.NAME_COMPONENT_ACCESS=new c.Component("ACCESS");xa.NAME_COMPONENT_E_KEY=new c.Component("E-KEY");xa.NAME_COMPONENT_D_KEY=new c.Component("D-KEY");xa.NAME_COMPONENT_C_KEY=new c.Component("C-KEY");xa.encryptDataPromise=function(a,g,m,n,s,q){a.getName().append(xa.NAME_COMPONENT_FOR).append(m);var H=s.getAlgorithmType();return H==ha.AesCbc||H==ha.AesEcb?xa.encryptSymmetricPromise_(g,n,m,s,q).then(function(c){a.setContent(c.wireEncode(bb.get()));return b.resolve()}):H==ha.RsaPkcs||H==ha.RsaOaep?xa.encryptAsymmetricPromise_(g,
n,m,s,q).then(function(c){a.setContent(c.wireEncode(bb.get()));return b.resolve()},function(H){H=ea.randomBytes(16);var x=new p(H,!1),qe=new c(m);qe.append("nonce");var Bc=new Pb(ha.AesCbc,Eb.BLOCK_SIZE),Ge;return xa.encryptAsymmetricPromise_(x,n,m,s,q).then(function(a){Ge=a;return xa.encryptSymmetricPromise_(g,x,qe,Bc,q)}).then(function(c){c=c.wireEncode();var g=Ge.wireEncode(),m=new f(c.size()+g.size());g.buf().copy(m,0);c.buf().copy(m,g.size());a.setContent(new p(m,!1));return b.resolve()})}):
b.reject(Error("Unsupported encryption method"))};xa.encryptData=function(a,c,g,f,m){return b.getValue(xa.encryptDataPromise(a,c,g,f,m,!0))};xa.encryptSymmetricPromise_=function(a,c,g,f,m){var n=f.getAlgorithmType(),p=f.getInitialVector(),s=new U;s.setType(Ga.KEYNAME);s.setKeyName(g);return n==ha.AesCbc||n==ha.AesEcb?n==ha.AesCbc&&p.size()!=Eb.BLOCK_SIZE?b.reject(Error("incorrect initial vector size")):Eb.encryptPromise(c,a,f,m).then(function(a){var c=new xb;c.setAlgorithmType(n);c.setKeyLocator(s);
c.setPayload(a);c.setInitialVector(p);return b.resolve(c)}):b.reject(Error("Unsupported encryption method"))};xa.encryptAsymmetricPromise_=function(a,c,g,f,m){var n=f.getAlgorithmType(),p=new U;p.setType(Ga.KEYNAME);p.setKeyName(g);return n==ha.RsaPkcs||n==ha.RsaOaep?kb.encryptPromise(c,a,f,m).then(function(a){var c=new xb;c.setAlgorithmType(n);c.setKeyLocator(p);c.setPayload(a);return b.resolve(c)}):b.reject(Error("Unsupported encryption method"))};pd=a.constants;ea=a;p=a.Blob;Gd=a.DecryptKey;Qd=
a.EncryptKey;ha=a.EncryptAlgorithmType;m=a.DerNode;fb=a.OID;qa=a.PrivateKeyStorage;yb=a.UseSubtleCrypto;b=a.SyncPromise;Ba=a.PublicKey;xc=null;try{xc=a}catch(bf){}kb=function(){};q.RsaAlgorithm=kb;kb.generateKeyPromise=function(a,c){if(yb()&&!c)return crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:a.getKeySize(),publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]).then(function(a){return crypto.subtle.exportKey("pkcs8",a.privateKey)}).then(function(a){return Promise.resolve(new Gd(new p(new Uint8Array(a),
!1)))});if(!xc)return b.reject(Error("Need to install rsa-keygen: sudo npm install rsa-keygen"));try{var g=xc.generate(a.getKeySize()).private_key.toString().replace("-----BEGIN RSA PRIVATE KEY-----","").replace("-----END RSA PRIVATE KEY-----",""),n=new f(g,"base64"),s=qa.encodePkcs8PrivateKey(n,new fb(qa.RSA_ENCRYPTION_OID),new m.DerNull).buf();return b.resolve(new Gd(s))}catch(q){return b.reject(q)}};kb.generateKey=function(a){return b.getValue(kb.generateKeyPromise(a,!0))};kb.deriveEncryptKey=
function(a){a=kb.getRsaPrivateKeyDer(a);var b=m.parse(a.buf(),0).getChildren();a=b[1];var b=b[2],c=new m.DerSequence;c.addChild(a);c.addChild(b);a=c.encode();b=new m.DerSequence;b.addChild(new m.DerOid(new fb(qa.RSA_ENCRYPTION_OID)));b.addChild(new m.DerNull);c=new m.DerSequence;c.addChild(b);c.addChild(new m.DerBitString(a.buf(),0));return new Qd(c.encode())};kb.decryptPromise=function(a,c,g,f){if(yb()&&!f&&g.getAlgorithmType()!=ha.RsaPkcs)return g.getAlgorithmType()==ha.RsaOaep?crypto.subtle.importKey("pkcs8",
a.buf(),{name:"RSA-OAEP",hash:{name:"SHA-1"}},!1,["decrypt"]).then(function(a){return crypto.subtle.decrypt({name:"RSA-OAEP"},a,c.buf())}).then(function(a){return Promise.resolve(new p(new Uint8Array(a),!1))}):Promise.reject(Error("unsupported padding scheme"));f=kb.getRsaPrivateKeyDer(a).buf().toString("base64");a="-----BEGIN RSA PRIVATE KEY-----\n";for(var m=0;m<f.length;m+=64)a+=f.substr(m,64)+"\n";a+="-----END RSA PRIVATE KEY-----";if(g.getAlgorithmType()==ha.RsaPkcs)g=pd.RSA_PKCS1_PADDING;else if(g.getAlgorithmType()==
ha.RsaOaep)g=pd.RSA_PKCS1_OAEP_PADDING;else return b.reject(Error("unsupported padding scheme"));try{return b.resolve(new p(ea.privateDecrypt({key:a,padding:g},c.buf()),!1))}catch(n){return b.reject(n)}};kb.decrypt=function(a,c,g){return b.getValue(kb.decryptPromise(a,c,g,!0))};kb.encryptPromise=function(a,c,g,f){var m;try{m=new Ba(a)}catch(n){return b.reject(n)}return m.encryptPromise(c,g.getAlgorithmType(),f)};kb.encrypt=function(a,c,g){return b.getValue(kb.encryptPromise(a,c,g,!0))};kb.getRsaPrivateKeyDer=
function(a){a=m.parse(a.buf(),0).getChildren();if(m.getSequence(a,1).getChildren()[0].toVal()!=qa.RSA_ENCRYPTION_OID)throw Error("The PKCS #8 private key is not RSA_ENCRYPTION");return a[2].getPayload()};var b=a.SyncPromise,hd=function(){};q.ConsumerDb=hd;hd.Error=function(a){if(a)return a.__proto__=hd.Error.prototype,a};hd.Error.prototype=Error();hd.Error.prototype.name="ConsumerDbError";hd.prototype.getKeyPromise=function(a,c){return b.reject(Error("ConsumerDb.getKeyPromise is not implemented"))};
hd.prototype.addKeyPromise=function(a,c,g){return b.reject(Error("ConsumerDb.addKeyPromise is not implemented"))};hd.prototype.deleteKeyPromise=function(a,c){return b.reject(Error("ConsumerDb.addKeyPromise is not implemented"))};var p=a.Blob,c=a.Name,F=a.Interest,hb=a.NetworkNack,wb=a.Link,xb=a.EncryptedContent,pc=a.EncryptError,Pb=a.EncryptParams,ha=a.EncryptAlgorithmType,kb=a.RsaAlgorithm,Eb=a.AesAlgorithm,xa=a.Encryptor,b=a.SyncPromise,O=a.NdnCommon,Ja=function tb(a,b,g,f,m,n,p){this.database_=
m;this.keyChain_=b;this.face_=a;this.groupName_=new c(g);this.consumerName_=new c(f);this.cKeyLink_=void 0==n?tb.NO_LINK:new wb(n);this.dKeyLink_=void 0==p?tb.NO_LINK:new wb(p);this.cKeyMap_={};this.dKeyMap_={}};q.Consumer=Ja;Ja.prototype.consume=function(a,b,c,g){void 0==g&&(g=Ja.NO_LINK);a=new F(a);var f=this;this.sendInterest_(a,1,new wb(g),function(a){f.decryptContent_(a,function(c){try{b(a,c)}catch(g){console.log("Error in onConsumeComplete: "+O.getErrorWithStackTrace(g))}},c)},c)};Ja.prototype.setGroup=
function(a){this.groupName_=new c(a)};Ja.prototype.addDecryptionKeyPromise=function(a,c,g){return this.consumerName_.match(a)?this.database_.addKeyPromise(a,c,g):b.reject(Error("addDecryptionKey: The consumer name must be a prefix of the key name"))};Ja.prototype.addDecryptionKey=function(a,c,g,f){return b.complete(g,f,this.addDecryptionKeyPromise(a,c,!g))};Ja.Error=function(a,b){this.errorCode=a;this.message=b};Ja.Error.callOnError=function(a,b,c){c||(c="");if(b instanceof Ja.Error)try{a(b.errorCode,
b.message)}catch(g){console.log("Error in onError: "+O.getErrorWithStackTrace(g))}else try{a(pc.ErrorCode.General,c+b)}catch(f){console.log("Error in onError: "+O.getErrorWithStackTrace(f))}};Ja.decryptPromise_=function(a,c){return b.resolve().then(function(){if("object"==typeof a&&a instanceof p){var g=a;a=new xb;a.wireDecode(g)}g=a.getPayload();if(a.getAlgorithmType()==ha.AesCbc){var f=new Pb(ha.AesCbc);f.setInitialVector(a.getInitialVector());return Eb.decryptPromise(c,g,f)}return a.getAlgorithmType()==
ha.RsaOaep?(f=new Pb(ha.RsaOaep),kb.decryptPromise(c,g,f)):b.reject(new Ja.Error(pc.ErrorCode.UnsupportedEncryptionScheme,""+a.getAlgorithmType()))})};Ja.decrypt_=function(a,b,c,g){Ja.decryptPromise_(a,b).then(function(a){c(a)},function(a){Ja.Error.callOnError(g,a)})};Ja.prototype.decryptContent_=function(a,b,g){var f=new xb;try{f.wireDecode(a.getContent())}catch(m){Ja.Error.callOnError(g,m,"Error decoding EncryptedContent: ");return}var n=f.getKeyLocator().getKeyName();if(a=this.cKeyMap_[n.toUri()])this.decrypt_(f,
a,b,g);else{a=new c(n);a.append(xa.NAME_COMPONENT_FOR).append(this.groupName_);a=new F(a);var p=this;this.sendInterest_(a,1,this.cKeyLink_,function(a){p.decryptCKey_(a,function(a){p.cKeyMap_[n.toUri()]=a;Ja.decrypt_(f,a,b,g)},g)},g)}};Ja.prototype.decryptCKey_=function(a,b,g){a=a.getContent();var f=new xb;try{f.wireDecode(a)}catch(m){Ja.Error.callOnError(g,m,"Error decoding EncryptedContent: ");return}a=f.getKeyLocator().getKeyName();var n=a.getPrefix(-3);n.append(xa.NAME_COMPONENT_D_KEY).append(a.getSubName(-2));
if(a=this.dKeyMap_[n.toUri()])this.decrypt_(f,a,b,g);else{a=new c(n);a.append(xa.NAME_COMPONENT_FOR).append(this.consumerName_);a=new F(a);var p=this;this.sendInterest_(a,1,this.dKeyLink_,function(a){p.decryptDKeyPromise_(a).then(function(a){p.dKeyMap_[n.toUri()]=a;Ja.decrypt_(f,a,b,g)},function(a){Ja.Error.callOnError(g,a,"decryptDKey error: ")})},g)}};Ja.prototype.decryptDKeyPromise_=function(a){var c,g,f,m=this;return b.resolve().then(function(){c=a.getContent();g=new xb;g.wireDecode(c);var b=
g.getKeyLocator().getKeyName();return m.getDecryptionKeyPromise_(b)}).then(function(a){if(0==a.size())return b.reject(new Ja.Error(pc.ErrorCode.NoDecryptKey,"The desired consumer decryption key in not in the database"));var m=c.buf().slice(g.wireEncode().size());f=new p(m,!1);return 0==f.size()?b.reject(new Ja.Error(pc.ErrorCode.InvalidEncryptedFormat,"The data packet does not satisfy the D-KEY packet format")):Ja.decryptPromise_(g,a)}).then(function(a){return Ja.decryptPromise_(f,a)})};Ja.prototype.sendInterest_=
function(a,b,c,g,f){function m(a,b){try{f(pc.ErrorCode.DataRetrievalFailure,a.getName().toUri())}catch(c){console.log("Error in onError: "+O.getErrorWithStackTrace(c))}}var n=this,p=function(a,b){try{n.keyChain_.verifyData(b,g,function(a,b){try{f(pc.ErrorCode.Validation,"verifyData failed. Reason: "+b)}catch(c){console.log("Error in onError: "+O.getErrorWithStackTrace(c))}})}catch(c){Ja.Error.callOnError(f,c,"verifyData error: ")}},s=function(a){0<b?n.sendInterest_(a,b-1,c,g,f):m(a,new hb)};0!==c.getDelegations().size()&&
(a=new F(a),a.setLinkWireEncoding(c.wireEncode()));try{this.face_.expressInterest(a,p,s,m)}catch(Bc){Ja.Error.callOnError(f,Bc,"expressInterest error: ")}};Ja.prototype.getDecryptionKeyPromise_=function(a){return this.database_.getKeyPromise(a)};Ja.NO_LINK=new wb;p=a.Blob;Gd=function Ue(a){this.keyBits_="object"===typeof a&&a instanceof Ue?a.keyBits_:"object"===typeof a&&a instanceof p?a:new p(a)};q.DecryptKey=Gd;Gd.prototype.getKeyBits=function(){return this.keyBits_};pc=function(){};q.EncryptError=
pc;pc.ErrorCode={Timeout:1,Validation:2,UnsupportedEncryptionScheme:32,InvalidEncryptedFormat:33,NoDecryptKey:34,EncryptionFailure:35,DataRetrievalFailure:36,General:100};p=a.Blob;Qd=function Ve(a){this.keyBits_="object"===typeof a&&a instanceof Ve?a.keyBits_:"object"===typeof a&&a instanceof p?a:new p(a)};q.EncryptKey=Qd;Qd.prototype.getKeyBits=function(){return this.keyBits_};U=a.KeyLocator;s=a.WireFormat;p=a.Blob;xb=function We(a){"object"===typeof a&&a instanceof We?(this.algorithmType_=a.algorithmType_,
this.keyLocator_=new U(a.keyLocator_),this.initialVector_=a.initialVector_,this.payload_=a.payload_):(this.algorithmType_=null,this.keyLocator_=new U,this.initialVector_=new p,this.payload_=new p)};q.EncryptedContent=xb;xb.prototype.getAlgorithmType=function(){return this.algorithmType_};xb.prototype.getKeyLocator=function(){return this.keyLocator_};xb.prototype.getInitialVector=function(){return this.initialVector_};xb.prototype.getPayload=function(){return this.payload_};xb.prototype.setAlgorithmType=
function(a){this.algorithmType_=a;return this};xb.prototype.setKeyLocator=function(a){this.keyLocator_="object"===typeof a&&a instanceof U?new U(a):new U;return this};xb.prototype.setInitialVector=function(a){this.initialVector_="object"===typeof a&&a instanceof p?a:new p(a);return this};xb.prototype.setPayload=function(a){this.payload_="object"===typeof a&&a instanceof p?a:new p(a);return this};xb.prototype.wireEncode=function(a){a=a||s.getDefaultWireFormat();return a.encodeEncryptedContent(this)};
xb.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();"object"===typeof a&&a instanceof p?b.decodeEncryptedContent(this,a.buf(),!1):b.decodeEncryptedContent(this,a,!0)};var b=a.SyncPromise,ab=function(){};q.GroupManagerDb=ab;ab.Error=function(a){if(a)return a.__proto__=ab.Error.prototype,a};ab.Error.prototype=Error();ab.Error.prototype.name="GroupManagerDbError";ab.prototype.hasSchedulePromise=function(a,c){return b.reject(Error("GroupManagerDb.hasSchedulePromise is not implemented"))};
ab.prototype.listAllScheduleNamesPromise=function(a){return b.reject(Error("GroupManagerDb.listAllScheduleNamesPromise is not implemented"))};ab.prototype.getSchedulePromise=function(a,c){return b.reject(Error("GroupManagerDb.getSchedulePromise is not implemented"))};ab.prototype.getScheduleMembersPromise=function(a,c){return b.reject(Error("GroupManagerDb.getScheduleMembersPromise is not implemented"))};ab.prototype.addSchedulePromise=function(a,c,g){return b.reject(Error("GroupManagerDb.addSchedulePromise is not implemented"))};
ab.prototype.deleteSchedulePromise=function(a,c){return b.reject(Error("GroupManagerDb.deleteSchedulePromise is not implemented"))};ab.prototype.renameSchedulePromise=function(a,c,g){return b.reject(Error("GroupManagerDb.renameSchedulePromise is not implemented"))};ab.prototype.updateSchedulePromise=function(a,c,g){return b.reject(Error("GroupManagerDb.updateSchedulePromise is not implemented"))};ab.prototype.hasMemberPromise=function(a,c){return b.reject(Error("GroupManagerDb.hasMemberPromise is not implemented"))};
ab.prototype.listAllMembersPromise=function(a){return b.reject(Error("GroupManagerDb.listAllMembersPromise is not implemented"))};ab.prototype.getMemberSchedulePromise=function(a,c){return b.reject(Error("GroupManagerDb.getMemberSchedulePromise is not implemented"))};ab.prototype.addMemberPromise=function(a,c,g,f){return b.reject(Error("GroupManagerDb.addMemberPromise is not implemented"))};ab.prototype.updateMemberSchedulePromise=function(a,c,g){return b.reject(Error("GroupManagerDb.updateMemberSchedulePromise is not implemented"))};
ab.prototype.deleteMemberPromise=function(a,c){return b.reject(Error("GroupManagerDb.deleteMemberPromise is not implemented"))};ab.prototype.hasEKeyPromise=function(a,c){return b.reject(Error("GroupManagerDb.hasEKeyPromise is not implemented"))};ab.prototype.addEKeyPromise=function(a,c,g,f){return b.reject(Error("GroupManagerDb.addEKeyPromise is not implemented"))};ab.prototype.getEKeyPromise=function(a,c){return b.reject(Error("GroupManagerDb.getEKeyPromise is not implemented"))};ab.prototype.cleanEKeysPromise=
function(a){return b.reject(Error("GroupManagerDb.cleanEKeysPromise is not implemented"))};ab.prototype.deleteEKeyPromise=function(a,c){return b.reject(Error("GroupManagerDb.deleteEKeyPromise is not implemented"))};var c=a.Name,Q=a.Data,b=a.SyncPromise,Ia=a.IdentityCertificate,x=a.SecurityException,Vb=a.RsaKeyParams,Pb=a.EncryptParams,ha=a.EncryptAlgorithmType,xa=a.Encryptor,kb=a.RsaAlgorithm,lb=a.Interval,fa=a.Schedule,mb=function(a,b,g,f,m,n){this.namespace_=(new c(a)).append(xa.NAME_COMPONENT_READ).append(b);
this.database_=g;this.keySize_=f;this.freshnessHours_=m;this.keyChain_=n};q.GroupManager=mb;mb.prototype.getGroupKeyPromise=function(a,g,f){void 0==g&&(g=!0);var m=[],n=[],p=this,s,q,H,x;return this.calculateIntervalPromise_(a,m,f).then(function(a){if(!1==a.isValid())return b.resolve(n);H=fa.toIsoString(a.getStartTime());x=fa.toIsoString(a.getEndTime());var P=new c(p.namespace_);P.append(xa.NAME_COMPONENT_E_KEY).append(H).append(x);return b.resolve().then(function(){return g?b.resolve(!1):p.database_.hasEKeyPromise(P,
f)}).then(function(a){return!g&&a?p.getEKeyPromise_(P,f).then(function(a){s=a.privateKey;q=a.publicKey;return b.resolve()}):p.generateKeyPairPromise_(f).then(function(a){s=a.privateKeyBlob;q=a.publicKeyBlob;return p.deleteEKeyPromise_(P,f)}).then(function(){return p.addEKeyPromise_(P,q,s,f)})}).then(function(){return p.createEKeyDataPromise_(H,x,q,f)}).then(function(a){function c(a){return a>=m.length?b.resolve():p.createDKeyDataPromise_(H,x,m[a].keyName,s,m[a].publicKey,f).then(function(b){n.push(b);
return c(a+1)})}n.push(a);return c(0)}).then(function(){return b.resolve(n)})})};mb.prototype.addSchedulePromise=function(a,b,c){return this.database_.addSchedulePromise(a,b,c)};mb.prototype.deleteSchedulePromise=function(a,b){return this.database_.deleteSchedulePromise(a,b)};mb.prototype.updateSchedulePromise=function(a,b,c){return this.database_.updateSchedulePromise(a,b,c)};mb.prototype.addMemberPromise=function(a,b,c){b=new Ia(b);return this.database_.addMemberPromise(a,b.getPublicKeyName(),b.getPublicKeyInfo().getKeyDer(),
c)};mb.prototype.removeMemberPromise=function(a,b){return this.database_.deleteMemberPromise(a,b)};mb.prototype.updateMemberSchedulePromise=function(a,b,c){return this.database_.updateMemberSchedulePromise(a,b,c)};mb.prototype.cleanEKeysPromise=function(a){return this.database_.cleanEKeysPromise(a)};mb.prototype.calculateIntervalPromise_=function(a,c,g){var f=new lb,m=new lb;c.splice(0,c.length);var n=this;return this.database_.listAllScheduleNamesPromise(g).then(function(p){function s(q){if(q>=p.length)return b.resolve();
var H=p[q];return n.database_.getSchedulePromise(H,g).then(function(b){b=b.getCoveringInterval(a);var p=b.interval;if(b.isPositive)return f.isValid()||(f=p),f.intersectWith(p),n.database_.getScheduleMembersPromise(H,g).then(function(a){for(var b=0;b<a.length;++b)mb.memberKeysAdd_(c,a[b]);return s(q+1)});m.isValid()||(m=p);m.intersectWith(p);return s(q+1)})}return s(0)}).then(function(){if(!f.isValid())return b.resolve(new lb(!1));var a;a=m.isValid()?f.intersectWith(m):f;return b.resolve(a)})};mb.memberKeysAdd_=
function(a,b){for(var c=0;c<a.length;){var g=a[c].keyName.compare(b.keyName);if(0==g)return;if(0<g)break;c+=1}a.splice(c,0,b)};mb.prototype.generateKeyPairPromise_=function(a){a=new Vb(this.keySize_);return kb.generateKeyPromise(a).then(function(a){a=a.getKeyBits();var c=kb.deriveEncryptKey(a).getKeyBits();return b.resolve({privateKeyBlob:a,publicKeyBlob:c})})};mb.prototype.createEKeyDataPromise_=function(a,b,g,f){f=new c(this.namespace_);f.append(xa.NAME_COMPONENT_E_KEY).append(a).append(b);a=new Q(f);
a.getMetaInfo().setFreshnessPeriod(this.freshnessHours_*mb.MILLISECONDS_IN_HOUR);a.setContent(g);return this.keyChain_.signPromise(a)};mb.prototype.createDKeyDataPromise_=function(a,g,f,m,n,p){var s=new c(this.namespace_);s.append(xa.NAME_COMPONENT_D_KEY);s.append(a).append(g);var q=new Q(s);q.getMetaInfo().setFreshnessPeriod(this.freshnessHours_*mb.MILLISECONDS_IN_HOUR);a=new Pb(ha.RsaOaep);var H=this;return xa.encryptDataPromise(q,m,f,n,a,p).catch(function(a){return b.reject(x(Error("createDKeyData: Error in encryptData: "+
a)))}).then(function(){return H.keyChain_.signPromise(q)})};mb.prototype.addEKeyPromise_=function(a,b,c,g){return this.database_.addEKeyPromise(a,b,c,g)};mb.prototype.getEKeyPromise_=function(a,b){return this.database_.getEKeyPromise(a,b)};mb.prototype.deleteEKeyPromise_=function(a,b){return this.database_.deleteEKeyPromise(a,b)};mb.MILLISECONDS_IN_HOUR=36E5;lb=function Xe(a,b){if("object"===typeof a&&a instanceof Xe)this.startTime_=a.startTime_,this.endTime_=a.endTime_,this.isValid_=a.isValid_;else if("number"===
typeof a){if(!(a<b))throw Error("Interval start time must be less than the end time");this.startTime_=a;this.endTime_=b;this.isValid_=!0}else this.startTime_=-Number.MAX_VALUE,this.endTime_=-Number.MAX_VALUE,this.isValid_=a?!0:!1};q.Interval=lb;lb.prototype.set=function(a){this.startTime_=a.startTime_;this.endTime_=a.endTime_;this.isValid_=a.isValid_};lb.prototype.covers=function(a){if(!this.isValid_)throw Error("Interval.covers: This Interval is invalid");return this.isEmpty()?!1:this.startTime_<=
a&&a<this.endTime_};lb.prototype.intersectWith=function(a){if(!this.isValid_)throw Error("Interval.intersectWith: This Interval is invalid");if(!a.isValid_)throw Error("Interval.intersectWith: The other Interval is invalid");if(this.isEmpty()||a.isEmpty()||this.startTime_>=a.endTime_||this.endTime_<=a.startTime_)return this.startTime_=this.endTime_,this;this.startTime_<=a.startTime_&&(this.startTime_=a.startTime_);this.endTime_>a.endTime_&&(this.endTime_=a.endTime_);return this};lb.prototype.unionWith=
function(a){if(!this.isValid_)throw Error("Interval.intersectWith: This Interval is invalid");if(!a.isValid_)throw Error("Interval.intersectWith: The other Interval is invalid");if(this.isEmpty())return this.startTime_=a.startTime_,this.endTime_=a.endTime_,this;if(a.isEmpty())return this;if(this.startTime_>=a.endTime_||this.endTime_<=a.startTime_)throw Error("Interval.unionWith: The two intervals do not have an intersection");this.startTime_>a.startTime_&&(this.startTime_=a.startTime_);this.endTime_<
a.endTime_&&(this.endTime_=a.endTime_);return this};lb.prototype.getStartTime=function(){if(!this.isValid_)throw Error("Interval.getStartTime: This Interval is invalid");return this.startTime_};lb.prototype.getEndTime=function(){if(!this.isValid_)throw Error("Interval.getEndTime: This Interval is invalid");return this.endTime_};lb.prototype.isValid=function(){return this.isValid_};lb.prototype.isEmpty=function(){if(!this.isValid_)throw Error("Interval.isEmpty: This Interval is invalid");return this.startTime_==
this.endTime_};var b=a.SyncPromise,Cc=function(){};q.ProducerDb=Cc;Cc.Error=function(a){if(a)return a.__proto__=Cc.Error.prototype,a};Cc.Error.prototype=Error();Cc.Error.prototype.name="ProducerDbError";Cc.prototype.hasContentKeyPromise=function(a,c){return b.reject(Error("ProducerDb.hasContentKeyPromise is not implemented"))};Cc.prototype.getContentKeyPromise=function(a,c){return b.reject(Error("ProducerDb.getContentKeyPromise is not implemented"))};Cc.prototype.addContentKeyPromise=function(a,c,
g){return b.reject(Error("ProducerDb.addContentKeyPromise is not implemented"))};Cc.prototype.deleteContentKeyPromise=function(a,c){return b.reject(Error("ProducerDb.deleteContentKeyPromise is not implemented"))};Cc.getFixedTimeSlot=function(a){return Math.floor(Math.round(a)/36E5)};var c=a.Name,F=a.Interest,Q=a.Data,wb=a.Link,hb=a.NetworkNack,Ra=a.Exclude,xa=a.Encryptor,Pb=a.EncryptParams,ha=a.EncryptAlgorithmType,od=a.AesKeyParams,Eb=a.AesAlgorithm,fa=a.Schedule,pc=a.EncryptError,O=a.NdnCommon,
b=a.SyncPromise,ja=function Fe(a,b,g,f,m,n,p){this.face_=g;this.keyChain_=f;this.database_=m;this.maxRepeatAttempts_=void 0==n?3:n;this.keyRetrievalLink_=void 0==p?Fe.NO_LINK:new wb(p);this.eKeyInfo_={};this.keyRequests_={};g=new c(a);f=new c(b);for(g.append(xa.NAME_COMPONENT_READ);0<f.size();)m=new c(g),m.append(f),m.append(xa.NAME_COMPONENT_E_KEY),this.eKeyInfo_[m.toUri()]={keyName:m,keyInfo:new Fe.KeyInfo_},f=f.getPrefix(-1);g.append(b);this.namespace_=new c(a);this.namespace_.append(xa.NAME_COMPONENT_SAMPLE);
this.namespace_.append(b)};q.Producer=ja;ja.prototype.createContentKey=function(a,b,g,f){f||(f=ja.defaultOnError);var m=ja.getRoundedTimeSlot_(a),n=new c(this.namespace_);n.append(xa.NAME_COMPONENT_C_KEY);n.append(fa.toIsoString(m));var p,s=this;this.database_.hasContentKeyPromise(a).then(function(m){m?null!=g&&g(n):(m=new od(128),p=Eb.generateKey(m).getKeyBits(),s.database_.addContentKeyPromise(a,p).then(function(){var m=Math.round(a);s.keyRequests_[m]=new ja.KeyRequest_(s.getEKeyInfoSize_());var m=
s.keyRequests_[m],p=new Ra;ja.excludeAfter(p,new c.Component(fa.toIsoString(a)));for(var Bc in s.eKeyInfo_){var q=s.eKeyInfo_[Bc],H=q.keyInfo;a<H.beginTimeSlot||a>=H.endTimeSlot?(m.repeatAttempts[Bc]=0,s.sendKeyInterest_((new F(q.keyName)).setExclude(p).setChildSelector(1),a,b,f)):(q=new c(q.keyName),q.append(fa.toIsoString(H.beginTimeSlot)),q.append(fa.toIsoString(H.endTimeSlot)),s.encryptContentKeyPromise_(H.keyBits,q,a,b,f))}null!=g&&g(n)}))})};ja.prototype.produce=function(a,b,g,f,m){m||(m=ja.defaultOnError);
var n=this;this.createContentKey(b,null,function(p){n.database_.getContentKeyPromise(b).then(function(f){var m=new c(n.namespace_);m.append(fa.toIsoString(b));a.setName(m);m=new Pb(ha.AesCbc,16);return xa.encryptData(a,g,p,f,m)}).then(function(){return n.keyChain_.signPromise(a)}).then(function(){try{f()}catch(a){console.log("Error in onComplete: "+O.getErrorWithStackTrace(a))}},function(a){try{m(pc.ErrorCode.General,""+a)}catch(b){console.log("Error in onError: "+O.getErrorWithStackTrace(b))}})},
m)};ja.defaultOnError=function(a,b){};ja.KeyInfo_=function(){this.endTimeSlot=this.beginTimeSlot=0;this.keyBits=null};ja.KeyRequest_=function(a){this.interestCount=a;this.repeatAttempts={};this.encryptedKeys=[]};ja.getRoundedTimeSlot_=function(a){return Math.round(36E5*Math.floor(Math.round(a)/36E5))};ja.prototype.sendKeyInterest_=function(a,b,c,g){var f=this;0!==this.keyRetrievalLink_.getDelegations().size()&&(a=new F(a),a.setLinkWireEncoding(this.keyRetrievalLink_.wireEncode()));this.face_.expressInterest(a,
function(a,m){f.handleCoveringKey_(a,m,b,c,g)},function(a){f.handleTimeout_(a,b,c,g)},function(a,m){f.handleNetworkNack_(a,m,b,c,g)})};ja.prototype.handleTimeout_=function(a,b,c,g){var f=Math.round(b),f=this.keyRequests_[f],m=a.getName().toUri();f.repeatAttempts[m]<this.maxRepeatAttempts_?(++f.repeatAttempts[m],this.sendKeyInterest_(a,b,c,g)):this.handleNetworkNack_(a,new hb,b,c,g)};ja.prototype.handleNetworkNack_=function(a,b,c,g,f){a=Math.round(c);this.updateKeyRequest_(this.keyRequests_[a],a,g)};
ja.prototype.updateKeyRequest_=function(a,b,c){--a.interestCount;if(0==a.interestCount&&null!=c){try{c(a.encryptedKeys)}catch(g){console.log("Error in onEncryptedKeys: "+O.getErrorWithStackTrace(g))}delete this.keyRequests_[b]}};ja.prototype.handleCoveringKey_=function(a,b,c,g,f){var m=Math.round(c),m=this.keyRequests_[m],n=a.getName(),p=n.toUri(),s=b.getName(),q=fa.fromIsoString(s.get(ja.START_TIME_STAMP_INDEX).getValue().toString()),H=fa.fromIsoString(s.get(ja.END_TIME_STAMP_INDEX).getValue().toString());
if(c>=H)a=new Ra(a.getExclude()),ja.excludeBefore(a,s.get(ja.START_TIME_STAMP_INDEX)),m.repeatAttempts[p]=0,this.sendKeyInterest_((new F(n)).setExclude(a).setChildSelector(1),c,g,f);else{var x=b.getContent(),P=this;this.encryptContentKeyPromise_(x,s,c,g,f).then(function(a){a&&(a=P.eKeyInfo_[p].keyInfo,a.beginTimeSlot=q,a.endTimeSlot=H,a.keyBits=x)})}};ja.prototype.encryptContentKeyPromise_=function(a,g,f,m,n){var p=Math.round(f),s=this.keyRequests_[p],q=new c(this.namespace_);q.append(xa.NAME_COMPONENT_C_KEY);
q.append(fa.toIsoString(ja.getRoundedTimeSlot_(f)));var H,x=this;return this.database_.getContentKeyPromise(f).then(function(b){H=new Q;H.setName(q);var c=new Pb(ha.RsaOaep);return xa.encryptDataPromise(H,b,g,a,c)}).then(function(){return b.resolve(!0)},function(a){try{n(pc.ErrorCode.EncryptionFailure,"encryptData failed: "+a)}catch(c){console.log("Error in onError: "+O.getErrorWithStackTrace(c))}return b.resolve(!1)}).then(function(a){return a?x.keyChain_.signPromise(H).then(function(){s.encryptedKeys.push(H);
x.updateKeyRequest_(s,p,m);return b.resolve(!0)}):b.resolve(!1)})};ja.prototype.getEKeyInfoSize_=function(){var a=0;for(key in this.eKeyInfo_)this.eKeyInfo_.hasOwnProperty(key)&&++a;return a};ja.ExcludeEntry=function(a,b){this.component_=a;this.anyFollowsComponent_=b};ja.getExcludeEntries=function(a){for(var b=[],g=0;g<a.size();++g)a.get(g)==Ra.ANY?0==b.length?b.push(new ja.ExcludeEntry(new c.Component,!0)):b[b.length-1].anyFollowsComponent_=!0:b.push(new ja.ExcludeEntry(a.get(g),!1));return b};ja.setExcludeEntries=
function(a,b){a.clear();for(var c=0;c<b.length;++c){var g=b[c];0==c&&0==g.component_.getValue().size()&&g.anyFollowsComponent_?a.appendAny():(a.appendComponent(g.component_),g.anyFollowsComponent_&&a.appendAny())}};ja.findEntryBeforeOrAt=function(a,b){for(var c=a.length-1;0<=c&&!(0>=a[c].component_.compare(b));)--c;return c};ja.excludeAfter=function(a,b){var c=ja.getExcludeEntries(a),g;g=ja.findEntryBeforeOrAt(c,b);if(0>g)c.splice(0,0,new ja.ExcludeEntry(b,!0)),g=0;else{var f=c[g];f.anyFollowsComponent_||
(f.component_.equals(b)?f.anyFollowsComponent_=!0:(c.splice(g+1,0,new ja.ExcludeEntry(b,!0)),g+=1))}g+=1;c.splice(g,c.length-g);ja.setExcludeEntries(a,c)};ja.excludeBefore=function(a,b){ja.excludeRange(a,new c.Component,b)};ja.excludeRange=function(a,b,c){if(0<=b.compare(c)){if(0==b.compare(c))throw Error("excludeRange: from == to. To exclude a single component, sue excludeOne.");throw Error("excludeRange: from must be less than to. Invalid range: ["+b.toEscapedString()+", "+c.toEscapedString()+"]");
}var g=ja.getExcludeEntries(a),f=ja.findEntryBeforeOrAt(g,b);if(0>f)g.splice(0,0,new ja.ExcludeEntry(b,!0)),b=0;else{var m=g[f];m.anyFollowsComponent_?b=f:m.component_.equals(b)?(m.anyFollowsComponent_=!0,b=f):(g.splice(f+1,0,new ja.ExcludeEntry(b,!0)),b=f+1)}f=ja.findEntryBeforeOrAt(g,c);m=g[f];f==b?g.splice(b+1,0,new ja.ExcludeEntry(c,!1)):(m.anyFollowsComponent_?c=f+1:m.component_.equals(c)?c=f:(g.splice(f+1,0,new ja.ExcludeEntry(c,!1)),c=f+1),b+=1,g.splice(b,c-b));ja.setExcludeEntries(a,g)};ja.START_TIME_STAMP_INDEX=
-2;ja.END_TIME_STAMP_INDEX=-1;ja.NO_LINK=new wb;var lb=a.Interval,Ca=function Pd(a,b,c,g,f,m){if("object"===typeof a&&a instanceof Pd)repetitiveInterval=a,this.startDate_=repetitiveInterval.startDate_,this.endDate_=repetitiveInterval.endDate_,this.intervalStartHour_=repetitiveInterval.intervalStartHour_,this.intervalEndHour_=repetitiveInterval.intervalEndHour_,this.nRepeats_=repetitiveInterval.nRepeats_,this.repeatUnit_=repetitiveInterval.repeatUnit_;else if("number"===typeof a){void 0==f&&(f=0);
void 0==m&&(m=Pd.RepeatUnit.NONE);this.startDate_=Pd.toDateOnlyMilliseconds_(a);this.endDate_=Pd.toDateOnlyMilliseconds_(b);this.intervalStartHour_=Math.round(c);this.intervalEndHour_=Math.round(g);this.nRepeats_=Math.round(f);this.repeatUnit_=m;if(!(this.intervalStartHour_<this.intervalEndHour_))throw Error("ReptitiveInterval: startHour must be less than endHour");if(!(this.startDate_<=this.endDate_))throw Error("ReptitiveInterval: startDate must be earlier than or same as endDate");if(!(0<=this.intervalStartHour_))throw Error("ReptitiveInterval: intervalStartHour must be non-negative");
if(!(1<=this.intervalEndHour_&&24>=this.intervalEndHour_))throw Error("ReptitiveInterval: intervalEndHour must be from 1 to 24");if(this.repeatUnit_==Pd.RepeatUnit.NONE&&this.startDate_!=this.endDate_)throw Error("ReptitiveInterval: With RepeatUnit.NONE, startDate must equal endDate");}else this.startDate_=-Number.MAX_VALUE,this.endDate_=-Number.MAX_VALUE,this.intervalStartHour_=0,this.intervalEndHour_=24,this.nRepeats_=0,this.repeatUnit_=Pd.RepeatUnit.NONE};q.RepetitiveInterval=Ca;Ca.RepeatUnit=
{NONE:0,DAY:1,MONTH:2,YEAR:3};Ca.prototype.getInterval=function(a){var b,c;this.hasIntervalOnDate_(a)?(b=Ca.toDateOnlyMilliseconds_(a)+this.intervalStartHour_*Ca.MILLISECONDS_IN_HOUR,c=Ca.toDateOnlyMilliseconds_(a)+this.intervalEndHour_*Ca.MILLISECONDS_IN_HOUR,a<b?(c=b,b=Ca.toDateOnlyMilliseconds_(a),a=!1):a>c?(b=c,c=Ca.toDateOnlyMilliseconds_(a)+Ca.MILLISECONDS_IN_DAY,a=!1):a=!0):(b=Ca.toDateOnlyMilliseconds_(a),c=Ca.toDateOnlyMilliseconds_(a)+24*Ca.MILLISECONDS_IN_HOUR,a=!1);return{isPositive:a,
interval:new lb(b,c)}};Ca.prototype.compare=function(a){return this.startDate_<a.startDate_?-1:this.startDate_>a.startDate_?1:this.endDate_<a.endDate_?-1:this.endDate_>a.endDate_?1:this.intervalStartHour_<a.intervalStartHour_?-1:this.intervalStartHour_>a.intervalStartHour_?1:this.intervalEndHour_<a.intervalEndHour_?-1:this.intervalEndHour_>a.intervalEndHour_?1:this.nRepeats_<a.nRepeats_?-1:this.nRepeats_>a.nRepeats_?1:this.repeatUnit_<a.repeatUnit_?-1:this.repeatUnit_>a.repeatUnit_?1:0};Ca.prototype.getStartDate=
function(){return this.startDate_};Ca.prototype.getEndDate=function(){return this.endDate_};Ca.prototype.getIntervalStartHour=function(){return this.intervalStartHour_};Ca.prototype.getIntervalEndHour=function(){return this.intervalEndHour_};Ca.prototype.getNRepeats=function(){return this.nRepeats_};Ca.prototype.getRepeatUnit=function(){return this.repeatUnit_};Ca.prototype.hasIntervalOnDate_=function(a){a=Ca.toDateOnlyMilliseconds_(a);if(a<this.startDate_||a>this.endDate_)return!1;if(this.repeatUnit_==
Ca.RepeatUnit.NONE)return!0;if(this.repeatUnit_==Ca.RepeatUnit.DAY){if(0==(a-this.startDate_)/Ca.MILLISECONDS_IN_DAY%this.nRepeats_)return!0}else{a=new Date(a);var b=new Date(this.startDate_);if(this.repeatUnit_==Ca.RepeatUnit.MONTH&&a.getUTCDate()==b.getUTCDate()){if(0==(12*(a.getUTCFullYear()-b.getUTCFullYear())+a.getUTCMonth()-b.getUTCMonth())%this.nRepeats_)return!0}else if(this.repeatUnit_==Ca.RepeatUnit.YEAR&&a.getUTCDate()==b.getUTCDate()&&a.getUTCMonth()==b.getUTCMonth()&&0==(a.getUTCFullYear()-
b.getUTCFullYear())%this.nRepeats_)return!0}return!1};Ca.toDateOnlyMilliseconds_=function(a){a=Math.round(a);return a-=a%Ca.MILLISECONDS_IN_DAY};Ca.MILLISECONDS_IN_HOUR=36E5;Ca.MILLISECONDS_IN_DAY=864E5;lb=a.Interval;Ca=a.RepetitiveInterval;n=a.Tlv;ta=a.TlvEncoder;na=a.TlvDecoder;p=a.Blob;fa=function Ze(a){"object"===typeof a&&a instanceof Ze?(this.whiteIntervalList_=a.whiteIntervalList_.slice(0),this.blackIntervalList_=a.blackIntervalList_.slice(0)):(this.whiteIntervalList_=[],this.blackIntervalList_=
[])};q.Schedule=fa;fa.prototype.addWhiteInterval=function(a){fa.sortedSetAdd_(this.whiteIntervalList_,a);return this};fa.prototype.addBlackInterval=function(a){fa.sortedSetAdd_(this.blackIntervalList_,a);return this};fa.prototype.getCoveringInterval=function(a){var b=new lb(!0),c=new lb(!0),g=new lb,f=new lb;fa.calculateIntervalResult_(this.blackIntervalList_,a,b,g);if(!b.isEmpty())return{isPositive:!1,interval:b};fa.calculateIntervalResult_(this.whiteIntervalList_,a,c,f);return c.isEmpty()&&!f.isValid()?
(a=Ca.toDateOnlyMilliseconds_(a),{isPositive:!1,interval:new lb(a,a+Ca.MILLISECONDS_IN_DAY)}):c.isEmpty()?{isPositive:!1,interval:f}:g.isValid()?{isPositive:!0,interval:c.intersectWith(g)}:{isPositive:!0,interval:c}};fa.prototype.wireEncode=function(){for(var a=new ta(256),b=a.getLength(),c=a.getLength(),g=this.blackIntervalList_.length-1;0<=g;g--)fa.encodeRepetitiveInterval_(this.blackIntervalList_[g],a);a.writeTypeAndLength(n.Encrypt_BlackIntervalList,a.getLength()-c);c=a.getLength();for(g=this.whiteIntervalList_.length-
1;0<=g;g--)fa.encodeRepetitiveInterval_(this.whiteIntervalList_[g],a);a.writeTypeAndLength(n.Encrypt_WhiteIntervalList,a.getLength()-c);a.writeTypeAndLength(n.Encrypt_Schedule,a.getLength()-b);return new p(a.getOutput(),!1)};fa.prototype.wireDecode=function(a){a="object"===typeof a&&a instanceof p?a.buf():a;a=new na(a);var b=a.readNestedTlvsStart(n.Encrypt_Schedule);this.whiteIntervalList_=[];for(var c=a.readNestedTlvsStart(n.Encrypt_WhiteIntervalList);a.getOffset()<c;)fa.sortedSetAdd_(this.whiteIntervalList_,
fa.decodeRepetitiveInterval_(a));a.finishNestedTlvs(c);this.blackIntervalList_=[];for(c=a.readNestedTlvsStart(n.Encrypt_BlackIntervalList);a.getOffset()<c;)fa.sortedSetAdd_(this.blackIntervalList_,fa.decodeRepetitiveInterval_(a));a.finishNestedTlvs(c);a.finishNestedTlvs(b)};fa.sortedSetAdd_=function(a,b){for(var c=0;c<a.length;){var g=a[c].compare(b);if(0==g)return;if(!(0>g))break;++c}a.splice(c,0,b)};fa.encodeRepetitiveInterval_=function(a,b){var c=b.getLength();b.writeNonNegativeIntegerTlv(n.Encrypt_RepeatUnit,
a.getRepeatUnit());b.writeNonNegativeIntegerTlv(n.Encrypt_NRepeats,a.getNRepeats());b.writeNonNegativeIntegerTlv(n.Encrypt_IntervalEndHour,a.getIntervalEndHour());b.writeNonNegativeIntegerTlv(n.Encrypt_IntervalStartHour,a.getIntervalStartHour());b.writeBlobTlv(n.Encrypt_EndDate,(new p(fa.toIsoString(a.getEndDate()))).buf());b.writeBlobTlv(n.Encrypt_StartDate,(new p(fa.toIsoString(a.getStartDate()))).buf());b.writeTypeAndLength(n.Encrypt_RepetitiveInterval,b.getLength()-c)};fa.decodeRepetitiveInterval_=
function(a){var b=a.readNestedTlvsStart(n.Encrypt_RepetitiveInterval),c=fa.fromIsoString((new p(a.readBlobTlv(n.Encrypt_StartDate),!0)).toString()),g=fa.fromIsoString((new p(a.readBlobTlv(n.Encrypt_EndDate),!0)).toString()),f=a.readNonNegativeIntegerTlv(n.Encrypt_IntervalStartHour),m=a.readNonNegativeIntegerTlv(n.Encrypt_IntervalEndHour),s=a.readNonNegativeIntegerTlv(n.Encrypt_NRepeats),q=a.readNonNegativeIntegerTlv(n.Encrypt_RepeatUnit);a.finishNestedTlvs(b);return new Ca(c,g,f,m,s,q)};fa.calculateIntervalResult_=
function(a,b,c,g){for(var f=0;f<a.length;++f){var m=a[f].getInterval(b),n=m.interval;!0==m.isPositive?c.unionWith(n):g.isValid()?g.intersectWith(n):g.set(n)}};fa.toIsoString=function(a){a=new Date(Math.round(a));return a.getUTCFullYear()+fa.to2DigitString(a.getUTCMonth()+1)+fa.to2DigitString(a.getUTCDate())+"T"+fa.to2DigitString(a.getUTCHours())+fa.to2DigitString(a.getUTCMinutes())+fa.to2DigitString(a.getUTCSeconds())};fa.to2DigitString=function(a){a=a.toString();return 1===a.length?"0"+a:a};fa.fromIsoString=
function(a){if(15!=a.length||"T"!=a.substr(8,1))throw Error("fromIsoString: Format is not the expected yyyymmddThhmmss");return Date.UTC(parseInt(a.substr(0,4)),parseInt(a.substr(4,2)-1),parseInt(a.substr(6,2)),parseInt(a.substr(9,2)),parseInt(a.substr(11,2)),parseInt(a.substr(13,2)))};new hd;new ab;new Cc;var nb=a.DigestTree,F=a.Interest,Q=a.Data,c=a.Name,p=a.Blob,Ma=a.MemoryContentCache,re=a.SyncStateProto,O=a.NdnCommon,Ea=function qe(b,c,g,f,m,n,p,s,q,H){this.onReceivedSyncState=b;this.onInitialized=
c;this.applicationDataPrefixUri=g.toUri();this.applicationBroadcastPrefix=f;this.session=m;this.face=n;this.keyChain=p;this.certificateName=s;this.sync_lifetime=q;this.usrseq=-1;this.digest_tree=new nb;this.contentCache=new Ma(n);this.digest_log=[];this.digest_log.push(new qe.DigestLogEntry("00",[]));this.contentCache.registerPrefix(this.applicationBroadcastPrefix,H,this.onInterest.bind(this));this.enabled=!0;b=new F(this.applicationBroadcastPrefix);b.getName().append("00");b.setInterestLifetimeMilliseconds(1E3);
var x;try{x=dcodeIO.ProtoBuf.newBuilder().import(re).build("Sync")}catch(P){x=a.newBuilder().import(re).build("Sync")}this.SyncStateMsg=x.SyncStateMsg;this.SyncState=x.SyncState;this.face.expressInterest(b,this.onData.bind(this),this.initialTimeOut.bind(this))};q.ChronoSync2013=Ea;Ea.prototype.getProducerPrefixes=function(){for(var a=[],b=0;b<this.digest_tree.digestnode.length;++b){var c=this.digest_tree.get(b);a.push(new Ea.PrefixAndSessionNo(c.getDataPrefix(),c.getSessionNo()))}return a};Ea.prototype.getProducerSequenceNo=
function(a,b){var c=this.digest_tree.find(a,b);return 0>c?-1:this.digest_tree.get(c).getSequenceNo()};Ea.prototype.publishNextSequenceNo=function(a){a=a instanceof p?a:new p(a,!0);this.usrseq++;var b={name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:this.usrseq,session:this.session}};!a.isNull()&&0<a.size()&&(b.application_info=a.buf());a=[new this.SyncState(b)];b=new this.SyncStateMsg({ss:a});this.broadcastSyncState(this.digest_tree.getRoot(),b);this.update(a)||console.log("Warning: ChronoSync: update did not create a new digest log entry");
a=new F(this.applicationBroadcastPrefix);a.getName().append(this.digest_tree.getRoot());a.setInterestLifetimeMilliseconds(this.sync_lifetime);this.face.expressInterest(a,this.onData.bind(this),this.syncTimeout.bind(this))};Ea.prototype.getSequenceNo=function(){return this.usrseq};Ea.DigestLogEntry=function(a,b){this.digest=a;this.data=b};Ea.DigestLogEntry.prototype.getDigest=function(){return this.digest};Ea.DigestLogEntry.prototype.getData=function(){return this.data};Ea.prototype.shutdown=function(){this.enabled=
!1;this.contentCache.unregisterAll()};Ea.SyncState=function(a,b,c,g){this.dataPrefixUri_=a;this.sessionNo_=b;this.sequenceNo_=c;this.applicationInfo_=g};Ea.SyncState.prototype.getDataPrefix=function(){return this.dataPrefixUri_};Ea.SyncState.prototype.getSessionNo=function(){return this.sessionNo_};Ea.SyncState.prototype.getSequenceNo=function(){return this.sequenceNo_};Ea.SyncState.prototype.getApplicationInfo=function(){return this.applicationInfo_};Ea.PrefixAndSessionNo=function(a,b){this.dataPrefixUri_=
a;this.sessionNo_=b};Ea.PrefixAndSessionNo.prototype.getDataPrefix=function(){return this.dataPrefixUri_};Ea.PrefixAndSessionNo.prototype.getSessionNo=function(){return this.sessionNo_};Ea.prototype.broadcastSyncState=function(a,b){var c=new Uint8Array(b.toArrayBuffer()),g=new Q(this.applicationBroadcastPrefix);g.getName().append(a);g.setContent(new p(c,!1));var f=this;this.keyChain.sign(g,this.certificateName,function(){f.contentCache.add(g)})};Ea.prototype.update=function(a){for(var b=0;b<a.length;b++)0==
a[b].type&&this.digest_tree.update(a[b].name,a[b].seqno.session,a[b].seqno.seq)&&this.applicationDataPrefixUri==a[b].name&&(this.usrseq=a[b].seqno.seq);return-1==this.logfind(this.digest_tree.getRoot())?(a=new Ea.DigestLogEntry(this.digest_tree.getRoot(),a),this.digest_log.push(a),!0):!1};Ea.prototype.logfind=function(a){for(var b=0;b<this.digest_log.length;b++)if(a==this.digest_log[b].digest)return b;return-1};Ea.prototype.onInterest=function(a,b,g,f,m){this.enabled&&(a=b.getName().get(this.applicationBroadcastPrefix.size()).toEscapedString(),
b.getName().size()==this.applicationBroadcastPrefix.size()+2&&(a=b.getName().get(this.applicationBroadcastPrefix.size()+1).toEscapedString()),b.getName().size()==this.applicationBroadcastPrefix.size()+2||"00"==a?this.processRecoveryInst(b,a,g):(this.contentCache.storePendingInterest(b,g),a!=this.digest_tree.getRoot()&&(b=this.logfind(a),-1==b?(b=new F(new c("/local/timeout")),b.setInterestLifetimeMilliseconds(2E3),this.face.expressInterest(b,this.dummyOnData,this.judgeRecovery.bind(this,b,a,g))):
this.processSyncInst(b,a,g))))};Ea.prototype.onData=function(a,b){if(this.enabled){var g=new Uint8Array(b.getContent().size());g.set(b.getContent().buf());var g=this.SyncStateMsg.decode(g.buffer).ss,m=!1;"00"==this.digest_tree.getRoot()?(m=!0,this.initialOndata(g)):(this.update(g),m=a.getName().size()==this.applicationBroadcastPrefix.size()+2?!0:!1);for(var n=[],s=0;s<g.length;s++)if(0==g[s].type){var q;g[s].application_info?(q=g[s].application_info.toBinary(),q=0<q.length?new p(new f(q,"binary"),
!1):new p):q=new p;n.push(new Ea.SyncState(g[s].name,g[s].seqno.session,g[s].seqno.seq,q))}try{this.onReceivedSyncState(n,m)}catch(H){console.log("Error in onReceivedSyncState: "+O.getErrorWithStackTrace(H))}g=new c(this.applicationBroadcastPrefix);g.append(this.digest_tree.getRoot());a=new F(g);a.setInterestLifetimeMilliseconds(this.sync_lifetime);this.face.expressInterest(a,this.onData.bind(this),this.syncTimeout.bind(this))}};Ea.prototype.initialTimeOut=function(a){if(this.enabled){console.log("no other people");
this.usrseq++;try{this.onInitialized()}catch(b){console.log("Error in onInitialized: "+O.getErrorWithStackTrace(b))}a=[new this.SyncState({name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:this.usrseq,session:this.session}})];this.update(a);a=new c(this.applicationBroadcastPrefix);a.append(this.digest_tree.getRoot());a=new F(a);a.setInterestLifetimeMilliseconds(this.sync_lifetime);this.face.expressInterest(a,this.onData.bind(this),this.syncTimeout.bind(this))}};Ea.prototype.processRecoveryInst=
function(a,b,c){if(-1!=this.logfind(b)){b=[];for(var g=0;g<this.digest_tree.digestnode.length;g++)b[g]=new this.SyncState({name:this.digest_tree.digestnode[g].getDataPrefix(),type:"UPDATE",seqno:{seq:this.digest_tree.digestnode[g].getSequenceNo(),session:this.digest_tree.digestnode[g].getSessionNo()}});if(0!=b.length){b=new this.SyncStateMsg({ss:b});b=new Uint8Array(b.toArrayBuffer());var f=new Q(a.getName());f.setContent(new p(b,!1));"00"==a.getName().get(-1).toEscapedString()&&f.getMetaInfo().setFreshnessPeriod(1E3);
this.keyChain.sign(f,this.certificateName,function(){try{c.putData(f)}catch(a){console.log(a.toString())}})}}};Ea.prototype.processSyncInst=function(a,b,g){for(var f=[],m=[],n=[],s=[],q=a+1;q<this.digest_log.length;q++)for(var H=this.digest_log[q].getData(),x=0;x<H.length;x++)0==H[x].type&&-1!=this.digest_tree.find(H[x].name,H[x].seqno.session)&&(a=m.indexOf(H[x].name),-1==a?(m.push(H[x].name),n.push(H[x].seqno.seq),s.push(H[x].seqno.session)):(n[a]=H[x].seqno.seq,s[a]=H[x].seqno.session));for(x=
0;x<m.length;x++)f[x]=new this.SyncState({name:m[x],type:"UPDATE",seqno:{seq:n[x],session:s[x]}});if(0!=f.length){f=new this.SyncStateMsg({ss:f});f=new Uint8Array(f.toArrayBuffer());a=new c(this.prefix);a.append(this.chatroom).append(b);var P=new Q(a);P.setContent(new p(f,!1));this.keyChain.sign(P,this.certificateName,function(){try{g.putData(P)}catch(a){console.log(a.toString())}})}};Ea.prototype.sendRecovery=function(a){var b=new c(this.applicationBroadcastPrefix);b.append("recovery").append(a);
a=new F(b);a.setInterestLifetimeMilliseconds(this.sync_lifetime);this.face.expressInterest(a,this.onData.bind(this),this.syncTimeout.bind(this))};Ea.prototype.judgeRecovery=function(a,b,c){a=this.logfind(b);-1!=a?b!=this.digest_tree.root&&this.processSyncInst(a,b,c):this.sendRecovery(b)};Ea.prototype.syncTimeout=function(a){if(this.enabled&&a.getName().get(this.applicationBroadcastPrefix.size()).toEscapedString()==this.digest_tree.root){var b=new c(a.getName()),b=new F(b);a.setInterestLifetimeMilliseconds(this.sync_lifetime);
this.face.expressInterest(b,this.onData.bind(this),this.syncTimeout.bind(this))}};Ea.prototype.initialOndata=function(a){this.update(a);for(var b=this.digest_tree.getRoot(),c=0;c<a.length;c++)if(a[c].name==this.applicationDataPrefixUri&&a[c].seqno.session==this.session){var g=[new this.SyncState({name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:a[c].seqno.seq+1,session:this.session}})];if(this.update(g)){g=new Ea.DigestLogEntry(this.digest_tree.getRoot(),g);this.digest_log.push(g);try{this.onInitialized()}catch(f){console.log("Error in onInitialized: "+
O.getErrorWithStackTrace(f))}}}g=0<=this.usrseq?new this.SyncState({name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:this.usrseq,session:this.session}}):new this.SyncState({name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:0,session:this.session}});a=new this.SyncStateMsg({ss:g});this.broadcastSyncState(b,a);if(-1==this.digest_tree.find(this.applicationDataPrefixUri,this.session)&&(this.usrseq++,a=[new this.SyncState({name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:this.usrseq,
session:this.session}})],this.update(a)))try{this.onInitialized()}catch(m){console.log("Error in onInitialized: "+O.getErrorWithStackTrace(m))}};Ea.prototype.dummyOnData=function(a,b){console.log("*** dummyOnData called. ***")};ea=a;nb=function(){this.root="00";this.digestnode=[]};q.DigestTree=nb;nb.Node=function(a,b,c){this.dataPrefix=a;this.seqno_session=b;this.seqno_seq=c;this.recomputeDigest()};nb.Node.prototype.getDataPrefix=function(){return this.dataPrefix};nb.Node.prototype.getSessionNo=function(){return this.seqno_session};
nb.Node.prototype.getSequenceNo=function(){return this.seqno_seq};nb.Node.prototype.getDigest=function(){return this.digest};nb.Node.prototype.setSequenceNo=function(a){this.seqno_seq=a;this.recomputeDigest()};nb.Node.prototype.Int32ToBuffer=function(a){for(var b=new f(4),c=0;4>c;c++)b[c]=a%256,a=Math.floor(a/256);return b};nb.Node.prototype.recomputeDigest=function(){var a=ea.createHash("sha256");a.update(this.Int32ToBuffer(this.seqno_session));a.update(this.Int32ToBuffer(this.seqno_seq));var a=
a.digest(),b=ea.createHash("sha256");b.update(this.dataPrefix);var b=b.digest(),c=ea.createHash("sha256");c.update(b);c.update(a);this.digest=c.digest("hex")};nb.Node.Compare=function(a,b){return a.dataPrefix!=b.dataPrefix?a.dataPrefix<b.dataPrefix:a.seqno_session<b.seqno_session};nb.prototype.update=function(a,b,c){var g=this.find(a,b);if(0<=g)if(this.digestnode[g].getSequenceNo()<c)this.digestnode[g].setSequenceNo(c);else return!1;else a=new nb.Node(a,b,c),this.digestnode.push(a),this.digestnode.sort(this.sortNodes);
this.recomputeRoot();return!0};nb.prototype.sortNodes=function(){for(var a,b=this.digestnode.length;0<b;b--)for(var c=0;c<b-1;c++)this.digestnode[c].getDataPrefix()>this.digestnode[c+1].getDataPrefix()&&(a=this.digestnode[c],this.digestnode[c]=this.digestnode[c+1],this.digestnode[c+1]=a)};nb.prototype.sortNodes=function(a,b){return a.getDataPrefix()==b.getDataPrefix()&&a.getSessionNo()==b.getSessionNo()?0:a.getDataPrefix()>b.getDataPrefix()||a.getDataPrefix()==b.getDataPrefix()&&a.getSessionNo()>
b.getSessionNo()?1:-1};nb.prototype.find=function(a,b){for(var c=0;c<this.digestnode.length;++c)if(this.digestnode[c].getDataPrefix()==a&&this.digestnode[c].getSessionNo()==b)return c;return-1};nb.prototype.size=function(){return this.digestnode.size()};nb.prototype.get=function(a){return this.digestnode[a]};nb.prototype.getRoot=function(){return this.root};nb.prototype.recomputeRoot=function(){for(var a=ea.createHash("sha256"),b=0;b<this.digestnode.length;b++)a.update(new f(this.digestnode[b].digest,
"hex"));this.root=a.digest("hex")};re={"package":"Sync",messages:[{name:"SyncState",fields:[{rule:"required",type:"string",name:"name",id:1,options:{}},{rule:"required",type:"ActionType",name:"type",id:2,options:{}},{rule:"optional",type:"SeqNo",name:"seqno",id:3,options:{}},{rule:"optional",type:"bytes",name:"application_info",id:4,options:{}}],enums:[{name:"ActionType",values:[{name:"UPDATE",id:0},{name:"DELETE",id:1},{name:"OTHER",id:2}],options:{}}],messages:[{name:"SeqNo",fields:[{rule:"required",
type:"uint32",name:"seq",id:1,options:{}},{rule:"required",type:"uint32",name:"session",id:2,options:{}}],enums:[],messages:[],options:{}}],options:{}},{name:"SyncStateMsg",fields:[{rule:"repeated",type:"SyncState",name:"ss",id:1,options:{}}],enums:[],messages:[],options:{}}],enums:[],imports:[],options:{}};q.SyncStateProto=re;var s=a.WireFormat,bd=a.CommandInterestPreparer,Rd=function(){bd.call(this)};Rd.prototype=new bd;Rd.prototype.name="CommandInterestGenerator";q.CommandInterestGenerator=Rd;
Rd.prototype.generate=function(a,b,c,g,f){f="function"===typeof g?g:f;g="function"!==typeof g&&g?g:s.getDefaultWireFormat();this.prepareCommandInterestName(a,g);b.sign(a,c,g,function(){(null==a.getInterestLifetimeMilliseconds()||0>a.getInterestLifetimeMilliseconds())&&a.setInterestLifetimeMilliseconds(1E3);f&&f()})};var g=a.Log.LOG,qc=function(){this.table_=[]};q.InterestFilterTable=qc;qc.Entry=function(a,b,c,g){this.interestFilterId_=a;this.filter_=b;this.onInterest_=c;this.face_=g};qc.Entry.prototype.getInterestFilterId=
function(){return this.interestFilterId_};qc.Entry.prototype.getFilter=function(){return this.filter_};qc.Entry.prototype.getOnInterest=function(){return this.onInterest_};qc.Entry.prototype.getFace=function(){return this.face_};qc.prototype.setInterestFilter=function(a,b,c,g){this.table_.push(new qc.Entry(a,b,c,g))};qc.prototype.getMatchedFilters=function(a,b){for(var c=0;c<this.table_.length;++c){var g=this.table_[c];g.getFilter().doesMatch(a.getName())&&b.push(g)}};qc.prototype.unsetInterestFilter=
function(a){for(var b=0,c=this.table_.length-1;0<=c;--c)this.table_[c].getInterestFilterId()==a&&(++b,this.table_.splice(c,1));0===b&&0<g&&console.log("unsetInterestFilter: Didn't find interestFilterId "+a)};var O=a.NdnCommon,g=a.Log.LOG,Kb=function(){this.table_=[];this.removeRequests_=[]};q.PendingInterestTable=Kb;Kb.Entry=function(a,b,c,g,f){this.pendingInterestId_=a;this.interest_=b;this.onData_=c;this.onTimeout_=g;this.onNetworkNack_=f;this.timerId_=-1};Kb.Entry.prototype.getPendingInterestId=
function(){return this.pendingInterestId_};Kb.Entry.prototype.getInterest=function(){return this.interest_};Kb.Entry.prototype.getOnData=function(){return this.onData_};Kb.Entry.prototype.getOnNetworkNack=function(){return this.onNetworkNack_};Kb.Entry.prototype.callTimeout=function(){if(this.onTimeout_)try{this.onTimeout_(this.interest_)}catch(a){console.log("Error in onTimeout: "+O.getErrorWithStackTrace(a))}};Kb.Entry.prototype.setTimeout=function(a,b){-1===this.timerId_&&(this.timerId_=setTimeout(a,
b))};Kb.Entry.prototype.clearTimeout=function(){-1!==this.timerId_&&(clearTimeout(this.timerId_),this.timerId_=-1)};Kb.prototype.add=function(a,b,c,f,m){var n=this.removeRequests_.indexOf(a);if(0<=n)return this.removeRequests_.splice(n,1),null;var p=new Kb.Entry(a,b,c,f,m);this.table_.push(p);a=b.getInterestLifetimeMilliseconds()||4E3;var s=this;p.setTimeout(function(){1<g&&console.log("Interest time out: "+b.getName().toUri());var a=s.table_.indexOf(p);0<=a&&s.table_.splice(a,1);p.callTimeout()},
a);return p};Kb.prototype.extractEntriesForExpressedInterest=function(a,b){for(var c=this.table_.length-1;0<=c;--c){var g=this.table_[c];g.getInterest().matchesData(a)&&(g.clearTimeout(),b.push(g),this.table_.splice(c,1))}};Kb.prototype.extractEntriesForNackInterest=function(a,b){for(var c=a.wireEncode(),g=this.table_.length-1;0<=g;--g){var f=this.table_[g];null!=f.getOnNetworkNack()&&f.getInterest().wireEncode().equals(c)&&(f.clearTimeout(),b.push(f),this.table_.splice(g,1))}};Kb.prototype.removePendingInterest=
function(a){if(null!=a){for(var b=0,c=this.table_.length-1;0<=c;--c){var f=this.table_[c];f.getPendingInterestId()==a&&(f.clearTimeout(),this.table_.splice(c,1),++b)}0===b&&0<g&&console.log("removePendingInterest: Didn't find pendingInterestId "+a);0===b&&0>this.removeRequests_.indexOf(a)&&this.removeRequests_.push(a)}};var g=a.Log.LOG,Rc=function(a){this.interestFilterTable_=a;this.table_=[];this.removeRequests_=[]};q.RegisteredPrefixTable=Rc;Rc.prototype.add=function(a,b,c){var g=this.removeRequests_.indexOf(a);
if(0<=g)return this.removeRequests_.splice(g,1),!1;this.table_.push(new Rc._Entry(a,b,c));return!0};Rc.prototype.removeRegisteredPrefix=function(a){for(var b=0,c=this.table_.length-1;0<=c;--c){var f=this.table_[c];f.getRegisteredPrefixId()==a&&(++b,0<f.getRelatedInterestFilterId()&&this.interestFilterTable_.unsetInterestFilter(f.getRelatedInterestFilterId()),this.table_.splice(c,1))}0===b&&0<g&&console.log("removeRegisteredPrefix: Didn't find registeredPrefixId "+a);0===b&&0>this.removeRequests_.indexOf(a)&&
this.removeRequests_.push(a)};Rc._Entry=function(a,b,c){this.registeredPrefixId_=a;this.prefix_=b;this.relatedInterestFilterId_=c};Rc._Entry.prototype.getRegisteredPrefixId=function(){return this.registeredPrefixId_};Rc._Entry.prototype.getPrefix=function(){return this.prefix_};Rc._Entry.prototype.getRelatedInterestFilterId=function(){return this.relatedInterestFilterId_};$c=function(){this.congestionMark_=0};q.CongestionMark=$c;$c.prototype.getCongestionMark=function(){return this.congestionMark_};
$c.prototype.setCongestionMark=function(a){this.congestionMark_=a};$c.getFirstHeader=function(a){for(var b=0;b<a.countHeaderFields();++b){var c=a.getHeaderField(b);if(c instanceof $c)return c}return null};wc=function(){this.faceId_=null};q.IncomingFaceId=wc;wc.prototype.getFaceId=function(){return this.faceId_};wc.prototype.setFaceId=function(a){this.faceId_=a};wc.getFirstHeader=function(a){for(var b=0;b<a.countHeaderFields();++b){var c=a.getHeaderField(b);if(c instanceof wc)return c}return null};
var p=a.Blob,id=function(){this.headerFields_=[];this.fragmentWireEncoding_=new p};q.LpPacket=id;id.prototype.getFragmentWireEncoding=function(){return this.fragmentWireEncoding_};id.prototype.countHeaderFields=function(){return this.headerFields_.length};id.prototype.getHeaderField=function(a){return this.headerFields_[a]};id.prototype.clear=function(){this.headerFields_=[];this.fragmentWireEncoding_=new p};id.prototype.setFragmentWireEncoding=function(a){this.fragmentWireEncoding_="object"===typeof a&&
a instanceof p?a:new p(a)};id.prototype.addHeaderField=function(a){this.headerFields_.push(a)};var L=a.DataUtils,c=a.Name,F=a.Interest,Q=a.Data,Qa=a.ControlParameters,nc=a.ControlResponse,uc=a.InterestFilter,s=a.WireFormat,bb=a.TlvWireFormat,n=a.Tlv,na=a.TlvDecoder,Fa=a.ForwardingFlags,pb=a.Transport,se=a.TcpTransport,ze=a.UnixTransport,Rd=a.CommandInterestGenerator,p=a.Blob,O=a.NdnCommon,hb=a.NetworkNack,id=a.LpPacket,qc=a.InterestFilterTable,Kb=a.PendingInterestTable,Rc=a.RegisteredPrefixTable,
Ib=a,g=a.Log.LOG;ca=function Bc(a,b){if(!Bc.supported)throw Error("The necessary JavaScript support is not available on this platform.");var f;if("object"==typeof a&&a instanceof pb){if(this.getConnectionInfo=null,this.transport=a,this.connectionInfo=b||null,f={},null==this.connectionInfo&&this.transport&&this.transport.__proto__&&"UnixTransport"==this.transport.__proto__.name){var m=Bc.getUnixSocketFilePathForLocalhost();null!=m?this.connectionInfo=new ze.ConnectionInfo(m):console.log("Face constructor: Cannot determine the default Unix socket file path for UnixTransport");
0<g&&console.log("Using "+this.connectionInfo.toString())}}else f=a||{},this.transport=(f.getTransport||function(){return new se})(),this.getConnectionInfo=f.getConnectionInfo||this.transport.defaultGetConnectionInfo,this.connectionInfo=f.connectionInfo||null,null==this.connectionInfo&&(m=void 0!==f.host?f.host:null,this.transport&&this.transport.__proto__&&"UnixTransport"==this.transport.__proto__.name?null!=m?this.connectionInfo=new ze.ConnectionInfo(m):null==this.getConnectionInfo&&(m=Bc.getUnixSocketFilePathForLocalhost(),
null!=m?this.connectionInfo=new ze.ConnectionInfo(m):console.log("Face constructor: Cannot determine the default Unix socket file path for UnixTransport")):null!=m&&(this.connectionInfo="undefined"!=typeof Bb?new Bb.ConnectionInfo(m,f.port||9696):new se.ConnectionInfo(m,f.port||6363)));null==this.connectionInfo?this.host=this.host=null:(this.host=this.connectionInfo.host,this.host=this.connectionInfo.port);this.readyStatus=Bc.UNOPEN;this.onopen=f.onopen||function(){3<g&&console.log("Face connection established.")};
this.onclose=f.onclose||function(){3<g&&console.log("Face connection closed.")};this.onConnectedCallbacks=[];this.commandKeyChain=null;this.commandCertificateName=new c;this.commandInterestGenerator=new Rd;this.timeoutPrefix=new c("/local/timeout");this.pendingInterestTable_=new Kb;this.interestFilterTable_=new qc;this.registeredPrefixTable_=new Rc(this.interestFilterTable_);this.lastEntryId=0};q.Face=ca;ca.UNOPEN=0;ca.OPEN_REQUESTED=1;ca.OPENED=2;ca.CLOSED=3;se.importFace(ca);ca.getUnixSocketFilePathForLocalhost=
function(){var a="/var/run/nfd.sock";if(Ib.existsSync(a))return a;a="/tmp/.ndnd.sock";return Ib.existsSync(a)?a:""};ca.getSupported=function(){try{(new f(1)).slice(0,1)}catch(a){return console.log("NDN not available: Buffer not supported. "+a),!1}return!0};ca.supported=ca.getSupported();ca.prototype.createRoute=function(a,b){this.connectionInfo=a instanceof pb.ConnectionInfo?a:new se.ConnectionInfo(a,b);this.host=this.connectionInfo.host;this.host=this.connectionInfo.port};ca.prototype.close=function(){this.readyStatus==
ca.OPENED&&(this.readyStatus=ca.CLOSED,this.transport.close())};ca.prototype.getNextEntryId=function(){return++this.lastEntryId};ca.makeShuffledHostGetConnectionInfo=function(a,b,c){a=a.slice(0,a.length);L.shuffle(a);return function(){return 0==a.length?null:c(a.splice(0,1)[0],b)}};ca.prototype.expressInterest=function(a,b,c,g,f,m){var n;"object"===typeof a&&a instanceof F?n=new F(a):b&&"object"===typeof b&&b instanceof F?(n=new F(b),n.setName(a),b=c,c=g,g=f,f=m):(n=new F(a),n.setInterestLifetimeMilliseconds(4E3));
var p=b,q,H,x;q="function"===typeof c?c:function(){};H="function"===typeof g?g:null;x=c instanceof s?c:g instanceof s?g:f instanceof s?f:s.getDefaultWireFormat();var P=this.getNextEntryId();n.setNonce(ca.nonceTemplate_);n.refreshNonce();if(null==this.connectionInfo)if(null==this.getConnectionInfo)console.log("ERROR: connectionInfo is NOT SET");else{var z=this;this.connectAndExecute(function(){z.reconnectAndExpressInterest(P,n,p,q,H,x)})}else this.reconnectAndExpressInterest(P,n,p,q,H,x);return P};
ca.prototype.reconnectAndExpressInterest=function(a,b,c,g,f,m){var n=this;if(this.connectionInfo.equals(this.transport.connectionInfo)&&this.readyStatus!==ca.UNOPEN)if(this.readyStatus===ca.OPEN_REQUESTED)this.onConnectedCallbacks.push(function(){n.expressInterestHelper(a,b,c,g,f,m)});else if(this.readyStatus===ca.OPENED)this.expressInterestHelper(a,b,c,g,f,m);else throw Error("reconnectAndExpressInterest: unexpected connection is not opened");else this.readyStatus=ca.OPEN_REQUESTED,this.onConnectedCallbacks.push(function(){n.expressInterestHelper(a,
b,c,g,f,m)}),this.transport.connect(this.connectionInfo,this,function(){for(n.readyStatus=ca.OPENED;0<n.onConnectedCallbacks.length;)try{n.onConnectedCallbacks.shift()()}catch(a){console.log("Face.reconnectAndExpressInterest: ignoring exception from onConnectedCallbacks: "+a)}if(n.onopen)n.onopen()},function(){n.closeByTransport()})};ca.prototype.expressInterestHelper=function(a,b,c,g,f,m){if(null!=this.pendingInterestTable_.add(a,b,c,g,f)&&!this.timeoutPrefix.match(b.getName())){a=b.wireEncode(m);
if(a.size()>ca.getMaxNdnPacketSize())throw Error("The encoded interest size exceeds the maximum limit getMaxNdnPacketSize()");this.transport.send(a.buf())}};ca.prototype.removePendingInterest=function(a){this.pendingInterestTable_.removePendingInterest(a)};ca.prototype.setCommandSigningInfo=function(a,b){this.commandKeyChain=a;this.commandCertificateName=new c(b)};ca.prototype.setCommandCertificateName=function(a){this.commandCertificateName=new c(a)};ca.prototype.makeCommandInterest=function(a,b,
c){c="function"===typeof b?b:c;b="function"!==typeof b&&b?b:s.getDefaultWireFormat();this.nodeMakeCommandInterest(a,this.commandKeyChain,this.commandCertificateName,b,c)};ca.prototype.nodeMakeCommandInterest=function(a,b,c,g,f){this.commandInterestGenerator.generate(a,b,c,g,f)};ca.prototype.registerPrefix=function(a,b,c,g,f,m){var n=g,p=f,q=m;g="function"===typeof n?n:null;f=n instanceof Fa?n:p instanceof Fa?p:new Fa;m=n instanceof s?n:p instanceof s?p:q instanceof s?q:s.getDefaultWireFormat();c||
(c=function(){});var H=this.getNextEntryId(),x=this,n=function(){x.nfdRegisterPrefix(H,a,b,f,c,g,x.commandKeyChain,x.commandCertificateName,m)};null==this.connectionInfo?null==this.getConnectionInfo?console.log("ERROR: connectionInfo is NOT SET"):this.connectAndExecute(n):n();return H};ca.getMaxNdnPacketSize=function(){return O.MAX_NDN_PACKET_SIZE};ca.RegisterResponse=function(a,b,c,g,f,m){this.prefix=a;this.onRegisterFailed=b;this.onRegisterSuccess=c;this.registeredPrefixId=g;this.parent=f;this.onInterest=
m};ca.RegisterResponse.prototype.onData=function(a,b){var c=new nc;try{c.wireDecode(b.getContent(),bb.get())}catch(f){0<g&&console.log("Register prefix failed: Error decoding the NFD response: "+f);if(this.onRegisterFailed)try{this.onRegisterFailed(this.prefix)}catch(m){console.log("Error in onRegisterFailed: "+O.getErrorWithStackTrace(m))}return}if(200!=c.getStatusCode()){if(0<g&&console.log("Register prefix failed: Expected NFD status code 200, got: "+c.getStatusCode()),this.onRegisterFailed)try{this.onRegisterFailed(this.prefix)}catch(n){console.log("Error in onRegisterFailed: "+
O.getErrorWithStackTrace(n))}}else{if(0!=this.registeredPrefixId&&(c=0,null!=this.onInterest&&(c=this.parent.setInterestFilter(new uc(this.prefix),this.onInterest)),!this.parent.registeredPrefixTable_.add(this.registeredPrefixId,this.prefix,c))){0<c&&this.parent.unsetInterestFilter(c);return}2<g&&console.log("Register prefix succeeded with the NFD forwarder for prefix "+this.prefix.toUri());if(null!=this.onRegisterSuccess)try{this.onRegisterSuccess(this.prefix,this.registeredPrefixId)}catch(p){console.log("Error in onRegisterSuccess: "+
O.getErrorWithStackTrace(p))}}};ca.RegisterResponse.prototype.onTimeout=function(a){2<g&&console.log("Timeout for NFD register prefix command.");if(this.onRegisterFailed)try{this.onRegisterFailed(this.prefix)}catch(b){console.log("Error in onRegisterFailed: "+O.getErrorWithStackTrace(b))}};ca.prototype.nfdRegisterPrefix=function(a,b,f,m,n,p,s,q,H){if(null==s)throw Error("registerPrefix: The command KeyChain has not been set. You must call setCommandSigningInfo.");if(0==q.size())throw Error("registerPrefix: The command certificate name has not been set. You must call setCommandSigningInfo.");
var x=new Qa;x.setName(b);x.setForwardingFlags(m);var P=this;this.isLocal(function(g){var m=new F;g?(m.setName(new c("/localhost/nfd/rib/register")),m.setInterestLifetimeMilliseconds(2E3)):(m.setName(new c("/localhop/nfd/rib/register")),m.setInterestLifetimeMilliseconds(4E3));m.getName().append(x.wireEncode(bb.get()));P.nodeMakeCommandInterest(m,s,q,bb.get(),function(){var c=new ca.RegisterResponse(b,n,p,a,P,f);P.reconnectAndExpressInterest(null,m,c.onData.bind(c),c.onTimeout.bind(c),null,H)})},function(a){0<
g&&console.log("Error in Transport.isLocal: "+a);if(n)try{n(b)}catch(c){console.log("Error in onRegisterFailed: "+O.getErrorWithStackTrace(c))}})};ca.prototype.removeRegisteredPrefix=function(a){this.registeredPrefixTable_.removeRegisteredPrefix(a)};ca.prototype.setInterestFilter=function(a,b){var c=this.getNextEntryId();this.interestFilterTable_.setInterestFilter(c,new uc(a),b,this);return c};ca.prototype.unsetInterestFilter=function(a){this.interestFilterTable_.unsetInterestFilter(a)};ca.prototype.putData=
function(a,b){b=b||s.getDefaultWireFormat();var c=a.wireEncode(b);if(c.size()>ca.getMaxNdnPacketSize())throw Error("The encoded Data packet size exceeds the maximum limit getMaxNdnPacketSize()");this.transport.send(c.buf())};ca.prototype.send=function(a){if(a.length>ca.getMaxNdnPacketSize())throw Error("The encoded packet size exceeds the maximum limit getMaxNdnPacketSize()");this.transport.send(a)};ca.prototype.isLocal=function(a,b){null==this.connectionInfo?a(!1):this.transport.isLocal(this.connectionInfo,
a,b)};ca.prototype.onReceivedElement=function(a){3<g&&console.log("Complete element received. Length "+a.length+". Start decoding.");var b=null;a[0]==n.LpPacket_LpPacket&&(b=new id,bb.get().decodeLpPacket(b,a,!1),a=b.getFragmentWireEncoding().buf());var c=null,f=null;if(a[0]==n.Interest||a[0]==n.Data){var m=new na(a);m.peekType(n.Interest,a.length)?(c=new F,c.wireDecode(a,bb.get()),null!=b&&c.setLpPacket(b)):m.peekType(n.Data,a.length)&&(f=new Q,f.wireDecode(a,bb.get()),null!=b&&f.setLpPacket(b))}if(null!==
b&&(b.setFragmentWireEncoding(new p),a=hb.getFirstHeader(b),null!=a)){if(null==c)return;f=[];this.pendingInterestTable_.extractEntriesForNackInterest(c,f);for(c=0;c<f.length;++c){b=f[c];try{b.getOnNetworkNack()(b.getInterest(),a)}catch(s){console.log("Error in onNetworkNack: "+O.getErrorWithStackTrace(s))}}return}null!==c?(3<g&&console.log("Interest packet received."),this.dispatchInterest_(c)):null!==f&&(3<g&&console.log("Data packet received."),this.satisfyPendingInterests_(f))};ca.prototype.dispatchInterest_=
function(a){var b=[];this.interestFilterTable_.getMatchedFilters(a,b);for(var c=0;c<b.length;++c){var f=b[c];3<g&&console.log("Found interest filter for "+a.getName().toUri());try{f.getOnInterest()(f.getFilter().getPrefix(),a,this,f.getInterestFilterId(),f.getFilter())}catch(m){console.log("Error in onInterest: "+O.getErrorWithStackTrace(m))}}};ca.prototype.satisfyPendingInterests_=function(a){var b=!1,c=[];this.pendingInterestTable_.extractEntriesForExpressedInterest(a,c);for(var g=0;g<c.length;++g){var f=
c[g],b=!0;try{f.getOnData()(f.getInterest(),a)}catch(m){console.log("Error in onData: "+O.getErrorWithStackTrace(m))}}return b};ca.prototype.connectAndExecute=function(a){var b=this.getConnectionInfo();if(null==b)console.log("ERROR: No more connectionInfo from getConnectionInfo"),this.host=this.host=this.connectionInfo=null;else if(b.equals(this.connectionInfo))console.log("ERROR: The host returned by getConnectionInfo is not alive: "+this.connectionInfo.toString());else{this.connectionInfo=b;0<g&&
console.log("connectAndExecute: trying host from getConnectionInfo: "+this.connectionInfo.toString());this.host=this.connectionInfo.host;this.host=this.connectionInfo.port;b=new F(new c("/"));b.setInterestLifetimeMilliseconds(4E3);var f=this,m=setTimeout(function(){0<g&&console.log("connectAndExecute: timeout waiting for host "+f.host);f.connectAndExecute(a)},3E3);this.reconnectAndExpressInterest(null,b,function(b,c){clearTimeout(m);0<g&&console.log("connectAndExecute: connected to host "+f.host);
a()},function(a){},null,s.getDefaultWireFormat())}};ca.prototype.closeByTransport=function(){this.readyStatus=ca.CLOSED;this.onclose()};ca.nonceTemplate_=new p(new f(4),!1);new ca(new pb,{equals:function(){return!0}});var te={};Object.keys(a).forEach(function(b){te[b]=ka[b];ka[b]=a[b]});a.noConflict=function(){Object.keys(te).forEach(function(b){ka[b]===a[b]&&("undefined"==typeof te[b]?delete ka[b]:ka[b]=te[b])});return a};ka.ndn=a})(this);
(function(ka,u,J){function S(f,u){"object"!==typeof u&&(u=u());Object.keys(u).forEach(function(D){f[D]=u[D]});return f}function T(f){return{from:function(u){f.prototype=Object.create(u.prototype);f.prototype.constructor=f;return{extend:function(D){S(f.prototype,"object"!==typeof D?D(u.prototype):D)}}}}}function V(f,u){return u(f)}function K(x,u){function D(a){this._cfg={version:a,storesSource:null,dbschema:{},tables:{},contentUpgrade:null};this.stores({})}function Yb(f,c,n,p){if(0===f){Object.keys(aa).forEach(function(a){q(c,
a,aa[a].primKey,aa[a].indexes)});var s=L._createTransaction(b,Xc,aa);s.idbtrans=c;s.idbtrans.onerror=La(n,["populating database"]);s.on("error").subscribe(n);R.newPSD(function(){R.PSD.trans=s;try{L.on("populate").fire(s)}catch(a){p.onerror=c.onerror=function(a){a.preventDefault()};try{c.abort()}catch(b){}c.db.close();n(a)}})}else{var x=[],g=Hc.filter(function(a){return a._cfg.version===f})[0];if(!g)throw new Ha("Dexie specification of currently installed DB version is missing");aa=L._dbSchema=g._cfg.dbschema;
var z=!1;Hc.filter(function(a){return a._cfg.version>f}).forEach(function(g){var f=aa,p=g._cfg.dbschema;Gc(f,c);Gc(p,c);aa=L._dbSchema=p;f=a(f,p);f.add.forEach(function(a){x.push(function(b,c){q(b,a[0],a[1].primKey,a[1].indexes);c()})});f.change.forEach(function(a){if(a.recreate)throw new Ha("Not yet support for changing primary key");x.push(function(b,c){var g=b.objectStore(a.name);a.add.forEach(function(a){Sb(g,a)});a.change.forEach(function(a){g.deleteIndex(a.name);Sb(g,a)});a.del.forEach(function(a){g.deleteIndex(a)});
c()})});g._cfg.contentUpgrade&&x.push(function(a,c){z=!0;var f=L._createTransaction(b,[].slice.call(a.db.objectStoreNames,0),p);f.idbtrans=a;var s=0;f._promise=V(f._promise,function(a){return function(b,g,f){function m(a){return function(){a.apply(this,arguments);0===--s&&c()}}++s;return a.call(this,b,function(a,b,c){arguments[0]=m(a);arguments[1]=m(b);g.apply(this,arguments)},f)}});a.onerror=La(n,["running upgrader function for version",g._cfg.version]);f.on("error").subscribe(n);g._cfg.contentUpgrade(f);
0===s&&c()});z&&(0<=navigator.userAgent.indexOf("Trident")||0<=navigator.userAgent.indexOf("MSIE"))||x.push(function(a,b){for(var c=0;c<a.db.objectStoreNames.length;++c){var g=a.db.objectStoreNames[c];null!==p[g]&&p[g]!==J||a.db.deleteObjectStore(g)}b()})});var P=function(){try{x.length?x.shift()(c,P):ka(aa,c)}catch(a){p.onerror=c.onerror=function(a){a.preventDefault()};try{c.abort()}catch(b){}c.db.close();n(a)}};P()}}function a(a,b){var f={del:[],add:[],change:[]},n;for(n in a)b[n]||f.del.push(n);
for(n in b){var p=a[n],q=b[n];if(p){var g={name:n,def:b[n],recreate:!1,del:[],add:[],change:[]};if(p.primKey.src!==q.primKey.src)g.recreate=!0,f.change.push(g);else{var p=p.indexes.reduce(function(a,b){a[b.name]=b;return a},{}),q=q.indexes.reduce(function(a,b){a[b.name]=b;return a},{}),x;for(x in p)q[x]||g.del.push(x);for(x in q){var P=p[x],m=q[x];P?P.src!==m.src&&g.change.push(m):g.add.push(m)}(g.recreate||0<g.del.length||0<g.add.length||0<g.change.length)&&f.change.push(g)}}else f.add.push([n,q])}return f}
function q(a,b,f,n){var p=a.db.createObjectStore(b,f.keyPath?{keyPath:f.keyPath,autoIncrement:f.auto}:{autoIncrement:f.auto});n.forEach(function(a){Sb(p,a)});return p}function ka(a,b){Object.keys(a).forEach(function(f){b.db.objectStoreNames.contains(f)||q(b,f,a[f].primKey,a[f].indexes)})}function Sb(a,b){a.createIndex(b.name,b.keyPath,{unique:b.unique,multiEntry:b.multi})}function Bd(a,b){throw new Ha("Table "+b[0]+" not part of transaction. Original Scope Function Source: "+K.Promise.PSD.trans.scopeFunc.toString());
}function Qb(a,b,f,n){this.name=a;this.schema=f;this.hook=O[a]?O[a].hook:ld(null,{creating:[Id,A],reading:[jd,Hd],updating:[he,A],deleting:[ke,A]});this._tpf=b;this._collClass=n||vb}function wd(a,b,f,n){Qb.call(this,a,b,f,n||Ka)}function xd(a,b,f,n){function p(a,b,c,g){return q._promise(a,c,g)}var q=this;this.db=L;this.mode=a;this.storeNames=b;this.idbtrans=null;this.on=ld(this,["complete","error"],"abort");this._reculock=0;this._blockedFuncs=[];this._psd=null;this.active=!0;this._dbschema=f;n&&(this.parent=
n);this._tpf=p;this.tables=Object.create(md);for(n=b.length-1;-1!==n;--n){var g=b[n],x=L._tableFactory(a,f[g],p);this.tables[g]=x;this[g]||(this[g]=x)}}function sc(a,b,f){this._ctx={table:a,index:":id"===b?null:b,collClass:a._collClass,or:f}}function vb(a,b){var f=null,n=null;if(b)try{f=b()}catch(p){n=p}var q=a._ctx;this._ctx={table:q.table,index:q.index,isPrimKey:!q.index||q.table.schema.primKey.keyPath&&q.index===q.table.schema.primKey.name,range:f,op:"openCursor",dir:"next",unique:"",algorithm:null,
filter:null,isMatch:null,offset:0,limit:Infinity,error:n,or:q.or}}function Ka(){vb.apply(this,arguments)}function Vc(a,b){return a._cfg.version-b._cfg.version}function cc(a,b,f,n,p,q){f.forEach(function(g){var f=L._tableFactory(n,p[g],b);a.forEach(function(a){a[g]||(q?Object.defineProperty(a,g,{configurable:!0,enumerable:!0,get:function(){var a=R.PSD&&R.PSD.trans;return a&&a.db===L?a.tables[g]:f}}):a[g]=f)})})}function dc(a){a.forEach(function(a){for(var b in a)a[b]instanceof Qb&&delete a[b]})}function Hb(a,
b,f,n,p,q){var g=R.PSD;q=q||Hd;a.onerror||(a.onerror=La(p));a.onsuccess=b?da(function(g){var x=a.result;if(x){var m=function(){x.continue()};b(x,function(a){m=a},n,p)&&f(q(x.value),x,function(a){m=a});m()}else n()},p,g):da(function(b){var c=a.result;if(c){var g=function(){c.continue()};f(q(c.value),c,function(a){g=a});g()}else n()},p,g)}function z(a){var b=[];a.split(",").forEach(function(a){a=a.trim();var f=a.replace("&","").replace("++","").replace("*",""),n=0!==f.indexOf("[")?f:a.substring(a.indexOf("[")+
1,a.indexOf("]")).split("+");b.push(new Tc(f,n||null,-1!==a.indexOf("&"),-1!==a.indexOf("*"),-1!==a.indexOf("++"),Array.isArray(n),-1!==n.indexOf(".")))});return b}function E(a,b){return a<b?-1:a>b?1:0}function Jd(a,b){return a<b?1:a>b?-1:0}function tc(a){return function(b,f){for(var n=0;;){var p=a(b[n],f[n]);if(0!==p)return p;++n;if(n===b.length||n===f.length)return a(b.length,f.length)}}}function Rb(a,b){return a?b?function(){return a.apply(this,arguments)&&b.apply(this,arguments)}:a:b}function Gb(){L.verno=
p.version/10;L._dbSchema=aa={};Xc=[].slice.call(p.objectStoreNames,0);if(0!==Xc.length){var a=p.transaction(Ec(Xc),"readonly");Xc.forEach(function(b){for(var f=a.objectStore(b),n=f.keyPath,p=n&&"string"===typeof n&&-1!==n.indexOf("."),q=new Tc(n,n||"",!1,!1,!!f.autoIncrement,n&&"string"!==typeof n,p),g=[],x=0;x<f.indexNames.length;++x){var P=f.index(f.indexNames[x]),p=(n=P.keyPath)&&"string"===typeof n&&-1!==n.indexOf("."),n=new Tc(P.name,n,!!P.unique,!!P.multiEntry,!1,n&&"string"!==typeof n,p);g.push(n)}aa[b]=
new Uc(b,q,g,{})});cc([O],L._transPromiseFactory,Object.keys(aa),b,aa)}}function Gc(a,b){for(var f=b.db.objectStoreNames,n=0;n<f.length;++n)for(var p=f[n],q=b.objectStore(p),g=0;g<q.indexNames.length;++g){var x=q.indexNames[g],P=q.index(x).keyPath,P="string"===typeof P?P:"["+[].slice.call(P).join("+")+"]";a[p]&&(P=a[p].idxByName[P])&&(P.name=x)}}var Tb=u&&u.addons||K.addons,ob=K.dependencies,Ab=ob.indexedDB,N=ob.IDBKeyRange,Wc=ob.TypeError,Ha=ob.Error,aa=this._dbSchema={},Hc=[],Xc=[],O={},md={},p=
null,Wa=!0,Xa=null,ma=!1,b="readwrite",L=this,n=[],ta=!1,na=!!f();this.version=function(a){if(p)throw new Ha("Cannot add version when database is open");this.verno=Math.max(this.verno,a);var b=Hc.filter(function(b){return b._cfg.version===a})[0];if(b)return b;b=new D(a);Hc.push(b);Hc.sort(Vc);return b};S(D.prototype,{stores:function(a){this._cfg.storesSource=this._cfg.storesSource?S(this._cfg.storesSource,a):a;var c={};Hc.forEach(function(a){S(c,a._cfg.storesSource)});a=this._cfg.dbschema={};this._parseStoresSpec(c,
a);aa=L._dbSchema=a;dc([O,L,md]);cc([md],Bd,Object.keys(a),b,a);cc([O,L,this._cfg.tables],L._transPromiseFactory,Object.keys(a),b,a,!0);Xc=Object.keys(a);return this},upgrade:function(a){var c=this;sa(function(){a(L._createTransaction(b,Object.keys(c._cfg.dbschema),c._cfg.dbschema))});this._cfg.contentUpgrade=a;return this},_parseStoresSpec:function(a,b){Object.keys(a).forEach(function(f){if(null!==a[f]){var n={},p=z(a[f]),q=p.shift();if(q.multi)throw new Ha("Primary key cannot be multi-valued");
q.keyPath&&q.auto&&Fb(n,q.keyPath,0);p.forEach(function(a){if(a.auto)throw new Ha("Only primary key can be marked as autoIncrement (++)");if(!a.keyPath)throw new Ha("Index must have a name and cannot be an empty string");Fb(n,a.keyPath,a.compound?a.keyPath.map(function(){return""}):"")});b[f]=new Uc(f,q,p,n)}})}});this._allTables=O;this._tableFactory=function(a,b,f){return"readonly"===a?new Qb(b.name,f,b,vb):new wd(b.name,f,b)};this._createTransaction=function(a,b,f,n){return new xd(a,b,f,n)};this._transPromiseFactory=
function(a,b,f){if(!Wa||R.PSD&&R.PSD.letThrough){var p=L._createTransaction(a,b,aa);return p._promise(a,function(a,b){p.error(function(a){L.on("error").fire(a)});f(function(b){p.complete(function(){a(b)})},b,p)})}var q=new R(function(p,g){n.push({resume:function(){var n=L._transPromiseFactory(a,b,f);q.onuncatched=n.onuncatched;n.then(p,g)}})});return q};this._whenReady=function(a){return!Wa||R.PSD&&R.PSD.letThrough?new R(a):new R(function(b,f){sa(function(){new R(function(){a(b,f)})});n.push({resume:function(){a(b,
f)}})})};this.verno=0;this.open=function(){return new R(function(a,b){function f(a){try{q.transaction.abort()}catch(g){}ma=!1;Xa=a;Wa=!1;b(Xa);n.forEach(function(a){a.resume()});n=[]}if(p||ma)throw new Ha("Database already opened or being opened");var q;try{Xa=null;ma=!0;0===Hc.length&&(ta=!0);if(!Ab)throw new Ha("indexedDB API not found. If using IE10+, make sure to run your code on a server URL (not locally). If using Safari, make sure to include indexedDB polyfill.");q=ta?Ab.open(x):Ab.open(x,
Math.round(10*L.verno));q.onerror=La(f,["opening database",x]);q.onblocked=function(a){L.on("blocked").fire(a)};q.onupgradeneeded=da(function(a){ta&&!L._allowEmptyDB?(q.onerror=function(a){a.preventDefault()},q.transaction.abort(),q.result.close(),a=Ab.deleteDatabase(x),a.onsuccess=a.onerror=function(){f(new Ha("Database '"+x+"' doesnt exist"))}):(q.transaction.onerror=La(f),a=a.oldVersion>Math.pow(2,62)?0:a.oldVersion,Yb(a/10,q.transaction,f,q))},f);q.onsuccess=da(function(b){ma=!1;p=q.result;ta?
Gb():0<p.objectStoreNames.length&&Gc(aa,p.transaction(Ec(p.objectStoreNames),"readonly"));p.onversionchange=L.on("versionchange").fire;na||Ld(function(a){if(-1===a.indexOf(x))return a.push(x)});R.newPSD(function(){function b(){Wa=!1;n.forEach(function(a){a.resume()});n=[];a()}R.PSD.letThrough=!0;try{var c=L.on.ready.fire();c&&"function"===typeof c.then?c.then(b,function(a){p.close();p=null;f(a)}):yd(b)}catch(q){f(q)}})},f)}catch(s){f(s)}})};this.close=function(){p&&(p.close(),p=null,Wa=!0,Xa=null)};
this.delete=function(){var a=arguments;return new R(function(b,f){function p(){L.close();var a=Ab.deleteDatabase(x);a.onsuccess=function(){na||Ld(function(a){var b=a.indexOf(x);if(0<=b)return a.splice(b,1)});b()};a.onerror=La(f,["deleting",x]);a.onblocked=function(){L.on("blocked").fire()}}if(0<a.length)throw new Ha("Arguments not allowed in db.delete()");ma?n.push({resume:p}):p()})};this.backendDB=function(){return p};this.isOpen=function(){return null!==p};this.hasFailed=function(){return null!==
Xa};this.dynamicallyOpened=function(){return ta};this.name=x;Object.defineProperty(this,"tables",{get:function(){return Object.keys(O).map(function(a){return O[a]})}});this.on=ld(this,"error","populate","blocked",{ready:[Sd,A],versionchange:[je,A]});this.on.ready.subscribe=V(this.on.ready.subscribe,function(a){return function(b,f){function p(){f||L.on.ready.unsubscribe(p);return b.apply(this,arguments)}a.call(this,p);L.isOpen()&&(Wa?n.push({resume:p}):p())}});sa(function(){L.on("populate").fire(L._createTransaction(b,
Xc,aa));L.on("error").fire(new Ha)});this.transaction=function(a,c,f){function n(b,c){var q=null;try{if(g)throw g;var q=L._createTransaction(a,x,aa,p),z=x.map(function(a){return q.tables[a]});z.push(q);var u,D=0;R.newPSD(function(){R.PSD.trans=q;q.scopeFunc=f;p&&(q.idbtrans=p.idbtrans,q._promise=V(q._promise,function(a){return function(b,c,g){function f(a){return function(b){var c;R._rootExec(function(){c=a(b);R._tickFinalize(function(){0===--D&&q.active&&(q.active=!1,q.on.complete.fire())})});return c}}
++D;return a.call(this,b,function(a,b,g){return c(f(a),f(b),g)},g)}}));q.complete(function(){b(u)});q.error(function(a){q.idbtrans&&(q.idbtrans.onerror=Kd);try{q.abort()}catch(b){}p&&(p.active=!1,p.on.error.fire(a));var g=c(a);p||g||L.on.error.fire(a)});R._rootExec(function(){u=f.apply(q,z)})});(!q.idbtrans||p&&0===D)&&q._nop()}catch(E){q&&q.idbtrans&&(q.idbtrans.onerror=Kd),q&&q.abort(),p&&p.on.error.fire(E),yd(function(){c(E)||L.on("error").fire(E)})}}c=[].slice.call(arguments,1,arguments.length-
1);f=arguments[arguments.length-1];var p=R.PSD&&R.PSD.trans;p&&p.db===L&&-1===a.indexOf("!")||(p=null);var q=-1!==a.indexOf("?");a=a.replace("!","").replace("?","");var g=null,x=(Array.isArray(c[0])?c.reduce(function(a,b){return a.concat(b)}):c).map(function(a){if("string"===typeof a)return a;a instanceof Qb||(g=g||new Wc("Invalid type. Arguments following mode must be instances of Table or String"));return a.name});"r"==a||"readonly"==a?a="readonly":"rw"==a||a==b?a=b:g=new Ha("Invalid transaction mode: "+
a);p&&!g&&(p&&"readonly"===p.mode&&a===b&&(q?p=null:g=g||new Ha("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY")),p&&x.forEach(function(a){p.tables.hasOwnProperty(a)||(q?p=null:g=g||new Ha("Table "+a+" not included in parent transaction. Parent Transaction function: "+p.scopeFunc.toString()))}));return p?p._promise(a,n,"lock"):L._whenReady(n)};this.table=function(a){if(!ta&&!O.hasOwnProperty(a))throw new Ha("Table does not exist");return O[a]};S(Qb.prototype,
function(){function a(){throw new Ha("Current Transaction is READONLY");}return{_trans:function(a,b,f){return this._tpf(a,[this.name],b,f)},_idbstore:function(a,b,f){var n=this;return this._tpf(a,[this.name],function(a,c,f){b(a,c,f.idbtrans.objectStore(n.name),f)},f)},get:function(a,b){var f=this;sa(function(){b(f.schema.instanceTemplate)});return this._idbstore("readonly",function(b,n,g){var p=g.get(a);p.onerror=La(n,["getting",a,"from",f.name]);p.onsuccess=function(){b(f.hook.reading.fire(p.result))}}).then(b)},
where:function(a){return new sc(this,a)},count:function(a){return this.toCollection().count(a)},offset:function(a){return this.toCollection().offset(a)},limit:function(a){return this.toCollection().limit(a)},reverse:function(){return this.toCollection().reverse()},filter:function(a){return this.toCollection().and(a)},each:function(a){var b=this;sa(function(){a(b.schema.instanceTemplate)});return this._idbstore("readonly",function(f,n,p){p=p.openCursor();p.onerror=La(n,["calling","Table.each()","on",
b.name]);Hb(p,null,a,f,n,b.hook.reading.fire)})},toArray:function(a){var b=this;sa(function(){a([b.schema.instanceTemplate])});return this._idbstore("readonly",function(a,c,f){var g=[];f=f.openCursor();f.onerror=La(c,["calling","Table.toArray()","on",b.name]);Hb(f,null,function(a){g.push(a)},function(){a(g)},c,b.hook.reading.fire)}).then(a)},orderBy:function(a){return new this._collClass(new sc(this,a))},toCollection:function(){return new this._collClass(new sc(this))},mapToClass:function(a,b){this.schema.mappedClass=
a;var f=Object.create(a.prototype);this.schema.primKey.keyPath&&(Fb(f,this.schema.primKey.keyPath,this.schema.primKey.auto?0:""),le(a.prototype,this.schema.primKey.keyPath));b&&rc(f,b);this.schema.instanceTemplate=f;f=Object.setPrototypeOf?function(b){if(!b)return b;Object.setPrototypeOf(b,a.prototype);return b}:function(b){if(!b)return b;var f=Object.create(a.prototype),g;for(g in b)b.hasOwnProperty(g)&&(f[g]=b[g]);return f};this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook);
this.schema.readHook=f;this.hook("reading",f);return a},defineClass:function(a){return this.mapToClass(K.defineClass(a),a)},add:a,put:a,"delete":a,clear:a,update:a}});T(wd).from(Qb).extend(function(){return{add:function(a,c){var f=this,n=this.hook.creating.fire;return this._idbstore(b,function(b,p,g,q){var x={};if(n!==A){var m=c||(g.keyPath?ga(a,g.keyPath):J);q=n.call(x,m,a,q);m===J&&q!==J&&(g.keyPath?Fb(a,g.keyPath,q):c=q)}var z=c?g.add(a,c):g.add(a);z.onerror=La(function(a){if(x.onerror)x.onerror(a);
return p(a)},["adding",a,"into",f.name]);z.onsuccess=function(c){var f=g.keyPath;f&&Fb(a,f,c.target.result);if(x.onsuccess)x.onsuccess(c.target.result);b(z.result)}})},put:function(a,c){var f=this,n=this.hook.updating.fire;return this.hook.creating.fire!==A||n!==A?this._trans(b,function(b,n,g){var p=c||f.schema.primKey.keyPath&&ga(a,f.schema.primKey.keyPath);p===J?g.tables[f.name].add(a).then(b,n):(g._lock(),a=Sc(a),g.tables[f.name].where(":id").equals(p).modify(function(b){this.value=a}).then(function(b){return 0===
b?g.tables[f.name].add(a,c):p}).finally(function(){g._unlock()}).then(b,n))}):this._idbstore(b,function(b,n,g){var p=c?g.put(a,c):g.put(a);p.onerror=La(n,["putting",a,"into",f.name]);p.onsuccess=function(c){var f=g.keyPath;f&&Fb(a,f,c.target.result);b(p.result)}})},"delete":function(a){return this.hook.deleting.subscribers.length?this.where(":id").equals(a).delete():this._idbstore(b,function(b,f,n){var p=n.delete(a);p.onerror=La(f,["deleting",a,"from",n.name]);p.onsuccess=function(a){b(p.result)}})},
clear:function(){return this.hook.deleting.subscribers.length?this.toCollection().delete():this._idbstore(b,function(a,b,f){var n=f.clear();n.onerror=La(b,["clearing",f.name]);n.onsuccess=function(b){a(n.result)}})},update:function(a,b){if("object"!==typeof b||Array.isArray(b))throw new Ha("db.update(keyOrObject, modifications). modifications must be an object.");if("object"!==typeof a||Array.isArray(a))return this.where(":id").equals(a).modify(b);Object.keys(b).forEach(function(f){Fb(a,f,b[f])});
var f=ga(a,this.schema.primKey.keyPath);f===J&&R.reject(new Ha("Object does not contain its primary key"));return this.where(":id").equals(f).modify(b)}}});S(xd.prototype,{_lock:function(){++this._reculock;1===this._reculock&&R.PSD&&(R.PSD.lockOwnerFor=this);return this},_unlock:function(){if(0===--this._reculock)for(R.PSD&&(R.PSD.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var a=this._blockedFuncs.shift();try{a()}catch(b){}}return this},_locked:function(){return this._reculock&&
(!R.PSD||R.PSD.lockOwnerFor!==this)},_nop:function(a){this.tables[this.storeNames[0]].get(0).then(a)},_promise:function(a,b,f){var n=this;return R.newPSD(function(){var q;n._locked()?q=new R(function(p,g){n._blockedFuncs.push(function(){n._promise(a,b,f).then(p,g)})}):(q=n.active?new R(function(q,g){if(!n.idbtrans&&a){if(!p)throw Xa?new Ha("Database not open. Following error in populate, ready or upgrade function made Dexie.open() fail: "+Xa):new Ha("Database not open");var s=n.idbtrans=p.transaction(Ec(n.storeNames),
n.mode);s.onerror=function(a){n.on("error").fire(a&&a.target.error);a.preventDefault();n.abort()};s.onabort=function(a){n.active=!1;n.on("abort").fire(a)};s.oncomplete=function(a){n.active=!1;n.on("complete").fire(a)}}f&&n._lock();try{b(q,g,n)}catch(x){K.ignoreTransaction(function(){n.on("error").fire(x)}),n.abort(),g(x)}}):R.reject(ue(new Ha("Transaction is inactive. Original Scope Function Source: "+n.scopeFunc.toString()))),n.active&&f&&q.finally(function(){n._unlock()}));q.onuncatched=function(a){K.ignoreTransaction(function(){n.on("error").fire(a)});
n.abort()};return q})},complete:function(a){return this.on("complete",a)},error:function(a){return this.on("error",a)},abort:function(){if(this.idbtrans&&this.active)try{this.active=!1,this.idbtrans.abort(),this.on.error.fire(new Ha("Transaction Aborted"))}catch(a){}},table:function(a){if(!this.tables.hasOwnProperty(a))throw new Ha("Table "+a+" not in transaction");return this.tables[a]}});S(sc.prototype,function(){function a(b,c){try{throw c;}catch(f){b._ctx.error=f}return b}function b(a){return Array.prototype.slice.call(1===
a.length&&Array.isArray(a[0])?a[0]:a)}function f(a){return"next"===a?function(a){return a.toUpperCase()}:function(a){return a.toLowerCase()}}function n(a){return"next"===a?function(a){return a.toLowerCase()}:function(a){return a.toUpperCase()}}function p(a,b,c,f,n,q){for(var s=Math.min(a.length,f.length),x=-1,z=0;z<s;++z){var u=b[z];if(u!==f[z])return 0>n(a[z],c[z])?a.substr(0,z)+c[z]+c.substr(z+1):0>n(a[z],f[z])?a.substr(0,z)+f[z]+c.substr(z+1):0<=x?a.substr(0,x)+b[x]+c.substr(x+1):null;0>n(a[z],
u)&&(x=z)}return s<f.length&&"next"===q?a+c.substr(a.length):s<a.length&&"prev"===q?a.substr(0,c.length):0>x?null:a.substr(0,x)+f[x]+c.substr(x+1)}function q(a,b,c){function m(a){x=f(a);z=n(a);u="next"===a?E:Jd;D=x(c);H=z(c);Fc=a}var x,z,u,D,H,Fc;m("next");a._ondirectionchange=function(a){m(a)};a._addAlgorithm(function(a,c,g){var f=a.key;if("string"!==typeof f)return!1;var m=z(f);if(b(m,H))return c(function(){a.continue()}),!0;var n=p(f,m,D,H,u,Fc);n?c(function(){a.continue(n)}):c(g);return!1})}return{between:function(a,
b,c,f){c=!1!==c;f=!0===f;return a>b||a===b&&!(!c&&!f||c&&f)?(new this._ctx.collClass(this,function(){return N.only(a)})).limit(0):new this._ctx.collClass(this,function(){return N.bound(a,b,!c,!f)})},equals:function(a){return new this._ctx.collClass(this,function(){return N.only(a)})},above:function(a){return new this._ctx.collClass(this,function(){return N.lowerBound(a,!0)})},aboveOrEqual:function(a){return new this._ctx.collClass(this,function(){return N.lowerBound(a)})},below:function(a){return new this._ctx.collClass(this,
function(){return N.upperBound(a,!0)})},belowOrEqual:function(a){return new this._ctx.collClass(this,function(){return N.upperBound(a)})},startsWith:function(b){return"string"!==typeof b?a(new this._ctx.collClass(this),new Wc("String expected")):this.between(b,b+String.fromCharCode(65535),!0,!0)},startsWithIgnoreCase:function(b){if("string"!==typeof b)return a(new this._ctx.collClass(this),new Wc("String expected"));if(""===b)return this.startsWith(b);var c=new this._ctx.collClass(this,function(){return N.bound(b.toUpperCase(),
b.toLowerCase()+String.fromCharCode(65535))});q(c,function(a,b){return 0===a.indexOf(b)},b);c._ondirectionchange=function(){a(c,new Ha("reverse() not supported with WhereClause.startsWithIgnoreCase()"))};return c},equalsIgnoreCase:function(b){if("string"!==typeof b)return a(new this._ctx.collClass(this),new Wc("String expected"));var c=new this._ctx.collClass(this,function(){return N.bound(b.toUpperCase(),b.toLowerCase())});q(c,function(a,b){return a===b},b);return c},anyOf:function(a){var f=this._ctx,
n=f.table.schema,m=(f=f.index?n.idxByName[f.index]:n.primKey)&&f.compound,p=b(arguments),q=m?tc(E):E;p.sort(q);if(0===p.length)return(new this._ctx.collClass(this,function(){return N.only("")})).limit(0);f=new this._ctx.collClass(this,function(){return N.bound(p[0],p[p.length-1])});f._ondirectionchange=function(a){q="next"===a?E:Jd;m&&(q=tc(q));p.sort(q)};var x=0;f._addAlgorithm(function(a,b,c){for(var g=a.key;0<q(g,p[x]);)if(++x,x===p.length)return b(c),!1;if(0===q(g,p[x]))return b(function(){a.continue()}),
!0;b(function(){a.continue(p[x])});return!1});return f}}});S(vb.prototype,function(){function a(b,c){b.filter=Rb(b.filter,c)}function c(a,b){a.isMatch=Rb(a.isMatch,b)}function f(a,b){if(a.isPrimKey)return b;var c=a.table.schema.idxByName[a.index];if(!c)throw new Ha("KeyPath "+a.index+" on object store "+b.name+" is not indexed");return a.isPrimKey?b:b.index(c.name)}function n(a,b){return f(a,b)[a.op](a.range||null,a.dir+a.unique)}function p(a,b,c,f,q){a.or?function(){function p(){2===++u&&c()}function x(a,
c,g){if(!s||s(c,g,p,f)){var n=c.primaryKey.toString();z.hasOwnProperty(n)||(z[n]=!0,b(a,c,g))}}var s=a.filter,z={},u=0;a.or._iterate(x,p,f,q);Hb(n(a,q),a.algorithm,x,p,f,a.table.hook.reading.fire)}():Hb(n(a,q),Rb(a.algorithm,a.filter),b,c,f,a.table.hook.reading.fire)}function q(a){return a.table.schema.instanceTemplate}return{_read:function(a,b){var c=this._ctx;return c.error?c.table._trans(null,function(a,b){b(c.error)}):c.table._idbstore("readonly",a).then(b)},_write:function(a){var c=this._ctx;
return c.error?c.table._trans(null,function(a,b){b(c.error)}):c.table._idbstore(b,a,"locked")},_addAlgorithm:function(a){var b=this._ctx;b.algorithm=Rb(b.algorithm,a)},_iterate:function(a,b,c,f){return p(this._ctx,a,b,c,f)},each:function(a){var b=this._ctx;sa(function(){a(q(b))});return this._read(function(c,f,n){p(b,a,c,f,n)})},count:function(a){sa(function(){a(0)});var b=this,c=this._ctx;if(c.filter||c.algorithm||c.or){var m=0;return this._read(function(a,b,g){p(c,function(){++m;return!1},function(){a(m)},
b,g)},a)}return this._read(function(a,g,m){m=f(c,m);m=c.range?m.count(c.range):m.count();m.onerror=La(g,["calling","count()","on",b.name]);m.onsuccess=function(b){a(Math.min(b.target.result,Math.max(0,c.limit-c.offset)))}},a)},sortBy:function(a,b){function c(a,b){return b?c(a[p[b]],b-1):a[x]}function f(a,b){var g=c(a,s),m=c(b,s);return g<m?-z:g>m?z:0}var n=this._ctx;sa(function(){b([q(n)])});var p=a.split(".").reverse(),x=p[0],s=p.length-1,z="next"===this._ctx.dir?1:-1;return this.toArray(function(a){return a.sort(f)}).then(b)},
toArray:function(a){var b=this._ctx;sa(function(){a([q(b)])});return this._read(function(a,c,g){var f=[];p(b,function(a){f.push(a)},function(){a(f)},c,g)},a)},offset:function(b){var c=this._ctx;if(0>=b)return this;c.offset+=b;c.or||c.algorithm||c.filter?a(c,function(a,c,f){return 0>--b}):a(c,function(a,c,f){if(0===b)return!0;if(1===b)return--b,!1;c(function(){a.advance(b);b=0});return!1});return this},limit:function(b){this._ctx.limit=Math.min(this._ctx.limit,b);a(this._ctx,function(a,c,f){0>=--b&&
c(f);return 0<=b});return this},until:function(b,c){var f=this._ctx;sa(function(){b(q(f))});a(this._ctx,function(a,f,n){return b(a.value)?(f(n),c):!0});return this},first:function(a){var b=this;sa(function(){a(q(b._ctx))});return this.limit(1).toArray(function(a){return a[0]}).then(a)},last:function(a){return this.reverse().first(a)},and:function(b){var f=this;sa(function(){b(q(f._ctx))});a(this._ctx,function(a){return b(a.value)});c(this._ctx,b);return this},or:function(a){return new sc(this._ctx.table,
a,this)},reverse:function(){this._ctx.dir="prev"===this._ctx.dir?"next":"prev";this._ondirectionchange&&this._ondirectionchange(this._ctx.dir);return this},desc:function(){return this.reverse()},eachKey:function(a){var b=this,c=this._ctx;sa(function(){a(q(b._ctx)[b._ctx.index])});c.isPrimKey||(c.op="openKeyCursor");return this.each(function(b,c){a(c.key,c)})},eachUniqueKey:function(a){this._ctx.unique="unique";return this.eachKey(a)},keys:function(a){sa(function(){a([q(c)[b._ctx.index]])});var b=
this,c=this._ctx;c.isPrimKey||(c.op="openKeyCursor");var f=[];return this.each(function(a,b){f.push(b.key)}).then(function(){return f}).then(a)},uniqueKeys:function(a){this._ctx.unique="unique";return this.keys(a)},firstKey:function(a){return this.limit(1).keys(function(a){return a[0]}).then(a)},lastKey:function(a){return this.reverse().firstKey(a)},distinct:function(){var b={};a(this._ctx,function(a){a=a.primaryKey.toString();var c=b.hasOwnProperty(a);b[a]=!0;return!c});return this}}});T(Ka).from(vb).extend({modify:function(a){var b=
this,f=this._ctx,n=f.table.hook,p=n.updating.fire,q=n.deleting.fire;sa(function(){"function"===typeof a&&a.call({value:f.table.schema.instanceTemplate},f.table.schema.instanceTemplate)});return this._write(function(g,n,x,m){function z(a){a&&(cc.push(a),O.push(Yb));return n(new Ad("Error modifying one or more objects",cc,C,O))}function u(){N&&C+cc.length===F&&(0<cc.length?z():g(C))}var D;if("function"===typeof a)D=p===A&&q===A?a:function(b){var c=Sc(b);if(!1===a.call(this,b))return!1;if(this.hasOwnProperty("value")){var g=
Dc(c,this.value),f=p.call(this,g,this.primKey,c,m);f&&(b=this.value,Object.keys(f).forEach(function(a){Fb(b,a,f[a])}))}else q.call(this,this.primKey,b,m)};else if(p===A){var E=Object.keys(a),Fc=E.length;D=function(b){for(var c=!1,g=0;g<Fc;++g){var f=E[g],m=a[f];ga(b,f)!==m&&(Fb(b,f,m),c=!0)}return c}}else{var L=a;a=Ud(L);D=function(b){var c=!1,g=p.call(this,a,this.primKey,Sc(b),m);g&&S(a,g);Object.keys(a).forEach(function(g){var f=a[g];ga(b,g)!==f&&(Fb(b,g,f),c=!0)});g&&(a=Ud(L));return c}}var F=
0,C=0,N=!1,cc=[],O=[],Yb=null;b._iterate(function(a,b,c){Yb=b.primaryKey;var g={primKey:b.primaryKey,value:a};if(!1!==D.call(g,a))b=(c=!g.hasOwnProperty("value"))?b.delete():b.update(g.value),++F,b.onerror=La(function(a){cc.push(a);O.push(g.primKey);if(g.onerror)g.onerror(a);u();return!0},c?["deleting",a,"from",f.table.name]:["modifying",a,"on",f.table.name]),b.onsuccess=function(a){if(g.onsuccess)g.onsuccess(g.value);++C;u()};else if(g.onsuccess)g.onsuccess(g.value)},function(){N=!0;u()},z,x)})},
"delete":function(){return this.modify(function(){delete this.value})}});S(this,{Collection:vb,Table:Qb,Transaction:xd,Version:D,WhereClause:sc,WriteableCollection:Ka,WriteableTable:wd});(function(){L.on("versionchange",function(a){L.close();L.on("error").fire(new Ha("Database version changed by other database connection."))})})();Tb.forEach(function(a){a(L)})}function A(){}function Hd(f){return f}function jd(f,u){return f===Hd?u:function(D){return u(f(D))}}function Ab(f,u){return function(){f.apply(this,
arguments);u.apply(this,arguments)}}function Id(f,u){return f===A?u:function(){var D=f.apply(this,arguments);D!==J&&(arguments[0]=D);var A=this.onsuccess,a=this.onerror;delete this.onsuccess;delete this.onerror;var q=u.apply(this,arguments);A&&(this.onsuccess=this.onsuccess?Ab(A,this.onsuccess):A);a&&(this.onerror=this.onerror?Ab(a,this.onerror):a);return q!==J?q:D}}function he(f,u){return f===A?u:function(){var D=f.apply(this,arguments);D!==J&&S(arguments[0],D);var A=this.onsuccess,a=this.onerror;
delete this.onsuccess;delete this.onerror;var q=u.apply(this,arguments);A&&(this.onsuccess=this.onsuccess?Ab(A,this.onsuccess):A);a&&(this.onerror=this.onerror?Ab(a,this.onerror):a);return D===J?q===J?J:q:q===J?D:S(D,q)}}function ie(f,u){return f===A?u:function(){return!1===f.apply(this,arguments)?!1:u.apply(this,arguments)}}function je(f,u){return f===A?u:function(){return!1===u.apply(this,arguments)?!1:f.apply(this,arguments)}}function ke(f,u){return f===A?u:function(){f.apply(this,arguments);u.apply(this,
arguments)}}function Sd(f,u){return f===A?u:function(){var D=f.apply(this,arguments);if(D&&"function"===typeof D.then){var A=this,a=arguments;return D.then(function(){return u.apply(A,a)})}return u.apply(this,arguments)}}function ld(f,u){function D(f,q,x){if(Array.isArray(f))return a(f);if("object"===typeof f)return K(f);q||(q=ie);x||(x=A);var u={subscribers:[],fire:x,subscribe:function(a){u.subscribers.push(a);u.fire=q(u.fire,a)},unsubscribe:function(a){u.subscribers=u.subscribers.filter(function(f){return f!==
a});u.fire=u.subscribers.reduce(q,x)}};return J[f]=R[f]=u}function K(a){Object.keys(a).forEach(function(f){var q=a[f];if(Array.isArray(q))D(f,a[f][0],a[f][1]);else if("asap"===q){var x=D(f,null,function(){var a=arguments;x.subscribers.forEach(function(f){yd(function(){f.apply(ka,a)})})});x.subscribe=function(a){-1===x.subscribers.indexOf(a)&&x.subscribers.push(a)};x.unsubscribe=function(a){a=x.subscribers.indexOf(a);-1!==a&&x.subscribers.splice(a,1)}}else throw Error("Invalid event config");})}function a(a){function f(){if(q)return!1;
q=!0}var q=!1;a.forEach(function(a){D(a).subscribe(f)})}var q=arguments,J={},R=function(a,q){if(q){var u=[].slice.call(arguments,1),D=J[a];D.subscribe.apply(D,u);return f}if("string"===typeof a)return J[a]};R.addEventType=D;for(var S=1,T=q.length;S<T;++S)D(q[S]);return R}function yd(f){ka.setImmediate?setImmediate(f):setTimeout(f,0)}function Td(f){f=setTimeout(f,1E3);clearTimeout(f)}function da(f,u,D){return function(){var A=R.PSD;R.PSD=D;try{f.apply(this,arguments)}catch(a){u(a)}finally{R.PSD=A}}}
function ga(f,u){if(f.hasOwnProperty(u))return f[u];if(!u)return f;if("string"!==typeof u){for(var D=[],A=0,a=u.length;A<a;++A){var q=ga(f,u[A]);D.push(q)}return D}D=u.indexOf(".");return-1!==D?(A=f[u.substr(0,D)],A===J?J:ga(A,u.substr(D+1))):J}function Fb(f,u,D){if(f&&u!==J)if("string"!==typeof u&&"length"in u){if(!("string"!==typeof D&&"length"in D))throw Error("Assertion failed");for(var A=0,a=u.length;A<a;++A)Fb(f,u[A],D[A])}else a=u.indexOf("."),-1!==a?(A=u.substr(0,a),u=u.substr(a+1),""===u?
D===J?delete f[A]:f[A]=D:((a=f[A])||(a=f[A]={}),Fb(a,u,D))):D===J?delete f[u]:f[u]=D}function le(f,u){Fb(f,u,J)}function Ud(f){var u={},D;for(D in f)f.hasOwnProperty(D)&&(u[D]=f[D]);return u}function Sc(f){if(!f||"object"!==typeof f)return f;var u;if(Array.isArray(f)){u=[];for(var D=0,A=f.length;D<A;++D)u.push(Sc(f[D]))}else if(f instanceof Date)u=new Date,u.setTime(f.getTime());else for(D in u=f.constructor?Object.create(f.constructor.prototype):{},f)f.hasOwnProperty(D)&&(u[D]=Sc(f[D]));return u}
function Dc(f,u){var D={},A;for(A in f)f.hasOwnProperty(A)&&(u.hasOwnProperty(A)?f[A]!==u[A]&&JSON.stringify(f[A])!=JSON.stringify(u[A])&&(D[A]=u[A]):D[A]=J);for(A in u)u.hasOwnProperty(A)&&!f.hasOwnProperty(A)&&(D[A]=u[A]);return D}function zd(f){if("function"===typeof f)return new f;if(Array.isArray(f))return[zd(f[0])];if(f&&"object"===typeof f){var u={};rc(u,f);return u}return f}function rc(f,u){Object.keys(u).forEach(function(D){var A=zd(u[D]);f[D]=A})}function La(f,u){return function(D){var A=
D&&D.target.error||Error();if(u){var a=" occurred when "+u.map(function(a){switch(typeof a){case "function":return a();case "string":return a;default:return JSON.stringify(a)}}).join(" ");A.name?A.toString=function(){return A.name+a+(A.message?". "+A.message:"")}:A+=a}f(A);D&&(D.stopPropagation&&D.stopPropagation(),D.preventDefault&&D.preventDefault());return!1}}function ue(f){try{throw f;}catch(u){return u}}function Kd(f){f.preventDefault()}function Ld(f){var u,A=K.dependencies.localStorage;if(!A)return f([]);
try{u=JSON.parse(A.getItem("Dexie.DatabaseNames")||"[]")}catch(J){u=[]}f(u)&&A.setItem("Dexie.DatabaseNames",JSON.stringify(u))}function Tc(f,u,A,J,a,q,K){this.name=f;this.keyPath=u;this.unique=A;this.multi=J;this.auto=a;this.compound=q;this.dotted=K;f="string"===typeof u?u:u&&"["+[].join.call(u,"+")+"]";this.src=(A?"&":"")+(J?"*":"")+(a?"++":"")+f}function Uc(f,u,A,J){this.name=f;this.primKey=u||new Tc;this.indexes=A||[new Tc];this.instanceTemplate=J;this.mappedClass=null;this.idxByName=A.reduce(function(a,
f){a[f.name]=f;return a},{})}function Ad(f,u,A,J){this.name="ModifyError";this.failures=u;this.failedKeys=J;this.successCount=A;this.message=u.join("\n")}function Ec(f){return 1===f.length?f[0]:f}function f(){var f=K.dependencies.indexedDB,u=f&&(f.getDatabaseNames||f.webkitGetDatabaseNames);return u&&u.bind(f)}var R=function(){function f(a,q){Ka.push([a,V.call(arguments,1)])}function u(){var a=Ka;Ka=[];for(var f=0,q=a.length;f<q;++f){var x=a[f];x[0].apply(ka,x[1])}}function D(a){if("object"!==typeof this)throw new TypeError("Promises must be constructed via new");
if("function"!==typeof a)throw new TypeError("not a function");this._value=this._state=null;this._deferreds=[];this._catched=!1;var f=this,u=!0;this._PSD=D.PSD;try{T(this,a,function(a){u?ga(q,f,a):q(f,a)},function(a){return u?(ga(K,f,a),!1):K(f,a)})}finally{u=!1}}function J(q,A){if(null===q._state)q._deferreds.push(A);else{var K=q._state?A.onFulfilled:A.onRejected;if(null===K)return(q._state?A.resolve:A.reject)(q._value);var z,E=sa;sa=!1;ga=f;try{var R=D.PSD;D.PSD=q._PSD;z=K(q._value);q._state||z&&
"function"===typeof z.then&&!1===z._state||a(q);A.resolve(z)}catch(S){if(!A.reject(S)&&q.onuncatched)try{q.onuncatched(S)}catch(T){}}finally{if(D.PSD=R,E){do{for(;0<Ka.length;)u();if(K=La.pop())try{K()}catch(V){}}while(0<La.length||0<Ka.length);ga=da;sa=!0}}}}function a(f){f._catched=!0;f._parent&&a(f._parent)}function q(a,f){var u=D.PSD;D.PSD=a._PSD;try{if(f===a)throw new TypeError("A promise cannot be resolved with itself.");!f||"object"!==typeof f&&"function"!==typeof f||"function"!==typeof f.then?
(a._state=!0,a._value=f,R.call(a)):T(a,function(a,q){f.then(a,q)},function(f){q(a,f)},function(f){K(a,f)})}catch(x){K(x)}finally{D.PSD=u}}function K(a,f){var q=D.PSD;D.PSD=a._PSD;a._state=!1;a._value=f;R.call(a);if(!a._catched)try{if(a.onuncatched)a.onuncatched(a._value);D.on.error.fire(a._value)}catch(u){}D.PSD=q;return a._catched}function R(){for(var a=0,f=this._deferreds.length;a<f;a++)J(this,this._deferreds[a]);this._deferreds=[]}function S(a,f,q,u){this.onFulfilled="function"===typeof a?a:null;
this.onRejected="function"===typeof f?f:null;this.resolve=q;this.reject=u}function T(a,f,q,u){var x=!1;try{f(function(a){x||(x=!0,q(a))},function(f){if(x)return a._catched;x=!0;return u(f)})}catch(A){if(!x)return u(A)}}var V=[].slice,da="undefined"===typeof setImmediate?function(a,f,q,u){var x=arguments;setTimeout(function(){a.apply(ka,V.call(x,1))},0)}:setImmediate,ga=da,sa=!0,Ka=[],La=[];D.on=ld(null,"error");D.all=function(){var a=Array.prototype.slice.call(1===arguments.length&&Array.isArray(arguments[0])?
arguments[0]:arguments);return new D(function(f,q){function u(A,D){try{if(D&&("object"===typeof D||"function"===typeof D)){var J=D.then;if("function"===typeof J){J.call(D,function(a){u(A,a)},q);return}}a[A]=D;0===--x&&f(a)}catch(K){q(K)}}if(0===a.length)return f([]);for(var x=a.length,A=0;A<a.length;A++)u(A,a[A])})};D.prototype.then=function(a,f){var q=this,u=new D(function(u,x){null===q._state?J(q,new S(a,f,u,x)):ga(J,q,new S(a,f,u,x))});u._PSD=this._PSD;u.onuncatched=this.onuncatched;u._parent=
this;return u};D.prototype._then=function(a,f){J(this,new S(a,f,A,A))};D.prototype["catch"]=function(a){if(1===arguments.length)return this.then(null,a);var f=arguments[0],q=arguments[1];return"function"===typeof f?this.then(null,function(a){return a instanceof f?q(a):D.reject(a)}):this.then(null,function(a){return a&&a.name===f?q(a):D.reject(a)})};D.prototype["finally"]=function(a){return this.then(function(f){a();return f},function(f){a();return D.reject(f)})};D.prototype.onuncatched=null;D.resolve=
function(a){var f=new D(function(){});f._state=!0;f._value=a;return f};D.reject=function(a){var f=new D(function(){});f._state=!1;f._value=a;return f};D.race=function(a){return new D(function(f,q){a.map(function(a){a.then(f,q)})})};D.PSD=null;D.newPSD=function(a){var f=D.PSD;D.PSD=f?Object.create(f):{};try{return a()}finally{D.PSD=f}};D._rootExec=function(a){var q=sa;sa=!1;ga=f;try{a()}finally{if(q){do{for(;0<Ka.length;)u();if(a=La.pop())try{a()}catch(A){}}while(0<La.length||0<Ka.length);ga=da;sa=
!0}}};D._tickFinalize=function(a){if(sa)throw Error("Not in a virtual tick");La.push(a)};return D}(),sa=function(){};T(Ad).from(Error);K.delete=function(f){var u=new K(f);f=u.delete();f.onblocked=function(f){u.on("blocked",f);return this};return f};K.getDatabaseNames=function(u){return(new R(function(u,x){var A=f();A?(A=A(),A.onsuccess=function(a){u([].slice.call(a.target.result,0))},A.onerror=La(x)):Ld(function(a){u(a);return!1})})).then(u)};K.defineClass=function(f){function u(f){f&&S(this,f)}rc(u.prototype,
f);return u};K.ignoreTransaction=function(f){return R.newPSD(function(){R.PSD.trans=null;return f()})};K.spawn=function(){ka.console&&console.warn("Dexie.spawn() is deprecated. Use Dexie.ignoreTransaction() instead.");return K.ignoreTransaction.apply(this,arguments)};K.vip=function(f){return R.newPSD(function(){R.PSD.letThrough=!0;return f()})};Object.defineProperty(K,"currentTransaction",{get:function(){return R.PSD&&R.PSD.trans||null}});K.Promise=R;K.derive=T;K.extend=S;K.override=V;K.events=ld;
K.getByKeyPath=ga;K.setByKeyPath=Fb;K.delByKeyPath=le;K.shallowClone=Ud;K.deepClone=Sc;K.addons=[];K.fakeAutoComplete=sa;K.asap=yd;K.ModifyError=Ad;K.MultiModifyError=Ad;K.IndexSpec=Tc;K.TableSchema=Uc;var Gb=ka.idbModules&&ka.idbModules.shimIndexedDB?ka.idbModules:{};K.dependencies={indexedDB:Gb.shimIndexedDB||ka.indexedDB||ka.mozIndexedDB||ka.webkitIndexedDB||ka.msIndexedDB,IDBKeyRange:Gb.IDBKeyRange||ka.IDBKeyRange||ka.webkitIDBKeyRange,IDBTransaction:Gb.IDBTransaction||ka.IDBTransaction||ka.webkitIDBTransaction,
Error:ka.Error||String,SyntaxError:ka.SyntaxError||String,TypeError:ka.TypeError||String,DOMError:ka.DOMError||String,localStorage:null!=("undefined"!==typeof chrome&&null!==chrome?chrome.storage:void 0)?null:ka.localStorage};K.version=1.1;u("Dexie",K);Td(function(){sa=Td})}).apply(null,"function"===typeof define&&define.amd?[self||window,function(ka,u){define(ka,function(){return u})}]:"undefined"!==typeof global&&"undefined"!==typeof module&&module.exports?[global,function(ka,u){module.exports=
u}]:[self||window,function(ka,u){(self||window)[ka]=u}]);
